<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 12.3.1"/>
    <title>ART.ModuleProcessing API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style><script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']]
        }
    };
</script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script>
    /* Re-invoke MathJax when DOM content changes, for example during search. */
    document.addEventListener("DOMContentLoaded", () => {
        new MutationObserver(() => MathJax.typeset()).observe(
            document.querySelector("main.pdoc").parentNode,
            {childList: true}
        );
    })
</script>
<style>
    mjx-container {
        overflow-x: auto;
    }
</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../ART.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;ART</a>

            <img src="logo.png" class="logo" alt="project logo"/>

            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



        <h2>API Documentation</h2>
            <ul class="memberlist">
            <li>
                    <a class="function" href="#OEPlacement">OEPlacement</a>
            </li>
            <li>
                    <a class="function" href="#RayTracingCalculation">RayTracingCalculation</a>
            </li>
            <li>
                    <a class="function" href="#FindOptimalDistance">FindOptimalDistance</a>
            </li>
            <li>
                    <a class="function" href="#FindCentralRay">FindCentralRay</a>
            </li>
            <li>
                    <a class="function" href="#StandardDeviation">StandardDeviation</a>
            </li>
            <li>
                    <a class="function" href="#WeightedStandardDeviation">WeightedStandardDeviation</a>
            </li>
            <li>
                    <a class="function" href="#ReturnNumericalAperture">ReturnNumericalAperture</a>
            </li>
            <li>
                    <a class="function" href="#ReturnAiryRadius">ReturnAiryRadius</a>
            </li>
            <li>
                    <a class="function" href="#save_compressed">save_compressed</a>
            </li>
            <li>
                    <a class="function" href="#load_compressed">load_compressed</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../ART.html">ART</a><wbr>.ModuleProcessing    </h1>

                        <div class="docstring"><p>Contains processing functions used for the ray-tracing and automated (pre-)alignment of the optical chains.
Usually these don't need to be called by users of ART, but they may be useful.</p>

<p>Created in Apr 2020</p>

<p>@author: Anthony Guillaume + Stefan Haessler</p>
</div>

                        <input id="mod-ModuleProcessing-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-ModuleProcessing-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#-1"><span class="linenos">  1</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2"><a href="#-2"><span class="linenos">  2</span></a><span class="sd">Contains processing functions used for the ray-tracing and automated (pre-)alignment of the optical chains.</span>
</span><span id="L-3"><a href="#-3"><span class="linenos">  3</span></a><span class="sd">Usually these don&#39;t need to be called by users of ART, but they may be useful.</span>
</span><span id="L-4"><a href="#-4"><span class="linenos">  4</span></a>
</span><span id="L-5"><a href="#-5"><span class="linenos">  5</span></a>
</span><span id="L-6"><a href="#-6"><span class="linenos">  6</span></a>
</span><span id="L-7"><a href="#-7"><span class="linenos">  7</span></a><span class="sd">Created in Apr 2020</span>
</span><span id="L-8"><a href="#-8"><span class="linenos">  8</span></a>
</span><span id="L-9"><a href="#-9"><span class="linenos">  9</span></a><span class="sd">@author: Anthony Guillaume + Stefan Haessler</span>
</span><span id="L-10"><a href="#-10"><span class="linenos"> 10</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-11"><a href="#-11"><span class="linenos"> 11</span></a><span class="c1"># %% Modules</span>
</span><span id="L-12"><a href="#-12"><span class="linenos"> 12</span></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="L-13"><a href="#-13"><span class="linenos"> 13</span></a><span class="kn">import</span> <span class="nn">pickle</span>
</span><span id="L-14"><a href="#-14"><span class="linenos"> 14</span></a>
</span><span id="L-15"><a href="#-15"><span class="linenos"> 15</span></a><span class="c1"># import gzip</span>
</span><span id="L-16"><a href="#-16"><span class="linenos"> 16</span></a><span class="kn">import</span> <span class="nn">lzma</span>
</span><span id="L-17"><a href="#-17"><span class="linenos"> 17</span></a><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">perf_counter</span>
</span><span id="L-18"><a href="#-18"><span class="linenos"> 18</span></a><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
</span><span id="L-19"><a href="#-19"><span class="linenos"> 19</span></a><span class="kn">import</span> <span class="nn">copy</span>
</span><span id="L-20"><a href="#-20"><span class="linenos"> 20</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-21"><a href="#-21"><span class="linenos"> 21</span></a><span class="kn">import</span> <span class="nn">ART.ModuleGeometry</span> <span class="k">as</span> <span class="nn">mgeo</span>
</span><span id="L-22"><a href="#-22"><span class="linenos"> 22</span></a><span class="kn">import</span> <span class="nn">ART.ModuleMirror</span> <span class="k">as</span> <span class="nn">mmirror</span>
</span><span id="L-23"><a href="#-23"><span class="linenos"> 23</span></a><span class="kn">import</span> <span class="nn">ART.ModuleMask</span> <span class="k">as</span> <span class="nn">mmask</span>
</span><span id="L-24"><a href="#-24"><span class="linenos"> 24</span></a><span class="kn">import</span> <span class="nn">ART.ModuleSource</span> <span class="k">as</span> <span class="nn">msource</span>
</span><span id="L-25"><a href="#-25"><span class="linenos"> 25</span></a><span class="kn">import</span> <span class="nn">ART.ModuleOpticalElement</span> <span class="k">as</span> <span class="nn">moe</span>
</span><span id="L-26"><a href="#-26"><span class="linenos"> 26</span></a><span class="kn">import</span> <span class="nn">ART.ModuleOpticalRay</span> <span class="k">as</span> <span class="nn">mray</span>
</span><span id="L-27"><a href="#-27"><span class="linenos"> 27</span></a><span class="kn">import</span> <span class="nn">ART.ModuleSupport</span> <span class="k">as</span> <span class="nn">msupp</span>
</span><span id="L-28"><a href="#-28"><span class="linenos"> 28</span></a><span class="kn">import</span> <span class="nn">ART.ModuleOpticalChain</span> <span class="k">as</span> <span class="nn">moc</span>
</span><span id="L-29"><a href="#-29"><span class="linenos"> 29</span></a>
</span><span id="L-30"><a href="#-30"><span class="linenos"> 30</span></a>
</span><span id="L-31"><a href="#-31"><span class="linenos"> 31</span></a><span class="c1"># %%</span>
</span><span id="L-32"><a href="#-32"><span class="linenos"> 32</span></a><span class="k">def</span> <span class="nf">_singleOEPlacement</span><span class="p">(</span>
</span><span id="L-33"><a href="#-33"><span class="linenos"> 33</span></a>    <span class="n">SourceProperties</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
</span><span id="L-34"><a href="#-34"><span class="linenos"> 34</span></a>    <span class="n">OpticsList</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
</span><span id="L-35"><a href="#-35"><span class="linenos"> 35</span></a>    <span class="n">DistanceList</span><span class="p">:</span> <span class="nb">list</span><span class="p">[(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
</span><span id="L-36"><a href="#-36"><span class="linenos"> 36</span></a>    <span class="n">IncidenceAngleList</span><span class="p">:</span> <span class="nb">list</span><span class="p">[(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
</span><span id="L-37"><a href="#-37"><span class="linenos"> 37</span></a>    <span class="n">IncidencePlaneAngleList</span><span class="p">:</span> <span class="nb">list</span><span class="p">[(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
</span><span id="L-38"><a href="#-38"><span class="linenos"> 38</span></a>    <span class="n">Description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-39"><a href="#-39"><span class="linenos"> 39</span></a><span class="p">):</span>
</span><span id="L-40"><a href="#-40"><span class="linenos"> 40</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-41"><a href="#-41"><span class="linenos"> 41</span></a><span class="sd">    Automatic placement and alignment of the optical elements for one optical chain.</span>
</span><span id="L-42"><a href="#-42"><span class="linenos"> 42</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-43"><a href="#-43"><span class="linenos"> 43</span></a>    <span class="n">Divergence</span> <span class="o">=</span> <span class="n">SourceProperties</span><span class="p">[</span><span class="s2">&quot;Divergence&quot;</span><span class="p">]</span>
</span><span id="L-44"><a href="#-44"><span class="linenos"> 44</span></a>    <span class="n">SourceSize</span> <span class="o">=</span> <span class="n">SourceProperties</span><span class="p">[</span><span class="s2">&quot;SourceSize&quot;</span><span class="p">]</span>
</span><span id="L-45"><a href="#-45"><span class="linenos"> 45</span></a>    <span class="n">RayNumber</span> <span class="o">=</span> <span class="n">SourceProperties</span><span class="p">[</span><span class="s2">&quot;NumberRays&quot;</span><span class="p">]</span>
</span><span id="L-46"><a href="#-46"><span class="linenos"> 46</span></a>    <span class="n">Wavelength</span> <span class="o">=</span> <span class="n">SourceProperties</span><span class="p">[</span><span class="s2">&quot;Wavelength&quot;</span><span class="p">]</span>
</span><span id="L-47"><a href="#-47"><span class="linenos"> 47</span></a>
</span><span id="L-48"><a href="#-48"><span class="linenos"> 48</span></a>    <span class="n">IncidencePlaneAngleList</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-49"><a href="#-49"><span class="linenos"> 49</span></a>        <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">((</span><span class="n">i</span> <span class="o">%</span> <span class="mi">360</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">IncidencePlaneAngleList</span>
</span><span id="L-50"><a href="#-50"><span class="linenos"> 50</span></a>    <span class="p">]</span>  <span class="c1"># wrap angles into [0,360]deg and convert to radian</span>
</span><span id="L-51"><a href="#-51"><span class="linenos"> 51</span></a>    <span class="n">IncidenceAngleList</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-52"><a href="#-52"><span class="linenos"> 52</span></a>        <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">((</span><span class="n">i</span> <span class="o">%</span> <span class="mi">360</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">IncidenceAngleList</span>
</span><span id="L-53"><a href="#-53"><span class="linenos"> 53</span></a>    <span class="p">]</span>  <span class="c1"># wrap angles into [0,360]deg and convert to radian</span>
</span><span id="L-54"><a href="#-54"><span class="linenos"> 54</span></a>
</span><span id="L-55"><a href="#-55"><span class="linenos"> 55</span></a>    <span class="c1"># Launch source ray bundle from the origin [x,y,z]=[0,0,0] into the x-direction:</span>
</span><span id="L-56"><a href="#-56"><span class="linenos"> 56</span></a>    <span class="n">SourcePosition</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
</span><span id="L-57"><a href="#-57"><span class="linenos"> 57</span></a>    <span class="n">SourceDirection</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
</span><span id="L-58"><a href="#-58"><span class="linenos"> 58</span></a>    <span class="k">if</span> <span class="n">Divergence</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-59"><a href="#-59"><span class="linenos"> 59</span></a>        <span class="k">if</span> <span class="n">SourceSize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-60"><a href="#-60"><span class="linenos"> 60</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-61"><a href="#-61"><span class="linenos"> 61</span></a>                <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="n">OpticsList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">support</span><span class="o">.</span><span class="n">dimX</span><span class="p">,</span> <span class="n">OpticsList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">support</span><span class="o">.</span><span class="n">dimY</span><span class="p">)</span>  <span class="c1"># for rect. support</span>
</span><span id="L-62"><a href="#-62"><span class="linenos"> 62</span></a>            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span><span id="L-63"><a href="#-63"><span class="linenos"> 63</span></a>                <span class="n">radius</span> <span class="o">=</span> <span class="n">OpticsList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">support</span><span class="o">.</span><span class="n">radius</span>  <span class="c1"># otherwise it must be a round support</span>
</span><span id="L-64"><a href="#-64"><span class="linenos"> 64</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-65"><a href="#-65"><span class="linenos"> 65</span></a>            <span class="n">radius</span> <span class="o">=</span> <span class="n">SourceSize</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="L-66"><a href="#-66"><span class="linenos"> 66</span></a>        <span class="n">SourceRayList</span> <span class="o">=</span> <span class="n">msource</span><span class="o">.</span><span class="n">PlaneWaveDisk</span><span class="p">(</span><span class="n">SourcePosition</span><span class="p">,</span> <span class="n">SourceDirection</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">RayNumber</span><span class="p">,</span> <span class="n">Wavelength</span><span class="o">=</span><span class="n">Wavelength</span><span class="p">)</span>
</span><span id="L-67"><a href="#-67"><span class="linenos"> 67</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-68"><a href="#-68"><span class="linenos"> 68</span></a>        <span class="k">if</span> <span class="n">SourceSize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-69"><a href="#-69"><span class="linenos"> 69</span></a>            <span class="n">SourceRayList</span> <span class="o">=</span> <span class="n">msource</span><span class="o">.</span><span class="n">PointSource</span><span class="p">(</span>
</span><span id="L-70"><a href="#-70"><span class="linenos"> 70</span></a>                <span class="n">SourcePosition</span><span class="p">,</span> <span class="n">SourceDirection</span><span class="p">,</span> <span class="n">Divergence</span><span class="p">,</span> <span class="n">RayNumber</span><span class="p">,</span> <span class="n">Wavelength</span><span class="o">=</span><span class="n">Wavelength</span>
</span><span id="L-71"><a href="#-71"><span class="linenos"> 71</span></a>            <span class="p">)</span>
</span><span id="L-72"><a href="#-72"><span class="linenos"> 72</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-73"><a href="#-73"><span class="linenos"> 73</span></a>            <span class="n">SourceRayList</span> <span class="o">=</span> <span class="n">msource</span><span class="o">.</span><span class="n">ExtendedSource</span><span class="p">(</span>
</span><span id="L-74"><a href="#-74"><span class="linenos"> 74</span></a>                <span class="n">SourcePosition</span><span class="p">,</span> <span class="n">SourceDirection</span><span class="p">,</span> <span class="n">SourceSize</span><span class="p">,</span> <span class="n">Divergence</span><span class="p">,</span> <span class="n">RayNumber</span><span class="p">,</span> <span class="n">Wavelength</span><span class="o">=</span><span class="n">Wavelength</span>
</span><span id="L-75"><a href="#-75"><span class="linenos"> 75</span></a>            <span class="p">)</span>
</span><span id="L-76"><a href="#-76"><span class="linenos"> 76</span></a>
</span><span id="L-77"><a href="#-77"><span class="linenos"> 77</span></a>    <span class="n">SourceRayList</span> <span class="o">=</span> <span class="n">msource</span><span class="o">.</span><span class="n">ApplyGaussianIntensityToRayList</span><span class="p">(</span>
</span><span id="L-78"><a href="#-78"><span class="linenos"> 78</span></a>        <span class="n">SourceRayList</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">e</span><span class="o">**</span><span class="mi">2</span>
</span><span id="L-79"><a href="#-79"><span class="linenos"> 79</span></a>    <span class="p">)</span>  <span class="c1"># Intensity drops to 1/e^2 at edge of ray-bundle</span>
</span><span id="L-80"><a href="#-80"><span class="linenos"> 80</span></a>
</span><span id="L-81"><a href="#-81"><span class="linenos"> 81</span></a>    <span class="c1"># Now successively create and align optical elements</span>
</span><span id="L-82"><a href="#-82"><span class="linenos"> 82</span></a>    <span class="n">SourceRay</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-83"><a href="#-83"><span class="linenos"> 83</span></a>        <span class="n">mray</span><span class="o">.</span><span class="n">Ray</span><span class="p">(</span><span class="n">SourcePosition</span><span class="p">,</span> <span class="n">SourceDirection</span><span class="p">)</span>
</span><span id="L-84"><a href="#-84"><span class="linenos"> 84</span></a>    <span class="p">]</span>  <span class="c1"># a single source ray in the central direction of the ray-bundle created above</span>
</span><span id="L-85"><a href="#-85"><span class="linenos"> 85</span></a>    <span class="n">OpticalElements</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-86"><a href="#-86"><span class="linenos"> 86</span></a>    <span class="n">OpticalElementCentre</span> <span class="o">=</span> <span class="n">SourcePosition</span>
</span><span id="L-87"><a href="#-87"><span class="linenos"> 87</span></a>    <span class="n">CentralVector</span> <span class="o">=</span> <span class="n">SourceDirection</span>
</span><span id="L-88"><a href="#-88"><span class="linenos"> 88</span></a>    <span class="n">RotationAxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span><span id="L-89"><a href="#-89"><span class="linenos"> 89</span></a>        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-90"><a href="#-90"><span class="linenos"> 90</span></a>    <span class="p">)</span>  <span class="c1"># Vector perpendicular to the incidence plane, i.e. initially the incidence plane is the x-z-plane.</span>
</span><span id="L-91"><a href="#-91"><span class="linenos"> 91</span></a>
</span><span id="L-92"><a href="#-92"><span class="linenos"> 92</span></a>    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">Optic</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">OpticsList</span><span class="p">):</span>
</span><span id="L-93"><a href="#-93"><span class="linenos"> 93</span></a>        <span class="c1"># for convex mirrors, rotated them by 180Â° them so we reflect from the &quot;back side&quot;</span>
</span><span id="L-94"><a href="#-94"><span class="linenos"> 94</span></a>        <span class="k">if</span> <span class="n">Optic</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;SphericalCX Mirror&quot;</span> <span class="ow">or</span> <span class="n">Optic</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;CylindricalCX Mirror&quot;</span><span class="p">:</span>
</span><span id="L-95"><a href="#-95"><span class="linenos"> 95</span></a>            <span class="n">IncidenceAngleList</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">IncidenceAngleList</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</span><span id="L-96"><a href="#-96"><span class="linenos"> 96</span></a>
</span><span id="L-97"><a href="#-97"><span class="linenos"> 97</span></a>        <span class="c1"># shift OpticalElementCentre-point from that of the preceding OE, by the required distance along the central ray vector</span>
</span><span id="L-98"><a href="#-98"><span class="linenos"> 98</span></a>        <span class="n">OpticalElementCentre</span> <span class="o">=</span> <span class="n">CentralVector</span> <span class="o">*</span> <span class="n">DistanceList</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">OpticalElementCentre</span>
</span><span id="L-99"><a href="#-99"><span class="linenos"> 99</span></a>
</span><span id="L-100"><a href="#-100"><span class="linenos">100</span></a>        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">IncidencePlaneAngleList</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">:</span>
</span><span id="L-101"><a href="#-101"><span class="linenos">101</span></a>            <span class="n">RotationAxis</span> <span class="o">=</span> <span class="o">-</span><span class="n">RotationAxis</span>
</span><span id="L-102"><a href="#-102"><span class="linenos">102</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-103"><a href="#-103"><span class="linenos">103</span></a>            <span class="n">RotationAxis</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">RotationAroundAxis</span><span class="p">(</span><span class="n">CentralVector</span><span class="p">,</span> <span class="o">-</span><span class="n">IncidencePlaneAngleList</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">RotationAxis</span><span class="p">)</span>
</span><span id="L-104"><a href="#-104"><span class="linenos">104</span></a>
</span><span id="L-105"><a href="#-105"><span class="linenos">105</span></a>        <span class="n">OpticalElementNormal</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">RotationAroundAxis</span><span class="p">(</span>
</span><span id="L-106"><a href="#-106"><span class="linenos">106</span></a>            <span class="n">RotationAxis</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">IncidenceAngleList</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">CentralVector</span><span class="p">,</span> <span class="n">RotationAxis</span><span class="p">)</span>
</span><span id="L-107"><a href="#-107"><span class="linenos">107</span></a>        <span class="p">)</span>
</span><span id="L-108"><a href="#-108"><span class="linenos">108</span></a>
</span><span id="L-109"><a href="#-109"><span class="linenos">109</span></a>        <span class="n">OpticalElementMajorAxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">RotationAxis</span><span class="p">,</span> <span class="n">OpticalElementNormal</span><span class="p">)</span>
</span><span id="L-110"><a href="#-110"><span class="linenos">110</span></a>
</span><span id="L-111"><a href="#-111"><span class="linenos">111</span></a>        <span class="n">Element</span> <span class="o">=</span> <span class="n">moe</span><span class="o">.</span><span class="n">OpticalElement</span><span class="p">(</span><span class="n">Optic</span><span class="p">,</span> <span class="n">OpticalElementCentre</span><span class="p">,</span> <span class="n">OpticalElementNormal</span><span class="p">,</span> <span class="n">OpticalElementMajorAxis</span><span class="p">)</span>
</span><span id="L-112"><a href="#-112"><span class="linenos">112</span></a>
</span><span id="L-113"><a href="#-113"><span class="linenos">113</span></a>        <span class="n">OpticalElements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Element</span><span class="p">)</span>
</span><span id="L-114"><a href="#-114"><span class="linenos">114</span></a>        <span class="n">auxChain</span> <span class="o">=</span> <span class="n">moc</span><span class="o">.</span><span class="n">OpticalChain</span><span class="p">(</span><span class="n">SourceRay</span><span class="p">,</span> <span class="n">OpticalElements</span><span class="p">)</span>
</span><span id="L-115"><a href="#-115"><span class="linenos">115</span></a>
</span><span id="L-116"><a href="#-116"><span class="linenos">116</span></a>        <span class="k">if</span> <span class="s2">&quot;Mirror&quot;</span> <span class="ow">in</span> <span class="n">Optic</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>
</span><span id="L-117"><a href="#-117"><span class="linenos">117</span></a>            <span class="n">OutRays</span> <span class="o">=</span> <span class="n">auxChain</span><span class="o">.</span><span class="n">get_output_rays</span><span class="p">()</span>
</span><span id="L-118"><a href="#-118"><span class="linenos">118</span></a>            <span class="n">CentralVector</span> <span class="o">=</span> <span class="n">OutRays</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vector</span>
</span><span id="L-119"><a href="#-119"><span class="linenos">119</span></a>        <span class="k">elif</span> <span class="n">Optic</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Mask&quot;</span><span class="p">:</span>
</span><span id="L-120"><a href="#-120"><span class="linenos">120</span></a>            <span class="c1"># CentralVector remains unchanged</span>
</span><span id="L-121"><a href="#-121"><span class="linenos">121</span></a>            <span class="c1"># in our auxChain, but *not* in the OpticalElements-list, replace mask by completely tansparent &quot;fake version&quot;</span>
</span><span id="L-122"><a href="#-122"><span class="linenos">122</span></a>            <span class="c1"># to be sure that our CentralVector serving as alignment-guide always passes</span>
</span><span id="L-123"><a href="#-123"><span class="linenos">123</span></a>            <span class="n">FakeMask</span> <span class="o">=</span> <span class="n">mmask</span><span class="o">.</span><span class="n">Mask</span><span class="p">(</span><span class="n">msupp</span><span class="o">.</span><span class="n">SupportRoundHole</span><span class="p">(</span><span class="n">Radius</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">RadiusHole</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">CenterHoleX</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">CenterHoleY</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
</span><span id="L-124"><a href="#-124"><span class="linenos">124</span></a>            <span class="n">auxChain</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">moe</span><span class="o">.</span><span class="n">OpticalElement</span><span class="p">(</span>
</span><span id="L-125"><a href="#-125"><span class="linenos">125</span></a>                <span class="n">FakeMask</span><span class="p">,</span> <span class="n">OpticalElementCentre</span><span class="p">,</span> <span class="n">OpticalElementNormal</span><span class="p">,</span> <span class="n">OpticalElementMajorAxis</span>
</span><span id="L-126"><a href="#-126"><span class="linenos">126</span></a>            <span class="p">)</span>
</span><span id="L-127"><a href="#-127"><span class="linenos">127</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-128"><a href="#-128"><span class="linenos">128</span></a>            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s2">&quot;I don`t recognize the type of optical element &quot;</span> <span class="o">+</span> <span class="n">OpticalElements</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">type</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>
</span><span id="L-129"><a href="#-129"><span class="linenos">129</span></a>
</span><span id="L-130"><a href="#-130"><span class="linenos">130</span></a>    <span class="k">return</span> <span class="n">moc</span><span class="o">.</span><span class="n">OpticalChain</span><span class="p">(</span><span class="n">SourceRayList</span><span class="p">,</span> <span class="n">OpticalElements</span><span class="p">,</span> <span class="n">Description</span><span class="p">)</span>
</span><span id="L-131"><a href="#-131"><span class="linenos">131</span></a>
</span><span id="L-132"><a href="#-132"><span class="linenos">132</span></a>
</span><span id="L-133"><a href="#-133"><span class="linenos">133</span></a><span class="k">def</span> <span class="nf">OEPlacement</span><span class="p">(</span>
</span><span id="L-134"><a href="#-134"><span class="linenos">134</span></a>    <span class="n">SourceProperties</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
</span><span id="L-135"><a href="#-135"><span class="linenos">135</span></a>    <span class="n">OpticsList</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
</span><span id="L-136"><a href="#-136"><span class="linenos">136</span></a>    <span class="n">DistanceList</span><span class="p">:</span> <span class="nb">list</span><span class="p">[(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
</span><span id="L-137"><a href="#-137"><span class="linenos">137</span></a>    <span class="n">IncidenceAngleList</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
</span><span id="L-138"><a href="#-138"><span class="linenos">138</span></a>    <span class="n">IncidencePlaneAngleList</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-139"><a href="#-139"><span class="linenos">139</span></a>    <span class="n">Description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-140"><a href="#-140"><span class="linenos">140</span></a>    <span class="n">render</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-141"><a href="#-141"><span class="linenos">141</span></a><span class="p">):</span>
</span><span id="L-142"><a href="#-142"><span class="linenos">142</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-143"><a href="#-143"><span class="linenos">143</span></a><span class="sd">    Automatically place optical elements in the &quot;lab frame&quot; according to given distances and incidence angles.</span>
</span><span id="L-144"><a href="#-144"><span class="linenos">144</span></a><span class="sd">    Outputs an OpticalChain-object.</span>
</span><span id="L-145"><a href="#-145"><span class="linenos">145</span></a>
</span><span id="L-146"><a href="#-146"><span class="linenos">146</span></a><span class="sd">    The source is placed at the origin, and points into the x-direction. The optical elements then follow.</span>
</span><span id="L-147"><a href="#-147"><span class="linenos">147</span></a>
</span><span id="L-148"><a href="#-148"><span class="linenos">148</span></a><span class="sd">    As long as the angles in IncidencePlaneAngleList are 0, the incidence plane remains the x-z plane, i.e.</span>
</span><span id="L-149"><a href="#-149"><span class="linenos">149</span></a><span class="sd">    the optical elements are rotated about the y-axis to set the desired incidence angle between OE-normal</span>
</span><span id="L-150"><a href="#-150"><span class="linenos">150</span></a><span class="sd">    and the direction of incidence of the incoming ray-bundle. Otherwise, the incidence plane gets rotated.</span>
</span><span id="L-151"><a href="#-151"><span class="linenos">151</span></a>
</span><span id="L-152"><a href="#-152"><span class="linenos">152</span></a><span class="sd">    One of the elements of one of the lists &#39;DistanceList&#39;, &#39;IncidenceAngleList&#39;, or &#39;IncidencePlaneAngleList&#39;</span>
</span><span id="L-153"><a href="#-153"><span class="linenos">153</span></a><span class="sd">    can be a list or a numpy-array. In that case, a list of OpticalChain-objects is created which can be looped over.</span>
</span><span id="L-154"><a href="#-154"><span class="linenos">154</span></a>
</span><span id="L-155"><a href="#-155"><span class="linenos">155</span></a><span class="sd">    Parameters</span>
</span><span id="L-156"><a href="#-156"><span class="linenos">156</span></a><span class="sd">    ----------</span>
</span><span id="L-157"><a href="#-157"><span class="linenos">157</span></a><span class="sd">        SourceProperties : dict</span>
</span><span id="L-158"><a href="#-158"><span class="linenos">158</span></a><span class="sd">            Dictionary with the keys &quot;Divergence&quot; :float, &quot;SourceSize&quot; :float,</span>
</span><span id="L-159"><a href="#-159"><span class="linenos">159</span></a><span class="sd">            &quot;NumberRays&quot; :int, and &quot;Wavelength&quot; :float.</span>
</span><span id="L-160"><a href="#-160"><span class="linenos">160</span></a><span class="sd">            This determines the source ray-bundle that is created.</span>
</span><span id="L-161"><a href="#-161"><span class="linenos">161</span></a>
</span><span id="L-162"><a href="#-162"><span class="linenos">162</span></a><span class="sd">        OpticsList : list[Optics-class-objects (Mirorrs or Masks)]</span>
</span><span id="L-163"><a href="#-163"><span class="linenos">163</span></a><span class="sd">            List of Optics-objects.</span>
</span><span id="L-164"><a href="#-164"><span class="linenos">164</span></a>
</span><span id="L-165"><a href="#-165"><span class="linenos">165</span></a><span class="sd">        DistanceList : list[float]</span>
</span><span id="L-166"><a href="#-166"><span class="linenos">166</span></a><span class="sd">            List of distances, in mm,  at which place the optics out of the</span>
</span><span id="L-167"><a href="#-167"><span class="linenos">167</span></a><span class="sd">            OpticsList from the precending one. For the first optic, this is</span>
</span><span id="L-168"><a href="#-168"><span class="linenos">168</span></a><span class="sd">            the distance from the light source.</span>
</span><span id="L-169"><a href="#-169"><span class="linenos">169</span></a>
</span><span id="L-170"><a href="#-170"><span class="linenos">170</span></a><span class="sd">            One of the elements can ne a list or a numpy-array instead of a float.</span>
</span><span id="L-171"><a href="#-171"><span class="linenos">171</span></a><span class="sd">            In that case, a list of OpticalChain-objects is created which can be looped over.</span>
</span><span id="L-172"><a href="#-172"><span class="linenos">172</span></a>
</span><span id="L-173"><a href="#-173"><span class="linenos">173</span></a><span class="sd">        IncidenceAngleList : list[float]</span>
</span><span id="L-174"><a href="#-174"><span class="linenos">174</span></a><span class="sd">            List of incidence angles, in degrees, measured between the central ray</span>
</span><span id="L-175"><a href="#-175"><span class="linenos">175</span></a><span class="sd">            of the incident ray bundle and the normal on the optical element.</span>
</span><span id="L-176"><a href="#-176"><span class="linenos">176</span></a>
</span><span id="L-177"><a href="#-177"><span class="linenos">177</span></a><span class="sd">            One of the elements can ne a list or a numpy-array instead of a float.</span>
</span><span id="L-178"><a href="#-178"><span class="linenos">178</span></a><span class="sd">            In that case, a list of OpticalChain-objects is created which can be looped over.</span>
</span><span id="L-179"><a href="#-179"><span class="linenos">179</span></a>
</span><span id="L-180"><a href="#-180"><span class="linenos">180</span></a><span class="sd">        IncidencePlaneAngleList : list[float], optional</span>
</span><span id="L-181"><a href="#-181"><span class="linenos">181</span></a><span class="sd">            List of angles, in degrees, by which the incidence plane is rotated</span>
</span><span id="L-182"><a href="#-182"><span class="linenos">182</span></a><span class="sd">            on the optical element with respect to that on the preceding one.</span>
</span><span id="L-183"><a href="#-183"><span class="linenos">183</span></a><span class="sd">            Consequently, for the first element, this angle has no qualitative effect.</span>
</span><span id="L-184"><a href="#-184"><span class="linenos">184</span></a>
</span><span id="L-185"><a href="#-185"><span class="linenos">185</span></a><span class="sd">            One of the elements can ne a list or a numpy-array instead of a float.</span>
</span><span id="L-186"><a href="#-186"><span class="linenos">186</span></a><span class="sd">            In that case, a list of OpticalChain-objects is created which can be looped over.</span>
</span><span id="L-187"><a href="#-187"><span class="linenos">187</span></a>
</span><span id="L-188"><a href="#-188"><span class="linenos">188</span></a><span class="sd">        Description : str, optional</span>
</span><span id="L-189"><a href="#-189"><span class="linenos">189</span></a><span class="sd">            A string to describe the optical setup.</span>
</span><span id="L-190"><a href="#-190"><span class="linenos">190</span></a>
</span><span id="L-191"><a href="#-191"><span class="linenos">191</span></a><span class="sd">        render : bool, optional</span>
</span><span id="L-192"><a href="#-192"><span class="linenos">192</span></a><span class="sd">            Whether save a png-image with a rendering of the optical setup.</span>
</span><span id="L-193"><a href="#-193"><span class="linenos">193</span></a>
</span><span id="L-194"><a href="#-194"><span class="linenos">194</span></a><span class="sd">    Returns</span>
</span><span id="L-195"><a href="#-195"><span class="linenos">195</span></a><span class="sd">    -------</span>
</span><span id="L-196"><a href="#-196"><span class="linenos">196</span></a><span class="sd">        OpticalChainList : list[OpticalChain-object]</span>
</span><span id="L-197"><a href="#-197"><span class="linenos">197</span></a>
</span><span id="L-198"><a href="#-198"><span class="linenos">198</span></a><span class="sd">        or</span>
</span><span id="L-199"><a href="#-199"><span class="linenos">199</span></a>
</span><span id="L-200"><a href="#-200"><span class="linenos">200</span></a><span class="sd">        OpticalChain : OpticalChain-object</span>
</span><span id="L-201"><a href="#-201"><span class="linenos">201</span></a>
</span><span id="L-202"><a href="#-202"><span class="linenos">202</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-203"><a href="#-203"><span class="linenos">203</span></a>    <span class="k">if</span> <span class="n">render</span><span class="p">:</span>
</span><span id="L-204"><a href="#-204"><span class="linenos">204</span></a>        <span class="kn">from</span> <span class="nn">mayavi</span> <span class="kn">import</span> <span class="n">mlab</span>
</span><span id="L-205"><a href="#-205"><span class="linenos">205</span></a>
</span><span id="L-206"><a href="#-206"><span class="linenos">206</span></a>    <span class="k">if</span> <span class="n">IncidencePlaneAngleList</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-207"><a href="#-207"><span class="linenos">207</span></a>        <span class="n">IncidencePlaneAngleList</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">OpticsList</span><span class="p">))</span>
</span><span id="L-208"><a href="#-208"><span class="linenos">208</span></a>
</span><span id="L-209"><a href="#-209"><span class="linenos">209</span></a>    <span class="n">nest_indx_distance</span> <span class="o">=</span> <span class="n">_which_indeces</span><span class="p">(</span><span class="n">DistanceList</span><span class="p">)</span>
</span><span id="L-210"><a href="#-210"><span class="linenos">210</span></a>    <span class="n">nest_indx_incidence</span> <span class="o">=</span> <span class="n">_which_indeces</span><span class="p">(</span><span class="n">IncidenceAngleList</span><span class="p">)</span>
</span><span id="L-211"><a href="#-211"><span class="linenos">211</span></a>    <span class="n">nest_indx_incplane</span> <span class="o">=</span> <span class="n">_which_indeces</span><span class="p">(</span><span class="n">IncidencePlaneAngleList</span><span class="p">)</span>
</span><span id="L-212"><a href="#-212"><span class="linenos">212</span></a>
</span><span id="L-213"><a href="#-213"><span class="linenos">213</span></a>    <span class="n">total_nested</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nest_indx_incidence</span> <span class="o">+</span> <span class="n">nest_indx_incplane</span> <span class="o">+</span> <span class="n">nest_indx_distance</span><span class="p">)</span>
</span><span id="L-214"><a href="#-214"><span class="linenos">214</span></a>    <span class="k">if</span> <span class="n">total_nested</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-215"><a href="#-215"><span class="linenos">215</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-216"><a href="#-216"><span class="linenos">216</span></a>            <span class="s2">&quot;Only one element of one of the lists IncidenceAngleList, IncidencePlaneAngleList, or DistanceList can be a list or array itself. Otherwise things get too tangled...&quot;</span>
</span><span id="L-217"><a href="#-217"><span class="linenos">217</span></a>        <span class="p">)</span>
</span><span id="L-218"><a href="#-218"><span class="linenos">218</span></a>    <span class="k">elif</span> <span class="n">total_nested</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-219"><a href="#-219"><span class="linenos">219</span></a>        <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">nest_indx_incidence</span> <span class="o">+</span> <span class="n">nest_indx_incplane</span> <span class="o">+</span> <span class="n">nest_indx_distance</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-220"><a href="#-220"><span class="linenos">220</span></a>        <span class="n">loop_variable_name</span> <span class="o">=</span> <span class="n">OpticsList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">+</span> <span class="s2">&quot;_idx_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="L-221"><a href="#-221"><span class="linenos">221</span></a>        <span class="k">if</span> <span class="n">nest_indx_incidence</span><span class="p">:</span>  <span class="c1"># if the list is not empty</span>
</span><span id="L-222"><a href="#-222"><span class="linenos">222</span></a>            <span class="n">loop_variable_name</span> <span class="o">+=</span> <span class="s2">&quot; incidence angle (deg)&quot;</span>
</span><span id="L-223"><a href="#-223"><span class="linenos">223</span></a>            <span class="n">loop_variable</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">IncidenceAngleList</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="L-224"><a href="#-224"><span class="linenos">224</span></a>            <span class="n">loop_list</span> <span class="o">=</span> <span class="n">IncidenceAngleList</span>
</span><span id="L-225"><a href="#-225"><span class="linenos">225</span></a>        <span class="k">elif</span> <span class="n">nest_indx_distance</span><span class="p">:</span>  <span class="c1"># if the list is not empty</span>
</span><span id="L-226"><a href="#-226"><span class="linenos">226</span></a>            <span class="n">loop_variable_name</span> <span class="o">+=</span> <span class="s2">&quot; distance (mm)&quot;</span>
</span><span id="L-227"><a href="#-227"><span class="linenos">227</span></a>            <span class="n">loop_variable</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">DistanceList</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="L-228"><a href="#-228"><span class="linenos">228</span></a>            <span class="n">loop_list</span> <span class="o">=</span> <span class="n">DistanceList</span>
</span><span id="L-229"><a href="#-229"><span class="linenos">229</span></a>        <span class="k">elif</span> <span class="n">nest_indx_incplane</span><span class="p">:</span>  <span class="c1"># if the list is not empty</span>
</span><span id="L-230"><a href="#-230"><span class="linenos">230</span></a>            <span class="n">loop_variable_name</span> <span class="o">+=</span> <span class="s2">&quot; incidence-plane angle rotation (deg)&quot;</span>
</span><span id="L-231"><a href="#-231"><span class="linenos">231</span></a>            <span class="n">loop_variable</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">IncidencePlaneAngleList</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="L-232"><a href="#-232"><span class="linenos">232</span></a>            <span class="n">loop_list</span> <span class="o">=</span> <span class="n">IncidencePlaneAngleList</span>
</span><span id="L-233"><a href="#-233"><span class="linenos">233</span></a>
</span><span id="L-234"><a href="#-234"><span class="linenos">234</span></a>        <span class="n">OpticalChainList</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-235"><a href="#-235"><span class="linenos">235</span></a>        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">loop_variable</span><span class="p">:</span>
</span><span id="L-236"><a href="#-236"><span class="linenos">236</span></a>            <span class="n">loop_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
</span><span id="L-237"><a href="#-237"><span class="linenos">237</span></a>            <span class="n">ModifiedOpticalChain</span> <span class="o">=</span> <span class="n">_singleOEPlacement</span><span class="p">(</span>
</span><span id="L-238"><a href="#-238"><span class="linenos">238</span></a>                <span class="n">SourceProperties</span><span class="p">,</span> <span class="n">OpticsList</span><span class="p">,</span> <span class="n">DistanceList</span><span class="p">,</span> <span class="n">IncidenceAngleList</span><span class="p">,</span> <span class="n">IncidencePlaneAngleList</span><span class="p">,</span> <span class="n">Description</span>
</span><span id="L-239"><a href="#-239"><span class="linenos">239</span></a>            <span class="p">)</span>
</span><span id="L-240"><a href="#-240"><span class="linenos">240</span></a>            <span class="n">ModifiedOpticalChain</span><span class="o">.</span><span class="n">loop_variable_name</span> <span class="o">=</span> <span class="n">loop_variable_name</span>
</span><span id="L-241"><a href="#-241"><span class="linenos">241</span></a>            <span class="n">ModifiedOpticalChain</span><span class="o">.</span><span class="n">loop_variable_value</span> <span class="o">=</span> <span class="n">x</span>
</span><span id="L-242"><a href="#-242"><span class="linenos">242</span></a>            <span class="n">OpticalChainList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ModifiedOpticalChain</span><span class="p">)</span>
</span><span id="L-243"><a href="#-243"><span class="linenos">243</span></a>
</span><span id="L-244"><a href="#-244"><span class="linenos">244</span></a>            <span class="k">if</span> <span class="n">render</span><span class="p">:</span>
</span><span id="L-245"><a href="#-245"><span class="linenos">245</span></a>                <span class="c1"># to produce and save renderings of the setup for each iteration in the loop:</span>
</span><span id="L-246"><a href="#-246"><span class="linenos">246</span></a>                <span class="n">mlab</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">offscreen</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-247"><a href="#-247"><span class="linenos">247</span></a>                <span class="n">fig</span> <span class="o">=</span> <span class="n">ModifiedOpticalChain</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
</span><span id="L-248"><a href="#-248"><span class="linenos">248</span></a>                <span class="n">name</span> <span class="o">=</span> <span class="n">loop_variable_name</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span>
</span><span id="L-249"><a href="#-249"><span class="linenos">249</span></a>                <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
</span><span id="L-250"><a href="#-250"><span class="linenos">250</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;...saving image...&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-251"><a href="#-251"><span class="linenos">251</span></a>                <span class="n">mlab</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">magnification</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="L-252"><a href="#-252"><span class="linenos">252</span></a>                <span class="nb">print</span><span class="p">(</span>
</span><span id="L-253"><a href="#-253"><span class="linenos">253</span></a>                    <span class="s2">&quot;</span><span class="se">\r\033</span><span class="s2">[K&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-254"><a href="#-254"><span class="linenos">254</span></a>                <span class="p">)</span>  <span class="c1"># move to beginning of the line with \r and then delete the whole line with \033[K</span>
</span><span id="L-255"><a href="#-255"><span class="linenos">255</span></a>
</span><span id="L-256"><a href="#-256"><span class="linenos">256</span></a>        <span class="k">if</span> <span class="n">render</span><span class="p">:</span>
</span><span id="L-257"><a href="#-257"><span class="linenos">257</span></a>            <span class="n">mlab</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">offscreen</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-258"><a href="#-258"><span class="linenos">258</span></a>
</span><span id="L-259"><a href="#-259"><span class="linenos">259</span></a>        <span class="k">return</span> <span class="n">OpticalChainList</span>
</span><span id="L-260"><a href="#-260"><span class="linenos">260</span></a>
</span><span id="L-261"><a href="#-261"><span class="linenos">261</span></a>    <span class="k">elif</span> <span class="n">total_nested</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-262"><a href="#-262"><span class="linenos">262</span></a>        <span class="n">OpticalChain</span> <span class="o">=</span> <span class="n">_singleOEPlacement</span><span class="p">(</span>
</span><span id="L-263"><a href="#-263"><span class="linenos">263</span></a>            <span class="n">SourceProperties</span><span class="p">,</span> <span class="n">OpticsList</span><span class="p">,</span> <span class="n">DistanceList</span><span class="p">,</span> <span class="n">IncidenceAngleList</span><span class="p">,</span> <span class="n">IncidencePlaneAngleList</span><span class="p">,</span> <span class="n">Description</span>
</span><span id="L-264"><a href="#-264"><span class="linenos">264</span></a>        <span class="p">)</span>  <span class="c1"># all simple</span>
</span><span id="L-265"><a href="#-265"><span class="linenos">265</span></a>        <span class="k">if</span> <span class="n">render</span><span class="p">:</span>
</span><span id="L-266"><a href="#-266"><span class="linenos">266</span></a>            <span class="n">mlab</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">offscreen</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-267"><a href="#-267"><span class="linenos">267</span></a>            <span class="n">fig</span> <span class="o">=</span> <span class="n">OpticalChain</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
</span><span id="L-268"><a href="#-268"><span class="linenos">268</span></a>            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;OpticalChain_&quot;</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">-%Hh%M&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span>
</span><span id="L-269"><a href="#-269"><span class="linenos">269</span></a>            <span class="n">mlab</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">magnification</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="L-270"><a href="#-270"><span class="linenos">270</span></a>            <span class="n">mlab</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">offscreen</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-271"><a href="#-271"><span class="linenos">271</span></a>
</span><span id="L-272"><a href="#-272"><span class="linenos">272</span></a>        <span class="k">return</span> <span class="n">OpticalChain</span>
</span><span id="L-273"><a href="#-273"><span class="linenos">273</span></a>
</span><span id="L-274"><a href="#-274"><span class="linenos">274</span></a>
</span><span id="L-275"><a href="#-275"><span class="linenos">275</span></a><span class="c1"># %%</span>
</span><span id="L-276"><a href="#-276"><span class="linenos">276</span></a><span class="k">def</span> <span class="nf">RayTracingCalculation</span><span class="p">(</span>
</span><span id="L-277"><a href="#-277"><span class="linenos">277</span></a>    <span class="n">source_rays</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">mray</span><span class="o">.</span><span class="n">Ray</span><span class="p">],</span> <span class="n">optical_elements</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">moe</span><span class="o">.</span><span class="n">OpticalElement</span><span class="p">]</span>
</span><span id="L-278"><a href="#-278"><span class="linenos">278</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">mray</span><span class="o">.</span><span class="n">Ray</span><span class="p">]]:</span>
</span><span id="L-279"><a href="#-279"><span class="linenos">279</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-280"><a href="#-280"><span class="linenos">280</span></a><span class="sd">    The actual ray-tracing calculation, starting from the list of &#39;source_rays&#39;,</span>
</span><span id="L-281"><a href="#-281"><span class="linenos">281</span></a><span class="sd">    and propagating them from one optical element to the next in the order of the</span>
</span><span id="L-282"><a href="#-282"><span class="linenos">282</span></a><span class="sd">    items of the list &#39;optical_elements&#39;.</span>
</span><span id="L-283"><a href="#-283"><span class="linenos">283</span></a>
</span><span id="L-284"><a href="#-284"><span class="linenos">284</span></a>
</span><span id="L-285"><a href="#-285"><span class="linenos">285</span></a><span class="sd">    Parameters</span>
</span><span id="L-286"><a href="#-286"><span class="linenos">286</span></a><span class="sd">    ----------</span>
</span><span id="L-287"><a href="#-287"><span class="linenos">287</span></a><span class="sd">        source_rays : list[Ray-objects]</span>
</span><span id="L-288"><a href="#-288"><span class="linenos">288</span></a><span class="sd">            List of input rays.</span>
</span><span id="L-289"><a href="#-289"><span class="linenos">289</span></a>
</span><span id="L-290"><a href="#-290"><span class="linenos">290</span></a><span class="sd">        optical_elements : list[OpticalElement-objects]</span>
</span><span id="L-291"><a href="#-291"><span class="linenos">291</span></a>
</span><span id="L-292"><a href="#-292"><span class="linenos">292</span></a>
</span><span id="L-293"><a href="#-293"><span class="linenos">293</span></a><span class="sd">    Returns</span>
</span><span id="L-294"><a href="#-294"><span class="linenos">294</span></a><span class="sd">    -------</span>
</span><span id="L-295"><a href="#-295"><span class="linenos">295</span></a><span class="sd">        output_rays : list[list[Ray-objects]]</span>
</span><span id="L-296"><a href="#-296"><span class="linenos">296</span></a><span class="sd">            List of lists of rays, each item corresponding to the ray-bundle *after*</span>
</span><span id="L-297"><a href="#-297"><span class="linenos">297</span></a><span class="sd">            the item with the same index in the &#39;optical_elements&#39;-list.</span>
</span><span id="L-298"><a href="#-298"><span class="linenos">298</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-299"><a href="#-299"><span class="linenos">299</span></a>    <span class="n">ez</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</span><span id="L-300"><a href="#-300"><span class="linenos">300</span></a>    <span class="n">ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
</span><span id="L-301"><a href="#-301"><span class="linenos">301</span></a>    <span class="n">output_rays</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-302"><a href="#-302"><span class="linenos">302</span></a>
</span><span id="L-303"><a href="#-303"><span class="linenos">303</span></a>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">optical_elements</span><span class="p">)):</span>
</span><span id="L-304"><a href="#-304"><span class="linenos">304</span></a>        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-305"><a href="#-305"><span class="linenos">305</span></a>            <span class="n">RayList</span> <span class="o">=</span> <span class="n">source_rays</span>
</span><span id="L-306"><a href="#-306"><span class="linenos">306</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-307"><a href="#-307"><span class="linenos">307</span></a>            <span class="n">RayList</span> <span class="o">=</span> <span class="n">output_rays</span><span class="p">[</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-308"><a href="#-308"><span class="linenos">308</span></a>
</span><span id="L-309"><a href="#-309"><span class="linenos">309</span></a>        <span class="c1"># Mirror = optical_elements[k].type</span>
</span><span id="L-310"><a href="#-310"><span class="linenos">310</span></a>        <span class="n">Position</span> <span class="o">=</span> <span class="n">optical_elements</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">position</span>
</span><span id="L-311"><a href="#-311"><span class="linenos">311</span></a>        <span class="n">n</span> <span class="o">=</span> <span class="n">optical_elements</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span>
</span><span id="L-312"><a href="#-312"><span class="linenos">312</span></a>        <span class="n">m</span> <span class="o">=</span> <span class="n">optical_elements</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">majoraxis</span>
</span><span id="L-313"><a href="#-313"><span class="linenos">313</span></a>
</span><span id="L-314"><a href="#-314"><span class="linenos">314</span></a>        <span class="c1"># transform rays into mirror coordinate system</span>
</span><span id="L-315"><a href="#-315"><span class="linenos">315</span></a>        <span class="n">RayList</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">TranslationRayList</span><span class="p">(</span><span class="n">RayList</span><span class="p">,</span> <span class="o">-</span><span class="n">Position</span><span class="p">)</span>
</span><span id="L-316"><a href="#-316"><span class="linenos">316</span></a>        <span class="n">RayList</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">RotationRayList</span><span class="p">(</span><span class="n">RayList</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">ez</span><span class="p">)</span>
</span><span id="L-317"><a href="#-317"><span class="linenos">317</span></a>        <span class="c1"># FIRST rotate m in the same way as you just did the ray list,</span>
</span><span id="L-318"><a href="#-318"><span class="linenos">318</span></a>        <span class="c1"># THEN rotate the rays again to match the NEW m with the x-axis !</span>
</span><span id="L-319"><a href="#-319"><span class="linenos">319</span></a>        <span class="n">mPrime</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">RotationPoint</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">ez</span><span class="p">)</span>
</span><span id="L-320"><a href="#-320"><span class="linenos">320</span></a>        <span class="n">RayList</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">RotationRayList</span><span class="p">(</span><span class="n">RayList</span><span class="p">,</span> <span class="n">mPrime</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>
</span><span id="L-321"><a href="#-321"><span class="linenos">321</span></a>        <span class="n">RayList</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">TranslationRayList</span><span class="p">(</span><span class="n">RayList</span><span class="p">,</span> <span class="n">optical_elements</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">get_centre</span><span class="p">())</span>
</span><span id="L-322"><a href="#-322"><span class="linenos">322</span></a>
</span><span id="L-323"><a href="#-323"><span class="linenos">323</span></a>        <span class="c1"># optical element acts on the rays:</span>
</span><span id="L-324"><a href="#-324"><span class="linenos">324</span></a>        <span class="k">if</span> <span class="s2">&quot;Mirror&quot;</span> <span class="ow">in</span> <span class="n">optical_elements</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>
</span><span id="L-325"><a href="#-325"><span class="linenos">325</span></a>            <span class="n">RayList</span> <span class="o">=</span> <span class="n">mmirror</span><span class="o">.</span><span class="n">ReflectionMirrorRayList</span><span class="p">(</span><span class="n">optical_elements</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">RayList</span><span class="p">)</span>
</span><span id="L-326"><a href="#-326"><span class="linenos">326</span></a>        <span class="k">elif</span> <span class="n">optical_elements</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Mask&quot;</span><span class="p">:</span>
</span><span id="L-327"><a href="#-327"><span class="linenos">327</span></a>            <span class="n">RayList</span> <span class="o">=</span> <span class="n">mmask</span><span class="o">.</span><span class="n">TransmitMaskRayList</span><span class="p">(</span><span class="n">optical_elements</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">RayList</span><span class="p">)</span>
</span><span id="L-328"><a href="#-328"><span class="linenos">328</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-329"><a href="#-329"><span class="linenos">329</span></a>            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s2">&quot;I don`t recognize the type of optical element &quot;</span> <span class="o">+</span> <span class="n">optical_elements</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">type</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>
</span><span id="L-330"><a href="#-330"><span class="linenos">330</span></a>
</span><span id="L-331"><a href="#-331"><span class="linenos">331</span></a>        <span class="c1"># transform new rays back into &quot;lab frame&quot;</span>
</span><span id="L-332"><a href="#-332"><span class="linenos">332</span></a>        <span class="n">RayList</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">TranslationRayList</span><span class="p">(</span><span class="n">RayList</span><span class="p">,</span> <span class="o">-</span><span class="n">optical_elements</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">get_centre</span><span class="p">())</span>
</span><span id="L-333"><a href="#-333"><span class="linenos">333</span></a>        <span class="n">RayList</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">RotationRayList</span><span class="p">(</span><span class="n">RayList</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">mPrime</span><span class="p">)</span>
</span><span id="L-334"><a href="#-334"><span class="linenos">334</span></a>        <span class="n">RayList</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">RotationRayList</span><span class="p">(</span><span class="n">RayList</span><span class="p">,</span> <span class="n">ez</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</span><span id="L-335"><a href="#-335"><span class="linenos">335</span></a>        <span class="n">RayList</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">TranslationRayList</span><span class="p">(</span><span class="n">RayList</span><span class="p">,</span> <span class="n">Position</span><span class="p">)</span>
</span><span id="L-336"><a href="#-336"><span class="linenos">336</span></a>
</span><span id="L-337"><a href="#-337"><span class="linenos">337</span></a>        <span class="n">output_rays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RayList</span><span class="p">)</span>
</span><span id="L-338"><a href="#-338"><span class="linenos">338</span></a>
</span><span id="L-339"><a href="#-339"><span class="linenos">339</span></a>    <span class="k">return</span> <span class="n">output_rays</span>
</span><span id="L-340"><a href="#-340"><span class="linenos">340</span></a>
</span><span id="L-341"><a href="#-341"><span class="linenos">341</span></a>
</span><span id="L-342"><a href="#-342"><span class="linenos">342</span></a><span class="c1"># %%</span>
</span><span id="L-343"><a href="#-343"><span class="linenos">343</span></a><span class="k">def</span> <span class="nf">_FindOptimalDistanceBIS</span><span class="p">(</span><span class="n">movingDetector</span><span class="p">,</span> <span class="n">Amplitude</span><span class="p">,</span> <span class="n">Step</span><span class="p">,</span> <span class="n">RayList</span><span class="p">,</span> <span class="n">OptFor</span><span class="p">,</span> <span class="n">IntensityWeighted</span><span class="p">):</span>
</span><span id="L-344"><a href="#-344"><span class="linenos">344</span></a>    <span class="n">ListSizeSpot</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-345"><a href="#-345"><span class="linenos">345</span></a>    <span class="n">ListDuration</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-346"><a href="#-346"><span class="linenos">346</span></a>    <span class="n">ListFitness</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-347"><a href="#-347"><span class="linenos">347</span></a>    <span class="k">if</span> <span class="n">IntensityWeighted</span><span class="p">:</span>
</span><span id="L-348"><a href="#-348"><span class="linenos">348</span></a>        <span class="n">Weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">intensity</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">RayList</span><span class="p">]</span>
</span><span id="L-349"><a href="#-349"><span class="linenos">349</span></a>
</span><span id="L-350"><a href="#-350"><span class="linenos">350</span></a>    <span class="n">movingDetector</span><span class="o">.</span><span class="n">shiftByDistance</span><span class="p">(</span><span class="o">-</span><span class="n">Amplitude</span><span class="p">)</span>
</span><span id="L-351"><a href="#-351"><span class="linenos">351</span></a>    <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">Amplitude</span> <span class="o">/</span> <span class="n">Step</span><span class="p">)</span>
</span><span id="L-352"><a href="#-352"><span class="linenos">352</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span><span id="L-353"><a href="#-353"><span class="linenos">353</span></a>        <span class="n">ListPointDetector2DCentre</span> <span class="o">=</span> <span class="n">movingDetector</span><span class="o">.</span><span class="n">get_PointList2DCentre</span><span class="p">(</span><span class="n">RayList</span><span class="p">)</span>
</span><span id="L-354"><a href="#-354"><span class="linenos">354</span></a>        <span class="k">if</span> <span class="n">OptFor</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">,</span> <span class="s2">&quot;spotsize&quot;</span><span class="p">]:</span>
</span><span id="L-355"><a href="#-355"><span class="linenos">355</span></a>            <span class="k">if</span> <span class="n">IntensityWeighted</span><span class="p">:</span>
</span><span id="L-356"><a href="#-356"><span class="linenos">356</span></a>                <span class="n">SpotSize</span> <span class="o">=</span> <span class="n">WeightedStandardDeviation</span><span class="p">(</span><span class="n">ListPointDetector2DCentre</span><span class="p">,</span> <span class="n">Weights</span><span class="p">)</span>
</span><span id="L-357"><a href="#-357"><span class="linenos">357</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-358"><a href="#-358"><span class="linenos">358</span></a>                <span class="n">SpotSize</span> <span class="o">=</span> <span class="n">StandardDeviation</span><span class="p">(</span><span class="n">ListPointDetector2DCentre</span><span class="p">)</span>
</span><span id="L-359"><a href="#-359"><span class="linenos">359</span></a>            <span class="n">ListSizeSpot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SpotSize</span><span class="p">)</span>
</span><span id="L-360"><a href="#-360"><span class="linenos">360</span></a>
</span><span id="L-361"><a href="#-361"><span class="linenos">361</span></a>        <span class="k">if</span> <span class="n">OptFor</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">,</span> <span class="s2">&quot;duration&quot;</span><span class="p">]:</span>
</span><span id="L-362"><a href="#-362"><span class="linenos">362</span></a>            <span class="n">DelayList</span> <span class="o">=</span> <span class="n">movingDetector</span><span class="o">.</span><span class="n">get_Delays</span><span class="p">(</span><span class="n">RayList</span><span class="p">)</span>
</span><span id="L-363"><a href="#-363"><span class="linenos">363</span></a>            <span class="k">if</span> <span class="n">IntensityWeighted</span><span class="p">:</span>
</span><span id="L-364"><a href="#-364"><span class="linenos">364</span></a>                <span class="n">Duration</span> <span class="o">=</span> <span class="n">WeightedStandardDeviation</span><span class="p">(</span><span class="n">DelayList</span><span class="p">,</span> <span class="n">Weights</span><span class="p">)</span>
</span><span id="L-365"><a href="#-365"><span class="linenos">365</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-366"><a href="#-366"><span class="linenos">366</span></a>                <span class="n">Duration</span> <span class="o">=</span> <span class="n">StandardDeviation</span><span class="p">(</span><span class="n">DelayList</span><span class="p">)</span>
</span><span id="L-367"><a href="#-367"><span class="linenos">367</span></a>            <span class="n">ListDuration</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Duration</span><span class="p">)</span>
</span><span id="L-368"><a href="#-368"><span class="linenos">368</span></a>
</span><span id="L-369"><a href="#-369"><span class="linenos">369</span></a>        <span class="k">if</span> <span class="n">OptFor</span> <span class="o">==</span> <span class="s2">&quot;intensity&quot;</span><span class="p">:</span>
</span><span id="L-370"><a href="#-370"><span class="linenos">370</span></a>            <span class="n">Fitness</span> <span class="o">=</span> <span class="n">SpotSize</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">Duration</span>
</span><span id="L-371"><a href="#-371"><span class="linenos">371</span></a>        <span class="k">elif</span> <span class="n">OptFor</span> <span class="o">==</span> <span class="s2">&quot;duration&quot;</span><span class="p">:</span>
</span><span id="L-372"><a href="#-372"><span class="linenos">372</span></a>            <span class="n">Fitness</span> <span class="o">=</span> <span class="n">Duration</span>
</span><span id="L-373"><a href="#-373"><span class="linenos">373</span></a>        <span class="k">elif</span> <span class="n">OptFor</span> <span class="o">==</span> <span class="s2">&quot;spotsize&quot;</span><span class="p">:</span>
</span><span id="L-374"><a href="#-374"><span class="linenos">374</span></a>            <span class="n">Fitness</span> <span class="o">=</span> <span class="n">SpotSize</span>
</span><span id="L-375"><a href="#-375"><span class="linenos">375</span></a>        <span class="n">ListFitness</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Fitness</span><span class="p">)</span>
</span><span id="L-376"><a href="#-376"><span class="linenos">376</span></a>
</span><span id="L-377"><a href="#-377"><span class="linenos">377</span></a>        <span class="n">movingDetector</span><span class="o">.</span><span class="n">shiftByDistance</span><span class="p">(</span><span class="n">Step</span><span class="p">)</span>
</span><span id="L-378"><a href="#-378"><span class="linenos">378</span></a>
</span><span id="L-379"><a href="#-379"><span class="linenos">379</span></a>    <span class="n">FitnessMin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ListFitness</span><span class="p">)</span>
</span><span id="L-380"><a href="#-380"><span class="linenos">380</span></a>    <span class="n">ind</span> <span class="o">=</span> <span class="n">ListFitness</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">FitnessMin</span><span class="p">)</span>
</span><span id="L-381"><a href="#-381"><span class="linenos">381</span></a>    <span class="k">if</span> <span class="n">OptFor</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">,</span> <span class="s2">&quot;spotsize&quot;</span><span class="p">]:</span>
</span><span id="L-382"><a href="#-382"><span class="linenos">382</span></a>        <span class="n">OptSizeSpot</span> <span class="o">=</span> <span class="n">ListSizeSpot</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
</span><span id="L-383"><a href="#-383"><span class="linenos">383</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-384"><a href="#-384"><span class="linenos">384</span></a>        <span class="n">OptSizeSpot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="L-385"><a href="#-385"><span class="linenos">385</span></a>    <span class="k">if</span> <span class="n">OptFor</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">,</span> <span class="s2">&quot;duration&quot;</span><span class="p">]:</span>
</span><span id="L-386"><a href="#-386"><span class="linenos">386</span></a>        <span class="n">OptDuration</span> <span class="o">=</span> <span class="n">ListDuration</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
</span><span id="L-387"><a href="#-387"><span class="linenos">387</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-388"><a href="#-388"><span class="linenos">388</span></a>        <span class="n">OptDuration</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="L-389"><a href="#-389"><span class="linenos">389</span></a>
</span><span id="L-390"><a href="#-390"><span class="linenos">390</span></a>    <span class="n">movingDetector</span><span class="o">.</span><span class="n">shiftByDistance</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">ind</span><span class="p">)</span> <span class="o">*</span> <span class="n">Step</span><span class="p">)</span>
</span><span id="L-391"><a href="#-391"><span class="linenos">391</span></a>
</span><span id="L-392"><a href="#-392"><span class="linenos">392</span></a>    <span class="k">return</span> <span class="n">movingDetector</span><span class="p">,</span> <span class="n">OptSizeSpot</span><span class="p">,</span> <span class="n">OptDuration</span>
</span><span id="L-393"><a href="#-393"><span class="linenos">393</span></a>
</span><span id="L-394"><a href="#-394"><span class="linenos">394</span></a>
</span><span id="L-395"><a href="#-395"><span class="linenos">395</span></a><span class="k">def</span> <span class="nf">FindOptimalDistance</span><span class="p">(</span>
</span><span id="L-396"><a href="#-396"><span class="linenos">396</span></a>    <span class="n">Detector</span><span class="p">,</span>
</span><span id="L-397"><a href="#-397"><span class="linenos">397</span></a>    <span class="n">RayList</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">mray</span><span class="o">.</span><span class="n">Ray</span><span class="p">],</span>
</span><span id="L-398"><a href="#-398"><span class="linenos">398</span></a>    <span class="n">OptFor</span><span class="o">=</span><span class="s2">&quot;intensity&quot;</span><span class="p">,</span>
</span><span id="L-399"><a href="#-399"><span class="linenos">399</span></a>    <span class="n">Amplitude</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-400"><a href="#-400"><span class="linenos">400</span></a>    <span class="n">Precision</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
</span><span id="L-401"><a href="#-401"><span class="linenos">401</span></a>    <span class="n">IntensityWeighted</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-402"><a href="#-402"><span class="linenos">402</span></a>    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-403"><a href="#-403"><span class="linenos">403</span></a><span class="p">):</span>
</span><span id="L-404"><a href="#-404"><span class="linenos">404</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-405"><a href="#-405"><span class="linenos">405</span></a><span class="sd">    Automatically finds the optimal the &#39;Detector&#39;-distance for either</span>
</span><span id="L-406"><a href="#-406"><span class="linenos">406</span></a><span class="sd">    maximum intensity, or minimal spotsize or duration.</span>
</span><span id="L-407"><a href="#-407"><span class="linenos">407</span></a>
</span><span id="L-408"><a href="#-408"><span class="linenos">408</span></a><span class="sd">    Parameters</span>
</span><span id="L-409"><a href="#-409"><span class="linenos">409</span></a><span class="sd">    ----------</span>
</span><span id="L-410"><a href="#-410"><span class="linenos">410</span></a><span class="sd">        Detector : Detector-object</span>
</span><span id="L-411"><a href="#-411"><span class="linenos">411</span></a>
</span><span id="L-412"><a href="#-412"><span class="linenos">412</span></a><span class="sd">        RayList : list[Ray-objects]</span>
</span><span id="L-413"><a href="#-413"><span class="linenos">413</span></a>
</span><span id="L-414"><a href="#-414"><span class="linenos">414</span></a><span class="sd">        OptFor : str, optional</span>
</span><span id="L-415"><a href="#-415"><span class="linenos">415</span></a><span class="sd">            &quot;spotsize&quot;: minimizes the standard-deviation spot size *d* on the detector.</span>
</span><span id="L-416"><a href="#-416"><span class="linenos">416</span></a><span class="sd">            &quot;duration&quot;: minimizes the standard-deviation *tau* of the ray-delays.</span>
</span><span id="L-417"><a href="#-417"><span class="linenos">417</span></a><span class="sd">            &quot;intensity&quot;: Maximizes 1/tau/d^2.</span>
</span><span id="L-418"><a href="#-418"><span class="linenos">418</span></a><span class="sd">            Defaults to &quot;intensity&quot;.</span>
</span><span id="L-419"><a href="#-419"><span class="linenos">419</span></a>
</span><span id="L-420"><a href="#-420"><span class="linenos">420</span></a><span class="sd">        Amplitude : float, optional</span>
</span><span id="L-421"><a href="#-421"><span class="linenos">421</span></a><span class="sd">            The detector-distances within which the optimization is done will be</span>
</span><span id="L-422"><a href="#-422"><span class="linenos">422</span></a><span class="sd">            the distance of &#39;Detector&#39; +/- Amplitude in mm.</span>
</span><span id="L-423"><a href="#-423"><span class="linenos">423</span></a>
</span><span id="L-424"><a href="#-424"><span class="linenos">424</span></a><span class="sd">        Precision : int, optional</span>
</span><span id="L-425"><a href="#-425"><span class="linenos">425</span></a><span class="sd">            Precision-parameter for the search algorithm. For Precision = n,</span>
</span><span id="L-426"><a href="#-426"><span class="linenos">426</span></a><span class="sd">            it will iterate with search amplitudes decreasing until 10^{-n}.</span>
</span><span id="L-427"><a href="#-427"><span class="linenos">427</span></a><span class="sd">            Defaults to 3.</span>
</span><span id="L-428"><a href="#-428"><span class="linenos">428</span></a>
</span><span id="L-429"><a href="#-429"><span class="linenos">429</span></a><span class="sd">        IntensityWeighted : bool, optional</span>
</span><span id="L-430"><a href="#-430"><span class="linenos">430</span></a><span class="sd">            Whether to weigh the calculation of spotsize and/or duration by the ray-intensities.</span>
</span><span id="L-431"><a href="#-431"><span class="linenos">431</span></a><span class="sd">            Defaults to False.</span>
</span><span id="L-432"><a href="#-432"><span class="linenos">432</span></a>
</span><span id="L-433"><a href="#-433"><span class="linenos">433</span></a><span class="sd">        verbose : bool, optional</span>
</span><span id="L-434"><a href="#-434"><span class="linenos">434</span></a><span class="sd">            Whether to print results to the console.</span>
</span><span id="L-435"><a href="#-435"><span class="linenos">435</span></a>
</span><span id="L-436"><a href="#-436"><span class="linenos">436</span></a><span class="sd">    Returns</span>
</span><span id="L-437"><a href="#-437"><span class="linenos">437</span></a><span class="sd">    -------</span>
</span><span id="L-438"><a href="#-438"><span class="linenos">438</span></a><span class="sd">        OptDetector : Detector-object</span>
</span><span id="L-439"><a href="#-439"><span class="linenos">439</span></a><span class="sd">            A new detector-instance with optimized distance.</span>
</span><span id="L-440"><a href="#-440"><span class="linenos">440</span></a>
</span><span id="L-441"><a href="#-441"><span class="linenos">441</span></a><span class="sd">        OptSpotSize : float</span>
</span><span id="L-442"><a href="#-442"><span class="linenos">442</span></a><span class="sd">            Spotsize, calculated as standard deviation in mm of the spot-diagram</span>
</span><span id="L-443"><a href="#-443"><span class="linenos">443</span></a><span class="sd">            on the optimized detector.</span>
</span><span id="L-444"><a href="#-444"><span class="linenos">444</span></a>
</span><span id="L-445"><a href="#-445"><span class="linenos">445</span></a><span class="sd">        OptDuration : float</span>
</span><span id="L-446"><a href="#-446"><span class="linenos">446</span></a><span class="sd">            Duration, calculated as standard deviation in fs of the ray-delays</span>
</span><span id="L-447"><a href="#-447"><span class="linenos">447</span></a><span class="sd">            on the optimized detector.</span>
</span><span id="L-448"><a href="#-448"><span class="linenos">448</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-449"><a href="#-449"><span class="linenos">449</span></a>
</span><span id="L-450"><a href="#-450"><span class="linenos">450</span></a>    <span class="k">if</span> <span class="n">OptFor</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="s2">&quot;duration&quot;</span><span class="p">]:</span>
</span><span id="L-451"><a href="#-451"><span class="linenos">451</span></a>        <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span>
</span><span id="L-452"><a href="#-452"><span class="linenos">452</span></a>            <span class="s2">&quot;I don`t recognize what you want to optimize the detector distance for. OptFor must be either &#39;intensity&#39;, &#39;size&#39; or &#39;duration&#39;.&quot;</span>
</span><span id="L-453"><a href="#-453"><span class="linenos">453</span></a>        <span class="p">)</span>
</span><span id="L-454"><a href="#-454"><span class="linenos">454</span></a>
</span><span id="L-455"><a href="#-455"><span class="linenos">455</span></a>    <span class="n">FirstDistance</span> <span class="o">=</span> <span class="n">Detector</span><span class="o">.</span><span class="n">get_distance</span><span class="p">()</span>
</span><span id="L-456"><a href="#-456"><span class="linenos">456</span></a>    <span class="n">ListPointDetector2DCentre</span> <span class="o">=</span> <span class="n">Detector</span><span class="o">.</span><span class="n">get_PointList2DCentre</span><span class="p">(</span><span class="n">RayList</span><span class="p">)</span>
</span><span id="L-457"><a href="#-457"><span class="linenos">457</span></a>    <span class="n">SizeSpot</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">StandardDeviation</span><span class="p">(</span><span class="n">ListPointDetector2DCentre</span><span class="p">)</span>
</span><span id="L-458"><a href="#-458"><span class="linenos">458</span></a>    <span class="n">NumericalAperture</span> <span class="o">=</span> <span class="n">ReturnNumericalAperture</span><span class="p">(</span><span class="n">RayList</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-459"><a href="#-459"><span class="linenos">459</span></a>    <span class="k">if</span> <span class="n">Amplitude</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-460"><a href="#-460"><span class="linenos">460</span></a>        <span class="n">Amplitude</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">SizeSpot</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">NumericalAperture</span><span class="p">))),</span> <span class="n">FirstDistance</span><span class="p">)</span>
</span><span id="L-461"><a href="#-461"><span class="linenos">461</span></a>    <span class="c1"># Step = Amplitude/10</span>
</span><span id="L-462"><a href="#-462"><span class="linenos">462</span></a>    <span class="n">Step</span> <span class="o">=</span> <span class="n">Amplitude</span> <span class="o">/</span> <span class="mi">5</span>  <span class="c1"># good enough in half the time ;-)</span>
</span><span id="L-463"><a href="#-463"><span class="linenos">463</span></a>
</span><span id="L-464"><a href="#-464"><span class="linenos">464</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-465"><a href="#-465"><span class="linenos">465</span></a>        <span class="nb">print</span><span class="p">(</span>
</span><span id="L-466"><a href="#-466"><span class="linenos">466</span></a>            <span class="sa">f</span><span class="s2">&quot;Searching optimal detector position for *</span><span class="si">{</span><span class="n">OptFor</span><span class="si">}</span><span class="s2">* within [</span><span class="si">{</span><span class="n">FirstDistance</span><span class="o">-</span><span class="n">Amplitude</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">FirstDistance</span><span class="o">+</span><span class="n">Amplitude</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">] mm...&quot;</span><span class="p">,</span>
</span><span id="L-467"><a href="#-467"><span class="linenos">467</span></a>            <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-468"><a href="#-468"><span class="linenos">468</span></a>            <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-469"><a href="#-469"><span class="linenos">469</span></a>        <span class="p">)</span>
</span><span id="L-470"><a href="#-470"><span class="linenos">470</span></a>    <span class="n">movingDetector</span> <span class="o">=</span> <span class="n">Detector</span><span class="o">.</span><span class="n">copy_detector</span><span class="p">()</span>
</span><span id="L-471"><a href="#-471"><span class="linenos">471</span></a>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Precision</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="L-472"><a href="#-472"><span class="linenos">472</span></a>        <span class="n">movingDetector</span><span class="p">,</span> <span class="n">OptSpotSize</span><span class="p">,</span> <span class="n">OptDuration</span> <span class="o">=</span> <span class="n">_FindOptimalDistanceBIS</span><span class="p">(</span>
</span><span id="L-473"><a href="#-473"><span class="linenos">473</span></a>            <span class="n">movingDetector</span><span class="p">,</span> <span class="n">Amplitude</span> <span class="o">*</span> <span class="mf">0.1</span><span class="o">**</span><span class="n">k</span><span class="p">,</span> <span class="n">Step</span> <span class="o">*</span> <span class="mf">0.1</span><span class="o">**</span><span class="n">k</span><span class="p">,</span> <span class="n">RayList</span><span class="p">,</span> <span class="n">OptFor</span><span class="p">,</span> <span class="n">IntensityWeighted</span>
</span><span id="L-474"><a href="#-474"><span class="linenos">474</span></a>        <span class="p">)</span>
</span><span id="L-475"><a href="#-475"><span class="linenos">475</span></a>
</span><span id="L-476"><a href="#-476"><span class="linenos">476</span></a>    <span class="k">if</span> <span class="p">(</span>
</span><span id="L-477"><a href="#-477"><span class="linenos">477</span></a>        <span class="ow">not</span> <span class="n">FirstDistance</span> <span class="o">-</span> <span class="n">Amplitude</span> <span class="o">+</span> <span class="mi">10</span><span class="o">**-</span><span class="n">Precision</span>
</span><span id="L-478"><a href="#-478"><span class="linenos">478</span></a>        <span class="o">&lt;</span> <span class="n">movingDetector</span><span class="o">.</span><span class="n">get_distance</span><span class="p">()</span>
</span><span id="L-479"><a href="#-479"><span class="linenos">479</span></a>        <span class="o">&lt;</span> <span class="n">FirstDistance</span> <span class="o">+</span> <span class="n">Amplitude</span> <span class="o">-</span> <span class="mi">10</span><span class="o">**-</span><span class="n">Precision</span>
</span><span id="L-480"><a href="#-480"><span class="linenos">480</span></a>    <span class="p">):</span>
</span><span id="L-481"><a href="#-481"><span class="linenos">481</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;There`s no minimum-size/duration focus in the searched range.&quot;</span><span class="p">)</span>
</span><span id="L-482"><a href="#-482"><span class="linenos">482</span></a>
</span><span id="L-483"><a href="#-483"><span class="linenos">483</span></a>    <span class="nb">print</span><span class="p">(</span>
</span><span id="L-484"><a href="#-484"><span class="linenos">484</span></a>        <span class="s2">&quot;</span><span class="se">\r\033</span><span class="s2">[K&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-485"><a href="#-485"><span class="linenos">485</span></a>    <span class="p">)</span>  <span class="c1"># move to beginning of the line with \r and then delete the whole line with \033[K</span>
</span><span id="L-486"><a href="#-486"><span class="linenos">486</span></a>    <span class="k">return</span> <span class="n">movingDetector</span><span class="p">,</span> <span class="n">OptSpotSize</span><span class="p">,</span> <span class="n">OptDuration</span>
</span><span id="L-487"><a href="#-487"><span class="linenos">487</span></a>
</span><span id="L-488"><a href="#-488"><span class="linenos">488</span></a>
</span><span id="L-489"><a href="#-489"><span class="linenos">489</span></a><span class="c1"># %%</span>
</span><span id="L-490"><a href="#-490"><span class="linenos">490</span></a><span class="k">def</span> <span class="nf">FindCentralRay</span><span class="p">(</span><span class="n">RayList</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">mray</span><span class="o">.</span><span class="n">Ray</span><span class="p">]):</span>
</span><span id="L-491"><a href="#-491"><span class="linenos">491</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-492"><a href="#-492"><span class="linenos">492</span></a><span class="sd">    Out of a the list of Ray-objects, RayList, return the one Ray-object whose Ray.number is 0.</span>
</span><span id="L-493"><a href="#-493"><span class="linenos">493</span></a><span class="sd">    This is the ray which the functions in ModuleSource set up as the central ray, i.e.</span>
</span><span id="L-494"><a href="#-494"><span class="linenos">494</span></a><span class="sd">    the one initially launched on the &quot;optical axis&quot;.</span>
</span><span id="L-495"><a href="#-495"><span class="linenos">495</span></a><span class="sd">    Should there be several rays whose number-attribute =0 (which is a bad situation), only</span>
</span><span id="L-496"><a href="#-496"><span class="linenos">496</span></a><span class="sd">    the first one encountered in the list is returned.</span>
</span><span id="L-497"><a href="#-497"><span class="linenos">497</span></a>
</span><span id="L-498"><a href="#-498"><span class="linenos">498</span></a><span class="sd">    Parameters</span>
</span><span id="L-499"><a href="#-499"><span class="linenos">499</span></a><span class="sd">    ----------</span>
</span><span id="L-500"><a href="#-500"><span class="linenos">500</span></a><span class="sd">        RayList : list of Ray-objects</span>
</span><span id="L-501"><a href="#-501"><span class="linenos">501</span></a>
</span><span id="L-502"><a href="#-502"><span class="linenos">502</span></a><span class="sd">    Returns</span>
</span><span id="L-503"><a href="#-503"><span class="linenos">503</span></a><span class="sd">    -------</span>
</span><span id="L-504"><a href="#-504"><span class="linenos">504</span></a><span class="sd">        CentralRay : Ray-object</span>
</span><span id="L-505"><a href="#-505"><span class="linenos">505</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-506"><a href="#-506"><span class="linenos">506</span></a>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">RayList</span><span class="p">:</span>
</span><span id="L-507"><a href="#-507"><span class="linenos">507</span></a>        <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">number</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-508"><a href="#-508"><span class="linenos">508</span></a>            <span class="k">return</span> <span class="n">k</span>
</span><span id="L-509"><a href="#-509"><span class="linenos">509</span></a>    <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-510"><a href="#-510"><span class="linenos">510</span></a>
</span><span id="L-511"><a href="#-511"><span class="linenos">511</span></a>
</span><span id="L-512"><a href="#-512"><span class="linenos">512</span></a><span class="k">def</span> <span class="nf">StandardDeviation</span><span class="p">(</span><span class="n">List</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-513"><a href="#-513"><span class="linenos">513</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-514"><a href="#-514"><span class="linenos">514</span></a><span class="sd">    Return the standard deviation of elements in the supplied list.</span>
</span><span id="L-515"><a href="#-515"><span class="linenos">515</span></a><span class="sd">    If the elements are floats, it&#39;s simply the root-mean-square over the numbers.</span>
</span><span id="L-516"><a href="#-516"><span class="linenos">516</span></a><span class="sd">    If the elements are vectors (represented as numpy-arrays), the root-mean-square</span>
</span><span id="L-517"><a href="#-517"><span class="linenos">517</span></a><span class="sd">    of the distance of the points from their mean is calculated.</span>
</span><span id="L-518"><a href="#-518"><span class="linenos">518</span></a>
</span><span id="L-519"><a href="#-519"><span class="linenos">519</span></a><span class="sd">    Parameters</span>
</span><span id="L-520"><a href="#-520"><span class="linenos">520</span></a><span class="sd">    ----------</span>
</span><span id="L-521"><a href="#-521"><span class="linenos">521</span></a><span class="sd">        List : list of floats or of np.ndarray</span>
</span><span id="L-522"><a href="#-522"><span class="linenos">522</span></a><span class="sd">            Numbers (in ART, typically delays)</span>
</span><span id="L-523"><a href="#-523"><span class="linenos">523</span></a><span class="sd">            or 2D or 3D vectors (in ART typically space coordinates)</span>
</span><span id="L-524"><a href="#-524"><span class="linenos">524</span></a>
</span><span id="L-525"><a href="#-525"><span class="linenos">525</span></a><span class="sd">    Returns</span>
</span><span id="L-526"><a href="#-526"><span class="linenos">526</span></a><span class="sd">    -------</span>
</span><span id="L-527"><a href="#-527"><span class="linenos">527</span></a><span class="sd">        Std : float</span>
</span><span id="L-528"><a href="#-528"><span class="linenos">528</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-529"><a href="#-529"><span class="linenos">529</span></a>    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
</span><span id="L-530"><a href="#-530"><span class="linenos">530</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">List</span><span class="p">)</span>
</span><span id="L-531"><a href="#-531"><span class="linenos">531</span></a>    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-532"><a href="#-532"><span class="linenos">532</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
</span><span id="L-533"><a href="#-533"><span class="linenos">533</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-534"><a href="#-534"><span class="linenos">534</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;StandardDeviation expects a list of floats or numpy-arrays as input, but got something else.&quot;</span><span class="p">)</span>
</span><span id="L-535"><a href="#-535"><span class="linenos">535</span></a>
</span><span id="L-536"><a href="#-536"><span class="linenos">536</span></a>
</span><span id="L-537"><a href="#-537"><span class="linenos">537</span></a><span class="k">def</span> <span class="nf">WeightedStandardDeviation</span><span class="p">(</span><span class="n">List</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">Weights</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-538"><a href="#-538"><span class="linenos">538</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-539"><a href="#-539"><span class="linenos">539</span></a><span class="sd">    Return the weighted standard deviation of elements in the supplied list.</span>
</span><span id="L-540"><a href="#-540"><span class="linenos">540</span></a><span class="sd">    If the elements are floats, it&#39;s simply the root-mean-square over the weighted numbers.</span>
</span><span id="L-541"><a href="#-541"><span class="linenos">541</span></a><span class="sd">    If the elements are vectors (represented as numpy-arrays), the root-mean-square</span>
</span><span id="L-542"><a href="#-542"><span class="linenos">542</span></a><span class="sd">    of the weighted distances of the points from their mean is calculated.</span>
</span><span id="L-543"><a href="#-543"><span class="linenos">543</span></a>
</span><span id="L-544"><a href="#-544"><span class="linenos">544</span></a><span class="sd">    Parameters</span>
</span><span id="L-545"><a href="#-545"><span class="linenos">545</span></a><span class="sd">    ----------</span>
</span><span id="L-546"><a href="#-546"><span class="linenos">546</span></a><span class="sd">        List : list of floats or of np.ndarray</span>
</span><span id="L-547"><a href="#-547"><span class="linenos">547</span></a><span class="sd">            Numbers (in ART, typically delays)</span>
</span><span id="L-548"><a href="#-548"><span class="linenos">548</span></a><span class="sd">            or 2D or 3D vectors (in ART typically space coordinates)</span>
</span><span id="L-549"><a href="#-549"><span class="linenos">549</span></a>
</span><span id="L-550"><a href="#-550"><span class="linenos">550</span></a><span class="sd">        Weights : list of floats, same length as List</span>
</span><span id="L-551"><a href="#-551"><span class="linenos">551</span></a><span class="sd">            Parameters such as Ray.intensity to be used as weights</span>
</span><span id="L-552"><a href="#-552"><span class="linenos">552</span></a>
</span><span id="L-553"><a href="#-553"><span class="linenos">553</span></a><span class="sd">    Returns</span>
</span><span id="L-554"><a href="#-554"><span class="linenos">554</span></a><span class="sd">    -------</span>
</span><span id="L-555"><a href="#-555"><span class="linenos">555</span></a><span class="sd">        Std : float</span>
</span><span id="L-556"><a href="#-556"><span class="linenos">556</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-557"><a href="#-557"><span class="linenos">557</span></a>    <span class="n">average</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">Weights</span><span class="p">,</span> <span class="n">returned</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-558"><a href="#-558"><span class="linenos">558</span></a>    <span class="n">variance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">List</span> <span class="o">-</span> <span class="n">average</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">Weights</span><span class="p">,</span> <span class="n">returned</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-559"><a href="#-559"><span class="linenos">559</span></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
</span><span id="L-560"><a href="#-560"><span class="linenos">560</span></a>
</span><span id="L-561"><a href="#-561"><span class="linenos">561</span></a>
</span><span id="L-562"><a href="#-562"><span class="linenos">562</span></a><span class="c1"># %%</span>
</span><span id="L-563"><a href="#-563"><span class="linenos">563</span></a><span class="k">def</span> <span class="nf">ReturnNumericalAperture</span><span class="p">(</span><span class="n">RayList</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">mray</span><span class="o">.</span><span class="n">Ray</span><span class="p">],</span> <span class="n">RefractiveIndex</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-564"><a href="#-564"><span class="linenos">564</span></a>    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-565"><a href="#-565"><span class="linenos">565</span></a><span class="sd">    Returns the numerical aperture associated with the supplied ray-bundle &#39;Raylist&#39;.</span>
</span><span id="L-566"><a href="#-566"><span class="linenos">566</span></a><span class="sd">    This is $n\sin\theta$, where $\theta$ is the maximum angle between any of the rays and the central ray,</span>
</span><span id="L-567"><a href="#-567"><span class="linenos">567</span></a><span class="sd">    and $n$ is the refractive index of the propagation medium.</span>
</span><span id="L-568"><a href="#-568"><span class="linenos">568</span></a>
</span><span id="L-569"><a href="#-569"><span class="linenos">569</span></a><span class="sd">    Parameters</span>
</span><span id="L-570"><a href="#-570"><span class="linenos">570</span></a><span class="sd">    ----------</span>
</span><span id="L-571"><a href="#-571"><span class="linenos">571</span></a><span class="sd">        RayList : list of Ray-object</span>
</span><span id="L-572"><a href="#-572"><span class="linenos">572</span></a><span class="sd">            The ray-bundle of which to determine the NA.</span>
</span><span id="L-573"><a href="#-573"><span class="linenos">573</span></a>
</span><span id="L-574"><a href="#-574"><span class="linenos">574</span></a><span class="sd">        RefractiveIndex : float, optional</span>
</span><span id="L-575"><a href="#-575"><span class="linenos">575</span></a><span class="sd">            Refractive index of the propagation medium, defaults to =1.</span>
</span><span id="L-576"><a href="#-576"><span class="linenos">576</span></a>
</span><span id="L-577"><a href="#-577"><span class="linenos">577</span></a><span class="sd">    Returns</span>
</span><span id="L-578"><a href="#-578"><span class="linenos">578</span></a><span class="sd">    -------</span>
</span><span id="L-579"><a href="#-579"><span class="linenos">579</span></a><span class="sd">        NA : float</span>
</span><span id="L-580"><a href="#-580"><span class="linenos">580</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-581"><a href="#-581"><span class="linenos">581</span></a>    <span class="n">CentralRay</span> <span class="o">=</span> <span class="n">FindCentralRay</span><span class="p">(</span><span class="n">RayList</span><span class="p">)</span>
</span><span id="L-582"><a href="#-582"><span class="linenos">582</span></a>    <span class="k">if</span> <span class="n">CentralRay</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-583"><a href="#-583"><span class="linenos">583</span></a>        <span class="n">CentralVector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
</span><span id="L-584"><a href="#-584"><span class="linenos">584</span></a>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">RayList</span><span class="p">:</span>
</span><span id="L-585"><a href="#-585"><span class="linenos">585</span></a>            <span class="n">CentralVector</span> <span class="o">=</span> <span class="n">CentralVector</span> <span class="o">+</span> <span class="n">k</span><span class="o">.</span><span class="n">vector</span>
</span><span id="L-586"><a href="#-586"><span class="linenos">586</span></a>        <span class="n">CentralVector</span> <span class="o">=</span> <span class="n">CentralVector</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">RayList</span><span class="p">)</span>
</span><span id="L-587"><a href="#-587"><span class="linenos">587</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-588"><a href="#-588"><span class="linenos">588</span></a>        <span class="n">CentralVector</span> <span class="o">=</span> <span class="n">CentralRay</span><span class="o">.</span><span class="n">vector</span>
</span><span id="L-589"><a href="#-589"><span class="linenos">589</span></a>    <span class="n">ListAngleAperture</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-590"><a href="#-590"><span class="linenos">590</span></a>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">RayList</span><span class="p">:</span>
</span><span id="L-591"><a href="#-591"><span class="linenos">591</span></a>        <span class="n">ListAngleAperture</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mgeo</span><span class="o">.</span><span class="n">AngleBetweenTwoVectors</span><span class="p">(</span><span class="n">CentralVector</span><span class="p">,</span> <span class="n">k</span><span class="o">.</span><span class="n">vector</span><span class="p">))</span>
</span><span id="L-592"><a href="#-592"><span class="linenos">592</span></a>
</span><span id="L-593"><a href="#-593"><span class="linenos">593</span></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">ListAngleAperture</span><span class="p">))</span> <span class="o">*</span> <span class="n">RefractiveIndex</span>
</span><span id="L-594"><a href="#-594"><span class="linenos">594</span></a>
</span><span id="L-595"><a href="#-595"><span class="linenos">595</span></a>
</span><span id="L-596"><a href="#-596"><span class="linenos">596</span></a><span class="c1"># %%</span>
</span><span id="L-597"><a href="#-597"><span class="linenos">597</span></a><span class="k">def</span> <span class="nf">ReturnAiryRadius</span><span class="p">(</span><span class="n">Wavelength</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">NumericalAperture</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-598"><a href="#-598"><span class="linenos">598</span></a>    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-599"><a href="#-599"><span class="linenos">599</span></a><span class="sd">    Returns the radius of the Airy disk: $r = 1.22 \frac\{\lambda\}\{NA\}$,</span>
</span><span id="L-600"><a href="#-600"><span class="linenos">600</span></a><span class="sd">    i.e. the diffraction-limited radius of the focal spot corresponding to a given</span>
</span><span id="L-601"><a href="#-601"><span class="linenos">601</span></a><span class="sd">    numerical aperture $NA$ and a light wavelength $\lambda$.</span>
</span><span id="L-602"><a href="#-602"><span class="linenos">602</span></a>
</span><span id="L-603"><a href="#-603"><span class="linenos">603</span></a><span class="sd">    For very small $NA&lt;10^\{-3\}$, diffraction effects becomes negligible and the Airy Radius becomes meaningless,</span>
</span><span id="L-604"><a href="#-604"><span class="linenos">604</span></a><span class="sd">    so in that case, a radius of 0 is returned.</span>
</span><span id="L-605"><a href="#-605"><span class="linenos">605</span></a>
</span><span id="L-606"><a href="#-606"><span class="linenos">606</span></a><span class="sd">    Parameters</span>
</span><span id="L-607"><a href="#-607"><span class="linenos">607</span></a><span class="sd">    ----------</span>
</span><span id="L-608"><a href="#-608"><span class="linenos">608</span></a><span class="sd">        Wavelength : float</span>
</span><span id="L-609"><a href="#-609"><span class="linenos">609</span></a><span class="sd">            Light wavelength in mm.</span>
</span><span id="L-610"><a href="#-610"><span class="linenos">610</span></a>
</span><span id="L-611"><a href="#-611"><span class="linenos">611</span></a><span class="sd">        NumericalAperture : float</span>
</span><span id="L-612"><a href="#-612"><span class="linenos">612</span></a>
</span><span id="L-613"><a href="#-613"><span class="linenos">613</span></a><span class="sd">    Returns</span>
</span><span id="L-614"><a href="#-614"><span class="linenos">614</span></a><span class="sd">    -------</span>
</span><span id="L-615"><a href="#-615"><span class="linenos">615</span></a><span class="sd">        AiryRadius : float</span>
</span><span id="L-616"><a href="#-616"><span class="linenos">616</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-617"><a href="#-617"><span class="linenos">617</span></a>    <span class="k">if</span> <span class="n">NumericalAperture</span> <span class="o">&gt;</span> <span class="mf">1e-3</span> <span class="ow">and</span> <span class="n">Wavelength</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-618"><a href="#-618"><span class="linenos">618</span></a>        <span class="k">return</span> <span class="mf">1.22</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">Wavelength</span> <span class="o">/</span> <span class="n">NumericalAperture</span>
</span><span id="L-619"><a href="#-619"><span class="linenos">619</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-620"><a href="#-620"><span class="linenos">620</span></a>        <span class="k">return</span> <span class="mi">0</span>  <span class="c1"># for very small numerical apertures, diffraction effects becomes negligible and the Airy Radius becomes meaningless</span>
</span><span id="L-621"><a href="#-621"><span class="linenos">621</span></a>
</span><span id="L-622"><a href="#-622"><span class="linenos">622</span></a>
</span><span id="L-623"><a href="#-623"><span class="linenos">623</span></a><span class="c1"># %%</span>
</span><span id="L-624"><a href="#-624"><span class="linenos">624</span></a><span class="k">def</span> <span class="nf">_hash_list_of_objects</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
</span><span id="L-625"><a href="#-625"><span class="linenos">625</span></a>    <span class="sd">&quot;&quot;&quot;returns a hash value for a list of objects, by just summing up all the individual hashes.&quot;&quot;&quot;</span>
</span><span id="L-626"><a href="#-626"><span class="linenos">626</span></a>    <span class="n">total_hash</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-627"><a href="#-627"><span class="linenos">627</span></a>    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="L-628"><a href="#-628"><span class="linenos">628</span></a>        <span class="n">total_hash</span> <span class="o">+=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="L-629"><a href="#-629"><span class="linenos">629</span></a>    <span class="k">return</span> <span class="n">total_hash</span>
</span><span id="L-630"><a href="#-630"><span class="linenos">630</span></a>
</span><span id="L-631"><a href="#-631"><span class="linenos">631</span></a>
</span><span id="L-632"><a href="#-632"><span class="linenos">632</span></a><span class="k">def</span> <span class="nf">_which_indeces</span><span class="p">(</span><span class="n">lst</span><span class="p">):</span>
</span><span id="L-633"><a href="#-633"><span class="linenos">633</span></a>    <span class="sd">&quot;&quot;&quot;takes an input-list, and gives you a list of the indeces where the input-list contains another list or a numpy-array&quot;&quot;&quot;</span>
</span><span id="L-634"><a href="#-634"><span class="linenos">634</span></a>    <span class="n">indexes</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))]</span>
</span><span id="L-635"><a href="#-635"><span class="linenos">635</span></a>    <span class="k">return</span> <span class="n">indexes</span>
</span><span id="L-636"><a href="#-636"><span class="linenos">636</span></a>
</span><span id="L-637"><a href="#-637"><span class="linenos">637</span></a>
</span><span id="L-638"><a href="#-638"><span class="linenos">638</span></a><span class="c1"># %%</span>
</span><span id="L-639"><a href="#-639"><span class="linenos">639</span></a><span class="k">def</span> <span class="nf">save_compressed</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-640"><a href="#-640"><span class="linenos">640</span></a>    <span class="sd">&quot;&quot;&quot;Save (=pickle) an object &#39;obj&#39; to a compressed file with name &#39;filename&#39;.&quot;&quot;&quot;</span>
</span><span id="L-641"><a href="#-641"><span class="linenos">641</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-642"><a href="#-642"><span class="linenos">642</span></a>        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;kept_data_&quot;</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">-%Hh%M&quot;</span><span class="p">)</span>
</span><span id="L-643"><a href="#-643"><span class="linenos">643</span></a>
</span><span id="L-644"><a href="#-644"><span class="linenos">644</span></a>    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-645"><a href="#-645"><span class="linenos">645</span></a>    <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.xz&quot;</span><span class="p">):</span>
</span><span id="L-646"><a href="#-646"><span class="linenos">646</span></a>        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-647"><a href="#-647"><span class="linenos">647</span></a>    <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-648"><a href="#-648"><span class="linenos">648</span></a>    <span class="c1"># with gzip.open(filename + &#39;.gz&#39;, &#39;wb&#39;) as f:</span>
</span><span id="L-649"><a href="#-649"><span class="linenos">649</span></a>    <span class="k">with</span> <span class="n">lzma</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.xz&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="L-650"><a href="#-650"><span class="linenos">650</span></a>        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</span><span id="L-651"><a href="#-651"><span class="linenos">651</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saved results to &quot;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.xz.&quot;</span><span class="p">)</span>
</span><span id="L-652"><a href="#-652"><span class="linenos">652</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&gt;To reload from disk do: kept_data = mp.load_compressed(&#39;&quot;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;&#39;)&quot;</span><span class="p">)</span>
</span><span id="L-653"><a href="#-653"><span class="linenos">653</span></a>
</span><span id="L-654"><a href="#-654"><span class="linenos">654</span></a>
</span><span id="L-655"><a href="#-655"><span class="linenos">655</span></a><span class="k">def</span> <span class="nf">load_compressed</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-656"><a href="#-656"><span class="linenos">656</span></a>    <span class="sd">&quot;&quot;&quot;Load (=unpickle) an object &#39;obj&#39; from a compressed file with name &#39;filename&#39;.&quot;&quot;&quot;</span>
</span><span id="L-657"><a href="#-657"><span class="linenos">657</span></a>    <span class="c1"># with gzip.open(filename + &#39;.gz&#39;, &#39;rb&#39;) as f:</span>
</span><span id="L-658"><a href="#-658"><span class="linenos">658</span></a>    <span class="k">with</span> <span class="n">lzma</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.xz&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="L-659"><a href="#-659"><span class="linenos">659</span></a>        <span class="n">obj</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="L-660"><a href="#-660"><span class="linenos">660</span></a>    <span class="k">return</span> <span class="n">obj</span>
</span><span id="L-661"><a href="#-661"><span class="linenos">661</span></a>
</span><span id="L-662"><a href="#-662"><span class="linenos">662</span></a>
</span><span id="L-663"><a href="#-663"><span class="linenos">663</span></a><span class="c1"># %%  tic-toc timer functions</span>
</span><span id="L-664"><a href="#-664"><span class="linenos">664</span></a><span class="n">_tstart_stack</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-665"><a href="#-665"><span class="linenos">665</span></a>
</span><span id="L-666"><a href="#-666"><span class="linenos">666</span></a>
</span><span id="L-667"><a href="#-667"><span class="linenos">667</span></a><span class="k">def</span> <span class="nf">_tic</span><span class="p">():</span>
</span><span id="L-668"><a href="#-668"><span class="linenos">668</span></a>    <span class="n">_tstart_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perf_counter</span><span class="p">())</span>
</span><span id="L-669"><a href="#-669"><span class="linenos">669</span></a>
</span><span id="L-670"><a href="#-670"><span class="linenos">670</span></a>
</span><span id="L-671"><a href="#-671"><span class="linenos">671</span></a><span class="k">def</span> <span class="nf">_toc</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;Elapsed: </span><span class="si">%s</span><span class="s2"> s&quot;</span><span class="p">):</span>
</span><span id="L-672"><a href="#-672"><span class="linenos">672</span></a>    <span class="nb">print</span><span class="p">(</span><span class="n">fmt</span> <span class="o">%</span> <span class="p">(</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">_tstart_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()))</span>
</span></pre></div>


            </section>
                <section id="OEPlacement">
                            <input id="OEPlacement-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">OEPlacement</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">SourceProperties</span><span class="p">:</span> <span class="nb">dict</span>,</span><span class="param">	<span class="n">OpticsList</span><span class="p">:</span> <span class="nb">list</span>,</span><span class="param">	<span class="n">DistanceList</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>,</span><span class="param">	<span class="n">IncidenceAngleList</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>,</span><span class="param">	<span class="n">IncidencePlaneAngleList</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">Description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>,</span><span class="param">	<span class="n">render</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="OEPlacement-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#OEPlacement"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="OEPlacement-134"><a href="#-134"><span class="linenos">134</span></a><span class="k">def</span> <span class="nf">OEPlacement</span><span class="p">(</span>
</span><span id="OEPlacement-135"><a href="#-135"><span class="linenos">135</span></a>    <span class="n">SourceProperties</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
</span><span id="OEPlacement-136"><a href="#-136"><span class="linenos">136</span></a>    <span class="n">OpticsList</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
</span><span id="OEPlacement-137"><a href="#-137"><span class="linenos">137</span></a>    <span class="n">DistanceList</span><span class="p">:</span> <span class="nb">list</span><span class="p">[(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
</span><span id="OEPlacement-138"><a href="#-138"><span class="linenos">138</span></a>    <span class="n">IncidenceAngleList</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
</span><span id="OEPlacement-139"><a href="#-139"><span class="linenos">139</span></a>    <span class="n">IncidencePlaneAngleList</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="OEPlacement-140"><a href="#-140"><span class="linenos">140</span></a>    <span class="n">Description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="OEPlacement-141"><a href="#-141"><span class="linenos">141</span></a>    <span class="n">render</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="OEPlacement-142"><a href="#-142"><span class="linenos">142</span></a><span class="p">):</span>
</span><span id="OEPlacement-143"><a href="#-143"><span class="linenos">143</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="OEPlacement-144"><a href="#-144"><span class="linenos">144</span></a><span class="sd">    Automatically place optical elements in the &quot;lab frame&quot; according to given distances and incidence angles.</span>
</span><span id="OEPlacement-145"><a href="#-145"><span class="linenos">145</span></a><span class="sd">    Outputs an OpticalChain-object.</span>
</span><span id="OEPlacement-146"><a href="#-146"><span class="linenos">146</span></a>
</span><span id="OEPlacement-147"><a href="#-147"><span class="linenos">147</span></a><span class="sd">    The source is placed at the origin, and points into the x-direction. The optical elements then follow.</span>
</span><span id="OEPlacement-148"><a href="#-148"><span class="linenos">148</span></a>
</span><span id="OEPlacement-149"><a href="#-149"><span class="linenos">149</span></a><span class="sd">    As long as the angles in IncidencePlaneAngleList are 0, the incidence plane remains the x-z plane, i.e.</span>
</span><span id="OEPlacement-150"><a href="#-150"><span class="linenos">150</span></a><span class="sd">    the optical elements are rotated about the y-axis to set the desired incidence angle between OE-normal</span>
</span><span id="OEPlacement-151"><a href="#-151"><span class="linenos">151</span></a><span class="sd">    and the direction of incidence of the incoming ray-bundle. Otherwise, the incidence plane gets rotated.</span>
</span><span id="OEPlacement-152"><a href="#-152"><span class="linenos">152</span></a>
</span><span id="OEPlacement-153"><a href="#-153"><span class="linenos">153</span></a><span class="sd">    One of the elements of one of the lists &#39;DistanceList&#39;, &#39;IncidenceAngleList&#39;, or &#39;IncidencePlaneAngleList&#39;</span>
</span><span id="OEPlacement-154"><a href="#-154"><span class="linenos">154</span></a><span class="sd">    can be a list or a numpy-array. In that case, a list of OpticalChain-objects is created which can be looped over.</span>
</span><span id="OEPlacement-155"><a href="#-155"><span class="linenos">155</span></a>
</span><span id="OEPlacement-156"><a href="#-156"><span class="linenos">156</span></a><span class="sd">    Parameters</span>
</span><span id="OEPlacement-157"><a href="#-157"><span class="linenos">157</span></a><span class="sd">    ----------</span>
</span><span id="OEPlacement-158"><a href="#-158"><span class="linenos">158</span></a><span class="sd">        SourceProperties : dict</span>
</span><span id="OEPlacement-159"><a href="#-159"><span class="linenos">159</span></a><span class="sd">            Dictionary with the keys &quot;Divergence&quot; :float, &quot;SourceSize&quot; :float,</span>
</span><span id="OEPlacement-160"><a href="#-160"><span class="linenos">160</span></a><span class="sd">            &quot;NumberRays&quot; :int, and &quot;Wavelength&quot; :float.</span>
</span><span id="OEPlacement-161"><a href="#-161"><span class="linenos">161</span></a><span class="sd">            This determines the source ray-bundle that is created.</span>
</span><span id="OEPlacement-162"><a href="#-162"><span class="linenos">162</span></a>
</span><span id="OEPlacement-163"><a href="#-163"><span class="linenos">163</span></a><span class="sd">        OpticsList : list[Optics-class-objects (Mirorrs or Masks)]</span>
</span><span id="OEPlacement-164"><a href="#-164"><span class="linenos">164</span></a><span class="sd">            List of Optics-objects.</span>
</span><span id="OEPlacement-165"><a href="#-165"><span class="linenos">165</span></a>
</span><span id="OEPlacement-166"><a href="#-166"><span class="linenos">166</span></a><span class="sd">        DistanceList : list[float]</span>
</span><span id="OEPlacement-167"><a href="#-167"><span class="linenos">167</span></a><span class="sd">            List of distances, in mm,  at which place the optics out of the</span>
</span><span id="OEPlacement-168"><a href="#-168"><span class="linenos">168</span></a><span class="sd">            OpticsList from the precending one. For the first optic, this is</span>
</span><span id="OEPlacement-169"><a href="#-169"><span class="linenos">169</span></a><span class="sd">            the distance from the light source.</span>
</span><span id="OEPlacement-170"><a href="#-170"><span class="linenos">170</span></a>
</span><span id="OEPlacement-171"><a href="#-171"><span class="linenos">171</span></a><span class="sd">            One of the elements can ne a list or a numpy-array instead of a float.</span>
</span><span id="OEPlacement-172"><a href="#-172"><span class="linenos">172</span></a><span class="sd">            In that case, a list of OpticalChain-objects is created which can be looped over.</span>
</span><span id="OEPlacement-173"><a href="#-173"><span class="linenos">173</span></a>
</span><span id="OEPlacement-174"><a href="#-174"><span class="linenos">174</span></a><span class="sd">        IncidenceAngleList : list[float]</span>
</span><span id="OEPlacement-175"><a href="#-175"><span class="linenos">175</span></a><span class="sd">            List of incidence angles, in degrees, measured between the central ray</span>
</span><span id="OEPlacement-176"><a href="#-176"><span class="linenos">176</span></a><span class="sd">            of the incident ray bundle and the normal on the optical element.</span>
</span><span id="OEPlacement-177"><a href="#-177"><span class="linenos">177</span></a>
</span><span id="OEPlacement-178"><a href="#-178"><span class="linenos">178</span></a><span class="sd">            One of the elements can ne a list or a numpy-array instead of a float.</span>
</span><span id="OEPlacement-179"><a href="#-179"><span class="linenos">179</span></a><span class="sd">            In that case, a list of OpticalChain-objects is created which can be looped over.</span>
</span><span id="OEPlacement-180"><a href="#-180"><span class="linenos">180</span></a>
</span><span id="OEPlacement-181"><a href="#-181"><span class="linenos">181</span></a><span class="sd">        IncidencePlaneAngleList : list[float], optional</span>
</span><span id="OEPlacement-182"><a href="#-182"><span class="linenos">182</span></a><span class="sd">            List of angles, in degrees, by which the incidence plane is rotated</span>
</span><span id="OEPlacement-183"><a href="#-183"><span class="linenos">183</span></a><span class="sd">            on the optical element with respect to that on the preceding one.</span>
</span><span id="OEPlacement-184"><a href="#-184"><span class="linenos">184</span></a><span class="sd">            Consequently, for the first element, this angle has no qualitative effect.</span>
</span><span id="OEPlacement-185"><a href="#-185"><span class="linenos">185</span></a>
</span><span id="OEPlacement-186"><a href="#-186"><span class="linenos">186</span></a><span class="sd">            One of the elements can ne a list or a numpy-array instead of a float.</span>
</span><span id="OEPlacement-187"><a href="#-187"><span class="linenos">187</span></a><span class="sd">            In that case, a list of OpticalChain-objects is created which can be looped over.</span>
</span><span id="OEPlacement-188"><a href="#-188"><span class="linenos">188</span></a>
</span><span id="OEPlacement-189"><a href="#-189"><span class="linenos">189</span></a><span class="sd">        Description : str, optional</span>
</span><span id="OEPlacement-190"><a href="#-190"><span class="linenos">190</span></a><span class="sd">            A string to describe the optical setup.</span>
</span><span id="OEPlacement-191"><a href="#-191"><span class="linenos">191</span></a>
</span><span id="OEPlacement-192"><a href="#-192"><span class="linenos">192</span></a><span class="sd">        render : bool, optional</span>
</span><span id="OEPlacement-193"><a href="#-193"><span class="linenos">193</span></a><span class="sd">            Whether save a png-image with a rendering of the optical setup.</span>
</span><span id="OEPlacement-194"><a href="#-194"><span class="linenos">194</span></a>
</span><span id="OEPlacement-195"><a href="#-195"><span class="linenos">195</span></a><span class="sd">    Returns</span>
</span><span id="OEPlacement-196"><a href="#-196"><span class="linenos">196</span></a><span class="sd">    -------</span>
</span><span id="OEPlacement-197"><a href="#-197"><span class="linenos">197</span></a><span class="sd">        OpticalChainList : list[OpticalChain-object]</span>
</span><span id="OEPlacement-198"><a href="#-198"><span class="linenos">198</span></a>
</span><span id="OEPlacement-199"><a href="#-199"><span class="linenos">199</span></a><span class="sd">        or</span>
</span><span id="OEPlacement-200"><a href="#-200"><span class="linenos">200</span></a>
</span><span id="OEPlacement-201"><a href="#-201"><span class="linenos">201</span></a><span class="sd">        OpticalChain : OpticalChain-object</span>
</span><span id="OEPlacement-202"><a href="#-202"><span class="linenos">202</span></a>
</span><span id="OEPlacement-203"><a href="#-203"><span class="linenos">203</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="OEPlacement-204"><a href="#-204"><span class="linenos">204</span></a>    <span class="k">if</span> <span class="n">render</span><span class="p">:</span>
</span><span id="OEPlacement-205"><a href="#-205"><span class="linenos">205</span></a>        <span class="kn">from</span> <span class="nn">mayavi</span> <span class="kn">import</span> <span class="n">mlab</span>
</span><span id="OEPlacement-206"><a href="#-206"><span class="linenos">206</span></a>
</span><span id="OEPlacement-207"><a href="#-207"><span class="linenos">207</span></a>    <span class="k">if</span> <span class="n">IncidencePlaneAngleList</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="OEPlacement-208"><a href="#-208"><span class="linenos">208</span></a>        <span class="n">IncidencePlaneAngleList</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">OpticsList</span><span class="p">))</span>
</span><span id="OEPlacement-209"><a href="#-209"><span class="linenos">209</span></a>
</span><span id="OEPlacement-210"><a href="#-210"><span class="linenos">210</span></a>    <span class="n">nest_indx_distance</span> <span class="o">=</span> <span class="n">_which_indeces</span><span class="p">(</span><span class="n">DistanceList</span><span class="p">)</span>
</span><span id="OEPlacement-211"><a href="#-211"><span class="linenos">211</span></a>    <span class="n">nest_indx_incidence</span> <span class="o">=</span> <span class="n">_which_indeces</span><span class="p">(</span><span class="n">IncidenceAngleList</span><span class="p">)</span>
</span><span id="OEPlacement-212"><a href="#-212"><span class="linenos">212</span></a>    <span class="n">nest_indx_incplane</span> <span class="o">=</span> <span class="n">_which_indeces</span><span class="p">(</span><span class="n">IncidencePlaneAngleList</span><span class="p">)</span>
</span><span id="OEPlacement-213"><a href="#-213"><span class="linenos">213</span></a>
</span><span id="OEPlacement-214"><a href="#-214"><span class="linenos">214</span></a>    <span class="n">total_nested</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nest_indx_incidence</span> <span class="o">+</span> <span class="n">nest_indx_incplane</span> <span class="o">+</span> <span class="n">nest_indx_distance</span><span class="p">)</span>
</span><span id="OEPlacement-215"><a href="#-215"><span class="linenos">215</span></a>    <span class="k">if</span> <span class="n">total_nested</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="OEPlacement-216"><a href="#-216"><span class="linenos">216</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="OEPlacement-217"><a href="#-217"><span class="linenos">217</span></a>            <span class="s2">&quot;Only one element of one of the lists IncidenceAngleList, IncidencePlaneAngleList, or DistanceList can be a list or array itself. Otherwise things get too tangled...&quot;</span>
</span><span id="OEPlacement-218"><a href="#-218"><span class="linenos">218</span></a>        <span class="p">)</span>
</span><span id="OEPlacement-219"><a href="#-219"><span class="linenos">219</span></a>    <span class="k">elif</span> <span class="n">total_nested</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="OEPlacement-220"><a href="#-220"><span class="linenos">220</span></a>        <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">nest_indx_incidence</span> <span class="o">+</span> <span class="n">nest_indx_incplane</span> <span class="o">+</span> <span class="n">nest_indx_distance</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="OEPlacement-221"><a href="#-221"><span class="linenos">221</span></a>        <span class="n">loop_variable_name</span> <span class="o">=</span> <span class="n">OpticsList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">+</span> <span class="s2">&quot;_idx_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="OEPlacement-222"><a href="#-222"><span class="linenos">222</span></a>        <span class="k">if</span> <span class="n">nest_indx_incidence</span><span class="p">:</span>  <span class="c1"># if the list is not empty</span>
</span><span id="OEPlacement-223"><a href="#-223"><span class="linenos">223</span></a>            <span class="n">loop_variable_name</span> <span class="o">+=</span> <span class="s2">&quot; incidence angle (deg)&quot;</span>
</span><span id="OEPlacement-224"><a href="#-224"><span class="linenos">224</span></a>            <span class="n">loop_variable</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">IncidenceAngleList</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="OEPlacement-225"><a href="#-225"><span class="linenos">225</span></a>            <span class="n">loop_list</span> <span class="o">=</span> <span class="n">IncidenceAngleList</span>
</span><span id="OEPlacement-226"><a href="#-226"><span class="linenos">226</span></a>        <span class="k">elif</span> <span class="n">nest_indx_distance</span><span class="p">:</span>  <span class="c1"># if the list is not empty</span>
</span><span id="OEPlacement-227"><a href="#-227"><span class="linenos">227</span></a>            <span class="n">loop_variable_name</span> <span class="o">+=</span> <span class="s2">&quot; distance (mm)&quot;</span>
</span><span id="OEPlacement-228"><a href="#-228"><span class="linenos">228</span></a>            <span class="n">loop_variable</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">DistanceList</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="OEPlacement-229"><a href="#-229"><span class="linenos">229</span></a>            <span class="n">loop_list</span> <span class="o">=</span> <span class="n">DistanceList</span>
</span><span id="OEPlacement-230"><a href="#-230"><span class="linenos">230</span></a>        <span class="k">elif</span> <span class="n">nest_indx_incplane</span><span class="p">:</span>  <span class="c1"># if the list is not empty</span>
</span><span id="OEPlacement-231"><a href="#-231"><span class="linenos">231</span></a>            <span class="n">loop_variable_name</span> <span class="o">+=</span> <span class="s2">&quot; incidence-plane angle rotation (deg)&quot;</span>
</span><span id="OEPlacement-232"><a href="#-232"><span class="linenos">232</span></a>            <span class="n">loop_variable</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">IncidencePlaneAngleList</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="OEPlacement-233"><a href="#-233"><span class="linenos">233</span></a>            <span class="n">loop_list</span> <span class="o">=</span> <span class="n">IncidencePlaneAngleList</span>
</span><span id="OEPlacement-234"><a href="#-234"><span class="linenos">234</span></a>
</span><span id="OEPlacement-235"><a href="#-235"><span class="linenos">235</span></a>        <span class="n">OpticalChainList</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="OEPlacement-236"><a href="#-236"><span class="linenos">236</span></a>        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">loop_variable</span><span class="p">:</span>
</span><span id="OEPlacement-237"><a href="#-237"><span class="linenos">237</span></a>            <span class="n">loop_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
</span><span id="OEPlacement-238"><a href="#-238"><span class="linenos">238</span></a>            <span class="n">ModifiedOpticalChain</span> <span class="o">=</span> <span class="n">_singleOEPlacement</span><span class="p">(</span>
</span><span id="OEPlacement-239"><a href="#-239"><span class="linenos">239</span></a>                <span class="n">SourceProperties</span><span class="p">,</span> <span class="n">OpticsList</span><span class="p">,</span> <span class="n">DistanceList</span><span class="p">,</span> <span class="n">IncidenceAngleList</span><span class="p">,</span> <span class="n">IncidencePlaneAngleList</span><span class="p">,</span> <span class="n">Description</span>
</span><span id="OEPlacement-240"><a href="#-240"><span class="linenos">240</span></a>            <span class="p">)</span>
</span><span id="OEPlacement-241"><a href="#-241"><span class="linenos">241</span></a>            <span class="n">ModifiedOpticalChain</span><span class="o">.</span><span class="n">loop_variable_name</span> <span class="o">=</span> <span class="n">loop_variable_name</span>
</span><span id="OEPlacement-242"><a href="#-242"><span class="linenos">242</span></a>            <span class="n">ModifiedOpticalChain</span><span class="o">.</span><span class="n">loop_variable_value</span> <span class="o">=</span> <span class="n">x</span>
</span><span id="OEPlacement-243"><a href="#-243"><span class="linenos">243</span></a>            <span class="n">OpticalChainList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ModifiedOpticalChain</span><span class="p">)</span>
</span><span id="OEPlacement-244"><a href="#-244"><span class="linenos">244</span></a>
</span><span id="OEPlacement-245"><a href="#-245"><span class="linenos">245</span></a>            <span class="k">if</span> <span class="n">render</span><span class="p">:</span>
</span><span id="OEPlacement-246"><a href="#-246"><span class="linenos">246</span></a>                <span class="c1"># to produce and save renderings of the setup for each iteration in the loop:</span>
</span><span id="OEPlacement-247"><a href="#-247"><span class="linenos">247</span></a>                <span class="n">mlab</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">offscreen</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="OEPlacement-248"><a href="#-248"><span class="linenos">248</span></a>                <span class="n">fig</span> <span class="o">=</span> <span class="n">ModifiedOpticalChain</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
</span><span id="OEPlacement-249"><a href="#-249"><span class="linenos">249</span></a>                <span class="n">name</span> <span class="o">=</span> <span class="n">loop_variable_name</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span>
</span><span id="OEPlacement-250"><a href="#-250"><span class="linenos">250</span></a>                <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
</span><span id="OEPlacement-251"><a href="#-251"><span class="linenos">251</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;...saving image...&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="OEPlacement-252"><a href="#-252"><span class="linenos">252</span></a>                <span class="n">mlab</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">magnification</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="OEPlacement-253"><a href="#-253"><span class="linenos">253</span></a>                <span class="nb">print</span><span class="p">(</span>
</span><span id="OEPlacement-254"><a href="#-254"><span class="linenos">254</span></a>                    <span class="s2">&quot;</span><span class="se">\r\033</span><span class="s2">[K&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span>
</span><span id="OEPlacement-255"><a href="#-255"><span class="linenos">255</span></a>                <span class="p">)</span>  <span class="c1"># move to beginning of the line with \r and then delete the whole line with \033[K</span>
</span><span id="OEPlacement-256"><a href="#-256"><span class="linenos">256</span></a>
</span><span id="OEPlacement-257"><a href="#-257"><span class="linenos">257</span></a>        <span class="k">if</span> <span class="n">render</span><span class="p">:</span>
</span><span id="OEPlacement-258"><a href="#-258"><span class="linenos">258</span></a>            <span class="n">mlab</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">offscreen</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="OEPlacement-259"><a href="#-259"><span class="linenos">259</span></a>
</span><span id="OEPlacement-260"><a href="#-260"><span class="linenos">260</span></a>        <span class="k">return</span> <span class="n">OpticalChainList</span>
</span><span id="OEPlacement-261"><a href="#-261"><span class="linenos">261</span></a>
</span><span id="OEPlacement-262"><a href="#-262"><span class="linenos">262</span></a>    <span class="k">elif</span> <span class="n">total_nested</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="OEPlacement-263"><a href="#-263"><span class="linenos">263</span></a>        <span class="n">OpticalChain</span> <span class="o">=</span> <span class="n">_singleOEPlacement</span><span class="p">(</span>
</span><span id="OEPlacement-264"><a href="#-264"><span class="linenos">264</span></a>            <span class="n">SourceProperties</span><span class="p">,</span> <span class="n">OpticsList</span><span class="p">,</span> <span class="n">DistanceList</span><span class="p">,</span> <span class="n">IncidenceAngleList</span><span class="p">,</span> <span class="n">IncidencePlaneAngleList</span><span class="p">,</span> <span class="n">Description</span>
</span><span id="OEPlacement-265"><a href="#-265"><span class="linenos">265</span></a>        <span class="p">)</span>  <span class="c1"># all simple</span>
</span><span id="OEPlacement-266"><a href="#-266"><span class="linenos">266</span></a>        <span class="k">if</span> <span class="n">render</span><span class="p">:</span>
</span><span id="OEPlacement-267"><a href="#-267"><span class="linenos">267</span></a>            <span class="n">mlab</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">offscreen</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="OEPlacement-268"><a href="#-268"><span class="linenos">268</span></a>            <span class="n">fig</span> <span class="o">=</span> <span class="n">OpticalChain</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
</span><span id="OEPlacement-269"><a href="#-269"><span class="linenos">269</span></a>            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;OpticalChain_&quot;</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">-%Hh%M&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span>
</span><span id="OEPlacement-270"><a href="#-270"><span class="linenos">270</span></a>            <span class="n">mlab</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">magnification</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="OEPlacement-271"><a href="#-271"><span class="linenos">271</span></a>            <span class="n">mlab</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">offscreen</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="OEPlacement-272"><a href="#-272"><span class="linenos">272</span></a>
</span><span id="OEPlacement-273"><a href="#-273"><span class="linenos">273</span></a>        <span class="k">return</span> <span class="n">OpticalChain</span>
</span></pre></div>


            <div class="docstring"><p>Automatically place optical elements in the "lab frame" according to given distances and incidence angles.
Outputs an OpticalChain-object.</p>

<p>The source is placed at the origin, and points into the x-direction. The optical elements then follow.</p>

<p>As long as the angles in IncidencePlaneAngleList are 0, the incidence plane remains the x-z plane, i.e.
the optical elements are rotated about the y-axis to set the desired incidence angle between OE-normal
and the direction of incidence of the incoming ray-bundle. Otherwise, the incidence plane gets rotated.</p>

<p>One of the elements of one of the lists 'DistanceList', 'IncidenceAngleList', or 'IncidencePlaneAngleList'
can be a list or a numpy-array. In that case, a list of OpticalChain-objects is created which can be looped over.</p>

<h2 id="parameters">Parameters</h2>

<pre><code>SourceProperties : dict
    Dictionary with the keys "Divergence" :float, "SourceSize" :float,
    "NumberRays" :int, and "Wavelength" :float.
    This determines the source ray-bundle that is created.

OpticsList : list[Optics-class-objects (Mirorrs or Masks)]
    List of Optics-objects.

DistanceList : list[float]
    List of distances, in mm,  at which place the optics out of the
    OpticsList from the precending one. For the first optic, this is
    the distance from the light source.

    One of the elements can ne a list or a numpy-array instead of a float.
    In that case, a list of OpticalChain-objects is created which can be looped over.

IncidenceAngleList : list[float]
    List of incidence angles, in degrees, measured between the central ray
    of the incident ray bundle and the normal on the optical element.

    One of the elements can ne a list or a numpy-array instead of a float.
    In that case, a list of OpticalChain-objects is created which can be looped over.

IncidencePlaneAngleList : list[float], optional
    List of angles, in degrees, by which the incidence plane is rotated
    on the optical element with respect to that on the preceding one.
    Consequently, for the first element, this angle has no qualitative effect.

    One of the elements can ne a list or a numpy-array instead of a float.
    In that case, a list of OpticalChain-objects is created which can be looped over.

Description : str, optional
    A string to describe the optical setup.

render : bool, optional
    Whether save a png-image with a rendering of the optical setup.
</code></pre>

<h2 id="returns">Returns</h2>

<pre><code>OpticalChainList : list[OpticalChain-object]

or

OpticalChain : OpticalChain-object
</code></pre>
</div>


                </section>
                <section id="RayTracingCalculation">
                            <input id="RayTracingCalculation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">RayTracingCalculation</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">source_rays</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n"><a href="ModuleOpticalRay.html#Ray">ART.ModuleOpticalRay.Ray</a></span><span class="p">]</span>,</span><span class="param">	<span class="n">optical_elements</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n"><a href="ModuleOpticalElement.html#OpticalElement">ART.ModuleOpticalElement.OpticalElement</a></span><span class="p">]</span></span><span class="return-annotation">) -> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n"><a href="ModuleOpticalRay.html#Ray">ART.ModuleOpticalRay.Ray</a></span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="RayTracingCalculation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#RayTracingCalculation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="RayTracingCalculation-277"><a href="#-277"><span class="linenos">277</span></a><span class="k">def</span> <span class="nf">RayTracingCalculation</span><span class="p">(</span>
</span><span id="RayTracingCalculation-278"><a href="#-278"><span class="linenos">278</span></a>    <span class="n">source_rays</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">mray</span><span class="o">.</span><span class="n">Ray</span><span class="p">],</span> <span class="n">optical_elements</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">moe</span><span class="o">.</span><span class="n">OpticalElement</span><span class="p">]</span>
</span><span id="RayTracingCalculation-279"><a href="#-279"><span class="linenos">279</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">mray</span><span class="o">.</span><span class="n">Ray</span><span class="p">]]:</span>
</span><span id="RayTracingCalculation-280"><a href="#-280"><span class="linenos">280</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="RayTracingCalculation-281"><a href="#-281"><span class="linenos">281</span></a><span class="sd">    The actual ray-tracing calculation, starting from the list of &#39;source_rays&#39;,</span>
</span><span id="RayTracingCalculation-282"><a href="#-282"><span class="linenos">282</span></a><span class="sd">    and propagating them from one optical element to the next in the order of the</span>
</span><span id="RayTracingCalculation-283"><a href="#-283"><span class="linenos">283</span></a><span class="sd">    items of the list &#39;optical_elements&#39;.</span>
</span><span id="RayTracingCalculation-284"><a href="#-284"><span class="linenos">284</span></a>
</span><span id="RayTracingCalculation-285"><a href="#-285"><span class="linenos">285</span></a>
</span><span id="RayTracingCalculation-286"><a href="#-286"><span class="linenos">286</span></a><span class="sd">    Parameters</span>
</span><span id="RayTracingCalculation-287"><a href="#-287"><span class="linenos">287</span></a><span class="sd">    ----------</span>
</span><span id="RayTracingCalculation-288"><a href="#-288"><span class="linenos">288</span></a><span class="sd">        source_rays : list[Ray-objects]</span>
</span><span id="RayTracingCalculation-289"><a href="#-289"><span class="linenos">289</span></a><span class="sd">            List of input rays.</span>
</span><span id="RayTracingCalculation-290"><a href="#-290"><span class="linenos">290</span></a>
</span><span id="RayTracingCalculation-291"><a href="#-291"><span class="linenos">291</span></a><span class="sd">        optical_elements : list[OpticalElement-objects]</span>
</span><span id="RayTracingCalculation-292"><a href="#-292"><span class="linenos">292</span></a>
</span><span id="RayTracingCalculation-293"><a href="#-293"><span class="linenos">293</span></a>
</span><span id="RayTracingCalculation-294"><a href="#-294"><span class="linenos">294</span></a><span class="sd">    Returns</span>
</span><span id="RayTracingCalculation-295"><a href="#-295"><span class="linenos">295</span></a><span class="sd">    -------</span>
</span><span id="RayTracingCalculation-296"><a href="#-296"><span class="linenos">296</span></a><span class="sd">        output_rays : list[list[Ray-objects]]</span>
</span><span id="RayTracingCalculation-297"><a href="#-297"><span class="linenos">297</span></a><span class="sd">            List of lists of rays, each item corresponding to the ray-bundle *after*</span>
</span><span id="RayTracingCalculation-298"><a href="#-298"><span class="linenos">298</span></a><span class="sd">            the item with the same index in the &#39;optical_elements&#39;-list.</span>
</span><span id="RayTracingCalculation-299"><a href="#-299"><span class="linenos">299</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="RayTracingCalculation-300"><a href="#-300"><span class="linenos">300</span></a>    <span class="n">ez</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</span><span id="RayTracingCalculation-301"><a href="#-301"><span class="linenos">301</span></a>    <span class="n">ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
</span><span id="RayTracingCalculation-302"><a href="#-302"><span class="linenos">302</span></a>    <span class="n">output_rays</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="RayTracingCalculation-303"><a href="#-303"><span class="linenos">303</span></a>
</span><span id="RayTracingCalculation-304"><a href="#-304"><span class="linenos">304</span></a>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">optical_elements</span><span class="p">)):</span>
</span><span id="RayTracingCalculation-305"><a href="#-305"><span class="linenos">305</span></a>        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="RayTracingCalculation-306"><a href="#-306"><span class="linenos">306</span></a>            <span class="n">RayList</span> <span class="o">=</span> <span class="n">source_rays</span>
</span><span id="RayTracingCalculation-307"><a href="#-307"><span class="linenos">307</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="RayTracingCalculation-308"><a href="#-308"><span class="linenos">308</span></a>            <span class="n">RayList</span> <span class="o">=</span> <span class="n">output_rays</span><span class="p">[</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="RayTracingCalculation-309"><a href="#-309"><span class="linenos">309</span></a>
</span><span id="RayTracingCalculation-310"><a href="#-310"><span class="linenos">310</span></a>        <span class="c1"># Mirror = optical_elements[k].type</span>
</span><span id="RayTracingCalculation-311"><a href="#-311"><span class="linenos">311</span></a>        <span class="n">Position</span> <span class="o">=</span> <span class="n">optical_elements</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">position</span>
</span><span id="RayTracingCalculation-312"><a href="#-312"><span class="linenos">312</span></a>        <span class="n">n</span> <span class="o">=</span> <span class="n">optical_elements</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span>
</span><span id="RayTracingCalculation-313"><a href="#-313"><span class="linenos">313</span></a>        <span class="n">m</span> <span class="o">=</span> <span class="n">optical_elements</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">majoraxis</span>
</span><span id="RayTracingCalculation-314"><a href="#-314"><span class="linenos">314</span></a>
</span><span id="RayTracingCalculation-315"><a href="#-315"><span class="linenos">315</span></a>        <span class="c1"># transform rays into mirror coordinate system</span>
</span><span id="RayTracingCalculation-316"><a href="#-316"><span class="linenos">316</span></a>        <span class="n">RayList</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">TranslationRayList</span><span class="p">(</span><span class="n">RayList</span><span class="p">,</span> <span class="o">-</span><span class="n">Position</span><span class="p">)</span>
</span><span id="RayTracingCalculation-317"><a href="#-317"><span class="linenos">317</span></a>        <span class="n">RayList</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">RotationRayList</span><span class="p">(</span><span class="n">RayList</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">ez</span><span class="p">)</span>
</span><span id="RayTracingCalculation-318"><a href="#-318"><span class="linenos">318</span></a>        <span class="c1"># FIRST rotate m in the same way as you just did the ray list,</span>
</span><span id="RayTracingCalculation-319"><a href="#-319"><span class="linenos">319</span></a>        <span class="c1"># THEN rotate the rays again to match the NEW m with the x-axis !</span>
</span><span id="RayTracingCalculation-320"><a href="#-320"><span class="linenos">320</span></a>        <span class="n">mPrime</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">RotationPoint</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">ez</span><span class="p">)</span>
</span><span id="RayTracingCalculation-321"><a href="#-321"><span class="linenos">321</span></a>        <span class="n">RayList</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">RotationRayList</span><span class="p">(</span><span class="n">RayList</span><span class="p">,</span> <span class="n">mPrime</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>
</span><span id="RayTracingCalculation-322"><a href="#-322"><span class="linenos">322</span></a>        <span class="n">RayList</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">TranslationRayList</span><span class="p">(</span><span class="n">RayList</span><span class="p">,</span> <span class="n">optical_elements</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">get_centre</span><span class="p">())</span>
</span><span id="RayTracingCalculation-323"><a href="#-323"><span class="linenos">323</span></a>
</span><span id="RayTracingCalculation-324"><a href="#-324"><span class="linenos">324</span></a>        <span class="c1"># optical element acts on the rays:</span>
</span><span id="RayTracingCalculation-325"><a href="#-325"><span class="linenos">325</span></a>        <span class="k">if</span> <span class="s2">&quot;Mirror&quot;</span> <span class="ow">in</span> <span class="n">optical_elements</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>
</span><span id="RayTracingCalculation-326"><a href="#-326"><span class="linenos">326</span></a>            <span class="n">RayList</span> <span class="o">=</span> <span class="n">mmirror</span><span class="o">.</span><span class="n">ReflectionMirrorRayList</span><span class="p">(</span><span class="n">optical_elements</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">RayList</span><span class="p">)</span>
</span><span id="RayTracingCalculation-327"><a href="#-327"><span class="linenos">327</span></a>        <span class="k">elif</span> <span class="n">optical_elements</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Mask&quot;</span><span class="p">:</span>
</span><span id="RayTracingCalculation-328"><a href="#-328"><span class="linenos">328</span></a>            <span class="n">RayList</span> <span class="o">=</span> <span class="n">mmask</span><span class="o">.</span><span class="n">TransmitMaskRayList</span><span class="p">(</span><span class="n">optical_elements</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">RayList</span><span class="p">)</span>
</span><span id="RayTracingCalculation-329"><a href="#-329"><span class="linenos">329</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="RayTracingCalculation-330"><a href="#-330"><span class="linenos">330</span></a>            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s2">&quot;I don`t recognize the type of optical element &quot;</span> <span class="o">+</span> <span class="n">optical_elements</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">type</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>
</span><span id="RayTracingCalculation-331"><a href="#-331"><span class="linenos">331</span></a>
</span><span id="RayTracingCalculation-332"><a href="#-332"><span class="linenos">332</span></a>        <span class="c1"># transform new rays back into &quot;lab frame&quot;</span>
</span><span id="RayTracingCalculation-333"><a href="#-333"><span class="linenos">333</span></a>        <span class="n">RayList</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">TranslationRayList</span><span class="p">(</span><span class="n">RayList</span><span class="p">,</span> <span class="o">-</span><span class="n">optical_elements</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">get_centre</span><span class="p">())</span>
</span><span id="RayTracingCalculation-334"><a href="#-334"><span class="linenos">334</span></a>        <span class="n">RayList</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">RotationRayList</span><span class="p">(</span><span class="n">RayList</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">mPrime</span><span class="p">)</span>
</span><span id="RayTracingCalculation-335"><a href="#-335"><span class="linenos">335</span></a>        <span class="n">RayList</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">RotationRayList</span><span class="p">(</span><span class="n">RayList</span><span class="p">,</span> <span class="n">ez</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</span><span id="RayTracingCalculation-336"><a href="#-336"><span class="linenos">336</span></a>        <span class="n">RayList</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">TranslationRayList</span><span class="p">(</span><span class="n">RayList</span><span class="p">,</span> <span class="n">Position</span><span class="p">)</span>
</span><span id="RayTracingCalculation-337"><a href="#-337"><span class="linenos">337</span></a>
</span><span id="RayTracingCalculation-338"><a href="#-338"><span class="linenos">338</span></a>        <span class="n">output_rays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RayList</span><span class="p">)</span>
</span><span id="RayTracingCalculation-339"><a href="#-339"><span class="linenos">339</span></a>
</span><span id="RayTracingCalculation-340"><a href="#-340"><span class="linenos">340</span></a>    <span class="k">return</span> <span class="n">output_rays</span>
</span></pre></div>


            <div class="docstring"><p>The actual ray-tracing calculation, starting from the list of 'source_rays',
and propagating them from one optical element to the next in the order of the
items of the list 'optical_elements'.</p>

<h2 id="parameters">Parameters</h2>

<pre><code>source_rays : list[Ray-objects]
    List of input rays.

optical_elements : list[OpticalElement-objects]
</code></pre>

<h2 id="returns">Returns</h2>

<pre><code>output_rays : list[list[Ray-objects]]
    List of lists of rays, each item corresponding to the ray-bundle *after*
    the item with the same index in the 'optical_elements'-list.
</code></pre>
</div>


                </section>
                <section id="FindOptimalDistance">
                            <input id="FindOptimalDistance-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">FindOptimalDistance</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">Detector</span>,</span><span class="param">	<span class="n">RayList</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n"><a href="ModuleOpticalRay.html#Ray">ART.ModuleOpticalRay.Ray</a></span><span class="p">]</span>,</span><span class="param">	<span class="n">OptFor</span><span class="o">=</span><span class="s1">&#39;intensity&#39;</span>,</span><span class="param">	<span class="n">Amplitude</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">Precision</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>,</span><span class="param">	<span class="n">IntensityWeighted</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">verbose</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="FindOptimalDistance-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FindOptimalDistance"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FindOptimalDistance-396"><a href="#-396"><span class="linenos">396</span></a><span class="k">def</span> <span class="nf">FindOptimalDistance</span><span class="p">(</span>
</span><span id="FindOptimalDistance-397"><a href="#-397"><span class="linenos">397</span></a>    <span class="n">Detector</span><span class="p">,</span>
</span><span id="FindOptimalDistance-398"><a href="#-398"><span class="linenos">398</span></a>    <span class="n">RayList</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">mray</span><span class="o">.</span><span class="n">Ray</span><span class="p">],</span>
</span><span id="FindOptimalDistance-399"><a href="#-399"><span class="linenos">399</span></a>    <span class="n">OptFor</span><span class="o">=</span><span class="s2">&quot;intensity&quot;</span><span class="p">,</span>
</span><span id="FindOptimalDistance-400"><a href="#-400"><span class="linenos">400</span></a>    <span class="n">Amplitude</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="FindOptimalDistance-401"><a href="#-401"><span class="linenos">401</span></a>    <span class="n">Precision</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
</span><span id="FindOptimalDistance-402"><a href="#-402"><span class="linenos">402</span></a>    <span class="n">IntensityWeighted</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="FindOptimalDistance-403"><a href="#-403"><span class="linenos">403</span></a>    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="FindOptimalDistance-404"><a href="#-404"><span class="linenos">404</span></a><span class="p">):</span>
</span><span id="FindOptimalDistance-405"><a href="#-405"><span class="linenos">405</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="FindOptimalDistance-406"><a href="#-406"><span class="linenos">406</span></a><span class="sd">    Automatically finds the optimal the &#39;Detector&#39;-distance for either</span>
</span><span id="FindOptimalDistance-407"><a href="#-407"><span class="linenos">407</span></a><span class="sd">    maximum intensity, or minimal spotsize or duration.</span>
</span><span id="FindOptimalDistance-408"><a href="#-408"><span class="linenos">408</span></a>
</span><span id="FindOptimalDistance-409"><a href="#-409"><span class="linenos">409</span></a><span class="sd">    Parameters</span>
</span><span id="FindOptimalDistance-410"><a href="#-410"><span class="linenos">410</span></a><span class="sd">    ----------</span>
</span><span id="FindOptimalDistance-411"><a href="#-411"><span class="linenos">411</span></a><span class="sd">        Detector : Detector-object</span>
</span><span id="FindOptimalDistance-412"><a href="#-412"><span class="linenos">412</span></a>
</span><span id="FindOptimalDistance-413"><a href="#-413"><span class="linenos">413</span></a><span class="sd">        RayList : list[Ray-objects]</span>
</span><span id="FindOptimalDistance-414"><a href="#-414"><span class="linenos">414</span></a>
</span><span id="FindOptimalDistance-415"><a href="#-415"><span class="linenos">415</span></a><span class="sd">        OptFor : str, optional</span>
</span><span id="FindOptimalDistance-416"><a href="#-416"><span class="linenos">416</span></a><span class="sd">            &quot;spotsize&quot;: minimizes the standard-deviation spot size *d* on the detector.</span>
</span><span id="FindOptimalDistance-417"><a href="#-417"><span class="linenos">417</span></a><span class="sd">            &quot;duration&quot;: minimizes the standard-deviation *tau* of the ray-delays.</span>
</span><span id="FindOptimalDistance-418"><a href="#-418"><span class="linenos">418</span></a><span class="sd">            &quot;intensity&quot;: Maximizes 1/tau/d^2.</span>
</span><span id="FindOptimalDistance-419"><a href="#-419"><span class="linenos">419</span></a><span class="sd">            Defaults to &quot;intensity&quot;.</span>
</span><span id="FindOptimalDistance-420"><a href="#-420"><span class="linenos">420</span></a>
</span><span id="FindOptimalDistance-421"><a href="#-421"><span class="linenos">421</span></a><span class="sd">        Amplitude : float, optional</span>
</span><span id="FindOptimalDistance-422"><a href="#-422"><span class="linenos">422</span></a><span class="sd">            The detector-distances within which the optimization is done will be</span>
</span><span id="FindOptimalDistance-423"><a href="#-423"><span class="linenos">423</span></a><span class="sd">            the distance of &#39;Detector&#39; +/- Amplitude in mm.</span>
</span><span id="FindOptimalDistance-424"><a href="#-424"><span class="linenos">424</span></a>
</span><span id="FindOptimalDistance-425"><a href="#-425"><span class="linenos">425</span></a><span class="sd">        Precision : int, optional</span>
</span><span id="FindOptimalDistance-426"><a href="#-426"><span class="linenos">426</span></a><span class="sd">            Precision-parameter for the search algorithm. For Precision = n,</span>
</span><span id="FindOptimalDistance-427"><a href="#-427"><span class="linenos">427</span></a><span class="sd">            it will iterate with search amplitudes decreasing until 10^{-n}.</span>
</span><span id="FindOptimalDistance-428"><a href="#-428"><span class="linenos">428</span></a><span class="sd">            Defaults to 3.</span>
</span><span id="FindOptimalDistance-429"><a href="#-429"><span class="linenos">429</span></a>
</span><span id="FindOptimalDistance-430"><a href="#-430"><span class="linenos">430</span></a><span class="sd">        IntensityWeighted : bool, optional</span>
</span><span id="FindOptimalDistance-431"><a href="#-431"><span class="linenos">431</span></a><span class="sd">            Whether to weigh the calculation of spotsize and/or duration by the ray-intensities.</span>
</span><span id="FindOptimalDistance-432"><a href="#-432"><span class="linenos">432</span></a><span class="sd">            Defaults to False.</span>
</span><span id="FindOptimalDistance-433"><a href="#-433"><span class="linenos">433</span></a>
</span><span id="FindOptimalDistance-434"><a href="#-434"><span class="linenos">434</span></a><span class="sd">        verbose : bool, optional</span>
</span><span id="FindOptimalDistance-435"><a href="#-435"><span class="linenos">435</span></a><span class="sd">            Whether to print results to the console.</span>
</span><span id="FindOptimalDistance-436"><a href="#-436"><span class="linenos">436</span></a>
</span><span id="FindOptimalDistance-437"><a href="#-437"><span class="linenos">437</span></a><span class="sd">    Returns</span>
</span><span id="FindOptimalDistance-438"><a href="#-438"><span class="linenos">438</span></a><span class="sd">    -------</span>
</span><span id="FindOptimalDistance-439"><a href="#-439"><span class="linenos">439</span></a><span class="sd">        OptDetector : Detector-object</span>
</span><span id="FindOptimalDistance-440"><a href="#-440"><span class="linenos">440</span></a><span class="sd">            A new detector-instance with optimized distance.</span>
</span><span id="FindOptimalDistance-441"><a href="#-441"><span class="linenos">441</span></a>
</span><span id="FindOptimalDistance-442"><a href="#-442"><span class="linenos">442</span></a><span class="sd">        OptSpotSize : float</span>
</span><span id="FindOptimalDistance-443"><a href="#-443"><span class="linenos">443</span></a><span class="sd">            Spotsize, calculated as standard deviation in mm of the spot-diagram</span>
</span><span id="FindOptimalDistance-444"><a href="#-444"><span class="linenos">444</span></a><span class="sd">            on the optimized detector.</span>
</span><span id="FindOptimalDistance-445"><a href="#-445"><span class="linenos">445</span></a>
</span><span id="FindOptimalDistance-446"><a href="#-446"><span class="linenos">446</span></a><span class="sd">        OptDuration : float</span>
</span><span id="FindOptimalDistance-447"><a href="#-447"><span class="linenos">447</span></a><span class="sd">            Duration, calculated as standard deviation in fs of the ray-delays</span>
</span><span id="FindOptimalDistance-448"><a href="#-448"><span class="linenos">448</span></a><span class="sd">            on the optimized detector.</span>
</span><span id="FindOptimalDistance-449"><a href="#-449"><span class="linenos">449</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="FindOptimalDistance-450"><a href="#-450"><span class="linenos">450</span></a>
</span><span id="FindOptimalDistance-451"><a href="#-451"><span class="linenos">451</span></a>    <span class="k">if</span> <span class="n">OptFor</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="s2">&quot;duration&quot;</span><span class="p">]:</span>
</span><span id="FindOptimalDistance-452"><a href="#-452"><span class="linenos">452</span></a>        <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span>
</span><span id="FindOptimalDistance-453"><a href="#-453"><span class="linenos">453</span></a>            <span class="s2">&quot;I don`t recognize what you want to optimize the detector distance for. OptFor must be either &#39;intensity&#39;, &#39;size&#39; or &#39;duration&#39;.&quot;</span>
</span><span id="FindOptimalDistance-454"><a href="#-454"><span class="linenos">454</span></a>        <span class="p">)</span>
</span><span id="FindOptimalDistance-455"><a href="#-455"><span class="linenos">455</span></a>
</span><span id="FindOptimalDistance-456"><a href="#-456"><span class="linenos">456</span></a>    <span class="n">FirstDistance</span> <span class="o">=</span> <span class="n">Detector</span><span class="o">.</span><span class="n">get_distance</span><span class="p">()</span>
</span><span id="FindOptimalDistance-457"><a href="#-457"><span class="linenos">457</span></a>    <span class="n">ListPointDetector2DCentre</span> <span class="o">=</span> <span class="n">Detector</span><span class="o">.</span><span class="n">get_PointList2DCentre</span><span class="p">(</span><span class="n">RayList</span><span class="p">)</span>
</span><span id="FindOptimalDistance-458"><a href="#-458"><span class="linenos">458</span></a>    <span class="n">SizeSpot</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">StandardDeviation</span><span class="p">(</span><span class="n">ListPointDetector2DCentre</span><span class="p">)</span>
</span><span id="FindOptimalDistance-459"><a href="#-459"><span class="linenos">459</span></a>    <span class="n">NumericalAperture</span> <span class="o">=</span> <span class="n">ReturnNumericalAperture</span><span class="p">(</span><span class="n">RayList</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="FindOptimalDistance-460"><a href="#-460"><span class="linenos">460</span></a>    <span class="k">if</span> <span class="n">Amplitude</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="FindOptimalDistance-461"><a href="#-461"><span class="linenos">461</span></a>        <span class="n">Amplitude</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">SizeSpot</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">NumericalAperture</span><span class="p">))),</span> <span class="n">FirstDistance</span><span class="p">)</span>
</span><span id="FindOptimalDistance-462"><a href="#-462"><span class="linenos">462</span></a>    <span class="c1"># Step = Amplitude/10</span>
</span><span id="FindOptimalDistance-463"><a href="#-463"><span class="linenos">463</span></a>    <span class="n">Step</span> <span class="o">=</span> <span class="n">Amplitude</span> <span class="o">/</span> <span class="mi">5</span>  <span class="c1"># good enough in half the time ;-)</span>
</span><span id="FindOptimalDistance-464"><a href="#-464"><span class="linenos">464</span></a>
</span><span id="FindOptimalDistance-465"><a href="#-465"><span class="linenos">465</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="FindOptimalDistance-466"><a href="#-466"><span class="linenos">466</span></a>        <span class="nb">print</span><span class="p">(</span>
</span><span id="FindOptimalDistance-467"><a href="#-467"><span class="linenos">467</span></a>            <span class="sa">f</span><span class="s2">&quot;Searching optimal detector position for *</span><span class="si">{</span><span class="n">OptFor</span><span class="si">}</span><span class="s2">* within [</span><span class="si">{</span><span class="n">FirstDistance</span><span class="o">-</span><span class="n">Amplitude</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">FirstDistance</span><span class="o">+</span><span class="n">Amplitude</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">] mm...&quot;</span><span class="p">,</span>
</span><span id="FindOptimalDistance-468"><a href="#-468"><span class="linenos">468</span></a>            <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="FindOptimalDistance-469"><a href="#-469"><span class="linenos">469</span></a>            <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="FindOptimalDistance-470"><a href="#-470"><span class="linenos">470</span></a>        <span class="p">)</span>
</span><span id="FindOptimalDistance-471"><a href="#-471"><span class="linenos">471</span></a>    <span class="n">movingDetector</span> <span class="o">=</span> <span class="n">Detector</span><span class="o">.</span><span class="n">copy_detector</span><span class="p">()</span>
</span><span id="FindOptimalDistance-472"><a href="#-472"><span class="linenos">472</span></a>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Precision</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="FindOptimalDistance-473"><a href="#-473"><span class="linenos">473</span></a>        <span class="n">movingDetector</span><span class="p">,</span> <span class="n">OptSpotSize</span><span class="p">,</span> <span class="n">OptDuration</span> <span class="o">=</span> <span class="n">_FindOptimalDistanceBIS</span><span class="p">(</span>
</span><span id="FindOptimalDistance-474"><a href="#-474"><span class="linenos">474</span></a>            <span class="n">movingDetector</span><span class="p">,</span> <span class="n">Amplitude</span> <span class="o">*</span> <span class="mf">0.1</span><span class="o">**</span><span class="n">k</span><span class="p">,</span> <span class="n">Step</span> <span class="o">*</span> <span class="mf">0.1</span><span class="o">**</span><span class="n">k</span><span class="p">,</span> <span class="n">RayList</span><span class="p">,</span> <span class="n">OptFor</span><span class="p">,</span> <span class="n">IntensityWeighted</span>
</span><span id="FindOptimalDistance-475"><a href="#-475"><span class="linenos">475</span></a>        <span class="p">)</span>
</span><span id="FindOptimalDistance-476"><a href="#-476"><span class="linenos">476</span></a>
</span><span id="FindOptimalDistance-477"><a href="#-477"><span class="linenos">477</span></a>    <span class="k">if</span> <span class="p">(</span>
</span><span id="FindOptimalDistance-478"><a href="#-478"><span class="linenos">478</span></a>        <span class="ow">not</span> <span class="n">FirstDistance</span> <span class="o">-</span> <span class="n">Amplitude</span> <span class="o">+</span> <span class="mi">10</span><span class="o">**-</span><span class="n">Precision</span>
</span><span id="FindOptimalDistance-479"><a href="#-479"><span class="linenos">479</span></a>        <span class="o">&lt;</span> <span class="n">movingDetector</span><span class="o">.</span><span class="n">get_distance</span><span class="p">()</span>
</span><span id="FindOptimalDistance-480"><a href="#-480"><span class="linenos">480</span></a>        <span class="o">&lt;</span> <span class="n">FirstDistance</span> <span class="o">+</span> <span class="n">Amplitude</span> <span class="o">-</span> <span class="mi">10</span><span class="o">**-</span><span class="n">Precision</span>
</span><span id="FindOptimalDistance-481"><a href="#-481"><span class="linenos">481</span></a>    <span class="p">):</span>
</span><span id="FindOptimalDistance-482"><a href="#-482"><span class="linenos">482</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;There`s no minimum-size/duration focus in the searched range.&quot;</span><span class="p">)</span>
</span><span id="FindOptimalDistance-483"><a href="#-483"><span class="linenos">483</span></a>
</span><span id="FindOptimalDistance-484"><a href="#-484"><span class="linenos">484</span></a>    <span class="nb">print</span><span class="p">(</span>
</span><span id="FindOptimalDistance-485"><a href="#-485"><span class="linenos">485</span></a>        <span class="s2">&quot;</span><span class="se">\r\033</span><span class="s2">[K&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span>
</span><span id="FindOptimalDistance-486"><a href="#-486"><span class="linenos">486</span></a>    <span class="p">)</span>  <span class="c1"># move to beginning of the line with \r and then delete the whole line with \033[K</span>
</span><span id="FindOptimalDistance-487"><a href="#-487"><span class="linenos">487</span></a>    <span class="k">return</span> <span class="n">movingDetector</span><span class="p">,</span> <span class="n">OptSpotSize</span><span class="p">,</span> <span class="n">OptDuration</span>
</span></pre></div>


            <div class="docstring"><p>Automatically finds the optimal the 'Detector'-distance for either
maximum intensity, or minimal spotsize or duration.</p>

<h2 id="parameters">Parameters</h2>

<pre><code>Detector : Detector-object

RayList : list[Ray-objects]

OptFor : str, optional
    "spotsize": minimizes the standard-deviation spot size *d* on the detector.
    "duration": minimizes the standard-deviation *tau* of the ray-delays.
    "intensity": Maximizes 1/tau/d^2.
    Defaults to "intensity".

Amplitude : float, optional
    The detector-distances within which the optimization is done will be
    the distance of 'Detector' +/- Amplitude in mm.

Precision : int, optional
    Precision-parameter for the search algorithm. For Precision = n,
    it will iterate with search amplitudes decreasing until 10^{-n}.
    Defaults to 3.

IntensityWeighted : bool, optional
    Whether to weigh the calculation of spotsize and/or duration by the ray-intensities.
    Defaults to False.

verbose : bool, optional
    Whether to print results to the console.
</code></pre>

<h2 id="returns">Returns</h2>

<pre><code>OptDetector : Detector-object
    A new detector-instance with optimized distance.

OptSpotSize : float
    Spotsize, calculated as standard deviation in mm of the spot-diagram
    on the optimized detector.

OptDuration : float
    Duration, calculated as standard deviation in fs of the ray-delays
    on the optimized detector.
</code></pre>
</div>


                </section>
                <section id="FindCentralRay">
                            <input id="FindCentralRay-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">FindCentralRay</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">RayList</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n"><a href="ModuleOpticalRay.html#Ray">ART.ModuleOpticalRay.Ray</a></span><span class="p">]</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="FindCentralRay-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FindCentralRay"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FindCentralRay-491"><a href="#-491"><span class="linenos">491</span></a><span class="k">def</span> <span class="nf">FindCentralRay</span><span class="p">(</span><span class="n">RayList</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">mray</span><span class="o">.</span><span class="n">Ray</span><span class="p">]):</span>
</span><span id="FindCentralRay-492"><a href="#-492"><span class="linenos">492</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="FindCentralRay-493"><a href="#-493"><span class="linenos">493</span></a><span class="sd">    Out of a the list of Ray-objects, RayList, return the one Ray-object whose Ray.number is 0.</span>
</span><span id="FindCentralRay-494"><a href="#-494"><span class="linenos">494</span></a><span class="sd">    This is the ray which the functions in ModuleSource set up as the central ray, i.e.</span>
</span><span id="FindCentralRay-495"><a href="#-495"><span class="linenos">495</span></a><span class="sd">    the one initially launched on the &quot;optical axis&quot;.</span>
</span><span id="FindCentralRay-496"><a href="#-496"><span class="linenos">496</span></a><span class="sd">    Should there be several rays whose number-attribute =0 (which is a bad situation), only</span>
</span><span id="FindCentralRay-497"><a href="#-497"><span class="linenos">497</span></a><span class="sd">    the first one encountered in the list is returned.</span>
</span><span id="FindCentralRay-498"><a href="#-498"><span class="linenos">498</span></a>
</span><span id="FindCentralRay-499"><a href="#-499"><span class="linenos">499</span></a><span class="sd">    Parameters</span>
</span><span id="FindCentralRay-500"><a href="#-500"><span class="linenos">500</span></a><span class="sd">    ----------</span>
</span><span id="FindCentralRay-501"><a href="#-501"><span class="linenos">501</span></a><span class="sd">        RayList : list of Ray-objects</span>
</span><span id="FindCentralRay-502"><a href="#-502"><span class="linenos">502</span></a>
</span><span id="FindCentralRay-503"><a href="#-503"><span class="linenos">503</span></a><span class="sd">    Returns</span>
</span><span id="FindCentralRay-504"><a href="#-504"><span class="linenos">504</span></a><span class="sd">    -------</span>
</span><span id="FindCentralRay-505"><a href="#-505"><span class="linenos">505</span></a><span class="sd">        CentralRay : Ray-object</span>
</span><span id="FindCentralRay-506"><a href="#-506"><span class="linenos">506</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="FindCentralRay-507"><a href="#-507"><span class="linenos">507</span></a>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">RayList</span><span class="p">:</span>
</span><span id="FindCentralRay-508"><a href="#-508"><span class="linenos">508</span></a>        <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">number</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="FindCentralRay-509"><a href="#-509"><span class="linenos">509</span></a>            <span class="k">return</span> <span class="n">k</span>
</span><span id="FindCentralRay-510"><a href="#-510"><span class="linenos">510</span></a>    <span class="k">return</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Out of a the list of Ray-objects, RayList, return the one Ray-object whose Ray.number is 0.
This is the ray which the functions in ModuleSource set up as the central ray, i.e.
the one initially launched on the "optical axis".
Should there be several rays whose number-attribute =0 (which is a bad situation), only
the first one encountered in the list is returned.</p>

<h2 id="parameters">Parameters</h2>

<pre><code>RayList : list of Ray-objects
</code></pre>

<h2 id="returns">Returns</h2>

<pre><code>CentralRay : Ray-object
</code></pre>
</div>


                </section>
                <section id="StandardDeviation">
                            <input id="StandardDeviation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">StandardDeviation</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">List</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="StandardDeviation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StandardDeviation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StandardDeviation-513"><a href="#-513"><span class="linenos">513</span></a><span class="k">def</span> <span class="nf">StandardDeviation</span><span class="p">(</span><span class="n">List</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="StandardDeviation-514"><a href="#-514"><span class="linenos">514</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="StandardDeviation-515"><a href="#-515"><span class="linenos">515</span></a><span class="sd">    Return the standard deviation of elements in the supplied list.</span>
</span><span id="StandardDeviation-516"><a href="#-516"><span class="linenos">516</span></a><span class="sd">    If the elements are floats, it&#39;s simply the root-mean-square over the numbers.</span>
</span><span id="StandardDeviation-517"><a href="#-517"><span class="linenos">517</span></a><span class="sd">    If the elements are vectors (represented as numpy-arrays), the root-mean-square</span>
</span><span id="StandardDeviation-518"><a href="#-518"><span class="linenos">518</span></a><span class="sd">    of the distance of the points from their mean is calculated.</span>
</span><span id="StandardDeviation-519"><a href="#-519"><span class="linenos">519</span></a>
</span><span id="StandardDeviation-520"><a href="#-520"><span class="linenos">520</span></a><span class="sd">    Parameters</span>
</span><span id="StandardDeviation-521"><a href="#-521"><span class="linenos">521</span></a><span class="sd">    ----------</span>
</span><span id="StandardDeviation-522"><a href="#-522"><span class="linenos">522</span></a><span class="sd">        List : list of floats or of np.ndarray</span>
</span><span id="StandardDeviation-523"><a href="#-523"><span class="linenos">523</span></a><span class="sd">            Numbers (in ART, typically delays)</span>
</span><span id="StandardDeviation-524"><a href="#-524"><span class="linenos">524</span></a><span class="sd">            or 2D or 3D vectors (in ART typically space coordinates)</span>
</span><span id="StandardDeviation-525"><a href="#-525"><span class="linenos">525</span></a>
</span><span id="StandardDeviation-526"><a href="#-526"><span class="linenos">526</span></a><span class="sd">    Returns</span>
</span><span id="StandardDeviation-527"><a href="#-527"><span class="linenos">527</span></a><span class="sd">    -------</span>
</span><span id="StandardDeviation-528"><a href="#-528"><span class="linenos">528</span></a><span class="sd">        Std : float</span>
</span><span id="StandardDeviation-529"><a href="#-529"><span class="linenos">529</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="StandardDeviation-530"><a href="#-530"><span class="linenos">530</span></a>    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
</span><span id="StandardDeviation-531"><a href="#-531"><span class="linenos">531</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">List</span><span class="p">)</span>
</span><span id="StandardDeviation-532"><a href="#-532"><span class="linenos">532</span></a>    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="StandardDeviation-533"><a href="#-533"><span class="linenos">533</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
</span><span id="StandardDeviation-534"><a href="#-534"><span class="linenos">534</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="StandardDeviation-535"><a href="#-535"><span class="linenos">535</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;StandardDeviation expects a list of floats or numpy-arrays as input, but got something else.&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Return the standard deviation of elements in the supplied list.
If the elements are floats, it's simply the root-mean-square over the numbers.
If the elements are vectors (represented as numpy-arrays), the root-mean-square
of the distance of the points from their mean is calculated.</p>

<h2 id="parameters">Parameters</h2>

<pre><code>List : list of floats or of np.ndarray
    Numbers (in ART, typically delays)
    or 2D or 3D vectors (in ART typically space coordinates)
</code></pre>

<h2 id="returns">Returns</h2>

<pre><code>Std : float
</code></pre>
</div>


                </section>
                <section id="WeightedStandardDeviation">
                            <input id="WeightedStandardDeviation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">WeightedStandardDeviation</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">List</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>, </span><span class="param"><span class="n">Weights</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="WeightedStandardDeviation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#WeightedStandardDeviation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="WeightedStandardDeviation-538"><a href="#-538"><span class="linenos">538</span></a><span class="k">def</span> <span class="nf">WeightedStandardDeviation</span><span class="p">(</span><span class="n">List</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">Weights</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="WeightedStandardDeviation-539"><a href="#-539"><span class="linenos">539</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="WeightedStandardDeviation-540"><a href="#-540"><span class="linenos">540</span></a><span class="sd">    Return the weighted standard deviation of elements in the supplied list.</span>
</span><span id="WeightedStandardDeviation-541"><a href="#-541"><span class="linenos">541</span></a><span class="sd">    If the elements are floats, it&#39;s simply the root-mean-square over the weighted numbers.</span>
</span><span id="WeightedStandardDeviation-542"><a href="#-542"><span class="linenos">542</span></a><span class="sd">    If the elements are vectors (represented as numpy-arrays), the root-mean-square</span>
</span><span id="WeightedStandardDeviation-543"><a href="#-543"><span class="linenos">543</span></a><span class="sd">    of the weighted distances of the points from their mean is calculated.</span>
</span><span id="WeightedStandardDeviation-544"><a href="#-544"><span class="linenos">544</span></a>
</span><span id="WeightedStandardDeviation-545"><a href="#-545"><span class="linenos">545</span></a><span class="sd">    Parameters</span>
</span><span id="WeightedStandardDeviation-546"><a href="#-546"><span class="linenos">546</span></a><span class="sd">    ----------</span>
</span><span id="WeightedStandardDeviation-547"><a href="#-547"><span class="linenos">547</span></a><span class="sd">        List : list of floats or of np.ndarray</span>
</span><span id="WeightedStandardDeviation-548"><a href="#-548"><span class="linenos">548</span></a><span class="sd">            Numbers (in ART, typically delays)</span>
</span><span id="WeightedStandardDeviation-549"><a href="#-549"><span class="linenos">549</span></a><span class="sd">            or 2D or 3D vectors (in ART typically space coordinates)</span>
</span><span id="WeightedStandardDeviation-550"><a href="#-550"><span class="linenos">550</span></a>
</span><span id="WeightedStandardDeviation-551"><a href="#-551"><span class="linenos">551</span></a><span class="sd">        Weights : list of floats, same length as List</span>
</span><span id="WeightedStandardDeviation-552"><a href="#-552"><span class="linenos">552</span></a><span class="sd">            Parameters such as Ray.intensity to be used as weights</span>
</span><span id="WeightedStandardDeviation-553"><a href="#-553"><span class="linenos">553</span></a>
</span><span id="WeightedStandardDeviation-554"><a href="#-554"><span class="linenos">554</span></a><span class="sd">    Returns</span>
</span><span id="WeightedStandardDeviation-555"><a href="#-555"><span class="linenos">555</span></a><span class="sd">    -------</span>
</span><span id="WeightedStandardDeviation-556"><a href="#-556"><span class="linenos">556</span></a><span class="sd">        Std : float</span>
</span><span id="WeightedStandardDeviation-557"><a href="#-557"><span class="linenos">557</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="WeightedStandardDeviation-558"><a href="#-558"><span class="linenos">558</span></a>    <span class="n">average</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">Weights</span><span class="p">,</span> <span class="n">returned</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="WeightedStandardDeviation-559"><a href="#-559"><span class="linenos">559</span></a>    <span class="n">variance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">List</span> <span class="o">-</span> <span class="n">average</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">Weights</span><span class="p">,</span> <span class="n">returned</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="WeightedStandardDeviation-560"><a href="#-560"><span class="linenos">560</span></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
</span></pre></div>


            <div class="docstring"><p>Return the weighted standard deviation of elements in the supplied list.
If the elements are floats, it's simply the root-mean-square over the weighted numbers.
If the elements are vectors (represented as numpy-arrays), the root-mean-square
of the weighted distances of the points from their mean is calculated.</p>

<h2 id="parameters">Parameters</h2>

<pre><code>List : list of floats or of np.ndarray
    Numbers (in ART, typically delays)
    or 2D or 3D vectors (in ART typically space coordinates)

Weights : list of floats, same length as List
    Parameters such as Ray.intensity to be used as weights
</code></pre>

<h2 id="returns">Returns</h2>

<pre><code>Std : float
</code></pre>
</div>


                </section>
                <section id="ReturnNumericalAperture">
                            <input id="ReturnNumericalAperture-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">ReturnNumericalAperture</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">RayList</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n"><a href="ModuleOpticalRay.html#Ray">ART.ModuleOpticalRay.Ray</a></span><span class="p">]</span>,</span><span class="param">	<span class="n">RefractiveIndex</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="ReturnNumericalAperture-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ReturnNumericalAperture"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ReturnNumericalAperture-564"><a href="#-564"><span class="linenos">564</span></a><span class="k">def</span> <span class="nf">ReturnNumericalAperture</span><span class="p">(</span><span class="n">RayList</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">mray</span><span class="o">.</span><span class="n">Ray</span><span class="p">],</span> <span class="n">RefractiveIndex</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="ReturnNumericalAperture-565"><a href="#-565"><span class="linenos">565</span></a>    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReturnNumericalAperture-566"><a href="#-566"><span class="linenos">566</span></a><span class="sd">    Returns the numerical aperture associated with the supplied ray-bundle &#39;Raylist&#39;.</span>
</span><span id="ReturnNumericalAperture-567"><a href="#-567"><span class="linenos">567</span></a><span class="sd">    This is $n\sin\theta$, where $\theta$ is the maximum angle between any of the rays and the central ray,</span>
</span><span id="ReturnNumericalAperture-568"><a href="#-568"><span class="linenos">568</span></a><span class="sd">    and $n$ is the refractive index of the propagation medium.</span>
</span><span id="ReturnNumericalAperture-569"><a href="#-569"><span class="linenos">569</span></a>
</span><span id="ReturnNumericalAperture-570"><a href="#-570"><span class="linenos">570</span></a><span class="sd">    Parameters</span>
</span><span id="ReturnNumericalAperture-571"><a href="#-571"><span class="linenos">571</span></a><span class="sd">    ----------</span>
</span><span id="ReturnNumericalAperture-572"><a href="#-572"><span class="linenos">572</span></a><span class="sd">        RayList : list of Ray-object</span>
</span><span id="ReturnNumericalAperture-573"><a href="#-573"><span class="linenos">573</span></a><span class="sd">            The ray-bundle of which to determine the NA.</span>
</span><span id="ReturnNumericalAperture-574"><a href="#-574"><span class="linenos">574</span></a>
</span><span id="ReturnNumericalAperture-575"><a href="#-575"><span class="linenos">575</span></a><span class="sd">        RefractiveIndex : float, optional</span>
</span><span id="ReturnNumericalAperture-576"><a href="#-576"><span class="linenos">576</span></a><span class="sd">            Refractive index of the propagation medium, defaults to =1.</span>
</span><span id="ReturnNumericalAperture-577"><a href="#-577"><span class="linenos">577</span></a>
</span><span id="ReturnNumericalAperture-578"><a href="#-578"><span class="linenos">578</span></a><span class="sd">    Returns</span>
</span><span id="ReturnNumericalAperture-579"><a href="#-579"><span class="linenos">579</span></a><span class="sd">    -------</span>
</span><span id="ReturnNumericalAperture-580"><a href="#-580"><span class="linenos">580</span></a><span class="sd">        NA : float</span>
</span><span id="ReturnNumericalAperture-581"><a href="#-581"><span class="linenos">581</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="ReturnNumericalAperture-582"><a href="#-582"><span class="linenos">582</span></a>    <span class="n">CentralRay</span> <span class="o">=</span> <span class="n">FindCentralRay</span><span class="p">(</span><span class="n">RayList</span><span class="p">)</span>
</span><span id="ReturnNumericalAperture-583"><a href="#-583"><span class="linenos">583</span></a>    <span class="k">if</span> <span class="n">CentralRay</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ReturnNumericalAperture-584"><a href="#-584"><span class="linenos">584</span></a>        <span class="n">CentralVector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
</span><span id="ReturnNumericalAperture-585"><a href="#-585"><span class="linenos">585</span></a>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">RayList</span><span class="p">:</span>
</span><span id="ReturnNumericalAperture-586"><a href="#-586"><span class="linenos">586</span></a>            <span class="n">CentralVector</span> <span class="o">=</span> <span class="n">CentralVector</span> <span class="o">+</span> <span class="n">k</span><span class="o">.</span><span class="n">vector</span>
</span><span id="ReturnNumericalAperture-587"><a href="#-587"><span class="linenos">587</span></a>        <span class="n">CentralVector</span> <span class="o">=</span> <span class="n">CentralVector</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">RayList</span><span class="p">)</span>
</span><span id="ReturnNumericalAperture-588"><a href="#-588"><span class="linenos">588</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="ReturnNumericalAperture-589"><a href="#-589"><span class="linenos">589</span></a>        <span class="n">CentralVector</span> <span class="o">=</span> <span class="n">CentralRay</span><span class="o">.</span><span class="n">vector</span>
</span><span id="ReturnNumericalAperture-590"><a href="#-590"><span class="linenos">590</span></a>    <span class="n">ListAngleAperture</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ReturnNumericalAperture-591"><a href="#-591"><span class="linenos">591</span></a>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">RayList</span><span class="p">:</span>
</span><span id="ReturnNumericalAperture-592"><a href="#-592"><span class="linenos">592</span></a>        <span class="n">ListAngleAperture</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mgeo</span><span class="o">.</span><span class="n">AngleBetweenTwoVectors</span><span class="p">(</span><span class="n">CentralVector</span><span class="p">,</span> <span class="n">k</span><span class="o">.</span><span class="n">vector</span><span class="p">))</span>
</span><span id="ReturnNumericalAperture-593"><a href="#-593"><span class="linenos">593</span></a>
</span><span id="ReturnNumericalAperture-594"><a href="#-594"><span class="linenos">594</span></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">ListAngleAperture</span><span class="p">))</span> <span class="o">*</span> <span class="n">RefractiveIndex</span>
</span></pre></div>


            <div class="docstring"><p>Returns the numerical aperture associated with the supplied ray-bundle 'Raylist'.
This is $n\sin\theta$, where $\theta$ is the maximum angle between any of the rays and the central ray,
and $n$ is the refractive index of the propagation medium.</p>

<h2 id="parameters">Parameters</h2>

<pre><code>RayList : list of Ray-object
    The ray-bundle of which to determine the NA.

RefractiveIndex : float, optional
    Refractive index of the propagation medium, defaults to =1.
</code></pre>

<h2 id="returns">Returns</h2>

<pre><code>NA : float
</code></pre>
</div>


                </section>
                <section id="ReturnAiryRadius">
                            <input id="ReturnAiryRadius-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">ReturnAiryRadius</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">Wavelength</span><span class="p">:</span> <span class="nb">float</span>, </span><span class="param"><span class="n">NumericalAperture</span><span class="p">:</span> <span class="nb">float</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="ReturnAiryRadius-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ReturnAiryRadius"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ReturnAiryRadius-598"><a href="#-598"><span class="linenos">598</span></a><span class="k">def</span> <span class="nf">ReturnAiryRadius</span><span class="p">(</span><span class="n">Wavelength</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">NumericalAperture</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="ReturnAiryRadius-599"><a href="#-599"><span class="linenos">599</span></a>    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReturnAiryRadius-600"><a href="#-600"><span class="linenos">600</span></a><span class="sd">    Returns the radius of the Airy disk: $r = 1.22 \frac\{\lambda\}\{NA\}$,</span>
</span><span id="ReturnAiryRadius-601"><a href="#-601"><span class="linenos">601</span></a><span class="sd">    i.e. the diffraction-limited radius of the focal spot corresponding to a given</span>
</span><span id="ReturnAiryRadius-602"><a href="#-602"><span class="linenos">602</span></a><span class="sd">    numerical aperture $NA$ and a light wavelength $\lambda$.</span>
</span><span id="ReturnAiryRadius-603"><a href="#-603"><span class="linenos">603</span></a>
</span><span id="ReturnAiryRadius-604"><a href="#-604"><span class="linenos">604</span></a><span class="sd">    For very small $NA&lt;10^\{-3\}$, diffraction effects becomes negligible and the Airy Radius becomes meaningless,</span>
</span><span id="ReturnAiryRadius-605"><a href="#-605"><span class="linenos">605</span></a><span class="sd">    so in that case, a radius of 0 is returned.</span>
</span><span id="ReturnAiryRadius-606"><a href="#-606"><span class="linenos">606</span></a>
</span><span id="ReturnAiryRadius-607"><a href="#-607"><span class="linenos">607</span></a><span class="sd">    Parameters</span>
</span><span id="ReturnAiryRadius-608"><a href="#-608"><span class="linenos">608</span></a><span class="sd">    ----------</span>
</span><span id="ReturnAiryRadius-609"><a href="#-609"><span class="linenos">609</span></a><span class="sd">        Wavelength : float</span>
</span><span id="ReturnAiryRadius-610"><a href="#-610"><span class="linenos">610</span></a><span class="sd">            Light wavelength in mm.</span>
</span><span id="ReturnAiryRadius-611"><a href="#-611"><span class="linenos">611</span></a>
</span><span id="ReturnAiryRadius-612"><a href="#-612"><span class="linenos">612</span></a><span class="sd">        NumericalAperture : float</span>
</span><span id="ReturnAiryRadius-613"><a href="#-613"><span class="linenos">613</span></a>
</span><span id="ReturnAiryRadius-614"><a href="#-614"><span class="linenos">614</span></a><span class="sd">    Returns</span>
</span><span id="ReturnAiryRadius-615"><a href="#-615"><span class="linenos">615</span></a><span class="sd">    -------</span>
</span><span id="ReturnAiryRadius-616"><a href="#-616"><span class="linenos">616</span></a><span class="sd">        AiryRadius : float</span>
</span><span id="ReturnAiryRadius-617"><a href="#-617"><span class="linenos">617</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="ReturnAiryRadius-618"><a href="#-618"><span class="linenos">618</span></a>    <span class="k">if</span> <span class="n">NumericalAperture</span> <span class="o">&gt;</span> <span class="mf">1e-3</span> <span class="ow">and</span> <span class="n">Wavelength</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ReturnAiryRadius-619"><a href="#-619"><span class="linenos">619</span></a>        <span class="k">return</span> <span class="mf">1.22</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">Wavelength</span> <span class="o">/</span> <span class="n">NumericalAperture</span>
</span><span id="ReturnAiryRadius-620"><a href="#-620"><span class="linenos">620</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="ReturnAiryRadius-621"><a href="#-621"><span class="linenos">621</span></a>        <span class="k">return</span> <span class="mi">0</span>  <span class="c1"># for very small numerical apertures, diffraction effects becomes negligible and the Airy Radius becomes meaningless</span>
</span></pre></div>


            <div class="docstring"><p>Returns the radius of the Airy disk: $r = 1.22 \frac{\lambda}{NA}$,
i.e. the diffraction-limited radius of the focal spot corresponding to a given
numerical aperture $NA$ and a light wavelength $\lambda$.</p>

<p>For very small $NA&lt;10^{-3}$, diffraction effects becomes negligible and the Airy Radius becomes meaningless,
so in that case, a radius of 0 is returned.</p>

<h2 id="parameters">Parameters</h2>

<pre><code>Wavelength : float
    Light wavelength in mm.

NumericalAperture : float
</code></pre>

<h2 id="returns">Returns</h2>

<pre><code>AiryRadius : float
</code></pre>
</div>


                </section>
                <section id="save_compressed">
                            <input id="save_compressed-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">save_compressed</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">obj</span>, </span><span class="param"><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="save_compressed-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#save_compressed"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="save_compressed-640"><a href="#-640"><span class="linenos">640</span></a><span class="k">def</span> <span class="nf">save_compressed</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="save_compressed-641"><a href="#-641"><span class="linenos">641</span></a>    <span class="sd">&quot;&quot;&quot;Save (=pickle) an object &#39;obj&#39; to a compressed file with name &#39;filename&#39;.&quot;&quot;&quot;</span>
</span><span id="save_compressed-642"><a href="#-642"><span class="linenos">642</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="save_compressed-643"><a href="#-643"><span class="linenos">643</span></a>        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;kept_data_&quot;</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">-%Hh%M&quot;</span><span class="p">)</span>
</span><span id="save_compressed-644"><a href="#-644"><span class="linenos">644</span></a>
</span><span id="save_compressed-645"><a href="#-645"><span class="linenos">645</span></a>    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="save_compressed-646"><a href="#-646"><span class="linenos">646</span></a>    <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.xz&quot;</span><span class="p">):</span>
</span><span id="save_compressed-647"><a href="#-647"><span class="linenos">647</span></a>        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="save_compressed-648"><a href="#-648"><span class="linenos">648</span></a>    <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="save_compressed-649"><a href="#-649"><span class="linenos">649</span></a>    <span class="c1"># with gzip.open(filename + &#39;.gz&#39;, &#39;wb&#39;) as f:</span>
</span><span id="save_compressed-650"><a href="#-650"><span class="linenos">650</span></a>    <span class="k">with</span> <span class="n">lzma</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.xz&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="save_compressed-651"><a href="#-651"><span class="linenos">651</span></a>        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</span><span id="save_compressed-652"><a href="#-652"><span class="linenos">652</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saved results to &quot;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.xz.&quot;</span><span class="p">)</span>
</span><span id="save_compressed-653"><a href="#-653"><span class="linenos">653</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&gt;To reload from disk do: kept_data = mp.load_compressed(&#39;&quot;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;&#39;)&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Save (=pickle) an object 'obj' to a compressed file with name 'filename'.</p>
</div>


                </section>
                <section id="load_compressed">
                            <input id="load_compressed-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">load_compressed</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="load_compressed-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#load_compressed"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="load_compressed-656"><a href="#-656"><span class="linenos">656</span></a><span class="k">def</span> <span class="nf">load_compressed</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="load_compressed-657"><a href="#-657"><span class="linenos">657</span></a>    <span class="sd">&quot;&quot;&quot;Load (=unpickle) an object &#39;obj&#39; from a compressed file with name &#39;filename&#39;.&quot;&quot;&quot;</span>
</span><span id="load_compressed-658"><a href="#-658"><span class="linenos">658</span></a>    <span class="c1"># with gzip.open(filename + &#39;.gz&#39;, &#39;rb&#39;) as f:</span>
</span><span id="load_compressed-659"><a href="#-659"><span class="linenos">659</span></a>    <span class="k">with</span> <span class="n">lzma</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.xz&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="load_compressed-660"><a href="#-660"><span class="linenos">660</span></a>        <span class="n">obj</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="load_compressed-661"><a href="#-661"><span class="linenos">661</span></a>    <span class="k">return</span> <span class="n">obj</span>
</span></pre></div>


            <div class="docstring"><p>Load (=unpickle) an object 'obj' from a compressed file with name 'filename'.</p>
</div>


                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value">${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>