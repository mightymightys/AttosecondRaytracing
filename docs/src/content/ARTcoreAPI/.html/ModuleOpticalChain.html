<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css" integrity="sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js" integrity="sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
            delimiters: [
                {left: "$$", right: "$$", display: true},
                {left: "$", right: "$", display: false}
            ]
        });
    });
</script>

<!--
<div class="td-toc"><nav id="TableOfContents"><div>
            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="variable" href="#logger">logger</a>
            </li>
            <li>
                    <a class="class" href="#OpticalChain">OpticalChain</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#OpticalChain.__init__">OpticalChain</a>
                        </li>
                        <li>
                                <a class="variable" href="#OpticalChain.source_rays">source_rays</a>
                        </li>
                        <li>
                                <a class="variable" href="#OpticalChain.optical_elements">optical_elements</a>
                        </li>
                        <li>
                                <a class="variable" href="#OpticalChain.description">description</a>
                        </li>
                        <li>
                                <a class="function" href="#OpticalChain.copy_chain">copy_chain</a>
                        </li>
                        <li>
                                <a class="function" href="#OpticalChain.get_output_rays">get_output_rays</a>
                        </li>
                        <li>
                                <a class="function" href="#OpticalChain.shift_source">shift_source</a>
                        </li>
                        <li>
                                <a class="function" href="#OpticalChain.tilt_source">tilt_source</a>
                        </li>
                        <li>
                                <a class="function" href="#OpticalChain.partial_realign">partial_realign</a>
                        </li>
                        <li>
                                <a class="function" href="#OpticalChain.rotate_OE">rotate_OE</a>
                        </li>
                        <li>
                                <a class="function" href="#OpticalChain.shift_OE">shift_OE</a>
                        </li>
                </ul>

            </li>
    </ul>

</div></nav></div>
-->

<!--
We comment the TOC out because we want to integrate it into the page layout of Docsy
-->


<div class="pdoc">
            <section class="module-info">
                    

                        <div class="docstring"><p>Provides the class OpticalChain, which represents the whole optical setup to be simulated,
from the bundle of source-<a href="ModuleOpticalRay.html">Rays</a> through the successive <a href="ModuleOpticalElement.html">OpticalElements</a>.</p>

<p><img src="OpticalChain.svg" alt="Illustration the Mirror-class." /></p>

<p>Created in Jan 2022</p>

<p>@author: Stefan Haessler</p>
</div>

                        <input id="mod-ModuleOpticalChain-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-ModuleOpticalChain-view-source"><span>View Source</span></label>

                        <div class="chroma pdoc-code"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="sd">Provides the class OpticalChain, which represents the whole optical setup to be simulated,</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="sd">from the bundle of source-[Rays](ModuleOpticalRay.html) through the successive [OpticalElements](ModuleOpticalElement.html).</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="sd">![Illustration the Mirror-class.](OpticalChain.svg)</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="sd">Created in Jan 2022</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="sd">@author: Stefan Haessler</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="c1"># %% Modules</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="kn">import</span> <span class="nn">copy</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="kn">import</span> <span class="nn">logging</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="kn">import</span> <span class="nn">ARTcore.ModuleProcessing</span> <span class="k">as</span> <span class="nn">mp</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="kn">import</span> <span class="nn">ARTcore.ModuleGeometry</span> <span class="k">as</span> <span class="nn">mgeo</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="kn">import</span> <span class="nn">ARTcore.ModuleOpticalRay</span> <span class="k">as</span> <span class="nn">mray</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="kn">import</span> <span class="nn">ARTcore.ModuleOpticalElement</span> <span class="k">as</span> <span class="nn">moe</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="kn">import</span> <span class="nn">ARTcore.ModuleSource</span> <span class="k">as</span> <span class="nn">msource</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="c1"># %%</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a><span class="k">class</span> <span class="nc">OpticalChain</span><span class="p">:</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="sd">    The OpticalChain represents the whole optical setup to be simulated:</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a><span class="sd">    Its main attributes are a list source-[Rays](ModuleOpticalRay.html) and</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a><span class="sd">    a list of successive [OpticalElements](ModuleOpticalElement.html).</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="sd">    The method OpticalChain.get_output_rays() returns an associated list of lists of</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a><span class="sd">    [Rays](ModuleOpticalRay.html), each calculated by ray-tracing from one</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a><span class="sd">    [OpticalElement](ModuleOpticalElement.html) to the next.</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a><span class="sd">    So OpticalChain.get_output_rays()[i] is the bundle of [Rays](ModuleOpticalRay.html) *after*</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a><span class="sd">    optical_elements[i].</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a><span class="sd">    The string &quot;description&quot; can contain a short description of the optical setup, or similar notes.</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a><span class="sd">    The OpticalChain can be visualized quickly with the method OpticalChain.quickshow(),</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a><span class="sd">    and more nicely with OpticalChain.render().</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="sd">    The class also provides methods for (mis-)alignment of the source-[Ray](ModuleOpticalRay.html)-bundle and the</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a><span class="sd">    [OpticalElements](ModuleOpticalElement.html), as well as methods for producing</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="sd">    a list of OpticalChain-objects containing variations of itself.</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a><span class="sd">    Attributes</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a><span class="sd">    ----------</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a><span class="sd">        source_rays : list[mray.Ray]</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a><span class="sd">            List of source rays, which are to be traced.</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a><span class="sd">        optical_elements : list[moe.OpticalElement]</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a><span class="sd">            List of successive optical elements.</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a><span class="sd">        description : str</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a><span class="sd">            A string to describe the optical setup.</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="sd">    Methods</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a><span class="sd">    ----------</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a><span class="sd">        copy_chain()</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a><span class="sd">        get_output_rays()</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a><span class="sd">        quickshow()</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a><span class="sd">        render()</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a><span class="sd">        ----------</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a><span class="sd">        shift_source(axis, distance)</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a><span class="sd">        tilt_source(self, axis, angle)</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a><span class="sd">        get_source_loop_list(axis, loop_variable_values)</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a><span class="sd">        ----------</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a><span class="sd">        rotate_OE(OEindx, axis, angle)</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a><span class="sd">        shift_OE(OEindx, axis, distance)</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a><span class="sd">        get_OE_loop_list(OEindx, axis, loop_variable_values)</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_rays</span><span class="p">,</span> <span class="n">optical_elements</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a><span class="sd">        Parameters</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a><span class="sd">        ----------</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a><span class="sd">            source_rays : list[mray.Ray]</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a><span class="sd">                List of source rays, which are to be traced.</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a><span class="sd">            optical_elements : list[moe.OpticalElement]</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a><span class="sd">                List of successive optical elements.</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a><span class="sd">            description : str, optional</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a><span class="sd">                A string to describe the optical setup. Defaults to &#39;&#39;.</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a><span class="sd">            loop_variable_name : str, optional</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a><span class="sd">                A string naming a parameter that is varied in a list of OpticalChain-objects.</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a><span class="sd">                Defaults to None.</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a><span class="sd">            loop_variable_value : float</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a><span class="sd">                The value of that varied parameter, which is useful when looping over</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a><span class="sd">                variations of an initial configuration. Defaults to None.</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">source_rays</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">source_rays</span><span class="p">)</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>        <span class="c1"># deepcopy so this object doesn&#39;t get changed when the global source_rays changes &quot;outside&quot;</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">optical_elements</span><span class="p">)</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>        <span class="c1"># deepcopy so this object doesn&#39;t get changed when the global optical_elements changes &quot;outside&quot;</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_output_rays</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_last_optical_elements_hash</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># for now we don&#39;t care which element was changed.</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>        <span class="c1"># we just always do the whole raytracing again</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_last_source_rays_hash</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>        <span class="n">pretty_str</span> <span class="o">=</span> <span class="s2">&quot;Optical setup [OpticalChain]:</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>        <span class="n">pretty_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;  - Description: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="k">else</span> <span class="s2">&quot;Description: Not provided.</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>        <span class="n">pretty_str</span> <span class="o">+=</span>  <span class="s2">&quot;  - Contains the following elements:</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>        <span class="n">pretty_str</span> <span class="o">+=</span>  <span class="sa">f</span><span class="s2">&quot;    - Source with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_rays</span><span class="p">)</span><span class="si">}</span><span class="s2"> rays at coordinate origin</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>        <span class="n">prev_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">):</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>            <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">element</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="n">prev_pos</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>                <span class="n">prev</span> <span class="o">=</span> <span class="s2">&quot;source&quot;</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>                <span class="n">prev</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;element </span><span class="si">{</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>            <span class="n">pretty_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    - Element </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">element</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2"> at distance </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">prev</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>            <span class="n">prev_pos</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">position</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>        <span class="k">return</span> <span class="n">pretty_str</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>    
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>    
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">)</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>    <span class="c1"># using property decorator</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>    <span class="c1"># a getter function</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>    <span class="nd">@property</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>    <span class="k">def</span> <span class="nf">source_rays</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source_rays</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>    <span class="c1"># a setter function</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a>    <span class="nd">@source_rays</span><span class="o">.</span><span class="n">setter</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>    <span class="k">def</span> <span class="nf">source_rays</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_rays</span><span class="p">):</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">source_rays</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mray</span><span class="o">.</span><span class="n">Ray</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">source_rays</span><span class="p">):</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_source_rays</span> <span class="o">=</span> <span class="n">source_rays</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Source_rays must be list of Ray-objects.&quot;</span><span class="p">)</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>    <span class="nd">@property</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>    <span class="k">def</span> <span class="nf">optical_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optical_elements</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>    <span class="nd">@optical_elements</span><span class="o">.</span><span class="n">setter</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>    <span class="k">def</span> <span class="nf">optical_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">optical_elements</span><span class="p">):</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">optical_elements</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">moe</span><span class="o">.</span><span class="n">OpticalElement</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">optical_elements</span><span class="p">):</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_optical_elements</span> <span class="o">=</span> <span class="n">optical_elements</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Optical_elements must be list of OpticalElement-objects.&quot;</span><span class="p">)</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>    <span class="c1"># %% METHODS ##################################################################</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>    <span class="k">def</span> <span class="nf">copy_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return another optical chain with the same source, optical elements and description-string as this one.&quot;&quot;&quot;</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>        <span class="k">return</span> <span class="n">OpticalChain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_rays</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>    <span class="k">def</span> <span class="nf">get_output_rays</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a><span class="sd">        Returns the list of (lists of) output rays, calculate them if this hasn&#39;t been done yet,</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a><span class="sd">        or if the source-ray-bundle or anything about the optical elements has changed.</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>        <span class="n">current_source_rays_hash</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">_hash_list_of_objects</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_rays</span><span class="p">)</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>        <span class="n">current_optical_elements_hash</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">_hash_list_of_objects</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">)</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">current_source_rays_hash</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_source_rays_hash</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>            <span class="n">current_optical_elements_hash</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_optical_elements_hash</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>        <span class="p">):</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;...ray-tracing...&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_output_rays</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">RayTracingCalculation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_rays</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>            <span class="nb">print</span><span class="p">(</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>                <span class="s2">&quot;</span><span class="se">\r\033</span><span class="s2">[K&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>            <span class="p">)</span>  <span class="c1"># move to beginning of the line with \r and then delete the whole line with \033[K</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_last_source_rays_hash</span> <span class="o">=</span> <span class="n">current_source_rays_hash</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_last_optical_elements_hash</span> <span class="o">=</span> <span class="n">current_optical_elements_hash</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_rays</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>    <span class="c1"># %%  methods to (mis-)align the optical chain; just uses the corresponding methods of the OpticalElement class...</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>    <span class="k">def</span> <span class="nf">shift_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">),</span> <span class="n">distance</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a><span class="sd">        Shift source ray bundle by distance (in mm) along the &#39;axis&#39; specified as</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a><span class="sd">        a lab-frame vector (numpy-array of length 3) or as one of the strings</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a><span class="sd">        &quot;vert&quot;, &quot;horiz&quot;, or &quot;random&quot;.</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a><span class="sd">        In the latter case, the reference is the incidence plane of the first</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a><span class="sd">        non-normal-incidence mirror after the source. If there is none, you will</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a><span class="sd">        be asked to rather specify the axis as a 3D-numpy-array.</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a><span class="sd">        axis = &quot;vert&quot; means the source position is shifted along the axis perpendicular</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a><span class="sd">        to that incidence plane, i.e. &quot;vertically&quot; away from the former incidence plane..</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a><span class="sd">        axis = &quot;horiz&quot; means the source direciton is translated along thr axis in that</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a><span class="sd">        incidence plane and perpendicular to the current source direction,</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a><span class="sd">        i.e. &quot;horizontally&quot; in the incidence plane, but retaining the same distance</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a><span class="sd">        of source and first optical element.</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a><span class="sd">        axis = &quot;random&quot; means the the source direction shifted in a random direction</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a><span class="sd">        within in the plane perpendicular to the current source direction,</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a><span class="sd">        e.g. simulating a fluctuation of hte transverse source position.</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a><span class="sd">        Parameters</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a><span class="sd">        ----------</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a><span class="sd">            axis : np.ndarray or str</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a><span class="sd">                Shift axis, specified either as a 3D lab-frame vector or as one</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a><span class="sd">                of the strings &quot;vert&quot;, &quot;horiz&quot;, or &quot;random&quot;.</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a><span class="sd">            distance : float</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a><span class="sd">                Shift distance in mm.</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a><span class="sd">        Returns</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a><span class="sd">        -------</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a><span class="sd">            Nothing, just modifies the property &#39;source_rays&#39;.</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The &quot;distance&quot;-argument must be an int or float number.&#39;</span><span class="p">)</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>        <span class="n">central_ray_vector</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">FindCentralRay</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_rays</span><span class="p">)</span><span class="o">.</span><span class="n">vector</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>        <span class="n">mirror_indcs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">OE</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;Mirror&quot;</span> <span class="ow">in</span> <span class="n">OE</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">type</span><span class="p">]</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>        <span class="n">OEnormal</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mirror_indcs</span><span class="p">:</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>            <span class="n">ith_OEnormal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">central_ray_vector</span><span class="p">,</span> <span class="n">ith_OEnormal</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">1e-10</span><span class="p">:</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>                <span class="n">OEnormal</span> <span class="o">=</span> <span class="n">ith_OEnormal</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>                <span class="k">break</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>        <span class="k">if</span> <span class="n">OEnormal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>                <span class="s2">&quot;There doesn&#39;t seem to be a non-normal-incidence mirror in this optical chain, </span><span class="se">\</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a><span class="s2">                            so you should rather give &#39;axis&#39; as a numpy-array of length 3.&quot;</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>            <span class="p">)</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>            <span class="n">translation_vector</span> <span class="o">=</span> <span class="n">axis</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>            <span class="n">perp_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">central_ray_vector</span><span class="p">,</span> <span class="n">OEnormal</span><span class="p">)</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>            <span class="n">horiz_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">perp_axis</span><span class="p">,</span> <span class="n">central_ray_vector</span><span class="p">)</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>            <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="s2">&quot;vert&quot;</span><span class="p">:</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>                <span class="n">translation_vector</span> <span class="o">=</span> <span class="n">perp_axis</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>            <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="s2">&quot;horiz&quot;</span><span class="p">:</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>                <span class="n">translation_vector</span> <span class="o">=</span> <span class="n">horiz_axis</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>            <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>                <span class="n">translation_vector</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">perp_axis</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">horiz_axis</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>                <span class="p">)</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>                    <span class="s1">&#39;The shift direction must be specified by &quot;axis&quot; as one of [&quot;vert&quot;, &quot;horiz&quot;, &quot;random&quot;].&#39;</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>                <span class="p">)</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">source_rays</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">TranslationRayList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_rays</span><span class="p">,</span> <span class="n">distance</span> <span class="o">*</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">translation_vector</span><span class="p">))</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>    <span class="k">def</span> <span class="nf">tilt_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">),</span> <span class="n">angle</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a><span class="sd">        Rotate source ray bundle by angle around an axis, specified as</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a><span class="sd">        a lab-frame vector (numpy-array of length 3) or as one of the strings</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a><span class="sd">        &quot;in_plane&quot;, &quot;out_plane&quot; or &quot;random&quot; direction.</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a><span class="sd">        In the latter case, the function considers the incidence plane of the first</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a><span class="sd">        non-normal-incidence mirror after the source. If there is none, you will</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a><span class="sd">        be asked to rather specify the axis as a 3D-numpy-array.</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a><span class="sd">        axis = &quot;in_plane&quot; means the source direction is rotated about an axis</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a><span class="sd">        perpendicular to that incidence plane, which tilts the source</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a><span class="sd">        &quot;horizontally&quot; in the same plane.</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a><span class="sd">        axis = &quot;out_plane&quot; means the source direciton is rotated about an axis</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a><span class="sd">        in that incidence plane and perpendicular to the current source direction,</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a><span class="sd">        which tilts the source &quot;vertically&quot; out of the former incidence plane.</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a><span class="sd">        axis = &quot;random&quot; means the the source direction is tilted in a random direction,</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a><span class="sd">        e.g. simulating a beam pointing fluctuation.</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a><span class="sd">        Attention, &quot;angle&quot; is given in deg, so as to remain consitent with the</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a><span class="sd">        conventions of other functions, although pointing is mostly talked about</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a><span class="sd">        in mrad instead.</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a><span class="sd">        Parameters</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a><span class="sd">        ----------</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a><span class="sd">            axis : np.ndarray or str</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a><span class="sd">                Shift axis, specified either as a 3D lab-frame vector or as one</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a><span class="sd">                of the strings &quot;in_plane&quot;, &quot;out_plane&quot;, or &quot;random&quot;.</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a><span class="sd">            angle : float</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a><span class="sd">                Rotation angle in degree.</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a><span class="sd">        Returns</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a><span class="sd">        -------</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a><span class="sd">            Nothing, just modifies the property &#39;source_rays&#39;.</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The &quot;angle&quot;-argument must be an int or float number.&#39;</span><span class="p">)</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>        <span class="n">central_ray_vector</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">FindCentralRay</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_rays</span><span class="p">)</span><span class="o">.</span><span class="n">vector</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>        <span class="n">mirror_indcs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">OE</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;Mirror&quot;</span> <span class="ow">in</span> <span class="n">OE</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">type</span><span class="p">]</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>        <span class="n">OEnormal</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mirror_indcs</span><span class="p">:</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>            <span class="n">ith_OEnormal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">central_ray_vector</span><span class="p">,</span> <span class="n">ith_OEnormal</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">1e-10</span><span class="p">:</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>                <span class="n">OEnormal</span> <span class="o">=</span> <span class="n">ith_OEnormal</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>                <span class="k">break</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>        <span class="k">if</span> <span class="n">OEnormal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>                <span class="s2">&quot;There doesn&#39;t seem to be a non-normal-incidence mirror in this optical chain, </span><span class="se">\</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a><span class="s2">                            so you should rather give &#39;axis&#39; as a numpy-array of length 3.&quot;</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>            <span class="p">)</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>            <span class="n">rot_axis</span> <span class="o">=</span> <span class="n">axis</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>            <span class="n">rot_axis_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">central_ray_vector</span><span class="p">,</span> <span class="n">OEnormal</span><span class="p">)</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>            <span class="n">rot_axis_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">rot_axis_in</span><span class="p">,</span> <span class="n">central_ray_vector</span><span class="p">)</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>            <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="s2">&quot;in_plane&quot;</span><span class="p">:</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>                <span class="n">rot_axis</span> <span class="o">=</span> <span class="n">rot_axis_in</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>            <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="s2">&quot;out_plane&quot;</span><span class="p">:</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>                <span class="n">rot_axis</span> <span class="o">=</span> <span class="n">rot_axis_out</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>            <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>                <span class="n">rot_axis</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">rot_axis_in</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">rot_axis_out</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>                <span class="p">)</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>                    <span class="s1">&#39;The tilt axis must be specified by as one of [&quot;in_plane&quot;, &quot;out_plane&quot;, &quot;random&quot;] or as a numpy-array of length 3.&#39;</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>                <span class="p">)</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">source_rays</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">RotationAroundAxisRayList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_rays</span><span class="p">,</span> <span class="n">rot_axis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>    <span class="k">def</span> <span class="nf">partial_realign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OEstart</span><span class="p">,</span> <span class="n">OEstop</span><span class="p">,</span> <span class="n">DistanceList</span><span class="p">,</span> <span class="n">IncidenceAngleList</span><span class="p">,</span> <span class="n">IncidencePlaneAngleList</span><span class="p">):</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a><span class="sd">        This as-of-yet not-implemented method will realign only the parts of the optical chain that are between the elements</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a><span class="sd">        OEstart and OEstop (both included).</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>        <span class="n">OpticsList</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">[</span><span class="n">OEstart</span><span class="p">:</span><span class="n">OEstop</span><span class="p">]]</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>        <span class="n">outray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_output_rays</span><span class="p">()[</span><span class="n">OEstart</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">outray</span><span class="p">)</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>        <span class="n">new_elements</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">OEPlacement</span><span class="p">(</span><span class="n">OpticsList</span><span class="p">,</span> <span class="n">DistanceList</span><span class="p">,</span> <span class="n">IncidenceAngleList</span><span class="p">,</span> <span class="n">IncidencePlaneAngleList</span><span class="p">,</span> <span class="n">outray</span><span class="p">)</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">[</span><span class="n">OEstart</span><span class="p">:</span><span class="n">OEstop</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_elements</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>        
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>    <span class="c1"># %%</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>    <span class="k">def</span> <span class="nf">rotate_OE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OEindx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">angle</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a><span class="sd">        Rotate the optical element OpticalChain.optical_elements[OEindx] with an axis defined relative to the master ray.</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a><span class="sd">        The axis can either be relative to the incoming master ray or the outgoing one. This is defined  by the &quot;ref&quot; variable </span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a><span class="sd">        that takes either of the two values:</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a><span class="sd">            - &quot;in&quot;</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a><span class="sd">            - &quot;out&quot;</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a><span class="sd">        In either case the &quot;axis&quot; can take these values:</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a><span class="sd">            - &quot;roll&quot;: Rotation about the master ray. Looking in the same direction as light propagation, positive is counterclockwise</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a><span class="sd">            - &quot;pitch&quot;: Rotation about the vector in the incidence plane that is normal to the master ray.</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a><span class="sd">            - &quot;yaw&quot;: Rotation about the vector normal to the incidence plane and to the master ray.</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a><span class="sd">        Parameters</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a><span class="sd">        ----------</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a><span class="sd">            OEindx : int</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a><span class="sd">                Index of the optical element to modify out of OpticalChain.optical_elements.</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a><span class="sd">            ref : str</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a><span class="sd">                Reference ray used to define the axes of rotation. Can be either:</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a><span class="sd">                &quot;in&quot; or &quot;out&quot; or &quot;local_normal&quot; (in+out)</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a><span class="sd">            axis : str</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a><span class="sd">                Rotation axis, specified as one of the strings</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a><span class="sd">                &quot;pitch&quot;, &quot;roll&quot;, &quot;yaw&quot;</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a><span class="sd">            angle : float</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a><span class="sd">                Rotation angle in degree.</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a><span class="sd">        Returns</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a><span class="sd">        -------</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a><span class="sd">            Nothing, just modifies OpticalChain.optical_elements[OEindx].</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">OEindx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">):</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>                <span class="s1">&#39;The &quot;OEnumber&quot;-argument is out of range compared to the length of OpticalChain.optical_elements.&#39;</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>            <span class="p">)</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The &quot;angle&quot;-argument must be an int or float number.&#39;</span><span class="p">)</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>        <span class="n">MasterRay</span> <span class="o">=</span> <span class="p">[</span><span class="n">mp</span><span class="o">.</span><span class="n">FindCentralRay</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_rays</span><span class="p">)]</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>        <span class="n">TracedRay</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">RayTracingCalculation</span><span class="p">(</span><span class="n">MasterRay</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">)</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>        <span class="n">TracedRay</span> <span class="o">=</span> <span class="p">[</span><span class="n">MasterRay</span><span class="p">]</span> <span class="o">+</span> <span class="n">TracedRay</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>        <span class="k">match</span> <span class="n">ref</span><span class="p">:</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>            <span class="k">case</span> <span class="s2">&quot;out&quot;</span><span class="p">:</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>                <span class="n">RefVec</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">TracedRay</span><span class="p">[</span><span class="n">OEindx</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vector</span><span class="p">)</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>            <span class="k">case</span> <span class="s2">&quot;in&quot;</span><span class="p">:</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a>                <span class="n">RefVec</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">TracedRay</span><span class="p">[</span><span class="n">OEindx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vector</span><span class="p">)</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>            <span class="k">case</span> <span class="s2">&quot;localnormal&quot;</span><span class="p">:</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>                <span class="n">In</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">TracedRay</span><span class="p">[</span><span class="n">OEindx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vector</span><span class="p">)</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>                <span class="n">Out</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">TracedRay</span><span class="p">[</span><span class="n">OEindx</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vector</span><span class="p">)</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>                <span class="n">RefVec</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">Out</span><span class="o">-</span><span class="n">In</span><span class="p">)</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The &quot;ref&quot;-argument must be a string out of [&quot;in&quot;, &quot;out&quot;, &quot;localnormal].&#39;</span><span class="p">)</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>        <span class="k">if</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span><span class="p">,</span><span class="n">RefVec</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-2</span><span class="p">:</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>            <span class="k">match</span> <span class="n">axis</span><span class="p">:</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>                <span class="k">case</span> <span class="s2">&quot;pitch&quot;</span><span class="p">:</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>                    <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">RotationAroundAxis</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">majoraxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span><span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span><span class="p">)</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>                <span class="k">case</span> <span class="s2">&quot;roll&quot;</span><span class="p">:</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>                    <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">RotationAroundAxis</span><span class="p">(</span><span class="n">RefVec</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span><span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span><span class="p">)</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>                <span class="k">case</span> <span class="s2">&quot;yaw&quot;</span><span class="p">:</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>                    <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">RotationAroundAxis</span><span class="p">(</span><span class="n">mgeo</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">RefVec</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">majoraxis</span><span class="p">)),</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span><span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span><span class="p">)</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>                <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The &quot;axis&quot;-argument must be a string out of [&quot;pitch&quot;, &quot;roll&quot;, &quot;yaw&quot;].&#39;</span><span class="p">)</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>            <span class="c1">#If the normal vector is aligned with the ray</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>            <span class="k">match</span> <span class="n">axis</span><span class="p">:</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>                <span class="k">case</span> <span class="s2">&quot;pitch&quot;</span><span class="p">:</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>                    <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">RotationAroundAxis</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">majoraxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span><span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span><span class="p">)</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>                <span class="k">case</span> <span class="s2">&quot;roll&quot;</span><span class="p">:</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>                    <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">majoraxis</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">RotationAroundAxis</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span><span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">majoraxis</span><span class="p">)</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>                <span class="k">case</span> <span class="s2">&quot;yaw&quot;</span><span class="p">:</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>                    <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">RotationAroundAxis</span><span class="p">(</span><span class="n">mgeo</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">RefVec</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">majoraxis</span><span class="p">)),</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span><span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span><span class="p">)</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>                <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The &quot;axis&quot;-argument must be a string out of [&quot;pitch&quot;, &quot;roll&quot;, &quot;yaw&quot;].&#39;</span><span class="p">)</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>    <span class="k">def</span> <span class="nf">shift_OE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OEindx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">distance</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a><span class="sd">        Shift the optical element OpticalChain.optical_elements[OEindx] along</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a><span class="sd">        axis referenced to the master ray.</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a><span class="sd">        The axis can either be relative to the incoming master ray or the outgoing one. This is defined  by the &quot;ref&quot; variable </span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a><span class="sd">        that takes either of the two values:</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a><span class="sd">            - &quot;in&quot;</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a><span class="sd">            - &quot;out&quot;</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a><span class="sd">        In either case the &quot;axis&quot; can take these values:</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a><span class="sd">            - &quot;along&quot;: Translation along the master ray.</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a><span class="sd">            - &quot;in_plane&quot;: Translation along the vector in the incidence plane that is normal to the master ray.</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a><span class="sd">            - &quot;out_plane&quot;: Translation along the vector normal to the incidence plane and to the master ray.</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a><span class="sd">        Parameters</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a><span class="sd">        ----------</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a><span class="sd">            OEindx : int</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a><span class="sd">                Index of the optical element to modify out of OpticalChain.optical_elements.</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a><span class="sd">            ref : str</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a><span class="sd">                Reference ray used to define the axes of rotation. Can be either:</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a><span class="sd">                &quot;in&quot; or &quot;out&quot;.</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a><span class="sd">            axis : str</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a><span class="sd">                Translation axis, specified as one of the strings</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a><span class="sd">                &quot;along&quot;, &quot;in_plane&quot;, &quot;out_plane&quot;.</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a><span class="sd">            distance : float</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a><span class="sd">                Rotation angle in degree.</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a><span class="sd">        Returns</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a><span class="sd">        -------</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a><span class="sd">            Nothing, just modifies OpticalChain.optical_elements[OEindx].</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">OEindx</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">):</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>                <span class="s1">&#39;The &quot;OEnumber&quot;-argument is out of range compared to the length of OpticalChain.optical_elements.&#39;</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>            <span class="p">)</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The &quot;dist&quot;-argument must be an int or float number.&#39;</span><span class="p">)</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>        <span class="n">MasterRay</span> <span class="o">=</span> <span class="p">[</span><span class="n">mp</span><span class="o">.</span><span class="n">FindCentralRay</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_rays</span><span class="p">)]</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>        <span class="n">TracedRay</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">RayTracingCalculation</span><span class="p">(</span><span class="n">MasterRay</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">)</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>        <span class="n">TracedRay</span> <span class="o">=</span> <span class="p">[</span><span class="n">MasterRay</span><span class="p">]</span> <span class="o">+</span> <span class="n">TracedRay</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>        <span class="k">match</span> <span class="n">ref</span><span class="p">:</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>            <span class="k">case</span> <span class="s2">&quot;out&quot;</span><span class="p">:</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>                <span class="n">RefVec</span> <span class="o">=</span> <span class="n">TracedRay</span><span class="p">[</span><span class="n">OEindx</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vector</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>            <span class="k">case</span> <span class="s2">&quot;in&quot;</span><span class="p">:</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>                <span class="n">RefVec</span> <span class="o">=</span> <span class="n">TracedRay</span><span class="p">[</span><span class="n">OEindx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vector</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The &quot;ref&quot;-argument must be a string out of [&quot;in&quot;, &quot;out&quot;].&#39;</span><span class="p">)</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>        <span class="k">match</span> <span class="n">axis</span><span class="p">:</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a>            <span class="k">case</span> <span class="s2">&quot;along&quot;</span><span class="p">:</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>                <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">position</span> <span class="o">+</span> <span class="n">distance</span> <span class="o">*</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">RefVec</span><span class="p">)</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>            <span class="k">case</span> <span class="s2">&quot;in_plane&quot;</span><span class="p">:</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>                <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">position</span> <span class="o">+</span> <span class="n">distance</span> <span class="o">*</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">RefVec</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">RefVec</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span><span class="p">)))</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>            <span class="k">case</span> <span class="s2">&quot;out_plane&quot;</span><span class="p">:</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>                <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">position</span> <span class="o">+</span> <span class="n">distance</span> <span class="o">*</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">RefVec</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span><span class="p">))</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a>            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The &quot;axis&quot;-argument must be a string out of [&quot;along&quot;, &quot;in_plane&quot;, &quot;out_plane&quot;].&#39;</span><span class="p">)</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>        <span class="c1"># some function that randomly misalings one, or several or all ?</span>
</span></pre></div>


            </section>
                <section id="logger">
                    <div class="attr variable">
            <span class="name">logger</span>        =
<span class="default_value">&lt;Logger <a href="">ARTcore.ModuleOpticalChain</a> (WARNING)&gt;</span>

        
    </div>
    <a class="headerlink" href="#logger"></a>
    
    

                </section>
                <section id="OpticalChain">
                            <input id="OpticalChain-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">OpticalChain</span>:

                <label class="view-source-button" for="OpticalChain-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#OpticalChain"></a>
            <div class="chroma pdoc-code"><pre><span></span><span id="OpticalChain-28"><a href="#OpticalChain-28"><span class="linenos"> 28</span></a><span class="k">class</span> <span class="nc">OpticalChain</span><span class="p">:</span>
</span><span id="OpticalChain-29"><a href="#OpticalChain-29"><span class="linenos"> 29</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="OpticalChain-30"><a href="#OpticalChain-30"><span class="linenos"> 30</span></a><span class="sd">    The OpticalChain represents the whole optical setup to be simulated:</span>
</span><span id="OpticalChain-31"><a href="#OpticalChain-31"><span class="linenos"> 31</span></a><span class="sd">    Its main attributes are a list source-[Rays](ModuleOpticalRay.html) and</span>
</span><span id="OpticalChain-32"><a href="#OpticalChain-32"><span class="linenos"> 32</span></a><span class="sd">    a list of successive [OpticalElements](ModuleOpticalElement.html).</span>
</span><span id="OpticalChain-33"><a href="#OpticalChain-33"><span class="linenos"> 33</span></a>
</span><span id="OpticalChain-34"><a href="#OpticalChain-34"><span class="linenos"> 34</span></a><span class="sd">    The method OpticalChain.get_output_rays() returns an associated list of lists of</span>
</span><span id="OpticalChain-35"><a href="#OpticalChain-35"><span class="linenos"> 35</span></a><span class="sd">    [Rays](ModuleOpticalRay.html), each calculated by ray-tracing from one</span>
</span><span id="OpticalChain-36"><a href="#OpticalChain-36"><span class="linenos"> 36</span></a><span class="sd">    [OpticalElement](ModuleOpticalElement.html) to the next.</span>
</span><span id="OpticalChain-37"><a href="#OpticalChain-37"><span class="linenos"> 37</span></a><span class="sd">    So OpticalChain.get_output_rays()[i] is the bundle of [Rays](ModuleOpticalRay.html) *after*</span>
</span><span id="OpticalChain-38"><a href="#OpticalChain-38"><span class="linenos"> 38</span></a><span class="sd">    optical_elements[i].</span>
</span><span id="OpticalChain-39"><a href="#OpticalChain-39"><span class="linenos"> 39</span></a>
</span><span id="OpticalChain-40"><a href="#OpticalChain-40"><span class="linenos"> 40</span></a><span class="sd">    The string &quot;description&quot; can contain a short description of the optical setup, or similar notes.</span>
</span><span id="OpticalChain-41"><a href="#OpticalChain-41"><span class="linenos"> 41</span></a>
</span><span id="OpticalChain-42"><a href="#OpticalChain-42"><span class="linenos"> 42</span></a><span class="sd">    The OpticalChain can be visualized quickly with the method OpticalChain.quickshow(),</span>
</span><span id="OpticalChain-43"><a href="#OpticalChain-43"><span class="linenos"> 43</span></a><span class="sd">    and more nicely with OpticalChain.render().</span>
</span><span id="OpticalChain-44"><a href="#OpticalChain-44"><span class="linenos"> 44</span></a>
</span><span id="OpticalChain-45"><a href="#OpticalChain-45"><span class="linenos"> 45</span></a><span class="sd">    The class also provides methods for (mis-)alignment of the source-[Ray](ModuleOpticalRay.html)-bundle and the</span>
</span><span id="OpticalChain-46"><a href="#OpticalChain-46"><span class="linenos"> 46</span></a><span class="sd">    [OpticalElements](ModuleOpticalElement.html), as well as methods for producing</span>
</span><span id="OpticalChain-47"><a href="#OpticalChain-47"><span class="linenos"> 47</span></a><span class="sd">    a list of OpticalChain-objects containing variations of itself.</span>
</span><span id="OpticalChain-48"><a href="#OpticalChain-48"><span class="linenos"> 48</span></a>
</span><span id="OpticalChain-49"><a href="#OpticalChain-49"><span class="linenos"> 49</span></a><span class="sd">    Attributes</span>
</span><span id="OpticalChain-50"><a href="#OpticalChain-50"><span class="linenos"> 50</span></a><span class="sd">    ----------</span>
</span><span id="OpticalChain-51"><a href="#OpticalChain-51"><span class="linenos"> 51</span></a><span class="sd">        source_rays : list[mray.Ray]</span>
</span><span id="OpticalChain-52"><a href="#OpticalChain-52"><span class="linenos"> 52</span></a><span class="sd">            List of source rays, which are to be traced.</span>
</span><span id="OpticalChain-53"><a href="#OpticalChain-53"><span class="linenos"> 53</span></a>
</span><span id="OpticalChain-54"><a href="#OpticalChain-54"><span class="linenos"> 54</span></a><span class="sd">        optical_elements : list[moe.OpticalElement]</span>
</span><span id="OpticalChain-55"><a href="#OpticalChain-55"><span class="linenos"> 55</span></a><span class="sd">            List of successive optical elements.</span>
</span><span id="OpticalChain-56"><a href="#OpticalChain-56"><span class="linenos"> 56</span></a>
</span><span id="OpticalChain-57"><a href="#OpticalChain-57"><span class="linenos"> 57</span></a><span class="sd">        description : str</span>
</span><span id="OpticalChain-58"><a href="#OpticalChain-58"><span class="linenos"> 58</span></a><span class="sd">            A string to describe the optical setup.</span>
</span><span id="OpticalChain-59"><a href="#OpticalChain-59"><span class="linenos"> 59</span></a><span class="sd">    Methods</span>
</span><span id="OpticalChain-60"><a href="#OpticalChain-60"><span class="linenos"> 60</span></a><span class="sd">    ----------</span>
</span><span id="OpticalChain-61"><a href="#OpticalChain-61"><span class="linenos"> 61</span></a><span class="sd">        copy_chain()</span>
</span><span id="OpticalChain-62"><a href="#OpticalChain-62"><span class="linenos"> 62</span></a>
</span><span id="OpticalChain-63"><a href="#OpticalChain-63"><span class="linenos"> 63</span></a><span class="sd">        get_output_rays()</span>
</span><span id="OpticalChain-64"><a href="#OpticalChain-64"><span class="linenos"> 64</span></a>
</span><span id="OpticalChain-65"><a href="#OpticalChain-65"><span class="linenos"> 65</span></a><span class="sd">        quickshow()</span>
</span><span id="OpticalChain-66"><a href="#OpticalChain-66"><span class="linenos"> 66</span></a>
</span><span id="OpticalChain-67"><a href="#OpticalChain-67"><span class="linenos"> 67</span></a><span class="sd">        render()</span>
</span><span id="OpticalChain-68"><a href="#OpticalChain-68"><span class="linenos"> 68</span></a>
</span><span id="OpticalChain-69"><a href="#OpticalChain-69"><span class="linenos"> 69</span></a><span class="sd">        ----------</span>
</span><span id="OpticalChain-70"><a href="#OpticalChain-70"><span class="linenos"> 70</span></a>
</span><span id="OpticalChain-71"><a href="#OpticalChain-71"><span class="linenos"> 71</span></a><span class="sd">        shift_source(axis, distance)</span>
</span><span id="OpticalChain-72"><a href="#OpticalChain-72"><span class="linenos"> 72</span></a>
</span><span id="OpticalChain-73"><a href="#OpticalChain-73"><span class="linenos"> 73</span></a><span class="sd">        tilt_source(self, axis, angle)</span>
</span><span id="OpticalChain-74"><a href="#OpticalChain-74"><span class="linenos"> 74</span></a>
</span><span id="OpticalChain-75"><a href="#OpticalChain-75"><span class="linenos"> 75</span></a><span class="sd">        get_source_loop_list(axis, loop_variable_values)</span>
</span><span id="OpticalChain-76"><a href="#OpticalChain-76"><span class="linenos"> 76</span></a>
</span><span id="OpticalChain-77"><a href="#OpticalChain-77"><span class="linenos"> 77</span></a><span class="sd">        ----------</span>
</span><span id="OpticalChain-78"><a href="#OpticalChain-78"><span class="linenos"> 78</span></a>
</span><span id="OpticalChain-79"><a href="#OpticalChain-79"><span class="linenos"> 79</span></a><span class="sd">        rotate_OE(OEindx, axis, angle)</span>
</span><span id="OpticalChain-80"><a href="#OpticalChain-80"><span class="linenos"> 80</span></a>
</span><span id="OpticalChain-81"><a href="#OpticalChain-81"><span class="linenos"> 81</span></a><span class="sd">        shift_OE(OEindx, axis, distance)</span>
</span><span id="OpticalChain-82"><a href="#OpticalChain-82"><span class="linenos"> 82</span></a>
</span><span id="OpticalChain-83"><a href="#OpticalChain-83"><span class="linenos"> 83</span></a><span class="sd">        get_OE_loop_list(OEindx, axis, loop_variable_values)</span>
</span><span id="OpticalChain-84"><a href="#OpticalChain-84"><span class="linenos"> 84</span></a>
</span><span id="OpticalChain-85"><a href="#OpticalChain-85"><span class="linenos"> 85</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="OpticalChain-86"><a href="#OpticalChain-86"><span class="linenos"> 86</span></a>
</span><span id="OpticalChain-87"><a href="#OpticalChain-87"><span class="linenos"> 87</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_rays</span><span class="p">,</span> <span class="n">optical_elements</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
</span><span id="OpticalChain-88"><a href="#OpticalChain-88"><span class="linenos"> 88</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="OpticalChain-89"><a href="#OpticalChain-89"><span class="linenos"> 89</span></a><span class="sd">        Parameters</span>
</span><span id="OpticalChain-90"><a href="#OpticalChain-90"><span class="linenos"> 90</span></a><span class="sd">        ----------</span>
</span><span id="OpticalChain-91"><a href="#OpticalChain-91"><span class="linenos"> 91</span></a><span class="sd">            source_rays : list[mray.Ray]</span>
</span><span id="OpticalChain-92"><a href="#OpticalChain-92"><span class="linenos"> 92</span></a><span class="sd">                List of source rays, which are to be traced.</span>
</span><span id="OpticalChain-93"><a href="#OpticalChain-93"><span class="linenos"> 93</span></a>
</span><span id="OpticalChain-94"><a href="#OpticalChain-94"><span class="linenos"> 94</span></a><span class="sd">            optical_elements : list[moe.OpticalElement]</span>
</span><span id="OpticalChain-95"><a href="#OpticalChain-95"><span class="linenos"> 95</span></a><span class="sd">                List of successive optical elements.</span>
</span><span id="OpticalChain-96"><a href="#OpticalChain-96"><span class="linenos"> 96</span></a>
</span><span id="OpticalChain-97"><a href="#OpticalChain-97"><span class="linenos"> 97</span></a><span class="sd">            description : str, optional</span>
</span><span id="OpticalChain-98"><a href="#OpticalChain-98"><span class="linenos"> 98</span></a><span class="sd">                A string to describe the optical setup. Defaults to &#39;&#39;.</span>
</span><span id="OpticalChain-99"><a href="#OpticalChain-99"><span class="linenos"> 99</span></a>
</span><span id="OpticalChain-100"><a href="#OpticalChain-100"><span class="linenos">100</span></a><span class="sd">            loop_variable_name : str, optional</span>
</span><span id="OpticalChain-101"><a href="#OpticalChain-101"><span class="linenos">101</span></a><span class="sd">                A string naming a parameter that is varied in a list of OpticalChain-objects.</span>
</span><span id="OpticalChain-102"><a href="#OpticalChain-102"><span class="linenos">102</span></a><span class="sd">                Defaults to None.</span>
</span><span id="OpticalChain-103"><a href="#OpticalChain-103"><span class="linenos">103</span></a>
</span><span id="OpticalChain-104"><a href="#OpticalChain-104"><span class="linenos">104</span></a><span class="sd">            loop_variable_value : float</span>
</span><span id="OpticalChain-105"><a href="#OpticalChain-105"><span class="linenos">105</span></a><span class="sd">                The value of that varied parameter, which is useful when looping over</span>
</span><span id="OpticalChain-106"><a href="#OpticalChain-106"><span class="linenos">106</span></a><span class="sd">                variations of an initial configuration. Defaults to None.</span>
</span><span id="OpticalChain-107"><a href="#OpticalChain-107"><span class="linenos">107</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="OpticalChain-108"><a href="#OpticalChain-108"><span class="linenos">108</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">source_rays</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">source_rays</span><span class="p">)</span>
</span><span id="OpticalChain-109"><a href="#OpticalChain-109"><span class="linenos">109</span></a>        <span class="c1"># deepcopy so this object doesn&#39;t get changed when the global source_rays changes &quot;outside&quot;</span>
</span><span id="OpticalChain-110"><a href="#OpticalChain-110"><span class="linenos">110</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">optical_elements</span><span class="p">)</span>
</span><span id="OpticalChain-111"><a href="#OpticalChain-111"><span class="linenos">111</span></a>        <span class="c1"># deepcopy so this object doesn&#39;t get changed when the global optical_elements changes &quot;outside&quot;</span>
</span><span id="OpticalChain-112"><a href="#OpticalChain-112"><span class="linenos">112</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>
</span><span id="OpticalChain-113"><a href="#OpticalChain-113"><span class="linenos">113</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_output_rays</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="OpticalChain-114"><a href="#OpticalChain-114"><span class="linenos">114</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_last_optical_elements_hash</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># for now we don&#39;t care which element was changed.</span>
</span><span id="OpticalChain-115"><a href="#OpticalChain-115"><span class="linenos">115</span></a>        <span class="c1"># we just always do the whole raytracing again</span>
</span><span id="OpticalChain-116"><a href="#OpticalChain-116"><span class="linenos">116</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_last_source_rays_hash</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="OpticalChain-117"><a href="#OpticalChain-117"><span class="linenos">117</span></a>
</span><span id="OpticalChain-118"><a href="#OpticalChain-118"><span class="linenos">118</span></a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="OpticalChain-119"><a href="#OpticalChain-119"><span class="linenos">119</span></a>        <span class="n">pretty_str</span> <span class="o">=</span> <span class="s2">&quot;Optical setup [OpticalChain]:</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="OpticalChain-120"><a href="#OpticalChain-120"><span class="linenos">120</span></a>        <span class="n">pretty_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;  - Description: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="k">else</span> <span class="s2">&quot;Description: Not provided.</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="OpticalChain-121"><a href="#OpticalChain-121"><span class="linenos">121</span></a>        <span class="n">pretty_str</span> <span class="o">+=</span>  <span class="s2">&quot;  - Contains the following elements:</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="OpticalChain-122"><a href="#OpticalChain-122"><span class="linenos">122</span></a>        <span class="n">pretty_str</span> <span class="o">+=</span>  <span class="sa">f</span><span class="s2">&quot;    - Source with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_rays</span><span class="p">)</span><span class="si">}</span><span class="s2"> rays at coordinate origin</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="OpticalChain-123"><a href="#OpticalChain-123"><span class="linenos">123</span></a>        <span class="n">prev_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span id="OpticalChain-124"><a href="#OpticalChain-124"><span class="linenos">124</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">):</span>
</span><span id="OpticalChain-125"><a href="#OpticalChain-125"><span class="linenos">125</span></a>            <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">element</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="n">prev_pos</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
</span><span id="OpticalChain-126"><a href="#OpticalChain-126"><span class="linenos">126</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="OpticalChain-127"><a href="#OpticalChain-127"><span class="linenos">127</span></a>                <span class="n">prev</span> <span class="o">=</span> <span class="s2">&quot;source&quot;</span>
</span><span id="OpticalChain-128"><a href="#OpticalChain-128"><span class="linenos">128</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="OpticalChain-129"><a href="#OpticalChain-129"><span class="linenos">129</span></a>                <span class="n">prev</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;element </span><span class="si">{</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="OpticalChain-130"><a href="#OpticalChain-130"><span class="linenos">130</span></a>            <span class="n">pretty_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    - Element </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">element</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2"> at distance </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">prev</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="OpticalChain-131"><a href="#OpticalChain-131"><span class="linenos">131</span></a>            <span class="n">prev_pos</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">position</span>
</span><span id="OpticalChain-132"><a href="#OpticalChain-132"><span class="linenos">132</span></a>        <span class="k">return</span> <span class="n">pretty_str</span>
</span><span id="OpticalChain-133"><a href="#OpticalChain-133"><span class="linenos">133</span></a>    
</span><span id="OpticalChain-134"><a href="#OpticalChain-134"><span class="linenos">134</span></a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
</span><span id="OpticalChain-135"><a href="#OpticalChain-135"><span class="linenos">135</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="OpticalChain-136"><a href="#OpticalChain-136"><span class="linenos">136</span></a>    
</span><span id="OpticalChain-137"><a href="#OpticalChain-137"><span class="linenos">137</span></a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="OpticalChain-138"><a href="#OpticalChain-138"><span class="linenos">138</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">)</span>
</span><span id="OpticalChain-139"><a href="#OpticalChain-139"><span class="linenos">139</span></a>
</span><span id="OpticalChain-140"><a href="#OpticalChain-140"><span class="linenos">140</span></a>    <span class="c1"># using property decorator</span>
</span><span id="OpticalChain-141"><a href="#OpticalChain-141"><span class="linenos">141</span></a>    <span class="c1"># a getter function</span>
</span><span id="OpticalChain-142"><a href="#OpticalChain-142"><span class="linenos">142</span></a>    <span class="nd">@property</span>
</span><span id="OpticalChain-143"><a href="#OpticalChain-143"><span class="linenos">143</span></a>    <span class="k">def</span> <span class="nf">source_rays</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="OpticalChain-144"><a href="#OpticalChain-144"><span class="linenos">144</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source_rays</span>
</span><span id="OpticalChain-145"><a href="#OpticalChain-145"><span class="linenos">145</span></a>
</span><span id="OpticalChain-146"><a href="#OpticalChain-146"><span class="linenos">146</span></a>    <span class="c1"># a setter function</span>
</span><span id="OpticalChain-147"><a href="#OpticalChain-147"><span class="linenos">147</span></a>    <span class="nd">@source_rays</span><span class="o">.</span><span class="n">setter</span>
</span><span id="OpticalChain-148"><a href="#OpticalChain-148"><span class="linenos">148</span></a>    <span class="k">def</span> <span class="nf">source_rays</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_rays</span><span class="p">):</span>
</span><span id="OpticalChain-149"><a href="#OpticalChain-149"><span class="linenos">149</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">source_rays</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mray</span><span class="o">.</span><span class="n">Ray</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">source_rays</span><span class="p">):</span>
</span><span id="OpticalChain-150"><a href="#OpticalChain-150"><span class="linenos">150</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_source_rays</span> <span class="o">=</span> <span class="n">source_rays</span>
</span><span id="OpticalChain-151"><a href="#OpticalChain-151"><span class="linenos">151</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="OpticalChain-152"><a href="#OpticalChain-152"><span class="linenos">152</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Source_rays must be list of Ray-objects.&quot;</span><span class="p">)</span>
</span><span id="OpticalChain-153"><a href="#OpticalChain-153"><span class="linenos">153</span></a>
</span><span id="OpticalChain-154"><a href="#OpticalChain-154"><span class="linenos">154</span></a>    <span class="nd">@property</span>
</span><span id="OpticalChain-155"><a href="#OpticalChain-155"><span class="linenos">155</span></a>    <span class="k">def</span> <span class="nf">optical_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="OpticalChain-156"><a href="#OpticalChain-156"><span class="linenos">156</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optical_elements</span>
</span><span id="OpticalChain-157"><a href="#OpticalChain-157"><span class="linenos">157</span></a>
</span><span id="OpticalChain-158"><a href="#OpticalChain-158"><span class="linenos">158</span></a>    <span class="nd">@optical_elements</span><span class="o">.</span><span class="n">setter</span>
</span><span id="OpticalChain-159"><a href="#OpticalChain-159"><span class="linenos">159</span></a>    <span class="k">def</span> <span class="nf">optical_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">optical_elements</span><span class="p">):</span>
</span><span id="OpticalChain-160"><a href="#OpticalChain-160"><span class="linenos">160</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">optical_elements</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">moe</span><span class="o">.</span><span class="n">OpticalElement</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">optical_elements</span><span class="p">):</span>
</span><span id="OpticalChain-161"><a href="#OpticalChain-161"><span class="linenos">161</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_optical_elements</span> <span class="o">=</span> <span class="n">optical_elements</span>
</span><span id="OpticalChain-162"><a href="#OpticalChain-162"><span class="linenos">162</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="OpticalChain-163"><a href="#OpticalChain-163"><span class="linenos">163</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Optical_elements must be list of OpticalElement-objects.&quot;</span><span class="p">)</span>
</span><span id="OpticalChain-164"><a href="#OpticalChain-164"><span class="linenos">164</span></a>
</span><span id="OpticalChain-165"><a href="#OpticalChain-165"><span class="linenos">165</span></a>    <span class="c1"># %% METHODS ##################################################################</span>
</span><span id="OpticalChain-166"><a href="#OpticalChain-166"><span class="linenos">166</span></a>
</span><span id="OpticalChain-167"><a href="#OpticalChain-167"><span class="linenos">167</span></a>    <span class="k">def</span> <span class="nf">copy_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="OpticalChain-168"><a href="#OpticalChain-168"><span class="linenos">168</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return another optical chain with the same source, optical elements and description-string as this one.&quot;&quot;&quot;</span>
</span><span id="OpticalChain-169"><a href="#OpticalChain-169"><span class="linenos">169</span></a>        <span class="k">return</span> <span class="n">OpticalChain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_rays</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
</span><span id="OpticalChain-170"><a href="#OpticalChain-170"><span class="linenos">170</span></a>
</span><span id="OpticalChain-171"><a href="#OpticalChain-171"><span class="linenos">171</span></a>    <span class="k">def</span> <span class="nf">get_output_rays</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="OpticalChain-172"><a href="#OpticalChain-172"><span class="linenos">172</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="OpticalChain-173"><a href="#OpticalChain-173"><span class="linenos">173</span></a><span class="sd">        Returns the list of (lists of) output rays, calculate them if this hasn&#39;t been done yet,</span>
</span><span id="OpticalChain-174"><a href="#OpticalChain-174"><span class="linenos">174</span></a><span class="sd">        or if the source-ray-bundle or anything about the optical elements has changed.</span>
</span><span id="OpticalChain-175"><a href="#OpticalChain-175"><span class="linenos">175</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="OpticalChain-176"><a href="#OpticalChain-176"><span class="linenos">176</span></a>        <span class="n">current_source_rays_hash</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">_hash_list_of_objects</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_rays</span><span class="p">)</span>
</span><span id="OpticalChain-177"><a href="#OpticalChain-177"><span class="linenos">177</span></a>        <span class="n">current_optical_elements_hash</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">_hash_list_of_objects</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">)</span>
</span><span id="OpticalChain-178"><a href="#OpticalChain-178"><span class="linenos">178</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">current_source_rays_hash</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_source_rays_hash</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
</span><span id="OpticalChain-179"><a href="#OpticalChain-179"><span class="linenos">179</span></a>            <span class="n">current_optical_elements_hash</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_optical_elements_hash</span>
</span><span id="OpticalChain-180"><a href="#OpticalChain-180"><span class="linenos">180</span></a>        <span class="p">):</span>
</span><span id="OpticalChain-181"><a href="#OpticalChain-181"><span class="linenos">181</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;...ray-tracing...&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="OpticalChain-182"><a href="#OpticalChain-182"><span class="linenos">182</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_output_rays</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">RayTracingCalculation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_rays</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="OpticalChain-183"><a href="#OpticalChain-183"><span class="linenos">183</span></a>            <span class="nb">print</span><span class="p">(</span>
</span><span id="OpticalChain-184"><a href="#OpticalChain-184"><span class="linenos">184</span></a>                <span class="s2">&quot;</span><span class="se">\r\033</span><span class="s2">[K&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span>
</span><span id="OpticalChain-185"><a href="#OpticalChain-185"><span class="linenos">185</span></a>            <span class="p">)</span>  <span class="c1"># move to beginning of the line with \r and then delete the whole line with \033[K</span>
</span><span id="OpticalChain-186"><a href="#OpticalChain-186"><span class="linenos">186</span></a>
</span><span id="OpticalChain-187"><a href="#OpticalChain-187"><span class="linenos">187</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_last_source_rays_hash</span> <span class="o">=</span> <span class="n">current_source_rays_hash</span>
</span><span id="OpticalChain-188"><a href="#OpticalChain-188"><span class="linenos">188</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_last_optical_elements_hash</span> <span class="o">=</span> <span class="n">current_optical_elements_hash</span>
</span><span id="OpticalChain-189"><a href="#OpticalChain-189"><span class="linenos">189</span></a>
</span><span id="OpticalChain-190"><a href="#OpticalChain-190"><span class="linenos">190</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_rays</span>
</span><span id="OpticalChain-191"><a href="#OpticalChain-191"><span class="linenos">191</span></a>    <span class="c1"># %%  methods to (mis-)align the optical chain; just uses the corresponding methods of the OpticalElement class...</span>
</span><span id="OpticalChain-192"><a href="#OpticalChain-192"><span class="linenos">192</span></a>
</span><span id="OpticalChain-193"><a href="#OpticalChain-193"><span class="linenos">193</span></a>    <span class="k">def</span> <span class="nf">shift_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">),</span> <span class="n">distance</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
</span><span id="OpticalChain-194"><a href="#OpticalChain-194"><span class="linenos">194</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="OpticalChain-195"><a href="#OpticalChain-195"><span class="linenos">195</span></a><span class="sd">        Shift source ray bundle by distance (in mm) along the &#39;axis&#39; specified as</span>
</span><span id="OpticalChain-196"><a href="#OpticalChain-196"><span class="linenos">196</span></a><span class="sd">        a lab-frame vector (numpy-array of length 3) or as one of the strings</span>
</span><span id="OpticalChain-197"><a href="#OpticalChain-197"><span class="linenos">197</span></a><span class="sd">        &quot;vert&quot;, &quot;horiz&quot;, or &quot;random&quot;.</span>
</span><span id="OpticalChain-198"><a href="#OpticalChain-198"><span class="linenos">198</span></a>
</span><span id="OpticalChain-199"><a href="#OpticalChain-199"><span class="linenos">199</span></a><span class="sd">        In the latter case, the reference is the incidence plane of the first</span>
</span><span id="OpticalChain-200"><a href="#OpticalChain-200"><span class="linenos">200</span></a><span class="sd">        non-normal-incidence mirror after the source. If there is none, you will</span>
</span><span id="OpticalChain-201"><a href="#OpticalChain-201"><span class="linenos">201</span></a><span class="sd">        be asked to rather specify the axis as a 3D-numpy-array.</span>
</span><span id="OpticalChain-202"><a href="#OpticalChain-202"><span class="linenos">202</span></a>
</span><span id="OpticalChain-203"><a href="#OpticalChain-203"><span class="linenos">203</span></a><span class="sd">        axis = &quot;vert&quot; means the source position is shifted along the axis perpendicular</span>
</span><span id="OpticalChain-204"><a href="#OpticalChain-204"><span class="linenos">204</span></a><span class="sd">        to that incidence plane, i.e. &quot;vertically&quot; away from the former incidence plane..</span>
</span><span id="OpticalChain-205"><a href="#OpticalChain-205"><span class="linenos">205</span></a>
</span><span id="OpticalChain-206"><a href="#OpticalChain-206"><span class="linenos">206</span></a><span class="sd">        axis = &quot;horiz&quot; means the source direciton is translated along thr axis in that</span>
</span><span id="OpticalChain-207"><a href="#OpticalChain-207"><span class="linenos">207</span></a><span class="sd">        incidence plane and perpendicular to the current source direction,</span>
</span><span id="OpticalChain-208"><a href="#OpticalChain-208"><span class="linenos">208</span></a><span class="sd">        i.e. &quot;horizontally&quot; in the incidence plane, but retaining the same distance</span>
</span><span id="OpticalChain-209"><a href="#OpticalChain-209"><span class="linenos">209</span></a><span class="sd">        of source and first optical element.</span>
</span><span id="OpticalChain-210"><a href="#OpticalChain-210"><span class="linenos">210</span></a>
</span><span id="OpticalChain-211"><a href="#OpticalChain-211"><span class="linenos">211</span></a><span class="sd">        axis = &quot;random&quot; means the the source direction shifted in a random direction</span>
</span><span id="OpticalChain-212"><a href="#OpticalChain-212"><span class="linenos">212</span></a><span class="sd">        within in the plane perpendicular to the current source direction,</span>
</span><span id="OpticalChain-213"><a href="#OpticalChain-213"><span class="linenos">213</span></a><span class="sd">        e.g. simulating a fluctuation of hte transverse source position.</span>
</span><span id="OpticalChain-214"><a href="#OpticalChain-214"><span class="linenos">214</span></a>
</span><span id="OpticalChain-215"><a href="#OpticalChain-215"><span class="linenos">215</span></a><span class="sd">        Parameters</span>
</span><span id="OpticalChain-216"><a href="#OpticalChain-216"><span class="linenos">216</span></a><span class="sd">        ----------</span>
</span><span id="OpticalChain-217"><a href="#OpticalChain-217"><span class="linenos">217</span></a><span class="sd">            axis : np.ndarray or str</span>
</span><span id="OpticalChain-218"><a href="#OpticalChain-218"><span class="linenos">218</span></a><span class="sd">                Shift axis, specified either as a 3D lab-frame vector or as one</span>
</span><span id="OpticalChain-219"><a href="#OpticalChain-219"><span class="linenos">219</span></a><span class="sd">                of the strings &quot;vert&quot;, &quot;horiz&quot;, or &quot;random&quot;.</span>
</span><span id="OpticalChain-220"><a href="#OpticalChain-220"><span class="linenos">220</span></a>
</span><span id="OpticalChain-221"><a href="#OpticalChain-221"><span class="linenos">221</span></a><span class="sd">            distance : float</span>
</span><span id="OpticalChain-222"><a href="#OpticalChain-222"><span class="linenos">222</span></a><span class="sd">                Shift distance in mm.</span>
</span><span id="OpticalChain-223"><a href="#OpticalChain-223"><span class="linenos">223</span></a>
</span><span id="OpticalChain-224"><a href="#OpticalChain-224"><span class="linenos">224</span></a><span class="sd">        Returns</span>
</span><span id="OpticalChain-225"><a href="#OpticalChain-225"><span class="linenos">225</span></a><span class="sd">        -------</span>
</span><span id="OpticalChain-226"><a href="#OpticalChain-226"><span class="linenos">226</span></a><span class="sd">            Nothing, just modifies the property &#39;source_rays&#39;.</span>
</span><span id="OpticalChain-227"><a href="#OpticalChain-227"><span class="linenos">227</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="OpticalChain-228"><a href="#OpticalChain-228"><span class="linenos">228</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
</span><span id="OpticalChain-229"><a href="#OpticalChain-229"><span class="linenos">229</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The &quot;distance&quot;-argument must be an int or float number.&#39;</span><span class="p">)</span>
</span><span id="OpticalChain-230"><a href="#OpticalChain-230"><span class="linenos">230</span></a>
</span><span id="OpticalChain-231"><a href="#OpticalChain-231"><span class="linenos">231</span></a>        <span class="n">central_ray_vector</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">FindCentralRay</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_rays</span><span class="p">)</span><span class="o">.</span><span class="n">vector</span>
</span><span id="OpticalChain-232"><a href="#OpticalChain-232"><span class="linenos">232</span></a>        <span class="n">mirror_indcs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">OE</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;Mirror&quot;</span> <span class="ow">in</span> <span class="n">OE</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">type</span><span class="p">]</span>
</span><span id="OpticalChain-233"><a href="#OpticalChain-233"><span class="linenos">233</span></a>
</span><span id="OpticalChain-234"><a href="#OpticalChain-234"><span class="linenos">234</span></a>        <span class="n">OEnormal</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="OpticalChain-235"><a href="#OpticalChain-235"><span class="linenos">235</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mirror_indcs</span><span class="p">:</span>
</span><span id="OpticalChain-236"><a href="#OpticalChain-236"><span class="linenos">236</span></a>            <span class="n">ith_OEnormal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span>
</span><span id="OpticalChain-237"><a href="#OpticalChain-237"><span class="linenos">237</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">central_ray_vector</span><span class="p">,</span> <span class="n">ith_OEnormal</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">1e-10</span><span class="p">:</span>
</span><span id="OpticalChain-238"><a href="#OpticalChain-238"><span class="linenos">238</span></a>                <span class="n">OEnormal</span> <span class="o">=</span> <span class="n">ith_OEnormal</span>
</span><span id="OpticalChain-239"><a href="#OpticalChain-239"><span class="linenos">239</span></a>                <span class="k">break</span>
</span><span id="OpticalChain-240"><a href="#OpticalChain-240"><span class="linenos">240</span></a>        <span class="k">if</span> <span class="n">OEnormal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="OpticalChain-241"><a href="#OpticalChain-241"><span class="linenos">241</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
</span><span id="OpticalChain-242"><a href="#OpticalChain-242"><span class="linenos">242</span></a>                <span class="s2">&quot;There doesn&#39;t seem to be a non-normal-incidence mirror in this optical chain, </span><span class="se">\</span>
</span><span id="OpticalChain-243"><a href="#OpticalChain-243"><span class="linenos">243</span></a><span class="s2">                            so you should rather give &#39;axis&#39; as a numpy-array of length 3.&quot;</span>
</span><span id="OpticalChain-244"><a href="#OpticalChain-244"><span class="linenos">244</span></a>            <span class="p">)</span>
</span><span id="OpticalChain-245"><a href="#OpticalChain-245"><span class="linenos">245</span></a>
</span><span id="OpticalChain-246"><a href="#OpticalChain-246"><span class="linenos">246</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="OpticalChain-247"><a href="#OpticalChain-247"><span class="linenos">247</span></a>            <span class="n">translation_vector</span> <span class="o">=</span> <span class="n">axis</span>
</span><span id="OpticalChain-248"><a href="#OpticalChain-248"><span class="linenos">248</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="OpticalChain-249"><a href="#OpticalChain-249"><span class="linenos">249</span></a>            <span class="n">perp_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">central_ray_vector</span><span class="p">,</span> <span class="n">OEnormal</span><span class="p">)</span>
</span><span id="OpticalChain-250"><a href="#OpticalChain-250"><span class="linenos">250</span></a>            <span class="n">horiz_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">perp_axis</span><span class="p">,</span> <span class="n">central_ray_vector</span><span class="p">)</span>
</span><span id="OpticalChain-251"><a href="#OpticalChain-251"><span class="linenos">251</span></a>
</span><span id="OpticalChain-252"><a href="#OpticalChain-252"><span class="linenos">252</span></a>            <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="s2">&quot;vert&quot;</span><span class="p">:</span>
</span><span id="OpticalChain-253"><a href="#OpticalChain-253"><span class="linenos">253</span></a>                <span class="n">translation_vector</span> <span class="o">=</span> <span class="n">perp_axis</span>
</span><span id="OpticalChain-254"><a href="#OpticalChain-254"><span class="linenos">254</span></a>            <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="s2">&quot;horiz&quot;</span><span class="p">:</span>
</span><span id="OpticalChain-255"><a href="#OpticalChain-255"><span class="linenos">255</span></a>                <span class="n">translation_vector</span> <span class="o">=</span> <span class="n">horiz_axis</span>
</span><span id="OpticalChain-256"><a href="#OpticalChain-256"><span class="linenos">256</span></a>            <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span>
</span><span id="OpticalChain-257"><a href="#OpticalChain-257"><span class="linenos">257</span></a>                <span class="n">translation_vector</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="OpticalChain-258"><a href="#OpticalChain-258"><span class="linenos">258</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">perp_axis</span>
</span><span id="OpticalChain-259"><a href="#OpticalChain-259"><span class="linenos">259</span></a>                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">horiz_axis</span>
</span><span id="OpticalChain-260"><a href="#OpticalChain-260"><span class="linenos">260</span></a>                <span class="p">)</span>
</span><span id="OpticalChain-261"><a href="#OpticalChain-261"><span class="linenos">261</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="OpticalChain-262"><a href="#OpticalChain-262"><span class="linenos">262</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="OpticalChain-263"><a href="#OpticalChain-263"><span class="linenos">263</span></a>                    <span class="s1">&#39;The shift direction must be specified by &quot;axis&quot; as one of [&quot;vert&quot;, &quot;horiz&quot;, &quot;random&quot;].&#39;</span>
</span><span id="OpticalChain-264"><a href="#OpticalChain-264"><span class="linenos">264</span></a>                <span class="p">)</span>
</span><span id="OpticalChain-265"><a href="#OpticalChain-265"><span class="linenos">265</span></a>
</span><span id="OpticalChain-266"><a href="#OpticalChain-266"><span class="linenos">266</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">source_rays</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">TranslationRayList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_rays</span><span class="p">,</span> <span class="n">distance</span> <span class="o">*</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">translation_vector</span><span class="p">))</span>
</span><span id="OpticalChain-267"><a href="#OpticalChain-267"><span class="linenos">267</span></a>
</span><span id="OpticalChain-268"><a href="#OpticalChain-268"><span class="linenos">268</span></a>    <span class="k">def</span> <span class="nf">tilt_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">),</span> <span class="n">angle</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
</span><span id="OpticalChain-269"><a href="#OpticalChain-269"><span class="linenos">269</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="OpticalChain-270"><a href="#OpticalChain-270"><span class="linenos">270</span></a><span class="sd">        Rotate source ray bundle by angle around an axis, specified as</span>
</span><span id="OpticalChain-271"><a href="#OpticalChain-271"><span class="linenos">271</span></a><span class="sd">        a lab-frame vector (numpy-array of length 3) or as one of the strings</span>
</span><span id="OpticalChain-272"><a href="#OpticalChain-272"><span class="linenos">272</span></a><span class="sd">        &quot;in_plane&quot;, &quot;out_plane&quot; or &quot;random&quot; direction.</span>
</span><span id="OpticalChain-273"><a href="#OpticalChain-273"><span class="linenos">273</span></a>
</span><span id="OpticalChain-274"><a href="#OpticalChain-274"><span class="linenos">274</span></a><span class="sd">        In the latter case, the function considers the incidence plane of the first</span>
</span><span id="OpticalChain-275"><a href="#OpticalChain-275"><span class="linenos">275</span></a><span class="sd">        non-normal-incidence mirror after the source. If there is none, you will</span>
</span><span id="OpticalChain-276"><a href="#OpticalChain-276"><span class="linenos">276</span></a><span class="sd">        be asked to rather specify the axis as a 3D-numpy-array.</span>
</span><span id="OpticalChain-277"><a href="#OpticalChain-277"><span class="linenos">277</span></a>
</span><span id="OpticalChain-278"><a href="#OpticalChain-278"><span class="linenos">278</span></a><span class="sd">        axis = &quot;in_plane&quot; means the source direction is rotated about an axis</span>
</span><span id="OpticalChain-279"><a href="#OpticalChain-279"><span class="linenos">279</span></a><span class="sd">        perpendicular to that incidence plane, which tilts the source</span>
</span><span id="OpticalChain-280"><a href="#OpticalChain-280"><span class="linenos">280</span></a><span class="sd">        &quot;horizontally&quot; in the same plane.</span>
</span><span id="OpticalChain-281"><a href="#OpticalChain-281"><span class="linenos">281</span></a>
</span><span id="OpticalChain-282"><a href="#OpticalChain-282"><span class="linenos">282</span></a><span class="sd">        axis = &quot;out_plane&quot; means the source direciton is rotated about an axis</span>
</span><span id="OpticalChain-283"><a href="#OpticalChain-283"><span class="linenos">283</span></a><span class="sd">        in that incidence plane and perpendicular to the current source direction,</span>
</span><span id="OpticalChain-284"><a href="#OpticalChain-284"><span class="linenos">284</span></a><span class="sd">        which tilts the source &quot;vertically&quot; out of the former incidence plane.</span>
</span><span id="OpticalChain-285"><a href="#OpticalChain-285"><span class="linenos">285</span></a>
</span><span id="OpticalChain-286"><a href="#OpticalChain-286"><span class="linenos">286</span></a><span class="sd">        axis = &quot;random&quot; means the the source direction is tilted in a random direction,</span>
</span><span id="OpticalChain-287"><a href="#OpticalChain-287"><span class="linenos">287</span></a><span class="sd">        e.g. simulating a beam pointing fluctuation.</span>
</span><span id="OpticalChain-288"><a href="#OpticalChain-288"><span class="linenos">288</span></a>
</span><span id="OpticalChain-289"><a href="#OpticalChain-289"><span class="linenos">289</span></a><span class="sd">        Attention, &quot;angle&quot; is given in deg, so as to remain consitent with the</span>
</span><span id="OpticalChain-290"><a href="#OpticalChain-290"><span class="linenos">290</span></a><span class="sd">        conventions of other functions, although pointing is mostly talked about</span>
</span><span id="OpticalChain-291"><a href="#OpticalChain-291"><span class="linenos">291</span></a><span class="sd">        in mrad instead.</span>
</span><span id="OpticalChain-292"><a href="#OpticalChain-292"><span class="linenos">292</span></a>
</span><span id="OpticalChain-293"><a href="#OpticalChain-293"><span class="linenos">293</span></a><span class="sd">        Parameters</span>
</span><span id="OpticalChain-294"><a href="#OpticalChain-294"><span class="linenos">294</span></a><span class="sd">        ----------</span>
</span><span id="OpticalChain-295"><a href="#OpticalChain-295"><span class="linenos">295</span></a><span class="sd">            axis : np.ndarray or str</span>
</span><span id="OpticalChain-296"><a href="#OpticalChain-296"><span class="linenos">296</span></a><span class="sd">                Shift axis, specified either as a 3D lab-frame vector or as one</span>
</span><span id="OpticalChain-297"><a href="#OpticalChain-297"><span class="linenos">297</span></a><span class="sd">                of the strings &quot;in_plane&quot;, &quot;out_plane&quot;, or &quot;random&quot;.</span>
</span><span id="OpticalChain-298"><a href="#OpticalChain-298"><span class="linenos">298</span></a>
</span><span id="OpticalChain-299"><a href="#OpticalChain-299"><span class="linenos">299</span></a><span class="sd">            angle : float</span>
</span><span id="OpticalChain-300"><a href="#OpticalChain-300"><span class="linenos">300</span></a><span class="sd">                Rotation angle in degree.</span>
</span><span id="OpticalChain-301"><a href="#OpticalChain-301"><span class="linenos">301</span></a>
</span><span id="OpticalChain-302"><a href="#OpticalChain-302"><span class="linenos">302</span></a><span class="sd">        Returns</span>
</span><span id="OpticalChain-303"><a href="#OpticalChain-303"><span class="linenos">303</span></a><span class="sd">        -------</span>
</span><span id="OpticalChain-304"><a href="#OpticalChain-304"><span class="linenos">304</span></a><span class="sd">            Nothing, just modifies the property &#39;source_rays&#39;.</span>
</span><span id="OpticalChain-305"><a href="#OpticalChain-305"><span class="linenos">305</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="OpticalChain-306"><a href="#OpticalChain-306"><span class="linenos">306</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
</span><span id="OpticalChain-307"><a href="#OpticalChain-307"><span class="linenos">307</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The &quot;angle&quot;-argument must be an int or float number.&#39;</span><span class="p">)</span>
</span><span id="OpticalChain-308"><a href="#OpticalChain-308"><span class="linenos">308</span></a>
</span><span id="OpticalChain-309"><a href="#OpticalChain-309"><span class="linenos">309</span></a>        <span class="n">central_ray_vector</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">FindCentralRay</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_rays</span><span class="p">)</span><span class="o">.</span><span class="n">vector</span>
</span><span id="OpticalChain-310"><a href="#OpticalChain-310"><span class="linenos">310</span></a>        <span class="n">mirror_indcs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">OE</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;Mirror&quot;</span> <span class="ow">in</span> <span class="n">OE</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">type</span><span class="p">]</span>
</span><span id="OpticalChain-311"><a href="#OpticalChain-311"><span class="linenos">311</span></a>
</span><span id="OpticalChain-312"><a href="#OpticalChain-312"><span class="linenos">312</span></a>        <span class="n">OEnormal</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="OpticalChain-313"><a href="#OpticalChain-313"><span class="linenos">313</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mirror_indcs</span><span class="p">:</span>
</span><span id="OpticalChain-314"><a href="#OpticalChain-314"><span class="linenos">314</span></a>            <span class="n">ith_OEnormal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span>
</span><span id="OpticalChain-315"><a href="#OpticalChain-315"><span class="linenos">315</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">central_ray_vector</span><span class="p">,</span> <span class="n">ith_OEnormal</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">1e-10</span><span class="p">:</span>
</span><span id="OpticalChain-316"><a href="#OpticalChain-316"><span class="linenos">316</span></a>                <span class="n">OEnormal</span> <span class="o">=</span> <span class="n">ith_OEnormal</span>
</span><span id="OpticalChain-317"><a href="#OpticalChain-317"><span class="linenos">317</span></a>                <span class="k">break</span>
</span><span id="OpticalChain-318"><a href="#OpticalChain-318"><span class="linenos">318</span></a>        <span class="k">if</span> <span class="n">OEnormal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="OpticalChain-319"><a href="#OpticalChain-319"><span class="linenos">319</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
</span><span id="OpticalChain-320"><a href="#OpticalChain-320"><span class="linenos">320</span></a>                <span class="s2">&quot;There doesn&#39;t seem to be a non-normal-incidence mirror in this optical chain, </span><span class="se">\</span>
</span><span id="OpticalChain-321"><a href="#OpticalChain-321"><span class="linenos">321</span></a><span class="s2">                            so you should rather give &#39;axis&#39; as a numpy-array of length 3.&quot;</span>
</span><span id="OpticalChain-322"><a href="#OpticalChain-322"><span class="linenos">322</span></a>            <span class="p">)</span>
</span><span id="OpticalChain-323"><a href="#OpticalChain-323"><span class="linenos">323</span></a>
</span><span id="OpticalChain-324"><a href="#OpticalChain-324"><span class="linenos">324</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="OpticalChain-325"><a href="#OpticalChain-325"><span class="linenos">325</span></a>            <span class="n">rot_axis</span> <span class="o">=</span> <span class="n">axis</span>
</span><span id="OpticalChain-326"><a href="#OpticalChain-326"><span class="linenos">326</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="OpticalChain-327"><a href="#OpticalChain-327"><span class="linenos">327</span></a>            <span class="n">rot_axis_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">central_ray_vector</span><span class="p">,</span> <span class="n">OEnormal</span><span class="p">)</span>
</span><span id="OpticalChain-328"><a href="#OpticalChain-328"><span class="linenos">328</span></a>            <span class="n">rot_axis_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">rot_axis_in</span><span class="p">,</span> <span class="n">central_ray_vector</span><span class="p">)</span>
</span><span id="OpticalChain-329"><a href="#OpticalChain-329"><span class="linenos">329</span></a>            <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="s2">&quot;in_plane&quot;</span><span class="p">:</span>
</span><span id="OpticalChain-330"><a href="#OpticalChain-330"><span class="linenos">330</span></a>                <span class="n">rot_axis</span> <span class="o">=</span> <span class="n">rot_axis_in</span>
</span><span id="OpticalChain-331"><a href="#OpticalChain-331"><span class="linenos">331</span></a>            <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="s2">&quot;out_plane&quot;</span><span class="p">:</span>
</span><span id="OpticalChain-332"><a href="#OpticalChain-332"><span class="linenos">332</span></a>                <span class="n">rot_axis</span> <span class="o">=</span> <span class="n">rot_axis_out</span>
</span><span id="OpticalChain-333"><a href="#OpticalChain-333"><span class="linenos">333</span></a>            <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span>
</span><span id="OpticalChain-334"><a href="#OpticalChain-334"><span class="linenos">334</span></a>                <span class="n">rot_axis</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="OpticalChain-335"><a href="#OpticalChain-335"><span class="linenos">335</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">rot_axis_in</span>
</span><span id="OpticalChain-336"><a href="#OpticalChain-336"><span class="linenos">336</span></a>                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">rot_axis_out</span>
</span><span id="OpticalChain-337"><a href="#OpticalChain-337"><span class="linenos">337</span></a>                <span class="p">)</span>
</span><span id="OpticalChain-338"><a href="#OpticalChain-338"><span class="linenos">338</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="OpticalChain-339"><a href="#OpticalChain-339"><span class="linenos">339</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="OpticalChain-340"><a href="#OpticalChain-340"><span class="linenos">340</span></a>                    <span class="s1">&#39;The tilt axis must be specified by as one of [&quot;in_plane&quot;, &quot;out_plane&quot;, &quot;random&quot;] or as a numpy-array of length 3.&#39;</span>
</span><span id="OpticalChain-341"><a href="#OpticalChain-341"><span class="linenos">341</span></a>                <span class="p">)</span>
</span><span id="OpticalChain-342"><a href="#OpticalChain-342"><span class="linenos">342</span></a>
</span><span id="OpticalChain-343"><a href="#OpticalChain-343"><span class="linenos">343</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">source_rays</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">RotationAroundAxisRayList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_rays</span><span class="p">,</span> <span class="n">rot_axis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span>
</span><span id="OpticalChain-344"><a href="#OpticalChain-344"><span class="linenos">344</span></a>
</span><span id="OpticalChain-345"><a href="#OpticalChain-345"><span class="linenos">345</span></a>    <span class="k">def</span> <span class="nf">partial_realign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OEstart</span><span class="p">,</span> <span class="n">OEstop</span><span class="p">,</span> <span class="n">DistanceList</span><span class="p">,</span> <span class="n">IncidenceAngleList</span><span class="p">,</span> <span class="n">IncidencePlaneAngleList</span><span class="p">):</span>
</span><span id="OpticalChain-346"><a href="#OpticalChain-346"><span class="linenos">346</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="OpticalChain-347"><a href="#OpticalChain-347"><span class="linenos">347</span></a><span class="sd">        This as-of-yet not-implemented method will realign only the parts of the optical chain that are between the elements</span>
</span><span id="OpticalChain-348"><a href="#OpticalChain-348"><span class="linenos">348</span></a><span class="sd">        OEstart and OEstop (both included).</span>
</span><span id="OpticalChain-349"><a href="#OpticalChain-349"><span class="linenos">349</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="OpticalChain-350"><a href="#OpticalChain-350"><span class="linenos">350</span></a>        <span class="n">OpticsList</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">[</span><span class="n">OEstart</span><span class="p">:</span><span class="n">OEstop</span><span class="p">]]</span>
</span><span id="OpticalChain-351"><a href="#OpticalChain-351"><span class="linenos">351</span></a>        <span class="n">outray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_output_rays</span><span class="p">()[</span><span class="n">OEstart</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="OpticalChain-352"><a href="#OpticalChain-352"><span class="linenos">352</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">outray</span><span class="p">)</span>
</span><span id="OpticalChain-353"><a href="#OpticalChain-353"><span class="linenos">353</span></a>        <span class="n">new_elements</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">OEPlacement</span><span class="p">(</span><span class="n">OpticsList</span><span class="p">,</span> <span class="n">DistanceList</span><span class="p">,</span> <span class="n">IncidenceAngleList</span><span class="p">,</span> <span class="n">IncidencePlaneAngleList</span><span class="p">,</span> <span class="n">outray</span><span class="p">)</span>
</span><span id="OpticalChain-354"><a href="#OpticalChain-354"><span class="linenos">354</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">[</span><span class="n">OEstart</span><span class="p">:</span><span class="n">OEstop</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_elements</span>
</span><span id="OpticalChain-355"><a href="#OpticalChain-355"><span class="linenos">355</span></a>        
</span><span id="OpticalChain-356"><a href="#OpticalChain-356"><span class="linenos">356</span></a>    <span class="c1"># %%</span>
</span><span id="OpticalChain-357"><a href="#OpticalChain-357"><span class="linenos">357</span></a>    <span class="k">def</span> <span class="nf">rotate_OE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OEindx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">angle</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
</span><span id="OpticalChain-358"><a href="#OpticalChain-358"><span class="linenos">358</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="OpticalChain-359"><a href="#OpticalChain-359"><span class="linenos">359</span></a><span class="sd">        Rotate the optical element OpticalChain.optical_elements[OEindx] with an axis defined relative to the master ray.</span>
</span><span id="OpticalChain-360"><a href="#OpticalChain-360"><span class="linenos">360</span></a><span class="sd">        The axis can either be relative to the incoming master ray or the outgoing one. This is defined  by the &quot;ref&quot; variable </span>
</span><span id="OpticalChain-361"><a href="#OpticalChain-361"><span class="linenos">361</span></a><span class="sd">        that takes either of the two values:</span>
</span><span id="OpticalChain-362"><a href="#OpticalChain-362"><span class="linenos">362</span></a><span class="sd">            - &quot;in&quot;</span>
</span><span id="OpticalChain-363"><a href="#OpticalChain-363"><span class="linenos">363</span></a><span class="sd">            - &quot;out&quot;</span>
</span><span id="OpticalChain-364"><a href="#OpticalChain-364"><span class="linenos">364</span></a><span class="sd">        In either case the &quot;axis&quot; can take these values:</span>
</span><span id="OpticalChain-365"><a href="#OpticalChain-365"><span class="linenos">365</span></a><span class="sd">            - &quot;roll&quot;: Rotation about the master ray. Looking in the same direction as light propagation, positive is counterclockwise</span>
</span><span id="OpticalChain-366"><a href="#OpticalChain-366"><span class="linenos">366</span></a><span class="sd">            - &quot;pitch&quot;: Rotation about the vector in the incidence plane that is normal to the master ray.</span>
</span><span id="OpticalChain-367"><a href="#OpticalChain-367"><span class="linenos">367</span></a><span class="sd">            - &quot;yaw&quot;: Rotation about the vector normal to the incidence plane and to the master ray.</span>
</span><span id="OpticalChain-368"><a href="#OpticalChain-368"><span class="linenos">368</span></a>
</span><span id="OpticalChain-369"><a href="#OpticalChain-369"><span class="linenos">369</span></a><span class="sd">        Parameters</span>
</span><span id="OpticalChain-370"><a href="#OpticalChain-370"><span class="linenos">370</span></a><span class="sd">        ----------</span>
</span><span id="OpticalChain-371"><a href="#OpticalChain-371"><span class="linenos">371</span></a><span class="sd">            OEindx : int</span>
</span><span id="OpticalChain-372"><a href="#OpticalChain-372"><span class="linenos">372</span></a><span class="sd">                Index of the optical element to modify out of OpticalChain.optical_elements.</span>
</span><span id="OpticalChain-373"><a href="#OpticalChain-373"><span class="linenos">373</span></a>
</span><span id="OpticalChain-374"><a href="#OpticalChain-374"><span class="linenos">374</span></a><span class="sd">            ref : str</span>
</span><span id="OpticalChain-375"><a href="#OpticalChain-375"><span class="linenos">375</span></a><span class="sd">                Reference ray used to define the axes of rotation. Can be either:</span>
</span><span id="OpticalChain-376"><a href="#OpticalChain-376"><span class="linenos">376</span></a><span class="sd">                &quot;in&quot; or &quot;out&quot; or &quot;local_normal&quot; (in+out)</span>
</span><span id="OpticalChain-377"><a href="#OpticalChain-377"><span class="linenos">377</span></a>
</span><span id="OpticalChain-378"><a href="#OpticalChain-378"><span class="linenos">378</span></a><span class="sd">            axis : str</span>
</span><span id="OpticalChain-379"><a href="#OpticalChain-379"><span class="linenos">379</span></a><span class="sd">                Rotation axis, specified as one of the strings</span>
</span><span id="OpticalChain-380"><a href="#OpticalChain-380"><span class="linenos">380</span></a><span class="sd">                &quot;pitch&quot;, &quot;roll&quot;, &quot;yaw&quot;</span>
</span><span id="OpticalChain-381"><a href="#OpticalChain-381"><span class="linenos">381</span></a>
</span><span id="OpticalChain-382"><a href="#OpticalChain-382"><span class="linenos">382</span></a><span class="sd">            angle : float</span>
</span><span id="OpticalChain-383"><a href="#OpticalChain-383"><span class="linenos">383</span></a><span class="sd">                Rotation angle in degree.</span>
</span><span id="OpticalChain-384"><a href="#OpticalChain-384"><span class="linenos">384</span></a>
</span><span id="OpticalChain-385"><a href="#OpticalChain-385"><span class="linenos">385</span></a><span class="sd">        Returns</span>
</span><span id="OpticalChain-386"><a href="#OpticalChain-386"><span class="linenos">386</span></a><span class="sd">        -------</span>
</span><span id="OpticalChain-387"><a href="#OpticalChain-387"><span class="linenos">387</span></a><span class="sd">            Nothing, just modifies OpticalChain.optical_elements[OEindx].</span>
</span><span id="OpticalChain-388"><a href="#OpticalChain-388"><span class="linenos">388</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="OpticalChain-389"><a href="#OpticalChain-389"><span class="linenos">389</span></a>        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">OEindx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">):</span>
</span><span id="OpticalChain-390"><a href="#OpticalChain-390"><span class="linenos">390</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="OpticalChain-391"><a href="#OpticalChain-391"><span class="linenos">391</span></a>                <span class="s1">&#39;The &quot;OEnumber&quot;-argument is out of range compared to the length of OpticalChain.optical_elements.&#39;</span>
</span><span id="OpticalChain-392"><a href="#OpticalChain-392"><span class="linenos">392</span></a>            <span class="p">)</span>
</span><span id="OpticalChain-393"><a href="#OpticalChain-393"><span class="linenos">393</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
</span><span id="OpticalChain-394"><a href="#OpticalChain-394"><span class="linenos">394</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The &quot;angle&quot;-argument must be an int or float number.&#39;</span><span class="p">)</span>
</span><span id="OpticalChain-395"><a href="#OpticalChain-395"><span class="linenos">395</span></a>        <span class="n">MasterRay</span> <span class="o">=</span> <span class="p">[</span><span class="n">mp</span><span class="o">.</span><span class="n">FindCentralRay</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_rays</span><span class="p">)]</span>
</span><span id="OpticalChain-396"><a href="#OpticalChain-396"><span class="linenos">396</span></a>        <span class="n">TracedRay</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">RayTracingCalculation</span><span class="p">(</span><span class="n">MasterRay</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">)</span>
</span><span id="OpticalChain-397"><a href="#OpticalChain-397"><span class="linenos">397</span></a>        <span class="n">TracedRay</span> <span class="o">=</span> <span class="p">[</span><span class="n">MasterRay</span><span class="p">]</span> <span class="o">+</span> <span class="n">TracedRay</span>
</span><span id="OpticalChain-398"><a href="#OpticalChain-398"><span class="linenos">398</span></a>        <span class="k">match</span> <span class="n">ref</span><span class="p">:</span>
</span><span id="OpticalChain-399"><a href="#OpticalChain-399"><span class="linenos">399</span></a>            <span class="k">case</span> <span class="s2">&quot;out&quot;</span><span class="p">:</span>
</span><span id="OpticalChain-400"><a href="#OpticalChain-400"><span class="linenos">400</span></a>                <span class="n">RefVec</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">TracedRay</span><span class="p">[</span><span class="n">OEindx</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vector</span><span class="p">)</span>
</span><span id="OpticalChain-401"><a href="#OpticalChain-401"><span class="linenos">401</span></a>            <span class="k">case</span> <span class="s2">&quot;in&quot;</span><span class="p">:</span>
</span><span id="OpticalChain-402"><a href="#OpticalChain-402"><span class="linenos">402</span></a>                <span class="n">RefVec</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">TracedRay</span><span class="p">[</span><span class="n">OEindx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vector</span><span class="p">)</span>
</span><span id="OpticalChain-403"><a href="#OpticalChain-403"><span class="linenos">403</span></a>            <span class="k">case</span> <span class="s2">&quot;localnormal&quot;</span><span class="p">:</span>
</span><span id="OpticalChain-404"><a href="#OpticalChain-404"><span class="linenos">404</span></a>                <span class="n">In</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">TracedRay</span><span class="p">[</span><span class="n">OEindx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vector</span><span class="p">)</span>
</span><span id="OpticalChain-405"><a href="#OpticalChain-405"><span class="linenos">405</span></a>                <span class="n">Out</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">TracedRay</span><span class="p">[</span><span class="n">OEindx</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vector</span><span class="p">)</span>
</span><span id="OpticalChain-406"><a href="#OpticalChain-406"><span class="linenos">406</span></a>                <span class="n">RefVec</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">Out</span><span class="o">-</span><span class="n">In</span><span class="p">)</span>
</span><span id="OpticalChain-407"><a href="#OpticalChain-407"><span class="linenos">407</span></a>            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
</span><span id="OpticalChain-408"><a href="#OpticalChain-408"><span class="linenos">408</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The &quot;ref&quot;-argument must be a string out of [&quot;in&quot;, &quot;out&quot;, &quot;localnormal].&#39;</span><span class="p">)</span>
</span><span id="OpticalChain-409"><a href="#OpticalChain-409"><span class="linenos">409</span></a>        <span class="k">if</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span><span class="p">,</span><span class="n">RefVec</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-2</span><span class="p">:</span>
</span><span id="OpticalChain-410"><a href="#OpticalChain-410"><span class="linenos">410</span></a>            <span class="k">match</span> <span class="n">axis</span><span class="p">:</span>
</span><span id="OpticalChain-411"><a href="#OpticalChain-411"><span class="linenos">411</span></a>                <span class="k">case</span> <span class="s2">&quot;pitch&quot;</span><span class="p">:</span>
</span><span id="OpticalChain-412"><a href="#OpticalChain-412"><span class="linenos">412</span></a>                    <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">RotationAroundAxis</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">majoraxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span><span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span><span class="p">)</span>
</span><span id="OpticalChain-413"><a href="#OpticalChain-413"><span class="linenos">413</span></a>                <span class="k">case</span> <span class="s2">&quot;roll&quot;</span><span class="p">:</span>
</span><span id="OpticalChain-414"><a href="#OpticalChain-414"><span class="linenos">414</span></a>                    <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">RotationAroundAxis</span><span class="p">(</span><span class="n">RefVec</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span><span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span><span class="p">)</span>
</span><span id="OpticalChain-415"><a href="#OpticalChain-415"><span class="linenos">415</span></a>                <span class="k">case</span> <span class="s2">&quot;yaw&quot;</span><span class="p">:</span>
</span><span id="OpticalChain-416"><a href="#OpticalChain-416"><span class="linenos">416</span></a>                    <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">RotationAroundAxis</span><span class="p">(</span><span class="n">mgeo</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">RefVec</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">majoraxis</span><span class="p">)),</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span><span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span><span class="p">)</span>
</span><span id="OpticalChain-417"><a href="#OpticalChain-417"><span class="linenos">417</span></a>                <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
</span><span id="OpticalChain-418"><a href="#OpticalChain-418"><span class="linenos">418</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The &quot;axis&quot;-argument must be a string out of [&quot;pitch&quot;, &quot;roll&quot;, &quot;yaw&quot;].&#39;</span><span class="p">)</span>
</span><span id="OpticalChain-419"><a href="#OpticalChain-419"><span class="linenos">419</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="OpticalChain-420"><a href="#OpticalChain-420"><span class="linenos">420</span></a>            <span class="c1">#If the normal vector is aligned with the ray</span>
</span><span id="OpticalChain-421"><a href="#OpticalChain-421"><span class="linenos">421</span></a>            <span class="k">match</span> <span class="n">axis</span><span class="p">:</span>
</span><span id="OpticalChain-422"><a href="#OpticalChain-422"><span class="linenos">422</span></a>                <span class="k">case</span> <span class="s2">&quot;pitch&quot;</span><span class="p">:</span>
</span><span id="OpticalChain-423"><a href="#OpticalChain-423"><span class="linenos">423</span></a>                    <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">RotationAroundAxis</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">majoraxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span><span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span><span class="p">)</span>
</span><span id="OpticalChain-424"><a href="#OpticalChain-424"><span class="linenos">424</span></a>                <span class="k">case</span> <span class="s2">&quot;roll&quot;</span><span class="p">:</span>
</span><span id="OpticalChain-425"><a href="#OpticalChain-425"><span class="linenos">425</span></a>                    <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">majoraxis</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">RotationAroundAxis</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span><span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">majoraxis</span><span class="p">)</span>
</span><span id="OpticalChain-426"><a href="#OpticalChain-426"><span class="linenos">426</span></a>                <span class="k">case</span> <span class="s2">&quot;yaw&quot;</span><span class="p">:</span>
</span><span id="OpticalChain-427"><a href="#OpticalChain-427"><span class="linenos">427</span></a>                    <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">RotationAroundAxis</span><span class="p">(</span><span class="n">mgeo</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">RefVec</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">majoraxis</span><span class="p">)),</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span><span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span><span class="p">)</span>
</span><span id="OpticalChain-428"><a href="#OpticalChain-428"><span class="linenos">428</span></a>                <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
</span><span id="OpticalChain-429"><a href="#OpticalChain-429"><span class="linenos">429</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The &quot;axis&quot;-argument must be a string out of [&quot;pitch&quot;, &quot;roll&quot;, &quot;yaw&quot;].&#39;</span><span class="p">)</span>
</span><span id="OpticalChain-430"><a href="#OpticalChain-430"><span class="linenos">430</span></a>
</span><span id="OpticalChain-431"><a href="#OpticalChain-431"><span class="linenos">431</span></a>    <span class="k">def</span> <span class="nf">shift_OE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OEindx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">distance</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
</span><span id="OpticalChain-432"><a href="#OpticalChain-432"><span class="linenos">432</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="OpticalChain-433"><a href="#OpticalChain-433"><span class="linenos">433</span></a><span class="sd">        Shift the optical element OpticalChain.optical_elements[OEindx] along</span>
</span><span id="OpticalChain-434"><a href="#OpticalChain-434"><span class="linenos">434</span></a><span class="sd">        axis referenced to the master ray.</span>
</span><span id="OpticalChain-435"><a href="#OpticalChain-435"><span class="linenos">435</span></a>
</span><span id="OpticalChain-436"><a href="#OpticalChain-436"><span class="linenos">436</span></a><span class="sd">        The axis can either be relative to the incoming master ray or the outgoing one. This is defined  by the &quot;ref&quot; variable </span>
</span><span id="OpticalChain-437"><a href="#OpticalChain-437"><span class="linenos">437</span></a><span class="sd">        that takes either of the two values:</span>
</span><span id="OpticalChain-438"><a href="#OpticalChain-438"><span class="linenos">438</span></a><span class="sd">            - &quot;in&quot;</span>
</span><span id="OpticalChain-439"><a href="#OpticalChain-439"><span class="linenos">439</span></a><span class="sd">            - &quot;out&quot;</span>
</span><span id="OpticalChain-440"><a href="#OpticalChain-440"><span class="linenos">440</span></a><span class="sd">        In either case the &quot;axis&quot; can take these values:</span>
</span><span id="OpticalChain-441"><a href="#OpticalChain-441"><span class="linenos">441</span></a><span class="sd">            - &quot;along&quot;: Translation along the master ray.</span>
</span><span id="OpticalChain-442"><a href="#OpticalChain-442"><span class="linenos">442</span></a><span class="sd">            - &quot;in_plane&quot;: Translation along the vector in the incidence plane that is normal to the master ray.</span>
</span><span id="OpticalChain-443"><a href="#OpticalChain-443"><span class="linenos">443</span></a><span class="sd">            - &quot;out_plane&quot;: Translation along the vector normal to the incidence plane and to the master ray.</span>
</span><span id="OpticalChain-444"><a href="#OpticalChain-444"><span class="linenos">444</span></a>
</span><span id="OpticalChain-445"><a href="#OpticalChain-445"><span class="linenos">445</span></a><span class="sd">        Parameters</span>
</span><span id="OpticalChain-446"><a href="#OpticalChain-446"><span class="linenos">446</span></a><span class="sd">        ----------</span>
</span><span id="OpticalChain-447"><a href="#OpticalChain-447"><span class="linenos">447</span></a><span class="sd">            OEindx : int</span>
</span><span id="OpticalChain-448"><a href="#OpticalChain-448"><span class="linenos">448</span></a><span class="sd">                Index of the optical element to modify out of OpticalChain.optical_elements.</span>
</span><span id="OpticalChain-449"><a href="#OpticalChain-449"><span class="linenos">449</span></a>
</span><span id="OpticalChain-450"><a href="#OpticalChain-450"><span class="linenos">450</span></a><span class="sd">            ref : str</span>
</span><span id="OpticalChain-451"><a href="#OpticalChain-451"><span class="linenos">451</span></a><span class="sd">                Reference ray used to define the axes of rotation. Can be either:</span>
</span><span id="OpticalChain-452"><a href="#OpticalChain-452"><span class="linenos">452</span></a><span class="sd">                &quot;in&quot; or &quot;out&quot;.</span>
</span><span id="OpticalChain-453"><a href="#OpticalChain-453"><span class="linenos">453</span></a>
</span><span id="OpticalChain-454"><a href="#OpticalChain-454"><span class="linenos">454</span></a><span class="sd">            axis : str</span>
</span><span id="OpticalChain-455"><a href="#OpticalChain-455"><span class="linenos">455</span></a><span class="sd">                Translation axis, specified as one of the strings</span>
</span><span id="OpticalChain-456"><a href="#OpticalChain-456"><span class="linenos">456</span></a><span class="sd">                &quot;along&quot;, &quot;in_plane&quot;, &quot;out_plane&quot;.</span>
</span><span id="OpticalChain-457"><a href="#OpticalChain-457"><span class="linenos">457</span></a>
</span><span id="OpticalChain-458"><a href="#OpticalChain-458"><span class="linenos">458</span></a><span class="sd">            distance : float</span>
</span><span id="OpticalChain-459"><a href="#OpticalChain-459"><span class="linenos">459</span></a><span class="sd">                Rotation angle in degree.</span>
</span><span id="OpticalChain-460"><a href="#OpticalChain-460"><span class="linenos">460</span></a>
</span><span id="OpticalChain-461"><a href="#OpticalChain-461"><span class="linenos">461</span></a><span class="sd">        Returns</span>
</span><span id="OpticalChain-462"><a href="#OpticalChain-462"><span class="linenos">462</span></a><span class="sd">        -------</span>
</span><span id="OpticalChain-463"><a href="#OpticalChain-463"><span class="linenos">463</span></a><span class="sd">            Nothing, just modifies OpticalChain.optical_elements[OEindx].</span>
</span><span id="OpticalChain-464"><a href="#OpticalChain-464"><span class="linenos">464</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="OpticalChain-465"><a href="#OpticalChain-465"><span class="linenos">465</span></a>        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">OEindx</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">):</span>
</span><span id="OpticalChain-466"><a href="#OpticalChain-466"><span class="linenos">466</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="OpticalChain-467"><a href="#OpticalChain-467"><span class="linenos">467</span></a>                <span class="s1">&#39;The &quot;OEnumber&quot;-argument is out of range compared to the length of OpticalChain.optical_elements.&#39;</span>
</span><span id="OpticalChain-468"><a href="#OpticalChain-468"><span class="linenos">468</span></a>            <span class="p">)</span>
</span><span id="OpticalChain-469"><a href="#OpticalChain-469"><span class="linenos">469</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
</span><span id="OpticalChain-470"><a href="#OpticalChain-470"><span class="linenos">470</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The &quot;dist&quot;-argument must be an int or float number.&#39;</span><span class="p">)</span>
</span><span id="OpticalChain-471"><a href="#OpticalChain-471"><span class="linenos">471</span></a>
</span><span id="OpticalChain-472"><a href="#OpticalChain-472"><span class="linenos">472</span></a>        <span class="n">MasterRay</span> <span class="o">=</span> <span class="p">[</span><span class="n">mp</span><span class="o">.</span><span class="n">FindCentralRay</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_rays</span><span class="p">)]</span>
</span><span id="OpticalChain-473"><a href="#OpticalChain-473"><span class="linenos">473</span></a>        <span class="n">TracedRay</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">RayTracingCalculation</span><span class="p">(</span><span class="n">MasterRay</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">)</span>
</span><span id="OpticalChain-474"><a href="#OpticalChain-474"><span class="linenos">474</span></a>        <span class="n">TracedRay</span> <span class="o">=</span> <span class="p">[</span><span class="n">MasterRay</span><span class="p">]</span> <span class="o">+</span> <span class="n">TracedRay</span>
</span><span id="OpticalChain-475"><a href="#OpticalChain-475"><span class="linenos">475</span></a>        <span class="k">match</span> <span class="n">ref</span><span class="p">:</span>
</span><span id="OpticalChain-476"><a href="#OpticalChain-476"><span class="linenos">476</span></a>            <span class="k">case</span> <span class="s2">&quot;out&quot;</span><span class="p">:</span>
</span><span id="OpticalChain-477"><a href="#OpticalChain-477"><span class="linenos">477</span></a>                <span class="n">RefVec</span> <span class="o">=</span> <span class="n">TracedRay</span><span class="p">[</span><span class="n">OEindx</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vector</span>
</span><span id="OpticalChain-478"><a href="#OpticalChain-478"><span class="linenos">478</span></a>            <span class="k">case</span> <span class="s2">&quot;in&quot;</span><span class="p">:</span>
</span><span id="OpticalChain-479"><a href="#OpticalChain-479"><span class="linenos">479</span></a>                <span class="n">RefVec</span> <span class="o">=</span> <span class="n">TracedRay</span><span class="p">[</span><span class="n">OEindx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vector</span>
</span><span id="OpticalChain-480"><a href="#OpticalChain-480"><span class="linenos">480</span></a>            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
</span><span id="OpticalChain-481"><a href="#OpticalChain-481"><span class="linenos">481</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The &quot;ref&quot;-argument must be a string out of [&quot;in&quot;, &quot;out&quot;].&#39;</span><span class="p">)</span>
</span><span id="OpticalChain-482"><a href="#OpticalChain-482"><span class="linenos">482</span></a>        <span class="k">match</span> <span class="n">axis</span><span class="p">:</span>
</span><span id="OpticalChain-483"><a href="#OpticalChain-483"><span class="linenos">483</span></a>            <span class="k">case</span> <span class="s2">&quot;along&quot;</span><span class="p">:</span>
</span><span id="OpticalChain-484"><a href="#OpticalChain-484"><span class="linenos">484</span></a>                <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">position</span> <span class="o">+</span> <span class="n">distance</span> <span class="o">*</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">RefVec</span><span class="p">)</span>
</span><span id="OpticalChain-485"><a href="#OpticalChain-485"><span class="linenos">485</span></a>            <span class="k">case</span> <span class="s2">&quot;in_plane&quot;</span><span class="p">:</span>
</span><span id="OpticalChain-486"><a href="#OpticalChain-486"><span class="linenos">486</span></a>                <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">position</span> <span class="o">+</span> <span class="n">distance</span> <span class="o">*</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">RefVec</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">RefVec</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span><span class="p">)))</span>
</span><span id="OpticalChain-487"><a href="#OpticalChain-487"><span class="linenos">487</span></a>            <span class="k">case</span> <span class="s2">&quot;out_plane&quot;</span><span class="p">:</span>
</span><span id="OpticalChain-488"><a href="#OpticalChain-488"><span class="linenos">488</span></a>                <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">position</span> <span class="o">+</span> <span class="n">distance</span> <span class="o">*</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">RefVec</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span><span class="p">))</span>
</span><span id="OpticalChain-489"><a href="#OpticalChain-489"><span class="linenos">489</span></a>            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
</span><span id="OpticalChain-490"><a href="#OpticalChain-490"><span class="linenos">490</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The &quot;axis&quot;-argument must be a string out of [&quot;along&quot;, &quot;in_plane&quot;, &quot;out_plane&quot;].&#39;</span><span class="p">)</span>
</span><span id="OpticalChain-491"><a href="#OpticalChain-491"><span class="linenos">491</span></a>
</span><span id="OpticalChain-492"><a href="#OpticalChain-492"><span class="linenos">492</span></a>        <span class="c1"># some function that randomly misalings one, or several or all ?</span>
</span></pre></div>


            <div class="docstring"><p>The OpticalChain represents the whole optical setup to be simulated:
Its main attributes are a list source-<a href="ModuleOpticalRay.html">Rays</a> and
a list of successive <a href="ModuleOpticalElement.html">OpticalElements</a>.</p>

<p>The method <a href="#OpticalChain.get_output_rays">OpticalChain.get_output_rays()</a> returns an associated list of lists of
<a href="ModuleOpticalRay.html">Rays</a>, each calculated by ray-tracing from one
<a href="ModuleOpticalElement.html">OpticalElement</a> to the next.
So <a href="#OpticalChain.get_output_rays">OpticalChain.get_output_rays()</a>[i] is the bundle of <a href="ModuleOpticalRay.html">Rays</a> <em>after</em>
optical_elements[i].</p>

<p>The string "description" can contain a short description of the optical setup, or similar notes.</p>

<p>The OpticalChain can be visualized quickly with the method OpticalChain.quickshow(),
and more nicely with OpticalChain.render().</p>

<p>The class also provides methods for (mis-)alignment of the source-<a href="ModuleOpticalRay.html">Ray</a>-bundle and the
<a href="ModuleOpticalElement.html">OpticalElements</a>, as well as methods for producing
a list of OpticalChain-objects containing variations of itself.</p>

<h2 id="attributes">Attributes</h2>

<pre><code>source_rays : list[mray.Ray]
    List of source rays, which are to be traced.

optical_elements : list[moe.OpticalElement]
    List of successive optical elements.

description : str
    A string to describe the optical setup.
</code></pre>

<h2 id="methods">Methods</h2>

<pre><code>copy_chain()

get_output_rays()

quickshow()

render()

----------

shift_source(axis, distance)

tilt_source(self, axis, angle)

get_source_loop_list(axis, loop_variable_values)

----------

rotate_OE(OEindx, axis, angle)

shift_OE(OEindx, axis, distance)

get_OE_loop_list(OEindx, axis, loop_variable_values)
</code></pre>
</div>


                            <div id="OpticalChain.__init__" class="classattr">
                                        <input id="OpticalChain.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">OpticalChain</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">source_rays</span>, </span><span class="param"><span class="n">optical_elements</span>, </span><span class="param"><span class="n">description</span><span class="o">=</span><span class="s1">&#39;&#39;</span></span>)</span>

                <label class="view-source-button" for="OpticalChain.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#OpticalChain.__init__"></a>
            <div class="chroma pdoc-code"><pre><span></span><span id="OpticalChain.__init__-87"><a href="#OpticalChain.__init__-87"><span class="linenos"> 87</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_rays</span><span class="p">,</span> <span class="n">optical_elements</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
</span><span id="OpticalChain.__init__-88"><a href="#OpticalChain.__init__-88"><span class="linenos"> 88</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="OpticalChain.__init__-89"><a href="#OpticalChain.__init__-89"><span class="linenos"> 89</span></a><span class="sd">        Parameters</span>
</span><span id="OpticalChain.__init__-90"><a href="#OpticalChain.__init__-90"><span class="linenos"> 90</span></a><span class="sd">        ----------</span>
</span><span id="OpticalChain.__init__-91"><a href="#OpticalChain.__init__-91"><span class="linenos"> 91</span></a><span class="sd">            source_rays : list[mray.Ray]</span>
</span><span id="OpticalChain.__init__-92"><a href="#OpticalChain.__init__-92"><span class="linenos"> 92</span></a><span class="sd">                List of source rays, which are to be traced.</span>
</span><span id="OpticalChain.__init__-93"><a href="#OpticalChain.__init__-93"><span class="linenos"> 93</span></a>
</span><span id="OpticalChain.__init__-94"><a href="#OpticalChain.__init__-94"><span class="linenos"> 94</span></a><span class="sd">            optical_elements : list[moe.OpticalElement]</span>
</span><span id="OpticalChain.__init__-95"><a href="#OpticalChain.__init__-95"><span class="linenos"> 95</span></a><span class="sd">                List of successive optical elements.</span>
</span><span id="OpticalChain.__init__-96"><a href="#OpticalChain.__init__-96"><span class="linenos"> 96</span></a>
</span><span id="OpticalChain.__init__-97"><a href="#OpticalChain.__init__-97"><span class="linenos"> 97</span></a><span class="sd">            description : str, optional</span>
</span><span id="OpticalChain.__init__-98"><a href="#OpticalChain.__init__-98"><span class="linenos"> 98</span></a><span class="sd">                A string to describe the optical setup. Defaults to &#39;&#39;.</span>
</span><span id="OpticalChain.__init__-99"><a href="#OpticalChain.__init__-99"><span class="linenos"> 99</span></a>
</span><span id="OpticalChain.__init__-100"><a href="#OpticalChain.__init__-100"><span class="linenos">100</span></a><span class="sd">            loop_variable_name : str, optional</span>
</span><span id="OpticalChain.__init__-101"><a href="#OpticalChain.__init__-101"><span class="linenos">101</span></a><span class="sd">                A string naming a parameter that is varied in a list of OpticalChain-objects.</span>
</span><span id="OpticalChain.__init__-102"><a href="#OpticalChain.__init__-102"><span class="linenos">102</span></a><span class="sd">                Defaults to None.</span>
</span><span id="OpticalChain.__init__-103"><a href="#OpticalChain.__init__-103"><span class="linenos">103</span></a>
</span><span id="OpticalChain.__init__-104"><a href="#OpticalChain.__init__-104"><span class="linenos">104</span></a><span class="sd">            loop_variable_value : float</span>
</span><span id="OpticalChain.__init__-105"><a href="#OpticalChain.__init__-105"><span class="linenos">105</span></a><span class="sd">                The value of that varied parameter, which is useful when looping over</span>
</span><span id="OpticalChain.__init__-106"><a href="#OpticalChain.__init__-106"><span class="linenos">106</span></a><span class="sd">                variations of an initial configuration. Defaults to None.</span>
</span><span id="OpticalChain.__init__-107"><a href="#OpticalChain.__init__-107"><span class="linenos">107</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="OpticalChain.__init__-108"><a href="#OpticalChain.__init__-108"><span class="linenos">108</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">source_rays</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">source_rays</span><span class="p">)</span>
</span><span id="OpticalChain.__init__-109"><a href="#OpticalChain.__init__-109"><span class="linenos">109</span></a>        <span class="c1"># deepcopy so this object doesn&#39;t get changed when the global source_rays changes &quot;outside&quot;</span>
</span><span id="OpticalChain.__init__-110"><a href="#OpticalChain.__init__-110"><span class="linenos">110</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">optical_elements</span><span class="p">)</span>
</span><span id="OpticalChain.__init__-111"><a href="#OpticalChain.__init__-111"><span class="linenos">111</span></a>        <span class="c1"># deepcopy so this object doesn&#39;t get changed when the global optical_elements changes &quot;outside&quot;</span>
</span><span id="OpticalChain.__init__-112"><a href="#OpticalChain.__init__-112"><span class="linenos">112</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>
</span><span id="OpticalChain.__init__-113"><a href="#OpticalChain.__init__-113"><span class="linenos">113</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_output_rays</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="OpticalChain.__init__-114"><a href="#OpticalChain.__init__-114"><span class="linenos">114</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_last_optical_elements_hash</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># for now we don&#39;t care which element was changed.</span>
</span><span id="OpticalChain.__init__-115"><a href="#OpticalChain.__init__-115"><span class="linenos">115</span></a>        <span class="c1"># we just always do the whole raytracing again</span>
</span><span id="OpticalChain.__init__-116"><a href="#OpticalChain.__init__-116"><span class="linenos">116</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_last_source_rays_hash</span> <span class="o">=</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><h2 id="parameters">Parameters</h2>

<pre><code>source_rays : list[mray.Ray]
    List of source rays, which are to be traced.

optical_elements : list[moe.OpticalElement]
    List of successive optical elements.

description : str, optional
    A string to describe the optical setup. Defaults to ''.

loop_variable_name : str, optional
    A string naming a parameter that is varied in a list of OpticalChain-objects.
    Defaults to None.

loop_variable_value : float
    The value of that varied parameter, which is useful when looping over
    variations of an initial configuration. Defaults to None.
</code></pre>
</div>


                            </div>
                            <div id="OpticalChain.source_rays" class="classattr">
                                        <input id="OpticalChain.source_rays-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">source_rays</span>

                <label class="view-source-button" for="OpticalChain.source_rays-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#OpticalChain.source_rays"></a>
            <div class="chroma pdoc-code"><pre><span></span><span id="OpticalChain.source_rays-142"><a href="#OpticalChain.source_rays-142"><span class="linenos">142</span></a>    <span class="nd">@property</span>
</span><span id="OpticalChain.source_rays-143"><a href="#OpticalChain.source_rays-143"><span class="linenos">143</span></a>    <span class="k">def</span> <span class="nf">source_rays</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="OpticalChain.source_rays-144"><a href="#OpticalChain.source_rays-144"><span class="linenos">144</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source_rays</span>
</span></pre></div>


    

                            </div>
                            <div id="OpticalChain.optical_elements" class="classattr">
                                        <input id="OpticalChain.optical_elements-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">optical_elements</span>

                <label class="view-source-button" for="OpticalChain.optical_elements-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#OpticalChain.optical_elements"></a>
            <div class="chroma pdoc-code"><pre><span></span><span id="OpticalChain.optical_elements-154"><a href="#OpticalChain.optical_elements-154"><span class="linenos">154</span></a>    <span class="nd">@property</span>
</span><span id="OpticalChain.optical_elements-155"><a href="#OpticalChain.optical_elements-155"><span class="linenos">155</span></a>    <span class="k">def</span> <span class="nf">optical_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="OpticalChain.optical_elements-156"><a href="#OpticalChain.optical_elements-156"><span class="linenos">156</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optical_elements</span>
</span></pre></div>


    

                            </div>
                            <div id="OpticalChain.description" class="classattr">
                                <div class="attr variable">
            <span class="name">description</span>

        
    </div>
    <a class="headerlink" href="#OpticalChain.description"></a>
    
    

                            </div>
                            <div id="OpticalChain.copy_chain" class="classattr">
                                        <input id="OpticalChain.copy_chain-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">copy_chain</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="OpticalChain.copy_chain-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#OpticalChain.copy_chain"></a>
            <div class="chroma pdoc-code"><pre><span></span><span id="OpticalChain.copy_chain-167"><a href="#OpticalChain.copy_chain-167"><span class="linenos">167</span></a>    <span class="k">def</span> <span class="nf">copy_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="OpticalChain.copy_chain-168"><a href="#OpticalChain.copy_chain-168"><span class="linenos">168</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return another optical chain with the same source, optical elements and description-string as this one.&quot;&quot;&quot;</span>
</span><span id="OpticalChain.copy_chain-169"><a href="#OpticalChain.copy_chain-169"><span class="linenos">169</span></a>        <span class="k">return</span> <span class="n">OpticalChain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_rays</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Return another optical chain with the same source, optical elements and description-string as this one.</p>
</div>


                            </div>
                            <div id="OpticalChain.get_output_rays" class="classattr">
                                        <input id="OpticalChain.get_output_rays-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_output_rays</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="OpticalChain.get_output_rays-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#OpticalChain.get_output_rays"></a>
            <div class="chroma pdoc-code"><pre><span></span><span id="OpticalChain.get_output_rays-171"><a href="#OpticalChain.get_output_rays-171"><span class="linenos">171</span></a>    <span class="k">def</span> <span class="nf">get_output_rays</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="OpticalChain.get_output_rays-172"><a href="#OpticalChain.get_output_rays-172"><span class="linenos">172</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="OpticalChain.get_output_rays-173"><a href="#OpticalChain.get_output_rays-173"><span class="linenos">173</span></a><span class="sd">        Returns the list of (lists of) output rays, calculate them if this hasn&#39;t been done yet,</span>
</span><span id="OpticalChain.get_output_rays-174"><a href="#OpticalChain.get_output_rays-174"><span class="linenos">174</span></a><span class="sd">        or if the source-ray-bundle or anything about the optical elements has changed.</span>
</span><span id="OpticalChain.get_output_rays-175"><a href="#OpticalChain.get_output_rays-175"><span class="linenos">175</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="OpticalChain.get_output_rays-176"><a href="#OpticalChain.get_output_rays-176"><span class="linenos">176</span></a>        <span class="n">current_source_rays_hash</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">_hash_list_of_objects</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_rays</span><span class="p">)</span>
</span><span id="OpticalChain.get_output_rays-177"><a href="#OpticalChain.get_output_rays-177"><span class="linenos">177</span></a>        <span class="n">current_optical_elements_hash</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">_hash_list_of_objects</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">)</span>
</span><span id="OpticalChain.get_output_rays-178"><a href="#OpticalChain.get_output_rays-178"><span class="linenos">178</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">current_source_rays_hash</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_source_rays_hash</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
</span><span id="OpticalChain.get_output_rays-179"><a href="#OpticalChain.get_output_rays-179"><span class="linenos">179</span></a>            <span class="n">current_optical_elements_hash</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_optical_elements_hash</span>
</span><span id="OpticalChain.get_output_rays-180"><a href="#OpticalChain.get_output_rays-180"><span class="linenos">180</span></a>        <span class="p">):</span>
</span><span id="OpticalChain.get_output_rays-181"><a href="#OpticalChain.get_output_rays-181"><span class="linenos">181</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;...ray-tracing...&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="OpticalChain.get_output_rays-182"><a href="#OpticalChain.get_output_rays-182"><span class="linenos">182</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_output_rays</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">RayTracingCalculation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_rays</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="OpticalChain.get_output_rays-183"><a href="#OpticalChain.get_output_rays-183"><span class="linenos">183</span></a>            <span class="nb">print</span><span class="p">(</span>
</span><span id="OpticalChain.get_output_rays-184"><a href="#OpticalChain.get_output_rays-184"><span class="linenos">184</span></a>                <span class="s2">&quot;</span><span class="se">\r\033</span><span class="s2">[K&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span>
</span><span id="OpticalChain.get_output_rays-185"><a href="#OpticalChain.get_output_rays-185"><span class="linenos">185</span></a>            <span class="p">)</span>  <span class="c1"># move to beginning of the line with \r and then delete the whole line with \033[K</span>
</span><span id="OpticalChain.get_output_rays-186"><a href="#OpticalChain.get_output_rays-186"><span class="linenos">186</span></a>
</span><span id="OpticalChain.get_output_rays-187"><a href="#OpticalChain.get_output_rays-187"><span class="linenos">187</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_last_source_rays_hash</span> <span class="o">=</span> <span class="n">current_source_rays_hash</span>
</span><span id="OpticalChain.get_output_rays-188"><a href="#OpticalChain.get_output_rays-188"><span class="linenos">188</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_last_optical_elements_hash</span> <span class="o">=</span> <span class="n">current_optical_elements_hash</span>
</span><span id="OpticalChain.get_output_rays-189"><a href="#OpticalChain.get_output_rays-189"><span class="linenos">189</span></a>
</span><span id="OpticalChain.get_output_rays-190"><a href="#OpticalChain.get_output_rays-190"><span class="linenos">190</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_rays</span>
</span></pre></div>


            <div class="docstring"><p>Returns the list of (lists of) output rays, calculate them if this hasn't been done yet,
or if the source-ray-bundle or anything about the optical elements has changed.</p>
</div>


                            </div>
                            <div id="OpticalChain.shift_source" class="classattr">
                                        <input id="OpticalChain.shift_source-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">shift_source</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	axis: (&lt;class &#x27;str&#x27;&gt;, &lt;class &#x27;numpy.ndarray&#x27;&gt;),</span><span class="param">	<span class="n">distance</span><span class="p">:</span> <span class="nb">float</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="OpticalChain.shift_source-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#OpticalChain.shift_source"></a>
            <div class="chroma pdoc-code"><pre><span></span><span id="OpticalChain.shift_source-193"><a href="#OpticalChain.shift_source-193"><span class="linenos">193</span></a>    <span class="k">def</span> <span class="nf">shift_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">),</span> <span class="n">distance</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
</span><span id="OpticalChain.shift_source-194"><a href="#OpticalChain.shift_source-194"><span class="linenos">194</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="OpticalChain.shift_source-195"><a href="#OpticalChain.shift_source-195"><span class="linenos">195</span></a><span class="sd">        Shift source ray bundle by distance (in mm) along the &#39;axis&#39; specified as</span>
</span><span id="OpticalChain.shift_source-196"><a href="#OpticalChain.shift_source-196"><span class="linenos">196</span></a><span class="sd">        a lab-frame vector (numpy-array of length 3) or as one of the strings</span>
</span><span id="OpticalChain.shift_source-197"><a href="#OpticalChain.shift_source-197"><span class="linenos">197</span></a><span class="sd">        &quot;vert&quot;, &quot;horiz&quot;, or &quot;random&quot;.</span>
</span><span id="OpticalChain.shift_source-198"><a href="#OpticalChain.shift_source-198"><span class="linenos">198</span></a>
</span><span id="OpticalChain.shift_source-199"><a href="#OpticalChain.shift_source-199"><span class="linenos">199</span></a><span class="sd">        In the latter case, the reference is the incidence plane of the first</span>
</span><span id="OpticalChain.shift_source-200"><a href="#OpticalChain.shift_source-200"><span class="linenos">200</span></a><span class="sd">        non-normal-incidence mirror after the source. If there is none, you will</span>
</span><span id="OpticalChain.shift_source-201"><a href="#OpticalChain.shift_source-201"><span class="linenos">201</span></a><span class="sd">        be asked to rather specify the axis as a 3D-numpy-array.</span>
</span><span id="OpticalChain.shift_source-202"><a href="#OpticalChain.shift_source-202"><span class="linenos">202</span></a>
</span><span id="OpticalChain.shift_source-203"><a href="#OpticalChain.shift_source-203"><span class="linenos">203</span></a><span class="sd">        axis = &quot;vert&quot; means the source position is shifted along the axis perpendicular</span>
</span><span id="OpticalChain.shift_source-204"><a href="#OpticalChain.shift_source-204"><span class="linenos">204</span></a><span class="sd">        to that incidence plane, i.e. &quot;vertically&quot; away from the former incidence plane..</span>
</span><span id="OpticalChain.shift_source-205"><a href="#OpticalChain.shift_source-205"><span class="linenos">205</span></a>
</span><span id="OpticalChain.shift_source-206"><a href="#OpticalChain.shift_source-206"><span class="linenos">206</span></a><span class="sd">        axis = &quot;horiz&quot; means the source direciton is translated along thr axis in that</span>
</span><span id="OpticalChain.shift_source-207"><a href="#OpticalChain.shift_source-207"><span class="linenos">207</span></a><span class="sd">        incidence plane and perpendicular to the current source direction,</span>
</span><span id="OpticalChain.shift_source-208"><a href="#OpticalChain.shift_source-208"><span class="linenos">208</span></a><span class="sd">        i.e. &quot;horizontally&quot; in the incidence plane, but retaining the same distance</span>
</span><span id="OpticalChain.shift_source-209"><a href="#OpticalChain.shift_source-209"><span class="linenos">209</span></a><span class="sd">        of source and first optical element.</span>
</span><span id="OpticalChain.shift_source-210"><a href="#OpticalChain.shift_source-210"><span class="linenos">210</span></a>
</span><span id="OpticalChain.shift_source-211"><a href="#OpticalChain.shift_source-211"><span class="linenos">211</span></a><span class="sd">        axis = &quot;random&quot; means the the source direction shifted in a random direction</span>
</span><span id="OpticalChain.shift_source-212"><a href="#OpticalChain.shift_source-212"><span class="linenos">212</span></a><span class="sd">        within in the plane perpendicular to the current source direction,</span>
</span><span id="OpticalChain.shift_source-213"><a href="#OpticalChain.shift_source-213"><span class="linenos">213</span></a><span class="sd">        e.g. simulating a fluctuation of hte transverse source position.</span>
</span><span id="OpticalChain.shift_source-214"><a href="#OpticalChain.shift_source-214"><span class="linenos">214</span></a>
</span><span id="OpticalChain.shift_source-215"><a href="#OpticalChain.shift_source-215"><span class="linenos">215</span></a><span class="sd">        Parameters</span>
</span><span id="OpticalChain.shift_source-216"><a href="#OpticalChain.shift_source-216"><span class="linenos">216</span></a><span class="sd">        ----------</span>
</span><span id="OpticalChain.shift_source-217"><a href="#OpticalChain.shift_source-217"><span class="linenos">217</span></a><span class="sd">            axis : np.ndarray or str</span>
</span><span id="OpticalChain.shift_source-218"><a href="#OpticalChain.shift_source-218"><span class="linenos">218</span></a><span class="sd">                Shift axis, specified either as a 3D lab-frame vector or as one</span>
</span><span id="OpticalChain.shift_source-219"><a href="#OpticalChain.shift_source-219"><span class="linenos">219</span></a><span class="sd">                of the strings &quot;vert&quot;, &quot;horiz&quot;, or &quot;random&quot;.</span>
</span><span id="OpticalChain.shift_source-220"><a href="#OpticalChain.shift_source-220"><span class="linenos">220</span></a>
</span><span id="OpticalChain.shift_source-221"><a href="#OpticalChain.shift_source-221"><span class="linenos">221</span></a><span class="sd">            distance : float</span>
</span><span id="OpticalChain.shift_source-222"><a href="#OpticalChain.shift_source-222"><span class="linenos">222</span></a><span class="sd">                Shift distance in mm.</span>
</span><span id="OpticalChain.shift_source-223"><a href="#OpticalChain.shift_source-223"><span class="linenos">223</span></a>
</span><span id="OpticalChain.shift_source-224"><a href="#OpticalChain.shift_source-224"><span class="linenos">224</span></a><span class="sd">        Returns</span>
</span><span id="OpticalChain.shift_source-225"><a href="#OpticalChain.shift_source-225"><span class="linenos">225</span></a><span class="sd">        -------</span>
</span><span id="OpticalChain.shift_source-226"><a href="#OpticalChain.shift_source-226"><span class="linenos">226</span></a><span class="sd">            Nothing, just modifies the property &#39;source_rays&#39;.</span>
</span><span id="OpticalChain.shift_source-227"><a href="#OpticalChain.shift_source-227"><span class="linenos">227</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="OpticalChain.shift_source-228"><a href="#OpticalChain.shift_source-228"><span class="linenos">228</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
</span><span id="OpticalChain.shift_source-229"><a href="#OpticalChain.shift_source-229"><span class="linenos">229</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The &quot;distance&quot;-argument must be an int or float number.&#39;</span><span class="p">)</span>
</span><span id="OpticalChain.shift_source-230"><a href="#OpticalChain.shift_source-230"><span class="linenos">230</span></a>
</span><span id="OpticalChain.shift_source-231"><a href="#OpticalChain.shift_source-231"><span class="linenos">231</span></a>        <span class="n">central_ray_vector</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">FindCentralRay</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_rays</span><span class="p">)</span><span class="o">.</span><span class="n">vector</span>
</span><span id="OpticalChain.shift_source-232"><a href="#OpticalChain.shift_source-232"><span class="linenos">232</span></a>        <span class="n">mirror_indcs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">OE</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;Mirror&quot;</span> <span class="ow">in</span> <span class="n">OE</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">type</span><span class="p">]</span>
</span><span id="OpticalChain.shift_source-233"><a href="#OpticalChain.shift_source-233"><span class="linenos">233</span></a>
</span><span id="OpticalChain.shift_source-234"><a href="#OpticalChain.shift_source-234"><span class="linenos">234</span></a>        <span class="n">OEnormal</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="OpticalChain.shift_source-235"><a href="#OpticalChain.shift_source-235"><span class="linenos">235</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mirror_indcs</span><span class="p">:</span>
</span><span id="OpticalChain.shift_source-236"><a href="#OpticalChain.shift_source-236"><span class="linenos">236</span></a>            <span class="n">ith_OEnormal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span>
</span><span id="OpticalChain.shift_source-237"><a href="#OpticalChain.shift_source-237"><span class="linenos">237</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">central_ray_vector</span><span class="p">,</span> <span class="n">ith_OEnormal</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">1e-10</span><span class="p">:</span>
</span><span id="OpticalChain.shift_source-238"><a href="#OpticalChain.shift_source-238"><span class="linenos">238</span></a>                <span class="n">OEnormal</span> <span class="o">=</span> <span class="n">ith_OEnormal</span>
</span><span id="OpticalChain.shift_source-239"><a href="#OpticalChain.shift_source-239"><span class="linenos">239</span></a>                <span class="k">break</span>
</span><span id="OpticalChain.shift_source-240"><a href="#OpticalChain.shift_source-240"><span class="linenos">240</span></a>        <span class="k">if</span> <span class="n">OEnormal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="OpticalChain.shift_source-241"><a href="#OpticalChain.shift_source-241"><span class="linenos">241</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
</span><span id="OpticalChain.shift_source-242"><a href="#OpticalChain.shift_source-242"><span class="linenos">242</span></a>                <span class="s2">&quot;There doesn&#39;t seem to be a non-normal-incidence mirror in this optical chain, </span><span class="se">\</span>
</span><span id="OpticalChain.shift_source-243"><a href="#OpticalChain.shift_source-243"><span class="linenos">243</span></a><span class="s2">                            so you should rather give &#39;axis&#39; as a numpy-array of length 3.&quot;</span>
</span><span id="OpticalChain.shift_source-244"><a href="#OpticalChain.shift_source-244"><span class="linenos">244</span></a>            <span class="p">)</span>
</span><span id="OpticalChain.shift_source-245"><a href="#OpticalChain.shift_source-245"><span class="linenos">245</span></a>
</span><span id="OpticalChain.shift_source-246"><a href="#OpticalChain.shift_source-246"><span class="linenos">246</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="OpticalChain.shift_source-247"><a href="#OpticalChain.shift_source-247"><span class="linenos">247</span></a>            <span class="n">translation_vector</span> <span class="o">=</span> <span class="n">axis</span>
</span><span id="OpticalChain.shift_source-248"><a href="#OpticalChain.shift_source-248"><span class="linenos">248</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="OpticalChain.shift_source-249"><a href="#OpticalChain.shift_source-249"><span class="linenos">249</span></a>            <span class="n">perp_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">central_ray_vector</span><span class="p">,</span> <span class="n">OEnormal</span><span class="p">)</span>
</span><span id="OpticalChain.shift_source-250"><a href="#OpticalChain.shift_source-250"><span class="linenos">250</span></a>            <span class="n">horiz_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">perp_axis</span><span class="p">,</span> <span class="n">central_ray_vector</span><span class="p">)</span>
</span><span id="OpticalChain.shift_source-251"><a href="#OpticalChain.shift_source-251"><span class="linenos">251</span></a>
</span><span id="OpticalChain.shift_source-252"><a href="#OpticalChain.shift_source-252"><span class="linenos">252</span></a>            <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="s2">&quot;vert&quot;</span><span class="p">:</span>
</span><span id="OpticalChain.shift_source-253"><a href="#OpticalChain.shift_source-253"><span class="linenos">253</span></a>                <span class="n">translation_vector</span> <span class="o">=</span> <span class="n">perp_axis</span>
</span><span id="OpticalChain.shift_source-254"><a href="#OpticalChain.shift_source-254"><span class="linenos">254</span></a>            <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="s2">&quot;horiz&quot;</span><span class="p">:</span>
</span><span id="OpticalChain.shift_source-255"><a href="#OpticalChain.shift_source-255"><span class="linenos">255</span></a>                <span class="n">translation_vector</span> <span class="o">=</span> <span class="n">horiz_axis</span>
</span><span id="OpticalChain.shift_source-256"><a href="#OpticalChain.shift_source-256"><span class="linenos">256</span></a>            <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span>
</span><span id="OpticalChain.shift_source-257"><a href="#OpticalChain.shift_source-257"><span class="linenos">257</span></a>                <span class="n">translation_vector</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="OpticalChain.shift_source-258"><a href="#OpticalChain.shift_source-258"><span class="linenos">258</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">perp_axis</span>
</span><span id="OpticalChain.shift_source-259"><a href="#OpticalChain.shift_source-259"><span class="linenos">259</span></a>                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">horiz_axis</span>
</span><span id="OpticalChain.shift_source-260"><a href="#OpticalChain.shift_source-260"><span class="linenos">260</span></a>                <span class="p">)</span>
</span><span id="OpticalChain.shift_source-261"><a href="#OpticalChain.shift_source-261"><span class="linenos">261</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="OpticalChain.shift_source-262"><a href="#OpticalChain.shift_source-262"><span class="linenos">262</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="OpticalChain.shift_source-263"><a href="#OpticalChain.shift_source-263"><span class="linenos">263</span></a>                    <span class="s1">&#39;The shift direction must be specified by &quot;axis&quot; as one of [&quot;vert&quot;, &quot;horiz&quot;, &quot;random&quot;].&#39;</span>
</span><span id="OpticalChain.shift_source-264"><a href="#OpticalChain.shift_source-264"><span class="linenos">264</span></a>                <span class="p">)</span>
</span><span id="OpticalChain.shift_source-265"><a href="#OpticalChain.shift_source-265"><span class="linenos">265</span></a>
</span><span id="OpticalChain.shift_source-266"><a href="#OpticalChain.shift_source-266"><span class="linenos">266</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">source_rays</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">TranslationRayList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_rays</span><span class="p">,</span> <span class="n">distance</span> <span class="o">*</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">translation_vector</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Shift source ray bundle by distance (in mm) along the 'axis' specified as
a lab-frame vector (numpy-array of length 3) or as one of the strings
"vert", "horiz", or "random".</p>

<p>In the latter case, the reference is the incidence plane of the first
non-normal-incidence mirror after the source. If there is none, you will
be asked to rather specify the axis as a 3D-numpy-array.</p>

<p>axis = "vert" means the source position is shifted along the axis perpendicular
to that incidence plane, i.e. "vertically" away from the former incidence plane..</p>

<p>axis = "horiz" means the source direciton is translated along thr axis in that
incidence plane and perpendicular to the current source direction,
i.e. "horizontally" in the incidence plane, but retaining the same distance
of source and first optical element.</p>

<p>axis = "random" means the the source direction shifted in a random direction
within in the plane perpendicular to the current source direction,
e.g. simulating a fluctuation of hte transverse source position.</p>

<h2 id="parameters">Parameters</h2>

<pre><code>axis : np.ndarray or str
    Shift axis, specified either as a 3D lab-frame vector or as one
    of the strings "vert", "horiz", or "random".

distance : float
    Shift distance in mm.
</code></pre>

<h2 id="returns">Returns</h2>

<pre><code>Nothing, just modifies the property 'source_rays'.
</code></pre>
</div>


                            </div>
                            <div id="OpticalChain.tilt_source" class="classattr">
                                        <input id="OpticalChain.tilt_source-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">tilt_source</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param">axis: (&lt;class &#x27;str&#x27;&gt;, &lt;class &#x27;numpy.ndarray&#x27;&gt;), </span><span class="param"><span class="n">angle</span><span class="p">:</span> <span class="nb">float</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="OpticalChain.tilt_source-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#OpticalChain.tilt_source"></a>
            <div class="chroma pdoc-code"><pre><span></span><span id="OpticalChain.tilt_source-268"><a href="#OpticalChain.tilt_source-268"><span class="linenos">268</span></a>    <span class="k">def</span> <span class="nf">tilt_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">),</span> <span class="n">angle</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
</span><span id="OpticalChain.tilt_source-269"><a href="#OpticalChain.tilt_source-269"><span class="linenos">269</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="OpticalChain.tilt_source-270"><a href="#OpticalChain.tilt_source-270"><span class="linenos">270</span></a><span class="sd">        Rotate source ray bundle by angle around an axis, specified as</span>
</span><span id="OpticalChain.tilt_source-271"><a href="#OpticalChain.tilt_source-271"><span class="linenos">271</span></a><span class="sd">        a lab-frame vector (numpy-array of length 3) or as one of the strings</span>
</span><span id="OpticalChain.tilt_source-272"><a href="#OpticalChain.tilt_source-272"><span class="linenos">272</span></a><span class="sd">        &quot;in_plane&quot;, &quot;out_plane&quot; or &quot;random&quot; direction.</span>
</span><span id="OpticalChain.tilt_source-273"><a href="#OpticalChain.tilt_source-273"><span class="linenos">273</span></a>
</span><span id="OpticalChain.tilt_source-274"><a href="#OpticalChain.tilt_source-274"><span class="linenos">274</span></a><span class="sd">        In the latter case, the function considers the incidence plane of the first</span>
</span><span id="OpticalChain.tilt_source-275"><a href="#OpticalChain.tilt_source-275"><span class="linenos">275</span></a><span class="sd">        non-normal-incidence mirror after the source. If there is none, you will</span>
</span><span id="OpticalChain.tilt_source-276"><a href="#OpticalChain.tilt_source-276"><span class="linenos">276</span></a><span class="sd">        be asked to rather specify the axis as a 3D-numpy-array.</span>
</span><span id="OpticalChain.tilt_source-277"><a href="#OpticalChain.tilt_source-277"><span class="linenos">277</span></a>
</span><span id="OpticalChain.tilt_source-278"><a href="#OpticalChain.tilt_source-278"><span class="linenos">278</span></a><span class="sd">        axis = &quot;in_plane&quot; means the source direction is rotated about an axis</span>
</span><span id="OpticalChain.tilt_source-279"><a href="#OpticalChain.tilt_source-279"><span class="linenos">279</span></a><span class="sd">        perpendicular to that incidence plane, which tilts the source</span>
</span><span id="OpticalChain.tilt_source-280"><a href="#OpticalChain.tilt_source-280"><span class="linenos">280</span></a><span class="sd">        &quot;horizontally&quot; in the same plane.</span>
</span><span id="OpticalChain.tilt_source-281"><a href="#OpticalChain.tilt_source-281"><span class="linenos">281</span></a>
</span><span id="OpticalChain.tilt_source-282"><a href="#OpticalChain.tilt_source-282"><span class="linenos">282</span></a><span class="sd">        axis = &quot;out_plane&quot; means the source direciton is rotated about an axis</span>
</span><span id="OpticalChain.tilt_source-283"><a href="#OpticalChain.tilt_source-283"><span class="linenos">283</span></a><span class="sd">        in that incidence plane and perpendicular to the current source direction,</span>
</span><span id="OpticalChain.tilt_source-284"><a href="#OpticalChain.tilt_source-284"><span class="linenos">284</span></a><span class="sd">        which tilts the source &quot;vertically&quot; out of the former incidence plane.</span>
</span><span id="OpticalChain.tilt_source-285"><a href="#OpticalChain.tilt_source-285"><span class="linenos">285</span></a>
</span><span id="OpticalChain.tilt_source-286"><a href="#OpticalChain.tilt_source-286"><span class="linenos">286</span></a><span class="sd">        axis = &quot;random&quot; means the the source direction is tilted in a random direction,</span>
</span><span id="OpticalChain.tilt_source-287"><a href="#OpticalChain.tilt_source-287"><span class="linenos">287</span></a><span class="sd">        e.g. simulating a beam pointing fluctuation.</span>
</span><span id="OpticalChain.tilt_source-288"><a href="#OpticalChain.tilt_source-288"><span class="linenos">288</span></a>
</span><span id="OpticalChain.tilt_source-289"><a href="#OpticalChain.tilt_source-289"><span class="linenos">289</span></a><span class="sd">        Attention, &quot;angle&quot; is given in deg, so as to remain consitent with the</span>
</span><span id="OpticalChain.tilt_source-290"><a href="#OpticalChain.tilt_source-290"><span class="linenos">290</span></a><span class="sd">        conventions of other functions, although pointing is mostly talked about</span>
</span><span id="OpticalChain.tilt_source-291"><a href="#OpticalChain.tilt_source-291"><span class="linenos">291</span></a><span class="sd">        in mrad instead.</span>
</span><span id="OpticalChain.tilt_source-292"><a href="#OpticalChain.tilt_source-292"><span class="linenos">292</span></a>
</span><span id="OpticalChain.tilt_source-293"><a href="#OpticalChain.tilt_source-293"><span class="linenos">293</span></a><span class="sd">        Parameters</span>
</span><span id="OpticalChain.tilt_source-294"><a href="#OpticalChain.tilt_source-294"><span class="linenos">294</span></a><span class="sd">        ----------</span>
</span><span id="OpticalChain.tilt_source-295"><a href="#OpticalChain.tilt_source-295"><span class="linenos">295</span></a><span class="sd">            axis : np.ndarray or str</span>
</span><span id="OpticalChain.tilt_source-296"><a href="#OpticalChain.tilt_source-296"><span class="linenos">296</span></a><span class="sd">                Shift axis, specified either as a 3D lab-frame vector or as one</span>
</span><span id="OpticalChain.tilt_source-297"><a href="#OpticalChain.tilt_source-297"><span class="linenos">297</span></a><span class="sd">                of the strings &quot;in_plane&quot;, &quot;out_plane&quot;, or &quot;random&quot;.</span>
</span><span id="OpticalChain.tilt_source-298"><a href="#OpticalChain.tilt_source-298"><span class="linenos">298</span></a>
</span><span id="OpticalChain.tilt_source-299"><a href="#OpticalChain.tilt_source-299"><span class="linenos">299</span></a><span class="sd">            angle : float</span>
</span><span id="OpticalChain.tilt_source-300"><a href="#OpticalChain.tilt_source-300"><span class="linenos">300</span></a><span class="sd">                Rotation angle in degree.</span>
</span><span id="OpticalChain.tilt_source-301"><a href="#OpticalChain.tilt_source-301"><span class="linenos">301</span></a>
</span><span id="OpticalChain.tilt_source-302"><a href="#OpticalChain.tilt_source-302"><span class="linenos">302</span></a><span class="sd">        Returns</span>
</span><span id="OpticalChain.tilt_source-303"><a href="#OpticalChain.tilt_source-303"><span class="linenos">303</span></a><span class="sd">        -------</span>
</span><span id="OpticalChain.tilt_source-304"><a href="#OpticalChain.tilt_source-304"><span class="linenos">304</span></a><span class="sd">            Nothing, just modifies the property &#39;source_rays&#39;.</span>
</span><span id="OpticalChain.tilt_source-305"><a href="#OpticalChain.tilt_source-305"><span class="linenos">305</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="OpticalChain.tilt_source-306"><a href="#OpticalChain.tilt_source-306"><span class="linenos">306</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
</span><span id="OpticalChain.tilt_source-307"><a href="#OpticalChain.tilt_source-307"><span class="linenos">307</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The &quot;angle&quot;-argument must be an int or float number.&#39;</span><span class="p">)</span>
</span><span id="OpticalChain.tilt_source-308"><a href="#OpticalChain.tilt_source-308"><span class="linenos">308</span></a>
</span><span id="OpticalChain.tilt_source-309"><a href="#OpticalChain.tilt_source-309"><span class="linenos">309</span></a>        <span class="n">central_ray_vector</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">FindCentralRay</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_rays</span><span class="p">)</span><span class="o">.</span><span class="n">vector</span>
</span><span id="OpticalChain.tilt_source-310"><a href="#OpticalChain.tilt_source-310"><span class="linenos">310</span></a>        <span class="n">mirror_indcs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">OE</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;Mirror&quot;</span> <span class="ow">in</span> <span class="n">OE</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">type</span><span class="p">]</span>
</span><span id="OpticalChain.tilt_source-311"><a href="#OpticalChain.tilt_source-311"><span class="linenos">311</span></a>
</span><span id="OpticalChain.tilt_source-312"><a href="#OpticalChain.tilt_source-312"><span class="linenos">312</span></a>        <span class="n">OEnormal</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="OpticalChain.tilt_source-313"><a href="#OpticalChain.tilt_source-313"><span class="linenos">313</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mirror_indcs</span><span class="p">:</span>
</span><span id="OpticalChain.tilt_source-314"><a href="#OpticalChain.tilt_source-314"><span class="linenos">314</span></a>            <span class="n">ith_OEnormal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span>
</span><span id="OpticalChain.tilt_source-315"><a href="#OpticalChain.tilt_source-315"><span class="linenos">315</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">central_ray_vector</span><span class="p">,</span> <span class="n">ith_OEnormal</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">1e-10</span><span class="p">:</span>
</span><span id="OpticalChain.tilt_source-316"><a href="#OpticalChain.tilt_source-316"><span class="linenos">316</span></a>                <span class="n">OEnormal</span> <span class="o">=</span> <span class="n">ith_OEnormal</span>
</span><span id="OpticalChain.tilt_source-317"><a href="#OpticalChain.tilt_source-317"><span class="linenos">317</span></a>                <span class="k">break</span>
</span><span id="OpticalChain.tilt_source-318"><a href="#OpticalChain.tilt_source-318"><span class="linenos">318</span></a>        <span class="k">if</span> <span class="n">OEnormal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="OpticalChain.tilt_source-319"><a href="#OpticalChain.tilt_source-319"><span class="linenos">319</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
</span><span id="OpticalChain.tilt_source-320"><a href="#OpticalChain.tilt_source-320"><span class="linenos">320</span></a>                <span class="s2">&quot;There doesn&#39;t seem to be a non-normal-incidence mirror in this optical chain, </span><span class="se">\</span>
</span><span id="OpticalChain.tilt_source-321"><a href="#OpticalChain.tilt_source-321"><span class="linenos">321</span></a><span class="s2">                            so you should rather give &#39;axis&#39; as a numpy-array of length 3.&quot;</span>
</span><span id="OpticalChain.tilt_source-322"><a href="#OpticalChain.tilt_source-322"><span class="linenos">322</span></a>            <span class="p">)</span>
</span><span id="OpticalChain.tilt_source-323"><a href="#OpticalChain.tilt_source-323"><span class="linenos">323</span></a>
</span><span id="OpticalChain.tilt_source-324"><a href="#OpticalChain.tilt_source-324"><span class="linenos">324</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="OpticalChain.tilt_source-325"><a href="#OpticalChain.tilt_source-325"><span class="linenos">325</span></a>            <span class="n">rot_axis</span> <span class="o">=</span> <span class="n">axis</span>
</span><span id="OpticalChain.tilt_source-326"><a href="#OpticalChain.tilt_source-326"><span class="linenos">326</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="OpticalChain.tilt_source-327"><a href="#OpticalChain.tilt_source-327"><span class="linenos">327</span></a>            <span class="n">rot_axis_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">central_ray_vector</span><span class="p">,</span> <span class="n">OEnormal</span><span class="p">)</span>
</span><span id="OpticalChain.tilt_source-328"><a href="#OpticalChain.tilt_source-328"><span class="linenos">328</span></a>            <span class="n">rot_axis_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">rot_axis_in</span><span class="p">,</span> <span class="n">central_ray_vector</span><span class="p">)</span>
</span><span id="OpticalChain.tilt_source-329"><a href="#OpticalChain.tilt_source-329"><span class="linenos">329</span></a>            <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="s2">&quot;in_plane&quot;</span><span class="p">:</span>
</span><span id="OpticalChain.tilt_source-330"><a href="#OpticalChain.tilt_source-330"><span class="linenos">330</span></a>                <span class="n">rot_axis</span> <span class="o">=</span> <span class="n">rot_axis_in</span>
</span><span id="OpticalChain.tilt_source-331"><a href="#OpticalChain.tilt_source-331"><span class="linenos">331</span></a>            <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="s2">&quot;out_plane&quot;</span><span class="p">:</span>
</span><span id="OpticalChain.tilt_source-332"><a href="#OpticalChain.tilt_source-332"><span class="linenos">332</span></a>                <span class="n">rot_axis</span> <span class="o">=</span> <span class="n">rot_axis_out</span>
</span><span id="OpticalChain.tilt_source-333"><a href="#OpticalChain.tilt_source-333"><span class="linenos">333</span></a>            <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span>
</span><span id="OpticalChain.tilt_source-334"><a href="#OpticalChain.tilt_source-334"><span class="linenos">334</span></a>                <span class="n">rot_axis</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="OpticalChain.tilt_source-335"><a href="#OpticalChain.tilt_source-335"><span class="linenos">335</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">rot_axis_in</span>
</span><span id="OpticalChain.tilt_source-336"><a href="#OpticalChain.tilt_source-336"><span class="linenos">336</span></a>                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">rot_axis_out</span>
</span><span id="OpticalChain.tilt_source-337"><a href="#OpticalChain.tilt_source-337"><span class="linenos">337</span></a>                <span class="p">)</span>
</span><span id="OpticalChain.tilt_source-338"><a href="#OpticalChain.tilt_source-338"><span class="linenos">338</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="OpticalChain.tilt_source-339"><a href="#OpticalChain.tilt_source-339"><span class="linenos">339</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="OpticalChain.tilt_source-340"><a href="#OpticalChain.tilt_source-340"><span class="linenos">340</span></a>                    <span class="s1">&#39;The tilt axis must be specified by as one of [&quot;in_plane&quot;, &quot;out_plane&quot;, &quot;random&quot;] or as a numpy-array of length 3.&#39;</span>
</span><span id="OpticalChain.tilt_source-341"><a href="#OpticalChain.tilt_source-341"><span class="linenos">341</span></a>                <span class="p">)</span>
</span><span id="OpticalChain.tilt_source-342"><a href="#OpticalChain.tilt_source-342"><span class="linenos">342</span></a>
</span><span id="OpticalChain.tilt_source-343"><a href="#OpticalChain.tilt_source-343"><span class="linenos">343</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">source_rays</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">RotationAroundAxisRayList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_rays</span><span class="p">,</span> <span class="n">rot_axis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Rotate source ray bundle by angle around an axis, specified as
a lab-frame vector (numpy-array of length 3) or as one of the strings
"in_plane", "out_plane" or "random" direction.</p>

<p>In the latter case, the function considers the incidence plane of the first
non-normal-incidence mirror after the source. If there is none, you will
be asked to rather specify the axis as a 3D-numpy-array.</p>

<p>axis = "in_plane" means the source direction is rotated about an axis
perpendicular to that incidence plane, which tilts the source
"horizontally" in the same plane.</p>

<p>axis = "out_plane" means the source direciton is rotated about an axis
in that incidence plane and perpendicular to the current source direction,
which tilts the source "vertically" out of the former incidence plane.</p>

<p>axis = "random" means the the source direction is tilted in a random direction,
e.g. simulating a beam pointing fluctuation.</p>

<p>Attention, "angle" is given in deg, so as to remain consitent with the
conventions of other functions, although pointing is mostly talked about
in mrad instead.</p>

<h2 id="parameters">Parameters</h2>

<pre><code>axis : np.ndarray or str
    Shift axis, specified either as a 3D lab-frame vector or as one
    of the strings "in_plane", "out_plane", or "random".

angle : float
    Rotation angle in degree.
</code></pre>

<h2 id="returns">Returns</h2>

<pre><code>Nothing, just modifies the property 'source_rays'.
</code></pre>
</div>


                            </div>
                            <div id="OpticalChain.partial_realign" class="classattr">
                                        <input id="OpticalChain.partial_realign-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">partial_realign</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">OEstart</span>,</span><span class="param">	<span class="n">OEstop</span>,</span><span class="param">	<span class="n">DistanceList</span>,</span><span class="param">	<span class="n">IncidenceAngleList</span>,</span><span class="param">	<span class="n">IncidencePlaneAngleList</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="OpticalChain.partial_realign-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#OpticalChain.partial_realign"></a>
            <div class="chroma pdoc-code"><pre><span></span><span id="OpticalChain.partial_realign-345"><a href="#OpticalChain.partial_realign-345"><span class="linenos">345</span></a>    <span class="k">def</span> <span class="nf">partial_realign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OEstart</span><span class="p">,</span> <span class="n">OEstop</span><span class="p">,</span> <span class="n">DistanceList</span><span class="p">,</span> <span class="n">IncidenceAngleList</span><span class="p">,</span> <span class="n">IncidencePlaneAngleList</span><span class="p">):</span>
</span><span id="OpticalChain.partial_realign-346"><a href="#OpticalChain.partial_realign-346"><span class="linenos">346</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="OpticalChain.partial_realign-347"><a href="#OpticalChain.partial_realign-347"><span class="linenos">347</span></a><span class="sd">        This as-of-yet not-implemented method will realign only the parts of the optical chain that are between the elements</span>
</span><span id="OpticalChain.partial_realign-348"><a href="#OpticalChain.partial_realign-348"><span class="linenos">348</span></a><span class="sd">        OEstart and OEstop (both included).</span>
</span><span id="OpticalChain.partial_realign-349"><a href="#OpticalChain.partial_realign-349"><span class="linenos">349</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="OpticalChain.partial_realign-350"><a href="#OpticalChain.partial_realign-350"><span class="linenos">350</span></a>        <span class="n">OpticsList</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">[</span><span class="n">OEstart</span><span class="p">:</span><span class="n">OEstop</span><span class="p">]]</span>
</span><span id="OpticalChain.partial_realign-351"><a href="#OpticalChain.partial_realign-351"><span class="linenos">351</span></a>        <span class="n">outray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_output_rays</span><span class="p">()[</span><span class="n">OEstart</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="OpticalChain.partial_realign-352"><a href="#OpticalChain.partial_realign-352"><span class="linenos">352</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">outray</span><span class="p">)</span>
</span><span id="OpticalChain.partial_realign-353"><a href="#OpticalChain.partial_realign-353"><span class="linenos">353</span></a>        <span class="n">new_elements</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">OEPlacement</span><span class="p">(</span><span class="n">OpticsList</span><span class="p">,</span> <span class="n">DistanceList</span><span class="p">,</span> <span class="n">IncidenceAngleList</span><span class="p">,</span> <span class="n">IncidencePlaneAngleList</span><span class="p">,</span> <span class="n">outray</span><span class="p">)</span>
</span><span id="OpticalChain.partial_realign-354"><a href="#OpticalChain.partial_realign-354"><span class="linenos">354</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">[</span><span class="n">OEstart</span><span class="p">:</span><span class="n">OEstop</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_elements</span>
</span></pre></div>


            <div class="docstring"><p>This as-of-yet not-implemented method will realign only the parts of the optical chain that are between the elements
OEstart and OEstop (both included).</p>
</div>


                            </div>
                            <div id="OpticalChain.rotate_OE" class="classattr">
                                        <input id="OpticalChain.rotate_OE-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">rotate_OE</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">OEindx</span><span class="p">:</span> <span class="nb">int</span>, </span><span class="param"><span class="n">ref</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">axis</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">angle</span><span class="p">:</span> <span class="nb">float</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="OpticalChain.rotate_OE-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#OpticalChain.rotate_OE"></a>
            <div class="chroma pdoc-code"><pre><span></span><span id="OpticalChain.rotate_OE-357"><a href="#OpticalChain.rotate_OE-357"><span class="linenos">357</span></a>    <span class="k">def</span> <span class="nf">rotate_OE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OEindx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">angle</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
</span><span id="OpticalChain.rotate_OE-358"><a href="#OpticalChain.rotate_OE-358"><span class="linenos">358</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="OpticalChain.rotate_OE-359"><a href="#OpticalChain.rotate_OE-359"><span class="linenos">359</span></a><span class="sd">        Rotate the optical element OpticalChain.optical_elements[OEindx] with an axis defined relative to the master ray.</span>
</span><span id="OpticalChain.rotate_OE-360"><a href="#OpticalChain.rotate_OE-360"><span class="linenos">360</span></a><span class="sd">        The axis can either be relative to the incoming master ray or the outgoing one. This is defined  by the &quot;ref&quot; variable </span>
</span><span id="OpticalChain.rotate_OE-361"><a href="#OpticalChain.rotate_OE-361"><span class="linenos">361</span></a><span class="sd">        that takes either of the two values:</span>
</span><span id="OpticalChain.rotate_OE-362"><a href="#OpticalChain.rotate_OE-362"><span class="linenos">362</span></a><span class="sd">            - &quot;in&quot;</span>
</span><span id="OpticalChain.rotate_OE-363"><a href="#OpticalChain.rotate_OE-363"><span class="linenos">363</span></a><span class="sd">            - &quot;out&quot;</span>
</span><span id="OpticalChain.rotate_OE-364"><a href="#OpticalChain.rotate_OE-364"><span class="linenos">364</span></a><span class="sd">        In either case the &quot;axis&quot; can take these values:</span>
</span><span id="OpticalChain.rotate_OE-365"><a href="#OpticalChain.rotate_OE-365"><span class="linenos">365</span></a><span class="sd">            - &quot;roll&quot;: Rotation about the master ray. Looking in the same direction as light propagation, positive is counterclockwise</span>
</span><span id="OpticalChain.rotate_OE-366"><a href="#OpticalChain.rotate_OE-366"><span class="linenos">366</span></a><span class="sd">            - &quot;pitch&quot;: Rotation about the vector in the incidence plane that is normal to the master ray.</span>
</span><span id="OpticalChain.rotate_OE-367"><a href="#OpticalChain.rotate_OE-367"><span class="linenos">367</span></a><span class="sd">            - &quot;yaw&quot;: Rotation about the vector normal to the incidence plane and to the master ray.</span>
</span><span id="OpticalChain.rotate_OE-368"><a href="#OpticalChain.rotate_OE-368"><span class="linenos">368</span></a>
</span><span id="OpticalChain.rotate_OE-369"><a href="#OpticalChain.rotate_OE-369"><span class="linenos">369</span></a><span class="sd">        Parameters</span>
</span><span id="OpticalChain.rotate_OE-370"><a href="#OpticalChain.rotate_OE-370"><span class="linenos">370</span></a><span class="sd">        ----------</span>
</span><span id="OpticalChain.rotate_OE-371"><a href="#OpticalChain.rotate_OE-371"><span class="linenos">371</span></a><span class="sd">            OEindx : int</span>
</span><span id="OpticalChain.rotate_OE-372"><a href="#OpticalChain.rotate_OE-372"><span class="linenos">372</span></a><span class="sd">                Index of the optical element to modify out of OpticalChain.optical_elements.</span>
</span><span id="OpticalChain.rotate_OE-373"><a href="#OpticalChain.rotate_OE-373"><span class="linenos">373</span></a>
</span><span id="OpticalChain.rotate_OE-374"><a href="#OpticalChain.rotate_OE-374"><span class="linenos">374</span></a><span class="sd">            ref : str</span>
</span><span id="OpticalChain.rotate_OE-375"><a href="#OpticalChain.rotate_OE-375"><span class="linenos">375</span></a><span class="sd">                Reference ray used to define the axes of rotation. Can be either:</span>
</span><span id="OpticalChain.rotate_OE-376"><a href="#OpticalChain.rotate_OE-376"><span class="linenos">376</span></a><span class="sd">                &quot;in&quot; or &quot;out&quot; or &quot;local_normal&quot; (in+out)</span>
</span><span id="OpticalChain.rotate_OE-377"><a href="#OpticalChain.rotate_OE-377"><span class="linenos">377</span></a>
</span><span id="OpticalChain.rotate_OE-378"><a href="#OpticalChain.rotate_OE-378"><span class="linenos">378</span></a><span class="sd">            axis : str</span>
</span><span id="OpticalChain.rotate_OE-379"><a href="#OpticalChain.rotate_OE-379"><span class="linenos">379</span></a><span class="sd">                Rotation axis, specified as one of the strings</span>
</span><span id="OpticalChain.rotate_OE-380"><a href="#OpticalChain.rotate_OE-380"><span class="linenos">380</span></a><span class="sd">                &quot;pitch&quot;, &quot;roll&quot;, &quot;yaw&quot;</span>
</span><span id="OpticalChain.rotate_OE-381"><a href="#OpticalChain.rotate_OE-381"><span class="linenos">381</span></a>
</span><span id="OpticalChain.rotate_OE-382"><a href="#OpticalChain.rotate_OE-382"><span class="linenos">382</span></a><span class="sd">            angle : float</span>
</span><span id="OpticalChain.rotate_OE-383"><a href="#OpticalChain.rotate_OE-383"><span class="linenos">383</span></a><span class="sd">                Rotation angle in degree.</span>
</span><span id="OpticalChain.rotate_OE-384"><a href="#OpticalChain.rotate_OE-384"><span class="linenos">384</span></a>
</span><span id="OpticalChain.rotate_OE-385"><a href="#OpticalChain.rotate_OE-385"><span class="linenos">385</span></a><span class="sd">        Returns</span>
</span><span id="OpticalChain.rotate_OE-386"><a href="#OpticalChain.rotate_OE-386"><span class="linenos">386</span></a><span class="sd">        -------</span>
</span><span id="OpticalChain.rotate_OE-387"><a href="#OpticalChain.rotate_OE-387"><span class="linenos">387</span></a><span class="sd">            Nothing, just modifies OpticalChain.optical_elements[OEindx].</span>
</span><span id="OpticalChain.rotate_OE-388"><a href="#OpticalChain.rotate_OE-388"><span class="linenos">388</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="OpticalChain.rotate_OE-389"><a href="#OpticalChain.rotate_OE-389"><span class="linenos">389</span></a>        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">OEindx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">):</span>
</span><span id="OpticalChain.rotate_OE-390"><a href="#OpticalChain.rotate_OE-390"><span class="linenos">390</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="OpticalChain.rotate_OE-391"><a href="#OpticalChain.rotate_OE-391"><span class="linenos">391</span></a>                <span class="s1">&#39;The &quot;OEnumber&quot;-argument is out of range compared to the length of OpticalChain.optical_elements.&#39;</span>
</span><span id="OpticalChain.rotate_OE-392"><a href="#OpticalChain.rotate_OE-392"><span class="linenos">392</span></a>            <span class="p">)</span>
</span><span id="OpticalChain.rotate_OE-393"><a href="#OpticalChain.rotate_OE-393"><span class="linenos">393</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
</span><span id="OpticalChain.rotate_OE-394"><a href="#OpticalChain.rotate_OE-394"><span class="linenos">394</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The &quot;angle&quot;-argument must be an int or float number.&#39;</span><span class="p">)</span>
</span><span id="OpticalChain.rotate_OE-395"><a href="#OpticalChain.rotate_OE-395"><span class="linenos">395</span></a>        <span class="n">MasterRay</span> <span class="o">=</span> <span class="p">[</span><span class="n">mp</span><span class="o">.</span><span class="n">FindCentralRay</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_rays</span><span class="p">)]</span>
</span><span id="OpticalChain.rotate_OE-396"><a href="#OpticalChain.rotate_OE-396"><span class="linenos">396</span></a>        <span class="n">TracedRay</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">RayTracingCalculation</span><span class="p">(</span><span class="n">MasterRay</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">)</span>
</span><span id="OpticalChain.rotate_OE-397"><a href="#OpticalChain.rotate_OE-397"><span class="linenos">397</span></a>        <span class="n">TracedRay</span> <span class="o">=</span> <span class="p">[</span><span class="n">MasterRay</span><span class="p">]</span> <span class="o">+</span> <span class="n">TracedRay</span>
</span><span id="OpticalChain.rotate_OE-398"><a href="#OpticalChain.rotate_OE-398"><span class="linenos">398</span></a>        <span class="k">match</span> <span class="n">ref</span><span class="p">:</span>
</span><span id="OpticalChain.rotate_OE-399"><a href="#OpticalChain.rotate_OE-399"><span class="linenos">399</span></a>            <span class="k">case</span> <span class="s2">&quot;out&quot;</span><span class="p">:</span>
</span><span id="OpticalChain.rotate_OE-400"><a href="#OpticalChain.rotate_OE-400"><span class="linenos">400</span></a>                <span class="n">RefVec</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">TracedRay</span><span class="p">[</span><span class="n">OEindx</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vector</span><span class="p">)</span>
</span><span id="OpticalChain.rotate_OE-401"><a href="#OpticalChain.rotate_OE-401"><span class="linenos">401</span></a>            <span class="k">case</span> <span class="s2">&quot;in&quot;</span><span class="p">:</span>
</span><span id="OpticalChain.rotate_OE-402"><a href="#OpticalChain.rotate_OE-402"><span class="linenos">402</span></a>                <span class="n">RefVec</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">TracedRay</span><span class="p">[</span><span class="n">OEindx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vector</span><span class="p">)</span>
</span><span id="OpticalChain.rotate_OE-403"><a href="#OpticalChain.rotate_OE-403"><span class="linenos">403</span></a>            <span class="k">case</span> <span class="s2">&quot;localnormal&quot;</span><span class="p">:</span>
</span><span id="OpticalChain.rotate_OE-404"><a href="#OpticalChain.rotate_OE-404"><span class="linenos">404</span></a>                <span class="n">In</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">TracedRay</span><span class="p">[</span><span class="n">OEindx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vector</span><span class="p">)</span>
</span><span id="OpticalChain.rotate_OE-405"><a href="#OpticalChain.rotate_OE-405"><span class="linenos">405</span></a>                <span class="n">Out</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">TracedRay</span><span class="p">[</span><span class="n">OEindx</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vector</span><span class="p">)</span>
</span><span id="OpticalChain.rotate_OE-406"><a href="#OpticalChain.rotate_OE-406"><span class="linenos">406</span></a>                <span class="n">RefVec</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">Out</span><span class="o">-</span><span class="n">In</span><span class="p">)</span>
</span><span id="OpticalChain.rotate_OE-407"><a href="#OpticalChain.rotate_OE-407"><span class="linenos">407</span></a>            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
</span><span id="OpticalChain.rotate_OE-408"><a href="#OpticalChain.rotate_OE-408"><span class="linenos">408</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The &quot;ref&quot;-argument must be a string out of [&quot;in&quot;, &quot;out&quot;, &quot;localnormal].&#39;</span><span class="p">)</span>
</span><span id="OpticalChain.rotate_OE-409"><a href="#OpticalChain.rotate_OE-409"><span class="linenos">409</span></a>        <span class="k">if</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span><span class="p">,</span><span class="n">RefVec</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-2</span><span class="p">:</span>
</span><span id="OpticalChain.rotate_OE-410"><a href="#OpticalChain.rotate_OE-410"><span class="linenos">410</span></a>            <span class="k">match</span> <span class="n">axis</span><span class="p">:</span>
</span><span id="OpticalChain.rotate_OE-411"><a href="#OpticalChain.rotate_OE-411"><span class="linenos">411</span></a>                <span class="k">case</span> <span class="s2">&quot;pitch&quot;</span><span class="p">:</span>
</span><span id="OpticalChain.rotate_OE-412"><a href="#OpticalChain.rotate_OE-412"><span class="linenos">412</span></a>                    <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">RotationAroundAxis</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">majoraxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span><span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span><span class="p">)</span>
</span><span id="OpticalChain.rotate_OE-413"><a href="#OpticalChain.rotate_OE-413"><span class="linenos">413</span></a>                <span class="k">case</span> <span class="s2">&quot;roll&quot;</span><span class="p">:</span>
</span><span id="OpticalChain.rotate_OE-414"><a href="#OpticalChain.rotate_OE-414"><span class="linenos">414</span></a>                    <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">RotationAroundAxis</span><span class="p">(</span><span class="n">RefVec</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span><span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span><span class="p">)</span>
</span><span id="OpticalChain.rotate_OE-415"><a href="#OpticalChain.rotate_OE-415"><span class="linenos">415</span></a>                <span class="k">case</span> <span class="s2">&quot;yaw&quot;</span><span class="p">:</span>
</span><span id="OpticalChain.rotate_OE-416"><a href="#OpticalChain.rotate_OE-416"><span class="linenos">416</span></a>                    <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">RotationAroundAxis</span><span class="p">(</span><span class="n">mgeo</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">RefVec</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">majoraxis</span><span class="p">)),</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span><span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span><span class="p">)</span>
</span><span id="OpticalChain.rotate_OE-417"><a href="#OpticalChain.rotate_OE-417"><span class="linenos">417</span></a>                <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
</span><span id="OpticalChain.rotate_OE-418"><a href="#OpticalChain.rotate_OE-418"><span class="linenos">418</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The &quot;axis&quot;-argument must be a string out of [&quot;pitch&quot;, &quot;roll&quot;, &quot;yaw&quot;].&#39;</span><span class="p">)</span>
</span><span id="OpticalChain.rotate_OE-419"><a href="#OpticalChain.rotate_OE-419"><span class="linenos">419</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="OpticalChain.rotate_OE-420"><a href="#OpticalChain.rotate_OE-420"><span class="linenos">420</span></a>            <span class="c1">#If the normal vector is aligned with the ray</span>
</span><span id="OpticalChain.rotate_OE-421"><a href="#OpticalChain.rotate_OE-421"><span class="linenos">421</span></a>            <span class="k">match</span> <span class="n">axis</span><span class="p">:</span>
</span><span id="OpticalChain.rotate_OE-422"><a href="#OpticalChain.rotate_OE-422"><span class="linenos">422</span></a>                <span class="k">case</span> <span class="s2">&quot;pitch&quot;</span><span class="p">:</span>
</span><span id="OpticalChain.rotate_OE-423"><a href="#OpticalChain.rotate_OE-423"><span class="linenos">423</span></a>                    <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">RotationAroundAxis</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">majoraxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span><span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span><span class="p">)</span>
</span><span id="OpticalChain.rotate_OE-424"><a href="#OpticalChain.rotate_OE-424"><span class="linenos">424</span></a>                <span class="k">case</span> <span class="s2">&quot;roll&quot;</span><span class="p">:</span>
</span><span id="OpticalChain.rotate_OE-425"><a href="#OpticalChain.rotate_OE-425"><span class="linenos">425</span></a>                    <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">majoraxis</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">RotationAroundAxis</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span><span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">majoraxis</span><span class="p">)</span>
</span><span id="OpticalChain.rotate_OE-426"><a href="#OpticalChain.rotate_OE-426"><span class="linenos">426</span></a>                <span class="k">case</span> <span class="s2">&quot;yaw&quot;</span><span class="p">:</span>
</span><span id="OpticalChain.rotate_OE-427"><a href="#OpticalChain.rotate_OE-427"><span class="linenos">427</span></a>                    <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">RotationAroundAxis</span><span class="p">(</span><span class="n">mgeo</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">RefVec</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">majoraxis</span><span class="p">)),</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span><span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span><span class="p">)</span>
</span><span id="OpticalChain.rotate_OE-428"><a href="#OpticalChain.rotate_OE-428"><span class="linenos">428</span></a>                <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
</span><span id="OpticalChain.rotate_OE-429"><a href="#OpticalChain.rotate_OE-429"><span class="linenos">429</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The &quot;axis&quot;-argument must be a string out of [&quot;pitch&quot;, &quot;roll&quot;, &quot;yaw&quot;].&#39;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Rotate the optical element <a href="#OpticalChain.optical_elements">OpticalChain.optical_elements</a>[OEindx] with an axis defined relative to the master ray.
The axis can either be relative to the incoming master ray or the outgoing one. This is defined  by the "ref" variable 
that takes either of the two values:
    - "in"
    - "out"
In either case the "axis" can take these values:
    - "roll": Rotation about the master ray. Looking in the same direction as light propagation, positive is counterclockwise
    - "pitch": Rotation about the vector in the incidence plane that is normal to the master ray.
    - "yaw": Rotation about the vector normal to the incidence plane and to the master ray.</p>

<h2 id="parameters">Parameters</h2>

<pre><code>OEindx : int
    Index of the optical element to modify out of <a href="#OpticalChain.optical_elements">OpticalChain.optical_elements</a>.

ref : str
    Reference ray used to define the axes of rotation. Can be either:
    "in" or "out" or "local_normal" (in+out)

axis : str
    Rotation axis, specified as one of the strings
    "pitch", "roll", "yaw"

angle : float
    Rotation angle in degree.
</code></pre>

<h2 id="returns">Returns</h2>

<pre><code>Nothing, just modifies <a href="#OpticalChain.optical_elements">OpticalChain.optical_elements</a>[OEindx].
</code></pre>
</div>


                            </div>
                            <div id="OpticalChain.shift_OE" class="classattr">
                                        <input id="OpticalChain.shift_OE-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">shift_OE</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">OEindx</span><span class="p">:</span> <span class="nb">int</span>, </span><span class="param"><span class="n">ref</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">axis</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">distance</span><span class="p">:</span> <span class="nb">float</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="OpticalChain.shift_OE-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#OpticalChain.shift_OE"></a>
            <div class="chroma pdoc-code"><pre><span></span><span id="OpticalChain.shift_OE-431"><a href="#OpticalChain.shift_OE-431"><span class="linenos">431</span></a>    <span class="k">def</span> <span class="nf">shift_OE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OEindx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">distance</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
</span><span id="OpticalChain.shift_OE-432"><a href="#OpticalChain.shift_OE-432"><span class="linenos">432</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="OpticalChain.shift_OE-433"><a href="#OpticalChain.shift_OE-433"><span class="linenos">433</span></a><span class="sd">        Shift the optical element OpticalChain.optical_elements[OEindx] along</span>
</span><span id="OpticalChain.shift_OE-434"><a href="#OpticalChain.shift_OE-434"><span class="linenos">434</span></a><span class="sd">        axis referenced to the master ray.</span>
</span><span id="OpticalChain.shift_OE-435"><a href="#OpticalChain.shift_OE-435"><span class="linenos">435</span></a>
</span><span id="OpticalChain.shift_OE-436"><a href="#OpticalChain.shift_OE-436"><span class="linenos">436</span></a><span class="sd">        The axis can either be relative to the incoming master ray or the outgoing one. This is defined  by the &quot;ref&quot; variable </span>
</span><span id="OpticalChain.shift_OE-437"><a href="#OpticalChain.shift_OE-437"><span class="linenos">437</span></a><span class="sd">        that takes either of the two values:</span>
</span><span id="OpticalChain.shift_OE-438"><a href="#OpticalChain.shift_OE-438"><span class="linenos">438</span></a><span class="sd">            - &quot;in&quot;</span>
</span><span id="OpticalChain.shift_OE-439"><a href="#OpticalChain.shift_OE-439"><span class="linenos">439</span></a><span class="sd">            - &quot;out&quot;</span>
</span><span id="OpticalChain.shift_OE-440"><a href="#OpticalChain.shift_OE-440"><span class="linenos">440</span></a><span class="sd">        In either case the &quot;axis&quot; can take these values:</span>
</span><span id="OpticalChain.shift_OE-441"><a href="#OpticalChain.shift_OE-441"><span class="linenos">441</span></a><span class="sd">            - &quot;along&quot;: Translation along the master ray.</span>
</span><span id="OpticalChain.shift_OE-442"><a href="#OpticalChain.shift_OE-442"><span class="linenos">442</span></a><span class="sd">            - &quot;in_plane&quot;: Translation along the vector in the incidence plane that is normal to the master ray.</span>
</span><span id="OpticalChain.shift_OE-443"><a href="#OpticalChain.shift_OE-443"><span class="linenos">443</span></a><span class="sd">            - &quot;out_plane&quot;: Translation along the vector normal to the incidence plane and to the master ray.</span>
</span><span id="OpticalChain.shift_OE-444"><a href="#OpticalChain.shift_OE-444"><span class="linenos">444</span></a>
</span><span id="OpticalChain.shift_OE-445"><a href="#OpticalChain.shift_OE-445"><span class="linenos">445</span></a><span class="sd">        Parameters</span>
</span><span id="OpticalChain.shift_OE-446"><a href="#OpticalChain.shift_OE-446"><span class="linenos">446</span></a><span class="sd">        ----------</span>
</span><span id="OpticalChain.shift_OE-447"><a href="#OpticalChain.shift_OE-447"><span class="linenos">447</span></a><span class="sd">            OEindx : int</span>
</span><span id="OpticalChain.shift_OE-448"><a href="#OpticalChain.shift_OE-448"><span class="linenos">448</span></a><span class="sd">                Index of the optical element to modify out of OpticalChain.optical_elements.</span>
</span><span id="OpticalChain.shift_OE-449"><a href="#OpticalChain.shift_OE-449"><span class="linenos">449</span></a>
</span><span id="OpticalChain.shift_OE-450"><a href="#OpticalChain.shift_OE-450"><span class="linenos">450</span></a><span class="sd">            ref : str</span>
</span><span id="OpticalChain.shift_OE-451"><a href="#OpticalChain.shift_OE-451"><span class="linenos">451</span></a><span class="sd">                Reference ray used to define the axes of rotation. Can be either:</span>
</span><span id="OpticalChain.shift_OE-452"><a href="#OpticalChain.shift_OE-452"><span class="linenos">452</span></a><span class="sd">                &quot;in&quot; or &quot;out&quot;.</span>
</span><span id="OpticalChain.shift_OE-453"><a href="#OpticalChain.shift_OE-453"><span class="linenos">453</span></a>
</span><span id="OpticalChain.shift_OE-454"><a href="#OpticalChain.shift_OE-454"><span class="linenos">454</span></a><span class="sd">            axis : str</span>
</span><span id="OpticalChain.shift_OE-455"><a href="#OpticalChain.shift_OE-455"><span class="linenos">455</span></a><span class="sd">                Translation axis, specified as one of the strings</span>
</span><span id="OpticalChain.shift_OE-456"><a href="#OpticalChain.shift_OE-456"><span class="linenos">456</span></a><span class="sd">                &quot;along&quot;, &quot;in_plane&quot;, &quot;out_plane&quot;.</span>
</span><span id="OpticalChain.shift_OE-457"><a href="#OpticalChain.shift_OE-457"><span class="linenos">457</span></a>
</span><span id="OpticalChain.shift_OE-458"><a href="#OpticalChain.shift_OE-458"><span class="linenos">458</span></a><span class="sd">            distance : float</span>
</span><span id="OpticalChain.shift_OE-459"><a href="#OpticalChain.shift_OE-459"><span class="linenos">459</span></a><span class="sd">                Rotation angle in degree.</span>
</span><span id="OpticalChain.shift_OE-460"><a href="#OpticalChain.shift_OE-460"><span class="linenos">460</span></a>
</span><span id="OpticalChain.shift_OE-461"><a href="#OpticalChain.shift_OE-461"><span class="linenos">461</span></a><span class="sd">        Returns</span>
</span><span id="OpticalChain.shift_OE-462"><a href="#OpticalChain.shift_OE-462"><span class="linenos">462</span></a><span class="sd">        -------</span>
</span><span id="OpticalChain.shift_OE-463"><a href="#OpticalChain.shift_OE-463"><span class="linenos">463</span></a><span class="sd">            Nothing, just modifies OpticalChain.optical_elements[OEindx].</span>
</span><span id="OpticalChain.shift_OE-464"><a href="#OpticalChain.shift_OE-464"><span class="linenos">464</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="OpticalChain.shift_OE-465"><a href="#OpticalChain.shift_OE-465"><span class="linenos">465</span></a>        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">OEindx</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">):</span>
</span><span id="OpticalChain.shift_OE-466"><a href="#OpticalChain.shift_OE-466"><span class="linenos">466</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="OpticalChain.shift_OE-467"><a href="#OpticalChain.shift_OE-467"><span class="linenos">467</span></a>                <span class="s1">&#39;The &quot;OEnumber&quot;-argument is out of range compared to the length of OpticalChain.optical_elements.&#39;</span>
</span><span id="OpticalChain.shift_OE-468"><a href="#OpticalChain.shift_OE-468"><span class="linenos">468</span></a>            <span class="p">)</span>
</span><span id="OpticalChain.shift_OE-469"><a href="#OpticalChain.shift_OE-469"><span class="linenos">469</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
</span><span id="OpticalChain.shift_OE-470"><a href="#OpticalChain.shift_OE-470"><span class="linenos">470</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The &quot;dist&quot;-argument must be an int or float number.&#39;</span><span class="p">)</span>
</span><span id="OpticalChain.shift_OE-471"><a href="#OpticalChain.shift_OE-471"><span class="linenos">471</span></a>
</span><span id="OpticalChain.shift_OE-472"><a href="#OpticalChain.shift_OE-472"><span class="linenos">472</span></a>        <span class="n">MasterRay</span> <span class="o">=</span> <span class="p">[</span><span class="n">mp</span><span class="o">.</span><span class="n">FindCentralRay</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_rays</span><span class="p">)]</span>
</span><span id="OpticalChain.shift_OE-473"><a href="#OpticalChain.shift_OE-473"><span class="linenos">473</span></a>        <span class="n">TracedRay</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">RayTracingCalculation</span><span class="p">(</span><span class="n">MasterRay</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">)</span>
</span><span id="OpticalChain.shift_OE-474"><a href="#OpticalChain.shift_OE-474"><span class="linenos">474</span></a>        <span class="n">TracedRay</span> <span class="o">=</span> <span class="p">[</span><span class="n">MasterRay</span><span class="p">]</span> <span class="o">+</span> <span class="n">TracedRay</span>
</span><span id="OpticalChain.shift_OE-475"><a href="#OpticalChain.shift_OE-475"><span class="linenos">475</span></a>        <span class="k">match</span> <span class="n">ref</span><span class="p">:</span>
</span><span id="OpticalChain.shift_OE-476"><a href="#OpticalChain.shift_OE-476"><span class="linenos">476</span></a>            <span class="k">case</span> <span class="s2">&quot;out&quot;</span><span class="p">:</span>
</span><span id="OpticalChain.shift_OE-477"><a href="#OpticalChain.shift_OE-477"><span class="linenos">477</span></a>                <span class="n">RefVec</span> <span class="o">=</span> <span class="n">TracedRay</span><span class="p">[</span><span class="n">OEindx</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vector</span>
</span><span id="OpticalChain.shift_OE-478"><a href="#OpticalChain.shift_OE-478"><span class="linenos">478</span></a>            <span class="k">case</span> <span class="s2">&quot;in&quot;</span><span class="p">:</span>
</span><span id="OpticalChain.shift_OE-479"><a href="#OpticalChain.shift_OE-479"><span class="linenos">479</span></a>                <span class="n">RefVec</span> <span class="o">=</span> <span class="n">TracedRay</span><span class="p">[</span><span class="n">OEindx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vector</span>
</span><span id="OpticalChain.shift_OE-480"><a href="#OpticalChain.shift_OE-480"><span class="linenos">480</span></a>            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
</span><span id="OpticalChain.shift_OE-481"><a href="#OpticalChain.shift_OE-481"><span class="linenos">481</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The &quot;ref&quot;-argument must be a string out of [&quot;in&quot;, &quot;out&quot;].&#39;</span><span class="p">)</span>
</span><span id="OpticalChain.shift_OE-482"><a href="#OpticalChain.shift_OE-482"><span class="linenos">482</span></a>        <span class="k">match</span> <span class="n">axis</span><span class="p">:</span>
</span><span id="OpticalChain.shift_OE-483"><a href="#OpticalChain.shift_OE-483"><span class="linenos">483</span></a>            <span class="k">case</span> <span class="s2">&quot;along&quot;</span><span class="p">:</span>
</span><span id="OpticalChain.shift_OE-484"><a href="#OpticalChain.shift_OE-484"><span class="linenos">484</span></a>                <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">position</span> <span class="o">+</span> <span class="n">distance</span> <span class="o">*</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">RefVec</span><span class="p">)</span>
</span><span id="OpticalChain.shift_OE-485"><a href="#OpticalChain.shift_OE-485"><span class="linenos">485</span></a>            <span class="k">case</span> <span class="s2">&quot;in_plane&quot;</span><span class="p">:</span>
</span><span id="OpticalChain.shift_OE-486"><a href="#OpticalChain.shift_OE-486"><span class="linenos">486</span></a>                <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">position</span> <span class="o">+</span> <span class="n">distance</span> <span class="o">*</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">RefVec</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">RefVec</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span><span class="p">)))</span>
</span><span id="OpticalChain.shift_OE-487"><a href="#OpticalChain.shift_OE-487"><span class="linenos">487</span></a>            <span class="k">case</span> <span class="s2">&quot;out_plane&quot;</span><span class="p">:</span>
</span><span id="OpticalChain.shift_OE-488"><a href="#OpticalChain.shift_OE-488"><span class="linenos">488</span></a>                <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">position</span> <span class="o">+</span> <span class="n">distance</span> <span class="o">*</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">RefVec</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="n">OEindx</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span><span class="p">))</span>
</span><span id="OpticalChain.shift_OE-489"><a href="#OpticalChain.shift_OE-489"><span class="linenos">489</span></a>            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
</span><span id="OpticalChain.shift_OE-490"><a href="#OpticalChain.shift_OE-490"><span class="linenos">490</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The &quot;axis&quot;-argument must be a string out of [&quot;along&quot;, &quot;in_plane&quot;, &quot;out_plane&quot;].&#39;</span><span class="p">)</span>
</span><span id="OpticalChain.shift_OE-491"><a href="#OpticalChain.shift_OE-491"><span class="linenos">491</span></a>
</span><span id="OpticalChain.shift_OE-492"><a href="#OpticalChain.shift_OE-492"><span class="linenos">492</span></a>        <span class="c1"># some function that randomly misalings one, or several or all ?</span>
</span></pre></div>


            <div class="docstring"><p>Shift the optical element <a href="#OpticalChain.optical_elements">OpticalChain.optical_elements</a>[OEindx] along
axis referenced to the master ray.</p>

<p>The axis can either be relative to the incoming master ray or the outgoing one. This is defined  by the "ref" variable 
that takes either of the two values:
    - "in"
    - "out"
In either case the "axis" can take these values:
    - "along": Translation along the master ray.
    - "in_plane": Translation along the vector in the incidence plane that is normal to the master ray.
    - "out_plane": Translation along the vector normal to the incidence plane and to the master ray.</p>

<h2 id="parameters">Parameters</h2>

<pre><code>OEindx : int
    Index of the optical element to modify out of <a href="#OpticalChain.optical_elements">OpticalChain.optical_elements</a>.

ref : str
    Reference ray used to define the axes of rotation. Can be either:
    "in" or "out".

axis : str
    Translation axis, specified as one of the strings
    "along", "in_plane", "out_plane".

distance : float
    Rotation angle in degree.
</code></pre>

<h2 id="returns">Returns</h2>

<pre><code>Nothing, just modifies <a href="#OpticalChain.optical_elements">OpticalChain.optical_elements</a>[OEindx].
</code></pre>
</div>


                            </div>
                </section>
</div>


<style>pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
<style>:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
<style>.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
<style>.pdoc *{scroll-margin:4rem;}</style>