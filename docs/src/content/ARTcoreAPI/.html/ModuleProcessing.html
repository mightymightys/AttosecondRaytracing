<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css" integrity="sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js" integrity="sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
            delimiters: [
                {left: "$$", right: "$$", display: true},
                {left: "$", right: "$", display: false}
            ]
        });
    });
</script>

<!--
<div class="td-toc"><nav id="TableOfContents"><div>
            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="variable" href="#logger">logger</a>
            </li>
            <li>
                    <a class="function" href="#OEPlacement">OEPlacement</a>
            </li>
            <li>
                    <a class="function" href="#RayTracingCalculation">RayTracingCalculation</a>
            </li>
            <li>
                    <a class="function" href="#FindOptimalDistance">FindOptimalDistance</a>
            </li>
            <li>
                    <a class="function" href="#FindCentralRay">FindCentralRay</a>
            </li>
            <li>
                    <a class="function" href="#StandardDeviation">StandardDeviation</a>
            </li>
            <li>
                    <a class="function" href="#WeightedStandardDeviation">WeightedStandardDeviation</a>
            </li>
            <li>
                    <a class="function" href="#ReturnNumericalAperture">ReturnNumericalAperture</a>
            </li>
            <li>
                    <a class="function" href="#ReturnAiryRadius">ReturnAiryRadius</a>
            </li>
            <li>
                    <a class="function" href="#save_compressed">save_compressed</a>
            </li>
            <li>
                    <a class="function" href="#load_compressed">load_compressed</a>
            </li>
    </ul>

</div></nav></div>
-->

<!--
We comment the TOC out because we want to integrate it into the page layout of Docsy
-->


<div class="pdoc">
            <section class="module-info">
                    

                        <div class="docstring"><p>Contains processing functions used for the ray-tracing and automated (pre-)alignment of the optical chains.
Usually these don't need to be called by users of ART, but they may be useful.</p>

<p>Created in Apr 2020</p>

<p>@author: Anthony Guillaume + Stefan Haessler</p>
</div>

                        <input id="mod-ModuleProcessing-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-ModuleProcessing-view-source"><span>View Source</span></label>

                        <div class="chroma pdoc-code"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="sd">Contains processing functions used for the ray-tracing and automated (pre-)alignment of the optical chains.</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="sd">Usually these don&#39;t need to be called by users of ART, but they may be useful.</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="sd">Created in Apr 2020</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="sd">@author: Anthony Guillaume + Stefan Haessler</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="c1"># %% Modules</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="kn">import</span> <span class="nn">ARTcore.ModuleGeometry</span> <span class="k">as</span> <span class="nn">mgeo</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="kn">import</span> <span class="nn">ARTcore.ModuleMirror</span> <span class="k">as</span> <span class="nn">mmirror</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="kn">import</span> <span class="nn">ARTcore.ModuleMask</span> <span class="k">as</span> <span class="nn">mmask</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="kn">import</span> <span class="nn">ARTcore.ModuleSource</span> <span class="k">as</span> <span class="nn">msource</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="kn">import</span> <span class="nn">ARTcore.ModuleOpticalElement</span> <span class="k">as</span> <span class="nn">moe</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="kn">import</span> <span class="nn">ARTcore.ModuleOpticalRay</span> <span class="k">as</span> <span class="nn">mray</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="kn">import</span> <span class="nn">ARTcore.ModuleSupport</span> <span class="k">as</span> <span class="nn">msupp</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="kn">import</span> <span class="nn">ARTcore.ModuleOpticalChain</span> <span class="k">as</span> <span class="nn">moc</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="kn">import</span> <span class="nn">pickle</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="c1"># import gzip</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="kn">import</span> <span class="nn">lzma</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">perf_counter</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="kn">import</span> <span class="nn">copy</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a><span class="kn">import</span> <span class="nn">quaternion</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a><span class="kn">import</span> <span class="nn">logging</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a><span class="c1"># %%</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a><span class="k">def</span> <span class="nf">OEPlacement</span><span class="p">(</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a>    <span class="n">OpticsList</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a>    <span class="n">DistanceList</span><span class="p">:</span> <span class="nb">list</span><span class="p">[(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a>    <span class="n">IncidenceAngleList</span><span class="p">:</span> <span class="nb">list</span><span class="p">[(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a>    <span class="n">IncidencePlaneAngleList</span><span class="p">:</span> <span class="nb">list</span><span class="p">[(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a>    <span class="n">InputRay</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a>    <span class="n">InputIncidencePlane</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="p">):</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="sd">    Automatic placement and alignment of the optical elements for one optical chain.</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="sd">    We start by aligning the optic with its &quot;normal&quot; aligned against the incoming ray of light and</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a><span class="sd">    with the &quot;majoraxis&quot; in the incidence plane. Refer to the schematic of each optic to see how it would be aligned in this situation.</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a><span class="sd">    After that, we rotate the optic around the normal to the incidence plane by the incidence angle in the anti-clockwise direction.</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a>    <span class="c1"># Convert angles to radian and wrap to 2pi</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a>    <span class="n">IncidencePlaneAngleList</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">IncidencePlaneAngleList</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a>    <span class="n">IncidenceAngleList</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">IncidenceAngleList</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a>    <span class="c1"># Define initial ray that the system will be aligned to</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">InputRay</span><span class="p">,</span><span class="n">mray</span><span class="o">.</span><span class="n">Ray</span><span class="p">):</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a>        <span class="k">if</span> <span class="n">InputIncidencePlane</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;If you specify an initial vector, you should also specify an incidence plane&quot;</span><span class="p">)</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>        <span class="n">MasterRay</span> <span class="o">=</span> <span class="p">[</span><span class="n">InputRay</span><span class="p">]</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a>        <span class="n">SourcePosition</span> <span class="o">=</span> <span class="n">InputRay</span><span class="o">.</span><span class="n">point</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a>        <span class="n">CentralVector</span> <span class="o">=</span> <span class="n">InputRay</span><span class="o">.</span><span class="n">vector</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a>        <span class="n">IncidencePlane</span> <span class="o">=</span> <span class="n">InputIncidencePlane</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>        <span class="n">SourcePosition</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>        <span class="n">CentralVector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>        <span class="n">MasterRay</span> <span class="o">=</span> <span class="p">[</span><span class="n">mray</span><span class="o">.</span><span class="n">Ray</span><span class="p">(</span><span class="n">SourcePosition</span><span class="p">,</span> <span class="n">CentralVector</span><span class="p">)]</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>        <span class="n">IncidencePlane</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>    
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>    <span class="n">OpticalElements</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># List of aligned optical elements</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>    <span class="n">OpticalElementCentre</span> <span class="o">=</span> <span class="n">SourcePosition</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>     <span class="c1"># Initially, incidence plane is XZ: horizontal (cause Y is mechanical vertical). Positive means deflection towards right</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">Optic</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">OpticsList</span><span class="p">):</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>        <span class="c1"># for convex mirrors, rotated them by 180° them so we reflect from the &quot;back side&quot;</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>        <span class="k">if</span> <span class="n">Optic</span><span class="o">.</span><span class="n">curvature</span> <span class="o">==</span> <span class="n">mmirror</span><span class="o">.</span><span class="n">Curvature</span><span class="o">.</span><span class="n">CONVEX</span><span class="p">:</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>            <span class="n">IncidenceAngleList</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">IncidenceAngleList</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>        <span class="c1"># shift OpticalElementCentre-point from that of the preceding OE, by the required distance along the central ray vector</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>        <span class="n">OpticalElementCentre</span> <span class="o">=</span> <span class="n">OpticalElementCentre</span> <span class="o">+</span> <span class="n">CentralVector</span> <span class="o">*</span> <span class="n">DistanceList</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> 
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>        <span class="c1"># You can&#39;t use += because you need a new object to be created, otherwise it modifies the OpticalElementCentre of the previous optics</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">IncidencePlaneAngleList</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">:</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>            <span class="n">IncidencePlane</span> <span class="o">=</span> <span class="o">-</span><span class="n">IncidencePlane</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>            <span class="n">IncidencePlane</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">RotationAroundAxis</span><span class="p">(</span><span class="n">CentralVector</span><span class="p">,</span> <span class="o">-</span><span class="n">IncidencePlaneAngleList</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">IncidencePlane</span><span class="p">)</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>        
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;IncidencePlane = </span><span class="si">{</span><span class="n">IncidencePlane</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CentralVector = </span><span class="si">{</span><span class="n">CentralVector</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>        <span class="c1"># We need to build a rotation matrix that will orient [0,0,1] (internal &quot;normal&quot; of OE) against CentralVector and </span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>        <span class="c1"># [0,1,0] (internal cross of majoraxis and &quot;normal&quot;) along IncidencePlane. The third vector [1,0,0] is (second cross first) and transforms correspondingly</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>        <span class="n">RotM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)))</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>        <span class="n">RotM</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">CentralVector</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>        <span class="n">RotM</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">IncidencePlane</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>        <span class="n">RotM</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">CentralVector</span><span class="p">,</span> <span class="n">IncidencePlane</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># Switch order and sign</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>        <span class="n">q</span> <span class="o">=</span> <span class="n">quaternion</span><span class="o">.</span><span class="n">from_rotation_matrix</span><span class="p">(</span><span class="n">RotM</span><span class="p">)</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculated Rotation Matrix for component </span><span class="si">{</span><span class="n">Optic</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="n">RotM</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resulting quaternion is </span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>        <span class="n">OpticalElementOrientation</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">QRotationAroundAxis</span><span class="p">(</span><span class="n">IncidencePlane</span><span class="p">,</span>  <span class="n">IncidenceAngleList</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">*</span> <span class="n">q</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>        
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>        <span class="n">Optic</span><span class="o">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="n">OpticalElementOrientation</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>        <span class="n">Optic</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">OpticalElementCentre</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>        <span class="n">OpticalElements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Optic</span><span class="p">)</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>        <span class="n">auxChain</span> <span class="o">=</span> <span class="n">moc</span><span class="o">.</span><span class="n">OpticalChain</span><span class="p">(</span><span class="n">MasterRay</span><span class="p">,</span> <span class="n">OpticalElements</span><span class="p">)</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>        <span class="k">if</span> <span class="s2">&quot;Mirror&quot;</span> <span class="ow">in</span> <span class="n">Optic</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>            <span class="n">OutRays</span> <span class="o">=</span> <span class="n">auxChain</span><span class="o">.</span><span class="n">get_output_rays</span><span class="p">()</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>            <span class="n">CentralVector</span> <span class="o">=</span> <span class="n">OutRays</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vector</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>        <span class="k">elif</span> <span class="n">Optic</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Mask&quot;</span><span class="p">:</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>            <span class="c1"># CentralVector remains unchanged</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>            <span class="c1"># in our auxChain, but *not* in the OpticalElements-list, replace mask by completely tansparent &quot;fake version&quot;</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>            <span class="c1"># to be sure that our CentralVector serving as alignment-guide always passes</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>            <span class="n">FakeMask</span> <span class="o">=</span> <span class="n">mmask</span><span class="o">.</span><span class="n">Mask</span><span class="p">(</span><span class="n">msupp</span><span class="o">.</span><span class="n">SupportRoundHole</span><span class="p">(</span><span class="n">Radius</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">RadiusHole</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">CenterHoleX</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">CenterHoleY</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">position</span> <span class="o">=</span> <span class="n">OpticalElementCentre</span><span class="p">,</span> <span class="n">orientation</span> <span class="o">=</span> <span class="n">OpticalElementOrientation</span><span class="p">)</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>            <span class="n">auxChain</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">FakeMask</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s2">&quot;I don`t recognize the type of optical element &quot;</span> <span class="o">+</span> <span class="n">OpticalElements</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">type</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>    <span class="k">return</span> <span class="n">OpticalElements</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a><span class="c1"># %%</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a><span class="k">def</span> <span class="nf">RayTracingCalculation</span><span class="p">(</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>    <span class="n">source_rays</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">mray</span><span class="o">.</span><span class="n">Ray</span><span class="p">],</span> <span class="n">optical_elements</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">moe</span><span class="o">.</span><span class="n">OpticalElement</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">mray</span><span class="o">.</span><span class="n">Ray</span><span class="p">]]:</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a><span class="sd">    The actual ray-tracing calculation, starting from the list of &#39;source_rays&#39;,</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a><span class="sd">    and propagating them from one optical element to the next in the order of the</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a><span class="sd">    items of the list &#39;optical_elements&#39;.</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a><span class="sd">    Parameters</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a><span class="sd">    ----------</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a><span class="sd">        source_rays : list[Ray-objects]</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a><span class="sd">            List of input rays.</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a><span class="sd">        optical_elements : list[OpticalElement-objects]</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a><span class="sd">    Returns</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a><span class="sd">    -------</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a><span class="sd">        output_rays : list[list[Ray-objects]]</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a><span class="sd">            List of lists of rays, each item corresponding to the ray-bundle *after*</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a><span class="sd">            the item with the same index in the &#39;optical_elements&#39;-list.</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>    <span class="n">output_rays</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">optical_elements</span><span class="p">)):</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>            <span class="n">RayList</span> <span class="o">=</span> <span class="n">source_rays</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>            <span class="n">RayList</span> <span class="o">=</span> <span class="n">output_rays</span><span class="p">[</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>        <span class="n">Position</span> <span class="o">=</span> <span class="n">optical_elements</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">position</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>        <span class="n">q</span> <span class="o">=</span> <span class="n">optical_elements</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">orientation</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>        <span class="c1"># transform rays into mirror coordinate system</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>        <span class="n">RayList</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">TranslationRayList</span><span class="p">(</span><span class="n">RayList</span><span class="p">,</span> <span class="o">-</span><span class="n">Position</span><span class="p">)</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>        <span class="n">RayList</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">RotationRayListByQ</span><span class="p">(</span><span class="n">RayList</span><span class="p">,</span> <span class="n">q</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>        <span class="n">RayList</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">TranslationRayList</span><span class="p">(</span><span class="n">RayList</span><span class="p">,</span> <span class="n">optical_elements</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">get_centre</span><span class="p">())</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>        <span class="c1"># optical element acts on the rays:</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">optical_elements</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">mmirror</span><span class="o">.</span><span class="n">Mirror</span><span class="p">):</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Encountering mirror&quot;</span><span class="p">)</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>            <span class="n">RayList</span> <span class="o">=</span> <span class="n">mmirror</span><span class="o">.</span><span class="n">ReflectionMirrorRayList</span><span class="p">(</span><span class="n">optical_elements</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">RayList</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">optical_elements</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">mmask</span><span class="o">.</span><span class="n">Mask</span><span class="p">):</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Encountering mask&quot;</span><span class="p">)</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>            <span class="n">RayList</span> <span class="o">=</span> <span class="n">mmask</span><span class="o">.</span><span class="n">TransmitMaskRayList</span><span class="p">(</span><span class="n">optical_elements</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">RayList</span><span class="p">)</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s2">&quot;The raytracing calculation cannot use this type of element: &quot;</span> <span class="o">+</span> <span class="n">optical_elements</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>        <span class="c1"># transform new rays back into &quot;lab frame&quot;</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>        <span class="n">RayList</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">TranslationRayList</span><span class="p">(</span><span class="n">RayList</span><span class="p">,</span> <span class="o">-</span><span class="n">optical_elements</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">get_centre</span><span class="p">())</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>        <span class="n">RayList</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">RotationRayListByQ</span><span class="p">(</span><span class="n">RayList</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>        <span class="n">RayList</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">TranslationRayList</span><span class="p">(</span><span class="n">RayList</span><span class="p">,</span> <span class="n">Position</span><span class="p">)</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>        <span class="n">output_rays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RayList</span><span class="p">)</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>    <span class="k">return</span> <span class="n">output_rays</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a><span class="c1"># %%</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a><span class="k">def</span> <span class="nf">_FindOptimalDistanceBIS</span><span class="p">(</span><span class="n">movingDetector</span><span class="p">,</span> <span class="n">Amplitude</span><span class="p">,</span> <span class="n">Step</span><span class="p">,</span> <span class="n">RayList</span><span class="p">,</span> <span class="n">OptFor</span><span class="p">,</span> <span class="n">IntensityWeighted</span><span class="p">):</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>    <span class="n">ListSizeSpot</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>    <span class="n">ListDuration</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>    <span class="n">ListFitness</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>    <span class="k">if</span> <span class="n">IntensityWeighted</span><span class="p">:</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>        <span class="n">Weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">intensity</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">RayList</span><span class="p">]</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>    <span class="n">movingDetector</span><span class="o">.</span><span class="n">shiftByDistance</span><span class="p">(</span><span class="o">-</span><span class="n">Amplitude</span><span class="p">)</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>    <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">Amplitude</span> <span class="o">/</span> <span class="n">Step</span><span class="p">)</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>        <span class="n">ListPointDetector2DCentre</span> <span class="o">=</span> <span class="n">movingDetector</span><span class="o">.</span><span class="n">get_PointList2DCentre</span><span class="p">(</span><span class="n">RayList</span><span class="p">)</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>        <span class="k">if</span> <span class="n">OptFor</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">,</span> <span class="s2">&quot;spotsize&quot;</span><span class="p">]:</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>            <span class="k">if</span> <span class="n">IntensityWeighted</span><span class="p">:</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>                <span class="n">SpotSize</span> <span class="o">=</span> <span class="n">WeightedStandardDeviation</span><span class="p">(</span><span class="n">ListPointDetector2DCentre</span><span class="p">,</span> <span class="n">Weights</span><span class="p">)</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>                <span class="n">SpotSize</span> <span class="o">=</span> <span class="n">StandardDeviation</span><span class="p">(</span><span class="n">ListPointDetector2DCentre</span><span class="p">)</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>            <span class="n">ListSizeSpot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SpotSize</span><span class="p">)</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>        <span class="k">if</span> <span class="n">OptFor</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">,</span> <span class="s2">&quot;duration&quot;</span><span class="p">]:</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>            <span class="n">DelayList</span> <span class="o">=</span> <span class="n">movingDetector</span><span class="o">.</span><span class="n">get_Delays</span><span class="p">(</span><span class="n">RayList</span><span class="p">)</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>            <span class="k">if</span> <span class="n">IntensityWeighted</span><span class="p">:</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>                <span class="n">Duration</span> <span class="o">=</span> <span class="n">WeightedStandardDeviation</span><span class="p">(</span><span class="n">DelayList</span><span class="p">,</span> <span class="n">Weights</span><span class="p">)</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>                <span class="n">Duration</span> <span class="o">=</span> <span class="n">StandardDeviation</span><span class="p">(</span><span class="n">DelayList</span><span class="p">)</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>            <span class="n">ListDuration</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Duration</span><span class="p">)</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>        <span class="k">if</span> <span class="n">OptFor</span> <span class="o">==</span> <span class="s2">&quot;intensity&quot;</span><span class="p">:</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>            <span class="n">Fitness</span> <span class="o">=</span> <span class="n">SpotSize</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">Duration</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>        <span class="k">elif</span> <span class="n">OptFor</span> <span class="o">==</span> <span class="s2">&quot;duration&quot;</span><span class="p">:</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>            <span class="n">Fitness</span> <span class="o">=</span> <span class="n">Duration</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>        <span class="k">elif</span> <span class="n">OptFor</span> <span class="o">==</span> <span class="s2">&quot;spotsize&quot;</span><span class="p">:</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>            <span class="n">Fitness</span> <span class="o">=</span> <span class="n">SpotSize</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>        <span class="n">ListFitness</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Fitness</span><span class="p">)</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>        <span class="n">movingDetector</span><span class="o">.</span><span class="n">shiftByDistance</span><span class="p">(</span><span class="n">Step</span><span class="p">)</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>    <span class="n">FitnessMin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ListFitness</span><span class="p">)</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>    <span class="n">ind</span> <span class="o">=</span> <span class="n">ListFitness</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">FitnessMin</span><span class="p">)</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>    <span class="k">if</span> <span class="n">OptFor</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">,</span> <span class="s2">&quot;spotsize&quot;</span><span class="p">]:</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>        <span class="n">OptSizeSpot</span> <span class="o">=</span> <span class="n">ListSizeSpot</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>        <span class="n">OptSizeSpot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>    <span class="k">if</span> <span class="n">OptFor</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">,</span> <span class="s2">&quot;duration&quot;</span><span class="p">]:</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>        <span class="n">OptDuration</span> <span class="o">=</span> <span class="n">ListDuration</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>        <span class="n">OptDuration</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>    <span class="n">movingDetector</span><span class="o">.</span><span class="n">shiftByDistance</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">ind</span><span class="p">)</span> <span class="o">*</span> <span class="n">Step</span><span class="p">)</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>    <span class="k">return</span> <span class="n">movingDetector</span><span class="p">,</span> <span class="n">OptSizeSpot</span><span class="p">,</span> <span class="n">OptDuration</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a><span class="k">def</span> <span class="nf">FindOptimalDistance</span><span class="p">(</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>    <span class="n">Detector</span><span class="p">,</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>    <span class="n">RayList</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">mray</span><span class="o">.</span><span class="n">Ray</span><span class="p">],</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>    <span class="n">OptFor</span><span class="o">=</span><span class="s2">&quot;intensity&quot;</span><span class="p">,</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>    <span class="n">Amplitude</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>    <span class="n">Precision</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>    <span class="n">IntensityWeighted</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a><span class="p">):</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a><span class="sd">    Automatically finds the optimal the &#39;Detector&#39;-distance for either</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a><span class="sd">    maximum intensity, or minimal spotsize or duration.</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a><span class="sd">    Parameters</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a><span class="sd">    ----------</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a><span class="sd">        Detector : Detector-object</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a><span class="sd">        RayList : list[Ray-objects]</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a><span class="sd">        OptFor : str, optional</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a><span class="sd">            &quot;spotsize&quot;: minimizes the standard-deviation spot size *d* on the detector.</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a><span class="sd">            &quot;duration&quot;: minimizes the standard-deviation *tau* of the ray-delays.</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a><span class="sd">            &quot;intensity&quot;: Maximizes 1/tau/d^2.</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a><span class="sd">            Defaults to &quot;intensity&quot;.</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a><span class="sd">        Amplitude : float, optional</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a><span class="sd">            The detector-distances within which the optimization is done will be</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a><span class="sd">            the distance of &#39;Detector&#39; +/- Amplitude in mm.</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a><span class="sd">        Precision : int, optional</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a><span class="sd">            Precision-parameter for the search algorithm. For Precision = n,</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a><span class="sd">            it will iterate with search amplitudes decreasing until 10^{-n}.</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a><span class="sd">            Defaults to 3.</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a><span class="sd">        IntensityWeighted : bool, optional</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a><span class="sd">            Whether to weigh the calculation of spotsize and/or duration by the ray-intensities.</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a><span class="sd">            Defaults to False.</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a><span class="sd">        verbose : bool, optional</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a><span class="sd">            Whether to print results to the console.</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a><span class="sd">    Returns</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a><span class="sd">    -------</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a><span class="sd">        OptDetector : Detector-object</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a><span class="sd">            A new detector-instance with optimized distance.</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a><span class="sd">        OptSpotSize : float</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a><span class="sd">            Spotsize, calculated as standard deviation in mm of the spot-diagram</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a><span class="sd">            on the optimized detector.</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a><span class="sd">        OptDuration : float</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a><span class="sd">            Duration, calculated as standard deviation in fs of the ray-delays</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a><span class="sd">            on the optimized detector.</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>    <span class="k">if</span> <span class="n">OptFor</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="s2">&quot;duration&quot;</span><span class="p">]:</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>        <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>            <span class="s2">&quot;I don`t recognize what you want to optimize the detector distance for. OptFor must be either &#39;intensity&#39;, &#39;size&#39; or &#39;duration&#39;.&quot;</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>        <span class="p">)</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>    <span class="n">FirstDistance</span> <span class="o">=</span> <span class="n">Detector</span><span class="o">.</span><span class="n">get_distance</span><span class="p">()</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>    <span class="n">ListPointDetector2DCentre</span> <span class="o">=</span> <span class="n">Detector</span><span class="o">.</span><span class="n">get_PointList2DCentre</span><span class="p">(</span><span class="n">RayList</span><span class="p">)</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>    <span class="n">SizeSpot</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">StandardDeviation</span><span class="p">(</span><span class="n">ListPointDetector2DCentre</span><span class="p">)</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>    <span class="n">NumericalAperture</span> <span class="o">=</span> <span class="n">ReturnNumericalAperture</span><span class="p">(</span><span class="n">RayList</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>    <span class="k">if</span> <span class="n">Amplitude</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>        <span class="n">Amplitude</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">SizeSpot</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">NumericalAperture</span><span class="p">))),</span> <span class="n">FirstDistance</span><span class="p">)</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>    <span class="n">Step</span> <span class="o">=</span> <span class="n">Amplitude</span><span class="o">/</span><span class="mi">10</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>    <span class="c1">#Step = Amplitude / 5  # pretty good in half the time ;-)</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>        <span class="nb">print</span><span class="p">(</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>            <span class="sa">f</span><span class="s2">&quot;Searching optimal detector position for *</span><span class="si">{</span><span class="n">OptFor</span><span class="si">}</span><span class="s2">* within [</span><span class="si">{</span><span class="n">FirstDistance</span><span class="o">-</span><span class="n">Amplitude</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">FirstDistance</span><span class="o">+</span><span class="n">Amplitude</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">] mm...&quot;</span><span class="p">,</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>            <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>            <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>        <span class="p">)</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>    <span class="n">movingDetector</span> <span class="o">=</span> <span class="n">Detector</span><span class="o">.</span><span class="n">copy_detector</span><span class="p">()</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Precision</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>        <span class="n">movingDetector</span><span class="p">,</span> <span class="n">OptSpotSize</span><span class="p">,</span> <span class="n">OptDuration</span> <span class="o">=</span> <span class="n">_FindOptimalDistanceBIS</span><span class="p">(</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>            <span class="n">movingDetector</span><span class="p">,</span> <span class="n">Amplitude</span> <span class="o">*</span> <span class="mf">0.1</span><span class="o">**</span><span class="n">k</span><span class="p">,</span> <span class="n">Step</span> <span class="o">*</span> <span class="mf">0.1</span><span class="o">**</span><span class="n">k</span><span class="p">,</span> <span class="n">RayList</span><span class="p">,</span> <span class="n">OptFor</span><span class="p">,</span> <span class="n">IntensityWeighted</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>        <span class="p">)</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>    <span class="k">if</span> <span class="p">(</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>        <span class="ow">not</span> <span class="n">FirstDistance</span> <span class="o">-</span> <span class="n">Amplitude</span> <span class="o">+</span> <span class="mi">10</span><span class="o">**-</span><span class="n">Precision</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>        <span class="o">&lt;</span> <span class="n">movingDetector</span><span class="o">.</span><span class="n">get_distance</span><span class="p">()</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>        <span class="o">&lt;</span> <span class="n">FirstDistance</span> <span class="o">+</span> <span class="n">Amplitude</span> <span class="o">-</span> <span class="mi">10</span><span class="o">**-</span><span class="n">Precision</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>    <span class="p">):</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;There`s no minimum-size/duration focus in the searched range.&quot;</span><span class="p">)</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>    <span class="nb">print</span><span class="p">(</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>        <span class="s2">&quot;</span><span class="se">\r\033</span><span class="s2">[K&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>    <span class="p">)</span>  <span class="c1"># move to beginning of the line with \r and then delete the whole line with \033[K</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>    <span class="k">return</span> <span class="n">movingDetector</span><span class="p">,</span> <span class="n">OptSpotSize</span><span class="p">,</span> <span class="n">OptDuration</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a><span class="c1"># %%</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a><span class="k">def</span> <span class="nf">FindCentralRay</span><span class="p">(</span><span class="n">RayList</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">mray</span><span class="o">.</span><span class="n">Ray</span><span class="p">]):</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a><span class="sd">    Out of a the list of Ray-objects, RayList, determine the average direction</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a><span class="sd">    vector and source point, and the return a Ray-object representing this </span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a><span class="sd">    central ray of the RayList.</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a><span class="sd">    </span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a><span class="sd">    Parameters</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a><span class="sd">    ----------</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a><span class="sd">        RayList : list of Ray-objects</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a><span class="sd">    Returns</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a><span class="sd">    -------</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a><span class="sd">        CentralRay : Ray-object</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>      
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>    <span class="n">CentralVector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">vector</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">RayList</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>    <span class="n">CentralPoint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">point</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">RayList</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>    
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>    <span class="k">return</span> <span class="n">mray</span><span class="o">.</span><span class="n">Ray</span><span class="p">(</span><span class="n">CentralPoint</span><span class="p">,</span> <span class="n">CentralVector</span><span class="p">)</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a><span class="k">def</span> <span class="nf">StandardDeviation</span><span class="p">(</span><span class="n">List</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a><span class="sd">    Return the standard deviation of elements in the supplied list.</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a><span class="sd">    If the elements are floats, it&#39;s simply the root-mean-square over the numbers.</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a><span class="sd">    If the elements are vectors (represented as numpy-arrays), the root-mean-square</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a><span class="sd">    of the distance of the points from their mean is calculated.</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a><span class="sd">    Parameters</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a><span class="sd">    ----------</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a><span class="sd">        List : list of floats or of np.ndarray</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a><span class="sd">            Numbers (in ART, typically delays)</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a><span class="sd">            or 2D or 3D vectors (in ART typically space coordinates)</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a><span class="sd">    Returns</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a><span class="sd">    -------</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a><span class="sd">        Std : float</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">List</span><span class="p">)</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;StandardDeviation expects a list of floats or numpy-arrays as input, but got something else.&quot;</span><span class="p">)</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a><span class="k">def</span> <span class="nf">WeightedStandardDeviation</span><span class="p">(</span><span class="n">List</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">Weights</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a><span class="sd">    Return the weighted standard deviation of elements in the supplied list.</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a><span class="sd">    If the elements are floats, it&#39;s simply the root-mean-square over the weighted numbers.</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a><span class="sd">    If the elements are vectors (represented as numpy-arrays), the root-mean-square</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a><span class="sd">    of the weighted distances of the points from their mean is calculated.</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a><span class="sd">    Parameters</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a><span class="sd">    ----------</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a><span class="sd">        List : list of floats or of np.ndarray</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a><span class="sd">            Numbers (in ART, typically delays)</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a><span class="sd">            or 2D or 3D vectors (in ART typically space coordinates)</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a><span class="sd">        Weights : list of floats, same length as List</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a><span class="sd">            Parameters such as Ray.intensity to be used as weights</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a><span class="sd">    Returns</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a><span class="sd">    -------</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a><span class="sd">        Std : float</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>    <span class="n">average</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">Weights</span><span class="p">,</span> <span class="n">returned</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>    <span class="n">variance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">List</span> <span class="o">-</span> <span class="n">average</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">Weights</span><span class="p">,</span> <span class="n">returned</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a><span class="c1"># %%</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a><span class="k">def</span> <span class="nf">ReturnNumericalAperture</span><span class="p">(</span><span class="n">RayList</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">mray</span><span class="o">.</span><span class="n">Ray</span><span class="p">],</span> <span class="n">RefractiveIndex</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a><span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a><span class="sd">    Returns the numerical aperture associated with the supplied ray-bundle &#39;Raylist&#39;.</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a><span class="sd">    This is $n\sin\theta$, where $\theta$ is the maximum angle between any of the rays and the central ray,</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a><span class="sd">    and $n$ is the refractive index of the propagation medium.</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a><span class="sd">    Parameters</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a><span class="sd">    ----------</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a><span class="sd">        RayList : list of Ray-object</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a><span class="sd">            The ray-bundle of which to determine the NA.</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a><span class="sd">        RefractiveIndex : float, optional</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a><span class="sd">            Refractive index of the propagation medium, defaults to =1.</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a><span class="sd">    Returns</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a><span class="sd">    -------</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a><span class="sd">        NA : float</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>    <span class="n">CentralRay</span> <span class="o">=</span> <span class="n">FindCentralRay</span><span class="p">(</span><span class="n">RayList</span><span class="p">)</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>    <span class="k">if</span> <span class="n">CentralRay</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>        <span class="n">CentralVector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">RayList</span><span class="p">:</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>            <span class="n">CentralVector</span> <span class="o">=</span> <span class="n">CentralVector</span> <span class="o">+</span> <span class="n">k</span><span class="o">.</span><span class="n">vector</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>        <span class="n">CentralVector</span> <span class="o">=</span> <span class="n">CentralVector</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">RayList</span><span class="p">)</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>        <span class="n">CentralVector</span> <span class="o">=</span> <span class="n">CentralRay</span><span class="o">.</span><span class="n">vector</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>    <span class="n">ListAngleAperture</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">RayList</span><span class="p">:</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>        <span class="n">ListAngleAperture</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mgeo</span><span class="o">.</span><span class="n">AngleBetweenTwoVectors</span><span class="p">(</span><span class="n">CentralVector</span><span class="p">,</span> <span class="n">k</span><span class="o">.</span><span class="n">vector</span><span class="p">))</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">ListAngleAperture</span><span class="p">))</span> <span class="o">*</span> <span class="n">RefractiveIndex</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a><span class="c1"># %%</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a><span class="k">def</span> <span class="nf">ReturnAiryRadius</span><span class="p">(</span><span class="n">Wavelength</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">NumericalAperture</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a><span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a><span class="sd">    Returns the radius of the Airy disk: $r = 1.22 \frac\{\lambda\}\{NA\}$,</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a><span class="sd">    i.e. the diffraction-limited radius of the focal spot corresponding to a given</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a><span class="sd">    numerical aperture $NA$ and a light wavelength $\lambda$.</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a><span class="sd">    For very small $NA&lt;10^\{-3\}$, diffraction effects becomes negligible and the Airy Radius becomes meaningless,</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a><span class="sd">    so in that case, a radius of 0 is returned.</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a><span class="sd">    Parameters</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a><span class="sd">    ----------</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a><span class="sd">        Wavelength : float</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a><span class="sd">            Light wavelength in mm.</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a><span class="sd">        NumericalAperture : float</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a><span class="sd">    Returns</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a><span class="sd">    -------</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a><span class="sd">        AiryRadius : float</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a>    <span class="k">if</span> <span class="n">NumericalAperture</span> <span class="o">&gt;</span> <span class="mf">1e-3</span> <span class="ow">and</span> <span class="n">Wavelength</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>        <span class="k">return</span> <span class="mf">1.22</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">Wavelength</span> <span class="o">/</span> <span class="n">NumericalAperture</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>        <span class="k">return</span> <span class="mi">0</span>  <span class="c1"># for very small numerical apertures, diffraction effects becomes negligible and the Airy Radius becomes meaningless</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a><span class="c1"># %%</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a><span class="k">def</span> <span class="nf">_hash_list_of_objects</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;returns a hash value for a list of objects, by just summing up all the individual hashes.&quot;&quot;&quot;</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>    <span class="n">total_hash</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>        <span class="n">total_hash</span> <span class="o">+=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>    <span class="k">return</span> <span class="n">total_hash</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a><span class="k">def</span> <span class="nf">_which_indeces</span><span class="p">(</span><span class="n">lst</span><span class="p">):</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;takes an input-list, and gives you a list of the indeces where the input-list contains another list or a numpy-array&quot;&quot;&quot;</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>    <span class="n">indexes</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))]</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>    <span class="k">return</span> <span class="n">indexes</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a><span class="c1"># %%</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a><span class="k">def</span> <span class="nf">save_compressed</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Save (=pickle) an object &#39;obj&#39; to a compressed file with name &#39;filename&#39;.&quot;&quot;&quot;</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;kept_data_&quot;</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">-%Hh%M&quot;</span><span class="p">)</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>    <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.xz&quot;</span><span class="p">):</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a>    <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>    <span class="c1"># with gzip.open(filename + &#39;.gz&#39;, &#39;wb&#39;) as f:</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>    <span class="k">with</span> <span class="n">lzma</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.xz&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saved results to &quot;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.xz.&quot;</span><span class="p">)</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&gt;To reload from disk do: kept_data = mp.load_compressed(&#39;&quot;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;&#39;)&quot;</span><span class="p">)</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a><span class="k">def</span> <span class="nf">load_compressed</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Load (=unpickle) an object &#39;obj&#39; from a compressed file with name &#39;filename&#39;.&quot;&quot;&quot;</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a>    <span class="c1"># with gzip.open(filename + &#39;.gz&#39;, &#39;rb&#39;) as f:</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a>    <span class="k">with</span> <span class="n">lzma</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.xz&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a>        <span class="n">obj</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a>    <span class="k">return</span> <span class="n">obj</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a><span class="c1"># %%  tic-toc timer functions</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a><span class="n">_tstart_stack</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a><span class="k">def</span> <span class="nf">_tic</span><span class="p">():</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a>    <span class="n">_tstart_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perf_counter</span><span class="p">())</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a><span class="k">def</span> <span class="nf">_toc</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;Elapsed: </span><span class="si">%s</span><span class="s2"> s&quot;</span><span class="p">):</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a>    <span class="nb">print</span><span class="p">(</span><span class="n">fmt</span> <span class="o">%</span> <span class="p">(</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">_tstart_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()))</span>
</span></pre></div>


            </section>
                <section id="logger">
                    <div class="attr variable">
            <span class="name">logger</span>        =
<span class="default_value">&lt;Logger <a href="">ARTcore.ModuleProcessing</a> (WARNING)&gt;</span>

        
    </div>
    <a class="headerlink" href="#logger"></a>
    
    

                </section>
                <section id="OEPlacement">
                            <input id="OEPlacement-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">OEPlacement</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">OpticsList</span><span class="p">:</span> <span class="nb">list</span>,</span><span class="param">	<span class="n">DistanceList</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>,</span><span class="param">	<span class="n">IncidenceAngleList</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>,</span><span class="param">	<span class="n">IncidencePlaneAngleList</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>,</span><span class="param">	<span class="n">InputRay</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">InputIncidencePlane</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="OEPlacement-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#OEPlacement"></a>
            <div class="chroma pdoc-code"><pre><span></span><span id="OEPlacement-38"><a href="#OEPlacement-38"><span class="linenos"> 38</span></a><span class="k">def</span> <span class="nf">OEPlacement</span><span class="p">(</span>
</span><span id="OEPlacement-39"><a href="#OEPlacement-39"><span class="linenos"> 39</span></a>    <span class="n">OpticsList</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
</span><span id="OEPlacement-40"><a href="#OEPlacement-40"><span class="linenos"> 40</span></a>    <span class="n">DistanceList</span><span class="p">:</span> <span class="nb">list</span><span class="p">[(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
</span><span id="OEPlacement-41"><a href="#OEPlacement-41"><span class="linenos"> 41</span></a>    <span class="n">IncidenceAngleList</span><span class="p">:</span> <span class="nb">list</span><span class="p">[(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
</span><span id="OEPlacement-42"><a href="#OEPlacement-42"><span class="linenos"> 42</span></a>    <span class="n">IncidencePlaneAngleList</span><span class="p">:</span> <span class="nb">list</span><span class="p">[(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
</span><span id="OEPlacement-43"><a href="#OEPlacement-43"><span class="linenos"> 43</span></a>    <span class="n">InputRay</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="OEPlacement-44"><a href="#OEPlacement-44"><span class="linenos"> 44</span></a>    <span class="n">InputIncidencePlane</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="OEPlacement-45"><a href="#OEPlacement-45"><span class="linenos"> 45</span></a><span class="p">):</span>
</span><span id="OEPlacement-46"><a href="#OEPlacement-46"><span class="linenos"> 46</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="OEPlacement-47"><a href="#OEPlacement-47"><span class="linenos"> 47</span></a><span class="sd">    Automatic placement and alignment of the optical elements for one optical chain.</span>
</span><span id="OEPlacement-48"><a href="#OEPlacement-48"><span class="linenos"> 48</span></a><span class="sd">    We start by aligning the optic with its &quot;normal&quot; aligned against the incoming ray of light and</span>
</span><span id="OEPlacement-49"><a href="#OEPlacement-49"><span class="linenos"> 49</span></a><span class="sd">    with the &quot;majoraxis&quot; in the incidence plane. Refer to the schematic of each optic to see how it would be aligned in this situation.</span>
</span><span id="OEPlacement-50"><a href="#OEPlacement-50"><span class="linenos"> 50</span></a><span class="sd">    After that, we rotate the optic around the normal to the incidence plane by the incidence angle in the anti-clockwise direction.</span>
</span><span id="OEPlacement-51"><a href="#OEPlacement-51"><span class="linenos"> 51</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="OEPlacement-52"><a href="#OEPlacement-52"><span class="linenos"> 52</span></a>    <span class="c1"># Convert angles to radian and wrap to 2pi</span>
</span><span id="OEPlacement-53"><a href="#OEPlacement-53"><span class="linenos"> 53</span></a>    <span class="n">IncidencePlaneAngleList</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">IncidencePlaneAngleList</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
</span><span id="OEPlacement-54"><a href="#OEPlacement-54"><span class="linenos"> 54</span></a>    <span class="n">IncidenceAngleList</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">IncidenceAngleList</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
</span><span id="OEPlacement-55"><a href="#OEPlacement-55"><span class="linenos"> 55</span></a>
</span><span id="OEPlacement-56"><a href="#OEPlacement-56"><span class="linenos"> 56</span></a>    <span class="c1"># Define initial ray that the system will be aligned to</span>
</span><span id="OEPlacement-57"><a href="#OEPlacement-57"><span class="linenos"> 57</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">InputRay</span><span class="p">,</span><span class="n">mray</span><span class="o">.</span><span class="n">Ray</span><span class="p">):</span>
</span><span id="OEPlacement-58"><a href="#OEPlacement-58"><span class="linenos"> 58</span></a>        <span class="k">if</span> <span class="n">InputIncidencePlane</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="OEPlacement-59"><a href="#OEPlacement-59"><span class="linenos"> 59</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;If you specify an initial vector, you should also specify an incidence plane&quot;</span><span class="p">)</span>
</span><span id="OEPlacement-60"><a href="#OEPlacement-60"><span class="linenos"> 60</span></a>        <span class="n">MasterRay</span> <span class="o">=</span> <span class="p">[</span><span class="n">InputRay</span><span class="p">]</span>
</span><span id="OEPlacement-61"><a href="#OEPlacement-61"><span class="linenos"> 61</span></a>        <span class="n">SourcePosition</span> <span class="o">=</span> <span class="n">InputRay</span><span class="o">.</span><span class="n">point</span>
</span><span id="OEPlacement-62"><a href="#OEPlacement-62"><span class="linenos"> 62</span></a>        <span class="n">CentralVector</span> <span class="o">=</span> <span class="n">InputRay</span><span class="o">.</span><span class="n">vector</span>
</span><span id="OEPlacement-63"><a href="#OEPlacement-63"><span class="linenos"> 63</span></a>        <span class="n">IncidencePlane</span> <span class="o">=</span> <span class="n">InputIncidencePlane</span>
</span><span id="OEPlacement-64"><a href="#OEPlacement-64"><span class="linenos"> 64</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="OEPlacement-65"><a href="#OEPlacement-65"><span class="linenos"> 65</span></a>        <span class="n">SourcePosition</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
</span><span id="OEPlacement-66"><a href="#OEPlacement-66"><span class="linenos"> 66</span></a>        <span class="n">CentralVector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
</span><span id="OEPlacement-67"><a href="#OEPlacement-67"><span class="linenos"> 67</span></a>        <span class="n">MasterRay</span> <span class="o">=</span> <span class="p">[</span><span class="n">mray</span><span class="o">.</span><span class="n">Ray</span><span class="p">(</span><span class="n">SourcePosition</span><span class="p">,</span> <span class="n">CentralVector</span><span class="p">)]</span>
</span><span id="OEPlacement-68"><a href="#OEPlacement-68"><span class="linenos"> 68</span></a>        <span class="n">IncidencePlane</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
</span><span id="OEPlacement-69"><a href="#OEPlacement-69"><span class="linenos"> 69</span></a>    
</span><span id="OEPlacement-70"><a href="#OEPlacement-70"><span class="linenos"> 70</span></a>    <span class="n">OpticalElements</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># List of aligned optical elements</span>
</span><span id="OEPlacement-71"><a href="#OEPlacement-71"><span class="linenos"> 71</span></a>
</span><span id="OEPlacement-72"><a href="#OEPlacement-72"><span class="linenos"> 72</span></a>    <span class="n">OpticalElementCentre</span> <span class="o">=</span> <span class="n">SourcePosition</span>
</span><span id="OEPlacement-73"><a href="#OEPlacement-73"><span class="linenos"> 73</span></a>     <span class="c1"># Initially, incidence plane is XZ: horizontal (cause Y is mechanical vertical). Positive means deflection towards right</span>
</span><span id="OEPlacement-74"><a href="#OEPlacement-74"><span class="linenos"> 74</span></a>
</span><span id="OEPlacement-75"><a href="#OEPlacement-75"><span class="linenos"> 75</span></a>    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">Optic</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">OpticsList</span><span class="p">):</span>
</span><span id="OEPlacement-76"><a href="#OEPlacement-76"><span class="linenos"> 76</span></a>        <span class="c1"># for convex mirrors, rotated them by 180° them so we reflect from the &quot;back side&quot;</span>
</span><span id="OEPlacement-77"><a href="#OEPlacement-77"><span class="linenos"> 77</span></a>        <span class="k">if</span> <span class="n">Optic</span><span class="o">.</span><span class="n">curvature</span> <span class="o">==</span> <span class="n">mmirror</span><span class="o">.</span><span class="n">Curvature</span><span class="o">.</span><span class="n">CONVEX</span><span class="p">:</span>
</span><span id="OEPlacement-78"><a href="#OEPlacement-78"><span class="linenos"> 78</span></a>            <span class="n">IncidenceAngleList</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">IncidenceAngleList</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</span><span id="OEPlacement-79"><a href="#OEPlacement-79"><span class="linenos"> 79</span></a>
</span><span id="OEPlacement-80"><a href="#OEPlacement-80"><span class="linenos"> 80</span></a>        <span class="c1"># shift OpticalElementCentre-point from that of the preceding OE, by the required distance along the central ray vector</span>
</span><span id="OEPlacement-81"><a href="#OEPlacement-81"><span class="linenos"> 81</span></a>        <span class="n">OpticalElementCentre</span> <span class="o">=</span> <span class="n">OpticalElementCentre</span> <span class="o">+</span> <span class="n">CentralVector</span> <span class="o">*</span> <span class="n">DistanceList</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> 
</span><span id="OEPlacement-82"><a href="#OEPlacement-82"><span class="linenos"> 82</span></a>        <span class="c1"># You can&#39;t use += because you need a new object to be created, otherwise it modifies the OpticalElementCentre of the previous optics</span>
</span><span id="OEPlacement-83"><a href="#OEPlacement-83"><span class="linenos"> 83</span></a>
</span><span id="OEPlacement-84"><a href="#OEPlacement-84"><span class="linenos"> 84</span></a>        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">IncidencePlaneAngleList</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">:</span>
</span><span id="OEPlacement-85"><a href="#OEPlacement-85"><span class="linenos"> 85</span></a>            <span class="n">IncidencePlane</span> <span class="o">=</span> <span class="o">-</span><span class="n">IncidencePlane</span>
</span><span id="OEPlacement-86"><a href="#OEPlacement-86"><span class="linenos"> 86</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="OEPlacement-87"><a href="#OEPlacement-87"><span class="linenos"> 87</span></a>            <span class="n">IncidencePlane</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">RotationAroundAxis</span><span class="p">(</span><span class="n">CentralVector</span><span class="p">,</span> <span class="o">-</span><span class="n">IncidencePlaneAngleList</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">IncidencePlane</span><span class="p">)</span>
</span><span id="OEPlacement-88"><a href="#OEPlacement-88"><span class="linenos"> 88</span></a>        
</span><span id="OEPlacement-89"><a href="#OEPlacement-89"><span class="linenos"> 89</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;IncidencePlane = </span><span class="si">{</span><span class="n">IncidencePlane</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="OEPlacement-90"><a href="#OEPlacement-90"><span class="linenos"> 90</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CentralVector = </span><span class="si">{</span><span class="n">CentralVector</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="OEPlacement-91"><a href="#OEPlacement-91"><span class="linenos"> 91</span></a>
</span><span id="OEPlacement-92"><a href="#OEPlacement-92"><span class="linenos"> 92</span></a>        <span class="c1"># We need to build a rotation matrix that will orient [0,0,1] (internal &quot;normal&quot; of OE) against CentralVector and </span>
</span><span id="OEPlacement-93"><a href="#OEPlacement-93"><span class="linenos"> 93</span></a>        <span class="c1"># [0,1,0] (internal cross of majoraxis and &quot;normal&quot;) along IncidencePlane. The third vector [1,0,0] is (second cross first) and transforms correspondingly</span>
</span><span id="OEPlacement-94"><a href="#OEPlacement-94"><span class="linenos"> 94</span></a>        <span class="n">RotM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)))</span>
</span><span id="OEPlacement-95"><a href="#OEPlacement-95"><span class="linenos"> 95</span></a>        <span class="n">RotM</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">CentralVector</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
</span><span id="OEPlacement-96"><a href="#OEPlacement-96"><span class="linenos"> 96</span></a>        <span class="n">RotM</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">IncidencePlane</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
</span><span id="OEPlacement-97"><a href="#OEPlacement-97"><span class="linenos"> 97</span></a>        <span class="n">RotM</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">CentralVector</span><span class="p">,</span> <span class="n">IncidencePlane</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># Switch order and sign</span>
</span><span id="OEPlacement-98"><a href="#OEPlacement-98"><span class="linenos"> 98</span></a>        <span class="n">q</span> <span class="o">=</span> <span class="n">quaternion</span><span class="o">.</span><span class="n">from_rotation_matrix</span><span class="p">(</span><span class="n">RotM</span><span class="p">)</span>
</span><span id="OEPlacement-99"><a href="#OEPlacement-99"><span class="linenos"> 99</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculated Rotation Matrix for component </span><span class="si">{</span><span class="n">Optic</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="n">RotM</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="OEPlacement-100"><a href="#OEPlacement-100"><span class="linenos">100</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resulting quaternion is </span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="OEPlacement-101"><a href="#OEPlacement-101"><span class="linenos">101</span></a>
</span><span id="OEPlacement-102"><a href="#OEPlacement-102"><span class="linenos">102</span></a>        <span class="n">OpticalElementOrientation</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">QRotationAroundAxis</span><span class="p">(</span><span class="n">IncidencePlane</span><span class="p">,</span>  <span class="n">IncidenceAngleList</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">*</span> <span class="n">q</span>
</span><span id="OEPlacement-103"><a href="#OEPlacement-103"><span class="linenos">103</span></a>        
</span><span id="OEPlacement-104"><a href="#OEPlacement-104"><span class="linenos">104</span></a>        <span class="n">Optic</span><span class="o">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="n">OpticalElementOrientation</span>
</span><span id="OEPlacement-105"><a href="#OEPlacement-105"><span class="linenos">105</span></a>        <span class="n">Optic</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">OpticalElementCentre</span>
</span><span id="OEPlacement-106"><a href="#OEPlacement-106"><span class="linenos">106</span></a>
</span><span id="OEPlacement-107"><a href="#OEPlacement-107"><span class="linenos">107</span></a>        <span class="n">OpticalElements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Optic</span><span class="p">)</span>
</span><span id="OEPlacement-108"><a href="#OEPlacement-108"><span class="linenos">108</span></a>        <span class="n">auxChain</span> <span class="o">=</span> <span class="n">moc</span><span class="o">.</span><span class="n">OpticalChain</span><span class="p">(</span><span class="n">MasterRay</span><span class="p">,</span> <span class="n">OpticalElements</span><span class="p">)</span>
</span><span id="OEPlacement-109"><a href="#OEPlacement-109"><span class="linenos">109</span></a>
</span><span id="OEPlacement-110"><a href="#OEPlacement-110"><span class="linenos">110</span></a>        <span class="k">if</span> <span class="s2">&quot;Mirror&quot;</span> <span class="ow">in</span> <span class="n">Optic</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>
</span><span id="OEPlacement-111"><a href="#OEPlacement-111"><span class="linenos">111</span></a>            <span class="n">OutRays</span> <span class="o">=</span> <span class="n">auxChain</span><span class="o">.</span><span class="n">get_output_rays</span><span class="p">()</span>
</span><span id="OEPlacement-112"><a href="#OEPlacement-112"><span class="linenos">112</span></a>            <span class="n">CentralVector</span> <span class="o">=</span> <span class="n">OutRays</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vector</span>
</span><span id="OEPlacement-113"><a href="#OEPlacement-113"><span class="linenos">113</span></a>        <span class="k">elif</span> <span class="n">Optic</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Mask&quot;</span><span class="p">:</span>
</span><span id="OEPlacement-114"><a href="#OEPlacement-114"><span class="linenos">114</span></a>            <span class="c1"># CentralVector remains unchanged</span>
</span><span id="OEPlacement-115"><a href="#OEPlacement-115"><span class="linenos">115</span></a>            <span class="c1"># in our auxChain, but *not* in the OpticalElements-list, replace mask by completely tansparent &quot;fake version&quot;</span>
</span><span id="OEPlacement-116"><a href="#OEPlacement-116"><span class="linenos">116</span></a>            <span class="c1"># to be sure that our CentralVector serving as alignment-guide always passes</span>
</span><span id="OEPlacement-117"><a href="#OEPlacement-117"><span class="linenos">117</span></a>            <span class="n">FakeMask</span> <span class="o">=</span> <span class="n">mmask</span><span class="o">.</span><span class="n">Mask</span><span class="p">(</span><span class="n">msupp</span><span class="o">.</span><span class="n">SupportRoundHole</span><span class="p">(</span><span class="n">Radius</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">RadiusHole</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">CenterHoleX</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">CenterHoleY</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">position</span> <span class="o">=</span> <span class="n">OpticalElementCentre</span><span class="p">,</span> <span class="n">orientation</span> <span class="o">=</span> <span class="n">OpticalElementOrientation</span><span class="p">)</span>
</span><span id="OEPlacement-118"><a href="#OEPlacement-118"><span class="linenos">118</span></a>            <span class="n">auxChain</span><span class="o">.</span><span class="n">optical_elements</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">FakeMask</span>
</span><span id="OEPlacement-119"><a href="#OEPlacement-119"><span class="linenos">119</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="OEPlacement-120"><a href="#OEPlacement-120"><span class="linenos">120</span></a>            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s2">&quot;I don`t recognize the type of optical element &quot;</span> <span class="o">+</span> <span class="n">OpticalElements</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">type</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>
</span><span id="OEPlacement-121"><a href="#OEPlacement-121"><span class="linenos">121</span></a>
</span><span id="OEPlacement-122"><a href="#OEPlacement-122"><span class="linenos">122</span></a>    <span class="k">return</span> <span class="n">OpticalElements</span>
</span></pre></div>


            <div class="docstring"><p>Automatic placement and alignment of the optical elements for one optical chain.
We start by aligning the optic with its "normal" aligned against the incoming ray of light and
with the "majoraxis" in the incidence plane. Refer to the schematic of each optic to see how it would be aligned in this situation.
After that, we rotate the optic around the normal to the incidence plane by the incidence angle in the anti-clockwise direction.</p>
</div>


                </section>
                <section id="RayTracingCalculation">
                            <input id="RayTracingCalculation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">RayTracingCalculation</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">source_rays</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n"><a href="ModuleOpticalRay.html#Ray">ARTcore.ModuleOpticalRay.Ray</a></span><span class="p">]</span>,</span><span class="param">	<span class="n">optical_elements</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n"><a href="ModuleOpticalElement.html#OpticalElement">ARTcore.ModuleOpticalElement.OpticalElement</a></span><span class="p">]</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">) -> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n"><a href="ModuleOpticalRay.html#Ray">ARTcore.ModuleOpticalRay.Ray</a></span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="RayTracingCalculation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#RayTracingCalculation"></a>
            <div class="chroma pdoc-code"><pre><span></span><span id="RayTracingCalculation-126"><a href="#RayTracingCalculation-126"><span class="linenos">126</span></a><span class="k">def</span> <span class="nf">RayTracingCalculation</span><span class="p">(</span>
</span><span id="RayTracingCalculation-127"><a href="#RayTracingCalculation-127"><span class="linenos">127</span></a>    <span class="n">source_rays</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">mray</span><span class="o">.</span><span class="n">Ray</span><span class="p">],</span> <span class="n">optical_elements</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">moe</span><span class="o">.</span><span class="n">OpticalElement</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span>
</span><span id="RayTracingCalculation-128"><a href="#RayTracingCalculation-128"><span class="linenos">128</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">mray</span><span class="o">.</span><span class="n">Ray</span><span class="p">]]:</span>
</span><span id="RayTracingCalculation-129"><a href="#RayTracingCalculation-129"><span class="linenos">129</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="RayTracingCalculation-130"><a href="#RayTracingCalculation-130"><span class="linenos">130</span></a><span class="sd">    The actual ray-tracing calculation, starting from the list of &#39;source_rays&#39;,</span>
</span><span id="RayTracingCalculation-131"><a href="#RayTracingCalculation-131"><span class="linenos">131</span></a><span class="sd">    and propagating them from one optical element to the next in the order of the</span>
</span><span id="RayTracingCalculation-132"><a href="#RayTracingCalculation-132"><span class="linenos">132</span></a><span class="sd">    items of the list &#39;optical_elements&#39;.</span>
</span><span id="RayTracingCalculation-133"><a href="#RayTracingCalculation-133"><span class="linenos">133</span></a>
</span><span id="RayTracingCalculation-134"><a href="#RayTracingCalculation-134"><span class="linenos">134</span></a>
</span><span id="RayTracingCalculation-135"><a href="#RayTracingCalculation-135"><span class="linenos">135</span></a><span class="sd">    Parameters</span>
</span><span id="RayTracingCalculation-136"><a href="#RayTracingCalculation-136"><span class="linenos">136</span></a><span class="sd">    ----------</span>
</span><span id="RayTracingCalculation-137"><a href="#RayTracingCalculation-137"><span class="linenos">137</span></a><span class="sd">        source_rays : list[Ray-objects]</span>
</span><span id="RayTracingCalculation-138"><a href="#RayTracingCalculation-138"><span class="linenos">138</span></a><span class="sd">            List of input rays.</span>
</span><span id="RayTracingCalculation-139"><a href="#RayTracingCalculation-139"><span class="linenos">139</span></a>
</span><span id="RayTracingCalculation-140"><a href="#RayTracingCalculation-140"><span class="linenos">140</span></a><span class="sd">        optical_elements : list[OpticalElement-objects]</span>
</span><span id="RayTracingCalculation-141"><a href="#RayTracingCalculation-141"><span class="linenos">141</span></a>
</span><span id="RayTracingCalculation-142"><a href="#RayTracingCalculation-142"><span class="linenos">142</span></a>
</span><span id="RayTracingCalculation-143"><a href="#RayTracingCalculation-143"><span class="linenos">143</span></a><span class="sd">    Returns</span>
</span><span id="RayTracingCalculation-144"><a href="#RayTracingCalculation-144"><span class="linenos">144</span></a><span class="sd">    -------</span>
</span><span id="RayTracingCalculation-145"><a href="#RayTracingCalculation-145"><span class="linenos">145</span></a><span class="sd">        output_rays : list[list[Ray-objects]]</span>
</span><span id="RayTracingCalculation-146"><a href="#RayTracingCalculation-146"><span class="linenos">146</span></a><span class="sd">            List of lists of rays, each item corresponding to the ray-bundle *after*</span>
</span><span id="RayTracingCalculation-147"><a href="#RayTracingCalculation-147"><span class="linenos">147</span></a><span class="sd">            the item with the same index in the &#39;optical_elements&#39;-list.</span>
</span><span id="RayTracingCalculation-148"><a href="#RayTracingCalculation-148"><span class="linenos">148</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="RayTracingCalculation-149"><a href="#RayTracingCalculation-149"><span class="linenos">149</span></a>    <span class="n">output_rays</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="RayTracingCalculation-150"><a href="#RayTracingCalculation-150"><span class="linenos">150</span></a>
</span><span id="RayTracingCalculation-151"><a href="#RayTracingCalculation-151"><span class="linenos">151</span></a>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">optical_elements</span><span class="p">)):</span>
</span><span id="RayTracingCalculation-152"><a href="#RayTracingCalculation-152"><span class="linenos">152</span></a>        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="RayTracingCalculation-153"><a href="#RayTracingCalculation-153"><span class="linenos">153</span></a>            <span class="n">RayList</span> <span class="o">=</span> <span class="n">source_rays</span>
</span><span id="RayTracingCalculation-154"><a href="#RayTracingCalculation-154"><span class="linenos">154</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="RayTracingCalculation-155"><a href="#RayTracingCalculation-155"><span class="linenos">155</span></a>            <span class="n">RayList</span> <span class="o">=</span> <span class="n">output_rays</span><span class="p">[</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="RayTracingCalculation-156"><a href="#RayTracingCalculation-156"><span class="linenos">156</span></a>
</span><span id="RayTracingCalculation-157"><a href="#RayTracingCalculation-157"><span class="linenos">157</span></a>        <span class="n">Position</span> <span class="o">=</span> <span class="n">optical_elements</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">position</span>
</span><span id="RayTracingCalculation-158"><a href="#RayTracingCalculation-158"><span class="linenos">158</span></a>        <span class="n">q</span> <span class="o">=</span> <span class="n">optical_elements</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">orientation</span>
</span><span id="RayTracingCalculation-159"><a href="#RayTracingCalculation-159"><span class="linenos">159</span></a>
</span><span id="RayTracingCalculation-160"><a href="#RayTracingCalculation-160"><span class="linenos">160</span></a>        <span class="c1"># transform rays into mirror coordinate system</span>
</span><span id="RayTracingCalculation-161"><a href="#RayTracingCalculation-161"><span class="linenos">161</span></a>        <span class="n">RayList</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">TranslationRayList</span><span class="p">(</span><span class="n">RayList</span><span class="p">,</span> <span class="o">-</span><span class="n">Position</span><span class="p">)</span>
</span><span id="RayTracingCalculation-162"><a href="#RayTracingCalculation-162"><span class="linenos">162</span></a>        <span class="n">RayList</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">RotationRayListByQ</span><span class="p">(</span><span class="n">RayList</span><span class="p">,</span> <span class="n">q</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
</span><span id="RayTracingCalculation-163"><a href="#RayTracingCalculation-163"><span class="linenos">163</span></a>        <span class="n">RayList</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">TranslationRayList</span><span class="p">(</span><span class="n">RayList</span><span class="p">,</span> <span class="n">optical_elements</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">get_centre</span><span class="p">())</span>
</span><span id="RayTracingCalculation-164"><a href="#RayTracingCalculation-164"><span class="linenos">164</span></a>
</span><span id="RayTracingCalculation-165"><a href="#RayTracingCalculation-165"><span class="linenos">165</span></a>        <span class="c1"># optical element acts on the rays:</span>
</span><span id="RayTracingCalculation-166"><a href="#RayTracingCalculation-166"><span class="linenos">166</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">optical_elements</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">mmirror</span><span class="o">.</span><span class="n">Mirror</span><span class="p">):</span>
</span><span id="RayTracingCalculation-167"><a href="#RayTracingCalculation-167"><span class="linenos">167</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Encountering mirror&quot;</span><span class="p">)</span>
</span><span id="RayTracingCalculation-168"><a href="#RayTracingCalculation-168"><span class="linenos">168</span></a>            <span class="n">RayList</span> <span class="o">=</span> <span class="n">mmirror</span><span class="o">.</span><span class="n">ReflectionMirrorRayList</span><span class="p">(</span><span class="n">optical_elements</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">RayList</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="RayTracingCalculation-169"><a href="#RayTracingCalculation-169"><span class="linenos">169</span></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">optical_elements</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">mmask</span><span class="o">.</span><span class="n">Mask</span><span class="p">):</span>
</span><span id="RayTracingCalculation-170"><a href="#RayTracingCalculation-170"><span class="linenos">170</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Encountering mask&quot;</span><span class="p">)</span>
</span><span id="RayTracingCalculation-171"><a href="#RayTracingCalculation-171"><span class="linenos">171</span></a>            <span class="n">RayList</span> <span class="o">=</span> <span class="n">mmask</span><span class="o">.</span><span class="n">TransmitMaskRayList</span><span class="p">(</span><span class="n">optical_elements</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">RayList</span><span class="p">)</span>
</span><span id="RayTracingCalculation-172"><a href="#RayTracingCalculation-172"><span class="linenos">172</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="RayTracingCalculation-173"><a href="#RayTracingCalculation-173"><span class="linenos">173</span></a>            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s2">&quot;The raytracing calculation cannot use this type of element: &quot;</span> <span class="o">+</span> <span class="n">optical_elements</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>
</span><span id="RayTracingCalculation-174"><a href="#RayTracingCalculation-174"><span class="linenos">174</span></a>
</span><span id="RayTracingCalculation-175"><a href="#RayTracingCalculation-175"><span class="linenos">175</span></a>        <span class="c1"># transform new rays back into &quot;lab frame&quot;</span>
</span><span id="RayTracingCalculation-176"><a href="#RayTracingCalculation-176"><span class="linenos">176</span></a>        <span class="n">RayList</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">TranslationRayList</span><span class="p">(</span><span class="n">RayList</span><span class="p">,</span> <span class="o">-</span><span class="n">optical_elements</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">get_centre</span><span class="p">())</span>
</span><span id="RayTracingCalculation-177"><a href="#RayTracingCalculation-177"><span class="linenos">177</span></a>        <span class="n">RayList</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">RotationRayListByQ</span><span class="p">(</span><span class="n">RayList</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
</span><span id="RayTracingCalculation-178"><a href="#RayTracingCalculation-178"><span class="linenos">178</span></a>        <span class="n">RayList</span> <span class="o">=</span> <span class="n">mgeo</span><span class="o">.</span><span class="n">TranslationRayList</span><span class="p">(</span><span class="n">RayList</span><span class="p">,</span> <span class="n">Position</span><span class="p">)</span>
</span><span id="RayTracingCalculation-179"><a href="#RayTracingCalculation-179"><span class="linenos">179</span></a>
</span><span id="RayTracingCalculation-180"><a href="#RayTracingCalculation-180"><span class="linenos">180</span></a>        <span class="n">output_rays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RayList</span><span class="p">)</span>
</span><span id="RayTracingCalculation-181"><a href="#RayTracingCalculation-181"><span class="linenos">181</span></a>
</span><span id="RayTracingCalculation-182"><a href="#RayTracingCalculation-182"><span class="linenos">182</span></a>    <span class="k">return</span> <span class="n">output_rays</span>
</span></pre></div>


            <div class="docstring"><p>The actual ray-tracing calculation, starting from the list of 'source_rays',
and propagating them from one optical element to the next in the order of the
items of the list 'optical_elements'.</p>

<h2 id="parameters">Parameters</h2>

<pre><code>source_rays : list[Ray-objects]
    List of input rays.

optical_elements : list[OpticalElement-objects]
</code></pre>

<h2 id="returns">Returns</h2>

<pre><code>output_rays : list[list[Ray-objects]]
    List of lists of rays, each item corresponding to the ray-bundle *after*
    the item with the same index in the 'optical_elements'-list.
</code></pre>
</div>


                </section>
                <section id="FindOptimalDistance">
                            <input id="FindOptimalDistance-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">FindOptimalDistance</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">Detector</span>,</span><span class="param">	<span class="n">RayList</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n"><a href="ModuleOpticalRay.html#Ray">ARTcore.ModuleOpticalRay.Ray</a></span><span class="p">]</span>,</span><span class="param">	<span class="n">OptFor</span><span class="o">=</span><span class="s1">&#39;intensity&#39;</span>,</span><span class="param">	<span class="n">Amplitude</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">Precision</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>,</span><span class="param">	<span class="n">IntensityWeighted</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">verbose</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="FindOptimalDistance-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FindOptimalDistance"></a>
            <div class="chroma pdoc-code"><pre><span></span><span id="FindOptimalDistance-238"><a href="#FindOptimalDistance-238"><span class="linenos">238</span></a><span class="k">def</span> <span class="nf">FindOptimalDistance</span><span class="p">(</span>
</span><span id="FindOptimalDistance-239"><a href="#FindOptimalDistance-239"><span class="linenos">239</span></a>    <span class="n">Detector</span><span class="p">,</span>
</span><span id="FindOptimalDistance-240"><a href="#FindOptimalDistance-240"><span class="linenos">240</span></a>    <span class="n">RayList</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">mray</span><span class="o">.</span><span class="n">Ray</span><span class="p">],</span>
</span><span id="FindOptimalDistance-241"><a href="#FindOptimalDistance-241"><span class="linenos">241</span></a>    <span class="n">OptFor</span><span class="o">=</span><span class="s2">&quot;intensity&quot;</span><span class="p">,</span>
</span><span id="FindOptimalDistance-242"><a href="#FindOptimalDistance-242"><span class="linenos">242</span></a>    <span class="n">Amplitude</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="FindOptimalDistance-243"><a href="#FindOptimalDistance-243"><span class="linenos">243</span></a>    <span class="n">Precision</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
</span><span id="FindOptimalDistance-244"><a href="#FindOptimalDistance-244"><span class="linenos">244</span></a>    <span class="n">IntensityWeighted</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="FindOptimalDistance-245"><a href="#FindOptimalDistance-245"><span class="linenos">245</span></a>    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="FindOptimalDistance-246"><a href="#FindOptimalDistance-246"><span class="linenos">246</span></a><span class="p">):</span>
</span><span id="FindOptimalDistance-247"><a href="#FindOptimalDistance-247"><span class="linenos">247</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="FindOptimalDistance-248"><a href="#FindOptimalDistance-248"><span class="linenos">248</span></a><span class="sd">    Automatically finds the optimal the &#39;Detector&#39;-distance for either</span>
</span><span id="FindOptimalDistance-249"><a href="#FindOptimalDistance-249"><span class="linenos">249</span></a><span class="sd">    maximum intensity, or minimal spotsize or duration.</span>
</span><span id="FindOptimalDistance-250"><a href="#FindOptimalDistance-250"><span class="linenos">250</span></a>
</span><span id="FindOptimalDistance-251"><a href="#FindOptimalDistance-251"><span class="linenos">251</span></a><span class="sd">    Parameters</span>
</span><span id="FindOptimalDistance-252"><a href="#FindOptimalDistance-252"><span class="linenos">252</span></a><span class="sd">    ----------</span>
</span><span id="FindOptimalDistance-253"><a href="#FindOptimalDistance-253"><span class="linenos">253</span></a><span class="sd">        Detector : Detector-object</span>
</span><span id="FindOptimalDistance-254"><a href="#FindOptimalDistance-254"><span class="linenos">254</span></a>
</span><span id="FindOptimalDistance-255"><a href="#FindOptimalDistance-255"><span class="linenos">255</span></a><span class="sd">        RayList : list[Ray-objects]</span>
</span><span id="FindOptimalDistance-256"><a href="#FindOptimalDistance-256"><span class="linenos">256</span></a>
</span><span id="FindOptimalDistance-257"><a href="#FindOptimalDistance-257"><span class="linenos">257</span></a><span class="sd">        OptFor : str, optional</span>
</span><span id="FindOptimalDistance-258"><a href="#FindOptimalDistance-258"><span class="linenos">258</span></a><span class="sd">            &quot;spotsize&quot;: minimizes the standard-deviation spot size *d* on the detector.</span>
</span><span id="FindOptimalDistance-259"><a href="#FindOptimalDistance-259"><span class="linenos">259</span></a><span class="sd">            &quot;duration&quot;: minimizes the standard-deviation *tau* of the ray-delays.</span>
</span><span id="FindOptimalDistance-260"><a href="#FindOptimalDistance-260"><span class="linenos">260</span></a><span class="sd">            &quot;intensity&quot;: Maximizes 1/tau/d^2.</span>
</span><span id="FindOptimalDistance-261"><a href="#FindOptimalDistance-261"><span class="linenos">261</span></a><span class="sd">            Defaults to &quot;intensity&quot;.</span>
</span><span id="FindOptimalDistance-262"><a href="#FindOptimalDistance-262"><span class="linenos">262</span></a>
</span><span id="FindOptimalDistance-263"><a href="#FindOptimalDistance-263"><span class="linenos">263</span></a><span class="sd">        Amplitude : float, optional</span>
</span><span id="FindOptimalDistance-264"><a href="#FindOptimalDistance-264"><span class="linenos">264</span></a><span class="sd">            The detector-distances within which the optimization is done will be</span>
</span><span id="FindOptimalDistance-265"><a href="#FindOptimalDistance-265"><span class="linenos">265</span></a><span class="sd">            the distance of &#39;Detector&#39; +/- Amplitude in mm.</span>
</span><span id="FindOptimalDistance-266"><a href="#FindOptimalDistance-266"><span class="linenos">266</span></a>
</span><span id="FindOptimalDistance-267"><a href="#FindOptimalDistance-267"><span class="linenos">267</span></a><span class="sd">        Precision : int, optional</span>
</span><span id="FindOptimalDistance-268"><a href="#FindOptimalDistance-268"><span class="linenos">268</span></a><span class="sd">            Precision-parameter for the search algorithm. For Precision = n,</span>
</span><span id="FindOptimalDistance-269"><a href="#FindOptimalDistance-269"><span class="linenos">269</span></a><span class="sd">            it will iterate with search amplitudes decreasing until 10^{-n}.</span>
</span><span id="FindOptimalDistance-270"><a href="#FindOptimalDistance-270"><span class="linenos">270</span></a><span class="sd">            Defaults to 3.</span>
</span><span id="FindOptimalDistance-271"><a href="#FindOptimalDistance-271"><span class="linenos">271</span></a>
</span><span id="FindOptimalDistance-272"><a href="#FindOptimalDistance-272"><span class="linenos">272</span></a><span class="sd">        IntensityWeighted : bool, optional</span>
</span><span id="FindOptimalDistance-273"><a href="#FindOptimalDistance-273"><span class="linenos">273</span></a><span class="sd">            Whether to weigh the calculation of spotsize and/or duration by the ray-intensities.</span>
</span><span id="FindOptimalDistance-274"><a href="#FindOptimalDistance-274"><span class="linenos">274</span></a><span class="sd">            Defaults to False.</span>
</span><span id="FindOptimalDistance-275"><a href="#FindOptimalDistance-275"><span class="linenos">275</span></a>
</span><span id="FindOptimalDistance-276"><a href="#FindOptimalDistance-276"><span class="linenos">276</span></a><span class="sd">        verbose : bool, optional</span>
</span><span id="FindOptimalDistance-277"><a href="#FindOptimalDistance-277"><span class="linenos">277</span></a><span class="sd">            Whether to print results to the console.</span>
</span><span id="FindOptimalDistance-278"><a href="#FindOptimalDistance-278"><span class="linenos">278</span></a>
</span><span id="FindOptimalDistance-279"><a href="#FindOptimalDistance-279"><span class="linenos">279</span></a><span class="sd">    Returns</span>
</span><span id="FindOptimalDistance-280"><a href="#FindOptimalDistance-280"><span class="linenos">280</span></a><span class="sd">    -------</span>
</span><span id="FindOptimalDistance-281"><a href="#FindOptimalDistance-281"><span class="linenos">281</span></a><span class="sd">        OptDetector : Detector-object</span>
</span><span id="FindOptimalDistance-282"><a href="#FindOptimalDistance-282"><span class="linenos">282</span></a><span class="sd">            A new detector-instance with optimized distance.</span>
</span><span id="FindOptimalDistance-283"><a href="#FindOptimalDistance-283"><span class="linenos">283</span></a>
</span><span id="FindOptimalDistance-284"><a href="#FindOptimalDistance-284"><span class="linenos">284</span></a><span class="sd">        OptSpotSize : float</span>
</span><span id="FindOptimalDistance-285"><a href="#FindOptimalDistance-285"><span class="linenos">285</span></a><span class="sd">            Spotsize, calculated as standard deviation in mm of the spot-diagram</span>
</span><span id="FindOptimalDistance-286"><a href="#FindOptimalDistance-286"><span class="linenos">286</span></a><span class="sd">            on the optimized detector.</span>
</span><span id="FindOptimalDistance-287"><a href="#FindOptimalDistance-287"><span class="linenos">287</span></a>
</span><span id="FindOptimalDistance-288"><a href="#FindOptimalDistance-288"><span class="linenos">288</span></a><span class="sd">        OptDuration : float</span>
</span><span id="FindOptimalDistance-289"><a href="#FindOptimalDistance-289"><span class="linenos">289</span></a><span class="sd">            Duration, calculated as standard deviation in fs of the ray-delays</span>
</span><span id="FindOptimalDistance-290"><a href="#FindOptimalDistance-290"><span class="linenos">290</span></a><span class="sd">            on the optimized detector.</span>
</span><span id="FindOptimalDistance-291"><a href="#FindOptimalDistance-291"><span class="linenos">291</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="FindOptimalDistance-292"><a href="#FindOptimalDistance-292"><span class="linenos">292</span></a>
</span><span id="FindOptimalDistance-293"><a href="#FindOptimalDistance-293"><span class="linenos">293</span></a>    <span class="k">if</span> <span class="n">OptFor</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="s2">&quot;duration&quot;</span><span class="p">]:</span>
</span><span id="FindOptimalDistance-294"><a href="#FindOptimalDistance-294"><span class="linenos">294</span></a>        <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span>
</span><span id="FindOptimalDistance-295"><a href="#FindOptimalDistance-295"><span class="linenos">295</span></a>            <span class="s2">&quot;I don`t recognize what you want to optimize the detector distance for. OptFor must be either &#39;intensity&#39;, &#39;size&#39; or &#39;duration&#39;.&quot;</span>
</span><span id="FindOptimalDistance-296"><a href="#FindOptimalDistance-296"><span class="linenos">296</span></a>        <span class="p">)</span>
</span><span id="FindOptimalDistance-297"><a href="#FindOptimalDistance-297"><span class="linenos">297</span></a>
</span><span id="FindOptimalDistance-298"><a href="#FindOptimalDistance-298"><span class="linenos">298</span></a>    <span class="n">FirstDistance</span> <span class="o">=</span> <span class="n">Detector</span><span class="o">.</span><span class="n">get_distance</span><span class="p">()</span>
</span><span id="FindOptimalDistance-299"><a href="#FindOptimalDistance-299"><span class="linenos">299</span></a>    <span class="n">ListPointDetector2DCentre</span> <span class="o">=</span> <span class="n">Detector</span><span class="o">.</span><span class="n">get_PointList2DCentre</span><span class="p">(</span><span class="n">RayList</span><span class="p">)</span>
</span><span id="FindOptimalDistance-300"><a href="#FindOptimalDistance-300"><span class="linenos">300</span></a>    <span class="n">SizeSpot</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">StandardDeviation</span><span class="p">(</span><span class="n">ListPointDetector2DCentre</span><span class="p">)</span>
</span><span id="FindOptimalDistance-301"><a href="#FindOptimalDistance-301"><span class="linenos">301</span></a>    <span class="n">NumericalAperture</span> <span class="o">=</span> <span class="n">ReturnNumericalAperture</span><span class="p">(</span><span class="n">RayList</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="FindOptimalDistance-302"><a href="#FindOptimalDistance-302"><span class="linenos">302</span></a>    <span class="k">if</span> <span class="n">Amplitude</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="FindOptimalDistance-303"><a href="#FindOptimalDistance-303"><span class="linenos">303</span></a>        <span class="n">Amplitude</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">SizeSpot</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">NumericalAperture</span><span class="p">))),</span> <span class="n">FirstDistance</span><span class="p">)</span>
</span><span id="FindOptimalDistance-304"><a href="#FindOptimalDistance-304"><span class="linenos">304</span></a>    <span class="n">Step</span> <span class="o">=</span> <span class="n">Amplitude</span><span class="o">/</span><span class="mi">10</span>
</span><span id="FindOptimalDistance-305"><a href="#FindOptimalDistance-305"><span class="linenos">305</span></a>    <span class="c1">#Step = Amplitude / 5  # pretty good in half the time ;-)</span>
</span><span id="FindOptimalDistance-306"><a href="#FindOptimalDistance-306"><span class="linenos">306</span></a>
</span><span id="FindOptimalDistance-307"><a href="#FindOptimalDistance-307"><span class="linenos">307</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="FindOptimalDistance-308"><a href="#FindOptimalDistance-308"><span class="linenos">308</span></a>        <span class="nb">print</span><span class="p">(</span>
</span><span id="FindOptimalDistance-309"><a href="#FindOptimalDistance-309"><span class="linenos">309</span></a>            <span class="sa">f</span><span class="s2">&quot;Searching optimal detector position for *</span><span class="si">{</span><span class="n">OptFor</span><span class="si">}</span><span class="s2">* within [</span><span class="si">{</span><span class="n">FirstDistance</span><span class="o">-</span><span class="n">Amplitude</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">FirstDistance</span><span class="o">+</span><span class="n">Amplitude</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">] mm...&quot;</span><span class="p">,</span>
</span><span id="FindOptimalDistance-310"><a href="#FindOptimalDistance-310"><span class="linenos">310</span></a>            <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="FindOptimalDistance-311"><a href="#FindOptimalDistance-311"><span class="linenos">311</span></a>            <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="FindOptimalDistance-312"><a href="#FindOptimalDistance-312"><span class="linenos">312</span></a>        <span class="p">)</span>
</span><span id="FindOptimalDistance-313"><a href="#FindOptimalDistance-313"><span class="linenos">313</span></a>    <span class="n">movingDetector</span> <span class="o">=</span> <span class="n">Detector</span><span class="o">.</span><span class="n">copy_detector</span><span class="p">()</span>
</span><span id="FindOptimalDistance-314"><a href="#FindOptimalDistance-314"><span class="linenos">314</span></a>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Precision</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="FindOptimalDistance-315"><a href="#FindOptimalDistance-315"><span class="linenos">315</span></a>        <span class="n">movingDetector</span><span class="p">,</span> <span class="n">OptSpotSize</span><span class="p">,</span> <span class="n">OptDuration</span> <span class="o">=</span> <span class="n">_FindOptimalDistanceBIS</span><span class="p">(</span>
</span><span id="FindOptimalDistance-316"><a href="#FindOptimalDistance-316"><span class="linenos">316</span></a>            <span class="n">movingDetector</span><span class="p">,</span> <span class="n">Amplitude</span> <span class="o">*</span> <span class="mf">0.1</span><span class="o">**</span><span class="n">k</span><span class="p">,</span> <span class="n">Step</span> <span class="o">*</span> <span class="mf">0.1</span><span class="o">**</span><span class="n">k</span><span class="p">,</span> <span class="n">RayList</span><span class="p">,</span> <span class="n">OptFor</span><span class="p">,</span> <span class="n">IntensityWeighted</span>
</span><span id="FindOptimalDistance-317"><a href="#FindOptimalDistance-317"><span class="linenos">317</span></a>        <span class="p">)</span>
</span><span id="FindOptimalDistance-318"><a href="#FindOptimalDistance-318"><span class="linenos">318</span></a>
</span><span id="FindOptimalDistance-319"><a href="#FindOptimalDistance-319"><span class="linenos">319</span></a>    <span class="k">if</span> <span class="p">(</span>
</span><span id="FindOptimalDistance-320"><a href="#FindOptimalDistance-320"><span class="linenos">320</span></a>        <span class="ow">not</span> <span class="n">FirstDistance</span> <span class="o">-</span> <span class="n">Amplitude</span> <span class="o">+</span> <span class="mi">10</span><span class="o">**-</span><span class="n">Precision</span>
</span><span id="FindOptimalDistance-321"><a href="#FindOptimalDistance-321"><span class="linenos">321</span></a>        <span class="o">&lt;</span> <span class="n">movingDetector</span><span class="o">.</span><span class="n">get_distance</span><span class="p">()</span>
</span><span id="FindOptimalDistance-322"><a href="#FindOptimalDistance-322"><span class="linenos">322</span></a>        <span class="o">&lt;</span> <span class="n">FirstDistance</span> <span class="o">+</span> <span class="n">Amplitude</span> <span class="o">-</span> <span class="mi">10</span><span class="o">**-</span><span class="n">Precision</span>
</span><span id="FindOptimalDistance-323"><a href="#FindOptimalDistance-323"><span class="linenos">323</span></a>    <span class="p">):</span>
</span><span id="FindOptimalDistance-324"><a href="#FindOptimalDistance-324"><span class="linenos">324</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;There`s no minimum-size/duration focus in the searched range.&quot;</span><span class="p">)</span>
</span><span id="FindOptimalDistance-325"><a href="#FindOptimalDistance-325"><span class="linenos">325</span></a>
</span><span id="FindOptimalDistance-326"><a href="#FindOptimalDistance-326"><span class="linenos">326</span></a>    <span class="nb">print</span><span class="p">(</span>
</span><span id="FindOptimalDistance-327"><a href="#FindOptimalDistance-327"><span class="linenos">327</span></a>        <span class="s2">&quot;</span><span class="se">\r\033</span><span class="s2">[K&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span>
</span><span id="FindOptimalDistance-328"><a href="#FindOptimalDistance-328"><span class="linenos">328</span></a>    <span class="p">)</span>  <span class="c1"># move to beginning of the line with \r and then delete the whole line with \033[K</span>
</span><span id="FindOptimalDistance-329"><a href="#FindOptimalDistance-329"><span class="linenos">329</span></a>    <span class="k">return</span> <span class="n">movingDetector</span><span class="p">,</span> <span class="n">OptSpotSize</span><span class="p">,</span> <span class="n">OptDuration</span>
</span></pre></div>


            <div class="docstring"><p>Automatically finds the optimal the 'Detector'-distance for either
maximum intensity, or minimal spotsize or duration.</p>

<h2 id="parameters">Parameters</h2>

<pre><code>Detector : Detector-object

RayList : list[Ray-objects]

OptFor : str, optional
    "spotsize": minimizes the standard-deviation spot size *d* on the detector.
    "duration": minimizes the standard-deviation *tau* of the ray-delays.
    "intensity": Maximizes 1/tau/d^2.
    Defaults to "intensity".

Amplitude : float, optional
    The detector-distances within which the optimization is done will be
    the distance of 'Detector' +/- Amplitude in mm.

Precision : int, optional
    Precision-parameter for the search algorithm. For Precision = n,
    it will iterate with search amplitudes decreasing until 10^{-n}.
    Defaults to 3.

IntensityWeighted : bool, optional
    Whether to weigh the calculation of spotsize and/or duration by the ray-intensities.
    Defaults to False.

verbose : bool, optional
    Whether to print results to the console.
</code></pre>

<h2 id="returns">Returns</h2>

<pre><code>OptDetector : Detector-object
    A new detector-instance with optimized distance.

OptSpotSize : float
    Spotsize, calculated as standard deviation in mm of the spot-diagram
    on the optimized detector.

OptDuration : float
    Duration, calculated as standard deviation in fs of the ray-delays
    on the optimized detector.
</code></pre>
</div>


                </section>
                <section id="FindCentralRay">
                            <input id="FindCentralRay-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">FindCentralRay</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">RayList</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n"><a href="ModuleOpticalRay.html#Ray">ARTcore.ModuleOpticalRay.Ray</a></span><span class="p">]</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="FindCentralRay-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FindCentralRay"></a>
            <div class="chroma pdoc-code"><pre><span></span><span id="FindCentralRay-333"><a href="#FindCentralRay-333"><span class="linenos">333</span></a><span class="k">def</span> <span class="nf">FindCentralRay</span><span class="p">(</span><span class="n">RayList</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">mray</span><span class="o">.</span><span class="n">Ray</span><span class="p">]):</span>
</span><span id="FindCentralRay-334"><a href="#FindCentralRay-334"><span class="linenos">334</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="FindCentralRay-335"><a href="#FindCentralRay-335"><span class="linenos">335</span></a><span class="sd">    Out of a the list of Ray-objects, RayList, determine the average direction</span>
</span><span id="FindCentralRay-336"><a href="#FindCentralRay-336"><span class="linenos">336</span></a><span class="sd">    vector and source point, and the return a Ray-object representing this </span>
</span><span id="FindCentralRay-337"><a href="#FindCentralRay-337"><span class="linenos">337</span></a><span class="sd">    central ray of the RayList.</span>
</span><span id="FindCentralRay-338"><a href="#FindCentralRay-338"><span class="linenos">338</span></a><span class="sd">    </span>
</span><span id="FindCentralRay-339"><a href="#FindCentralRay-339"><span class="linenos">339</span></a><span class="sd">    Parameters</span>
</span><span id="FindCentralRay-340"><a href="#FindCentralRay-340"><span class="linenos">340</span></a><span class="sd">    ----------</span>
</span><span id="FindCentralRay-341"><a href="#FindCentralRay-341"><span class="linenos">341</span></a><span class="sd">        RayList : list of Ray-objects</span>
</span><span id="FindCentralRay-342"><a href="#FindCentralRay-342"><span class="linenos">342</span></a>
</span><span id="FindCentralRay-343"><a href="#FindCentralRay-343"><span class="linenos">343</span></a><span class="sd">    Returns</span>
</span><span id="FindCentralRay-344"><a href="#FindCentralRay-344"><span class="linenos">344</span></a><span class="sd">    -------</span>
</span><span id="FindCentralRay-345"><a href="#FindCentralRay-345"><span class="linenos">345</span></a><span class="sd">        CentralRay : Ray-object</span>
</span><span id="FindCentralRay-346"><a href="#FindCentralRay-346"><span class="linenos">346</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="FindCentralRay-347"><a href="#FindCentralRay-347"><span class="linenos">347</span></a>      
</span><span id="FindCentralRay-348"><a href="#FindCentralRay-348"><span class="linenos">348</span></a>    <span class="n">CentralVector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">vector</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">RayList</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="FindCentralRay-349"><a href="#FindCentralRay-349"><span class="linenos">349</span></a>    <span class="n">CentralPoint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">point</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">RayList</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="FindCentralRay-350"><a href="#FindCentralRay-350"><span class="linenos">350</span></a>    
</span><span id="FindCentralRay-351"><a href="#FindCentralRay-351"><span class="linenos">351</span></a>    <span class="k">return</span> <span class="n">mray</span><span class="o">.</span><span class="n">Ray</span><span class="p">(</span><span class="n">CentralPoint</span><span class="p">,</span> <span class="n">CentralVector</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Out of a the list of Ray-objects, RayList, determine the average direction
vector and source point, and the return a Ray-object representing this 
central ray of the RayList.</p>

<h2 id="parameters">Parameters</h2>

<pre><code>RayList : list of Ray-objects
</code></pre>

<h2 id="returns">Returns</h2>

<pre><code>CentralRay : Ray-object
</code></pre>
</div>


                </section>
                <section id="StandardDeviation">
                            <input id="StandardDeviation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">StandardDeviation</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">List</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="StandardDeviation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StandardDeviation"></a>
            <div class="chroma pdoc-code"><pre><span></span><span id="StandardDeviation-354"><a href="#StandardDeviation-354"><span class="linenos">354</span></a><span class="k">def</span> <span class="nf">StandardDeviation</span><span class="p">(</span><span class="n">List</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="StandardDeviation-355"><a href="#StandardDeviation-355"><span class="linenos">355</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StandardDeviation-356"><a href="#StandardDeviation-356"><span class="linenos">356</span></a><span class="sd">    Return the standard deviation of elements in the supplied list.</span>
</span><span id="StandardDeviation-357"><a href="#StandardDeviation-357"><span class="linenos">357</span></a><span class="sd">    If the elements are floats, it&#39;s simply the root-mean-square over the numbers.</span>
</span><span id="StandardDeviation-358"><a href="#StandardDeviation-358"><span class="linenos">358</span></a><span class="sd">    If the elements are vectors (represented as numpy-arrays), the root-mean-square</span>
</span><span id="StandardDeviation-359"><a href="#StandardDeviation-359"><span class="linenos">359</span></a><span class="sd">    of the distance of the points from their mean is calculated.</span>
</span><span id="StandardDeviation-360"><a href="#StandardDeviation-360"><span class="linenos">360</span></a>
</span><span id="StandardDeviation-361"><a href="#StandardDeviation-361"><span class="linenos">361</span></a><span class="sd">    Parameters</span>
</span><span id="StandardDeviation-362"><a href="#StandardDeviation-362"><span class="linenos">362</span></a><span class="sd">    ----------</span>
</span><span id="StandardDeviation-363"><a href="#StandardDeviation-363"><span class="linenos">363</span></a><span class="sd">        List : list of floats or of np.ndarray</span>
</span><span id="StandardDeviation-364"><a href="#StandardDeviation-364"><span class="linenos">364</span></a><span class="sd">            Numbers (in ART, typically delays)</span>
</span><span id="StandardDeviation-365"><a href="#StandardDeviation-365"><span class="linenos">365</span></a><span class="sd">            or 2D or 3D vectors (in ART typically space coordinates)</span>
</span><span id="StandardDeviation-366"><a href="#StandardDeviation-366"><span class="linenos">366</span></a>
</span><span id="StandardDeviation-367"><a href="#StandardDeviation-367"><span class="linenos">367</span></a><span class="sd">    Returns</span>
</span><span id="StandardDeviation-368"><a href="#StandardDeviation-368"><span class="linenos">368</span></a><span class="sd">    -------</span>
</span><span id="StandardDeviation-369"><a href="#StandardDeviation-369"><span class="linenos">369</span></a><span class="sd">        Std : float</span>
</span><span id="StandardDeviation-370"><a href="#StandardDeviation-370"><span class="linenos">370</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="StandardDeviation-371"><a href="#StandardDeviation-371"><span class="linenos">371</span></a>    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
</span><span id="StandardDeviation-372"><a href="#StandardDeviation-372"><span class="linenos">372</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">List</span><span class="p">)</span>
</span><span id="StandardDeviation-373"><a href="#StandardDeviation-373"><span class="linenos">373</span></a>    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="StandardDeviation-374"><a href="#StandardDeviation-374"><span class="linenos">374</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
</span><span id="StandardDeviation-375"><a href="#StandardDeviation-375"><span class="linenos">375</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="StandardDeviation-376"><a href="#StandardDeviation-376"><span class="linenos">376</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;StandardDeviation expects a list of floats or numpy-arrays as input, but got something else.&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Return the standard deviation of elements in the supplied list.
If the elements are floats, it's simply the root-mean-square over the numbers.
If the elements are vectors (represented as numpy-arrays), the root-mean-square
of the distance of the points from their mean is calculated.</p>

<h2 id="parameters">Parameters</h2>

<pre><code>List : list of floats or of np.ndarray
    Numbers (in ART, typically delays)
    or 2D or 3D vectors (in ART typically space coordinates)
</code></pre>

<h2 id="returns">Returns</h2>

<pre><code>Std : float
</code></pre>
</div>


                </section>
                <section id="WeightedStandardDeviation">
                            <input id="WeightedStandardDeviation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">WeightedStandardDeviation</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">List</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>, </span><span class="param"><span class="n">Weights</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="WeightedStandardDeviation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#WeightedStandardDeviation"></a>
            <div class="chroma pdoc-code"><pre><span></span><span id="WeightedStandardDeviation-379"><a href="#WeightedStandardDeviation-379"><span class="linenos">379</span></a><span class="k">def</span> <span class="nf">WeightedStandardDeviation</span><span class="p">(</span><span class="n">List</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">Weights</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="WeightedStandardDeviation-380"><a href="#WeightedStandardDeviation-380"><span class="linenos">380</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="WeightedStandardDeviation-381"><a href="#WeightedStandardDeviation-381"><span class="linenos">381</span></a><span class="sd">    Return the weighted standard deviation of elements in the supplied list.</span>
</span><span id="WeightedStandardDeviation-382"><a href="#WeightedStandardDeviation-382"><span class="linenos">382</span></a><span class="sd">    If the elements are floats, it&#39;s simply the root-mean-square over the weighted numbers.</span>
</span><span id="WeightedStandardDeviation-383"><a href="#WeightedStandardDeviation-383"><span class="linenos">383</span></a><span class="sd">    If the elements are vectors (represented as numpy-arrays), the root-mean-square</span>
</span><span id="WeightedStandardDeviation-384"><a href="#WeightedStandardDeviation-384"><span class="linenos">384</span></a><span class="sd">    of the weighted distances of the points from their mean is calculated.</span>
</span><span id="WeightedStandardDeviation-385"><a href="#WeightedStandardDeviation-385"><span class="linenos">385</span></a>
</span><span id="WeightedStandardDeviation-386"><a href="#WeightedStandardDeviation-386"><span class="linenos">386</span></a><span class="sd">    Parameters</span>
</span><span id="WeightedStandardDeviation-387"><a href="#WeightedStandardDeviation-387"><span class="linenos">387</span></a><span class="sd">    ----------</span>
</span><span id="WeightedStandardDeviation-388"><a href="#WeightedStandardDeviation-388"><span class="linenos">388</span></a><span class="sd">        List : list of floats or of np.ndarray</span>
</span><span id="WeightedStandardDeviation-389"><a href="#WeightedStandardDeviation-389"><span class="linenos">389</span></a><span class="sd">            Numbers (in ART, typically delays)</span>
</span><span id="WeightedStandardDeviation-390"><a href="#WeightedStandardDeviation-390"><span class="linenos">390</span></a><span class="sd">            or 2D or 3D vectors (in ART typically space coordinates)</span>
</span><span id="WeightedStandardDeviation-391"><a href="#WeightedStandardDeviation-391"><span class="linenos">391</span></a>
</span><span id="WeightedStandardDeviation-392"><a href="#WeightedStandardDeviation-392"><span class="linenos">392</span></a><span class="sd">        Weights : list of floats, same length as List</span>
</span><span id="WeightedStandardDeviation-393"><a href="#WeightedStandardDeviation-393"><span class="linenos">393</span></a><span class="sd">            Parameters such as Ray.intensity to be used as weights</span>
</span><span id="WeightedStandardDeviation-394"><a href="#WeightedStandardDeviation-394"><span class="linenos">394</span></a>
</span><span id="WeightedStandardDeviation-395"><a href="#WeightedStandardDeviation-395"><span class="linenos">395</span></a><span class="sd">    Returns</span>
</span><span id="WeightedStandardDeviation-396"><a href="#WeightedStandardDeviation-396"><span class="linenos">396</span></a><span class="sd">    -------</span>
</span><span id="WeightedStandardDeviation-397"><a href="#WeightedStandardDeviation-397"><span class="linenos">397</span></a><span class="sd">        Std : float</span>
</span><span id="WeightedStandardDeviation-398"><a href="#WeightedStandardDeviation-398"><span class="linenos">398</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="WeightedStandardDeviation-399"><a href="#WeightedStandardDeviation-399"><span class="linenos">399</span></a>    <span class="n">average</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">Weights</span><span class="p">,</span> <span class="n">returned</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="WeightedStandardDeviation-400"><a href="#WeightedStandardDeviation-400"><span class="linenos">400</span></a>    <span class="n">variance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">List</span> <span class="o">-</span> <span class="n">average</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">Weights</span><span class="p">,</span> <span class="n">returned</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="WeightedStandardDeviation-401"><a href="#WeightedStandardDeviation-401"><span class="linenos">401</span></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
</span></pre></div>


            <div class="docstring"><p>Return the weighted standard deviation of elements in the supplied list.
If the elements are floats, it's simply the root-mean-square over the weighted numbers.
If the elements are vectors (represented as numpy-arrays), the root-mean-square
of the weighted distances of the points from their mean is calculated.</p>

<h2 id="parameters">Parameters</h2>

<pre><code>List : list of floats or of np.ndarray
    Numbers (in ART, typically delays)
    or 2D or 3D vectors (in ART typically space coordinates)

Weights : list of floats, same length as List
    Parameters such as Ray.intensity to be used as weights
</code></pre>

<h2 id="returns">Returns</h2>

<pre><code>Std : float
</code></pre>
</div>


                </section>
                <section id="ReturnNumericalAperture">
                            <input id="ReturnNumericalAperture-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">ReturnNumericalAperture</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">RayList</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n"><a href="ModuleOpticalRay.html#Ray">ARTcore.ModuleOpticalRay.Ray</a></span><span class="p">]</span>,</span><span class="param">	<span class="n">RefractiveIndex</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="ReturnNumericalAperture-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ReturnNumericalAperture"></a>
            <div class="chroma pdoc-code"><pre><span></span><span id="ReturnNumericalAperture-405"><a href="#ReturnNumericalAperture-405"><span class="linenos">405</span></a><span class="k">def</span> <span class="nf">ReturnNumericalAperture</span><span class="p">(</span><span class="n">RayList</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">mray</span><span class="o">.</span><span class="n">Ray</span><span class="p">],</span> <span class="n">RefractiveIndex</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="ReturnNumericalAperture-406"><a href="#ReturnNumericalAperture-406"><span class="linenos">406</span></a><span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReturnNumericalAperture-407"><a href="#ReturnNumericalAperture-407"><span class="linenos">407</span></a><span class="sd">    Returns the numerical aperture associated with the supplied ray-bundle &#39;Raylist&#39;.</span>
</span><span id="ReturnNumericalAperture-408"><a href="#ReturnNumericalAperture-408"><span class="linenos">408</span></a><span class="sd">    This is $n\sin\theta$, where $\theta$ is the maximum angle between any of the rays and the central ray,</span>
</span><span id="ReturnNumericalAperture-409"><a href="#ReturnNumericalAperture-409"><span class="linenos">409</span></a><span class="sd">    and $n$ is the refractive index of the propagation medium.</span>
</span><span id="ReturnNumericalAperture-410"><a href="#ReturnNumericalAperture-410"><span class="linenos">410</span></a>
</span><span id="ReturnNumericalAperture-411"><a href="#ReturnNumericalAperture-411"><span class="linenos">411</span></a><span class="sd">    Parameters</span>
</span><span id="ReturnNumericalAperture-412"><a href="#ReturnNumericalAperture-412"><span class="linenos">412</span></a><span class="sd">    ----------</span>
</span><span id="ReturnNumericalAperture-413"><a href="#ReturnNumericalAperture-413"><span class="linenos">413</span></a><span class="sd">        RayList : list of Ray-object</span>
</span><span id="ReturnNumericalAperture-414"><a href="#ReturnNumericalAperture-414"><span class="linenos">414</span></a><span class="sd">            The ray-bundle of which to determine the NA.</span>
</span><span id="ReturnNumericalAperture-415"><a href="#ReturnNumericalAperture-415"><span class="linenos">415</span></a>
</span><span id="ReturnNumericalAperture-416"><a href="#ReturnNumericalAperture-416"><span class="linenos">416</span></a><span class="sd">        RefractiveIndex : float, optional</span>
</span><span id="ReturnNumericalAperture-417"><a href="#ReturnNumericalAperture-417"><span class="linenos">417</span></a><span class="sd">            Refractive index of the propagation medium, defaults to =1.</span>
</span><span id="ReturnNumericalAperture-418"><a href="#ReturnNumericalAperture-418"><span class="linenos">418</span></a>
</span><span id="ReturnNumericalAperture-419"><a href="#ReturnNumericalAperture-419"><span class="linenos">419</span></a><span class="sd">    Returns</span>
</span><span id="ReturnNumericalAperture-420"><a href="#ReturnNumericalAperture-420"><span class="linenos">420</span></a><span class="sd">    -------</span>
</span><span id="ReturnNumericalAperture-421"><a href="#ReturnNumericalAperture-421"><span class="linenos">421</span></a><span class="sd">        NA : float</span>
</span><span id="ReturnNumericalAperture-422"><a href="#ReturnNumericalAperture-422"><span class="linenos">422</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="ReturnNumericalAperture-423"><a href="#ReturnNumericalAperture-423"><span class="linenos">423</span></a>    <span class="n">CentralRay</span> <span class="o">=</span> <span class="n">FindCentralRay</span><span class="p">(</span><span class="n">RayList</span><span class="p">)</span>
</span><span id="ReturnNumericalAperture-424"><a href="#ReturnNumericalAperture-424"><span class="linenos">424</span></a>    <span class="k">if</span> <span class="n">CentralRay</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ReturnNumericalAperture-425"><a href="#ReturnNumericalAperture-425"><span class="linenos">425</span></a>        <span class="n">CentralVector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
</span><span id="ReturnNumericalAperture-426"><a href="#ReturnNumericalAperture-426"><span class="linenos">426</span></a>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">RayList</span><span class="p">:</span>
</span><span id="ReturnNumericalAperture-427"><a href="#ReturnNumericalAperture-427"><span class="linenos">427</span></a>            <span class="n">CentralVector</span> <span class="o">=</span> <span class="n">CentralVector</span> <span class="o">+</span> <span class="n">k</span><span class="o">.</span><span class="n">vector</span>
</span><span id="ReturnNumericalAperture-428"><a href="#ReturnNumericalAperture-428"><span class="linenos">428</span></a>        <span class="n">CentralVector</span> <span class="o">=</span> <span class="n">CentralVector</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">RayList</span><span class="p">)</span>
</span><span id="ReturnNumericalAperture-429"><a href="#ReturnNumericalAperture-429"><span class="linenos">429</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="ReturnNumericalAperture-430"><a href="#ReturnNumericalAperture-430"><span class="linenos">430</span></a>        <span class="n">CentralVector</span> <span class="o">=</span> <span class="n">CentralRay</span><span class="o">.</span><span class="n">vector</span>
</span><span id="ReturnNumericalAperture-431"><a href="#ReturnNumericalAperture-431"><span class="linenos">431</span></a>    <span class="n">ListAngleAperture</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ReturnNumericalAperture-432"><a href="#ReturnNumericalAperture-432"><span class="linenos">432</span></a>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">RayList</span><span class="p">:</span>
</span><span id="ReturnNumericalAperture-433"><a href="#ReturnNumericalAperture-433"><span class="linenos">433</span></a>        <span class="n">ListAngleAperture</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mgeo</span><span class="o">.</span><span class="n">AngleBetweenTwoVectors</span><span class="p">(</span><span class="n">CentralVector</span><span class="p">,</span> <span class="n">k</span><span class="o">.</span><span class="n">vector</span><span class="p">))</span>
</span><span id="ReturnNumericalAperture-434"><a href="#ReturnNumericalAperture-434"><span class="linenos">434</span></a>
</span><span id="ReturnNumericalAperture-435"><a href="#ReturnNumericalAperture-435"><span class="linenos">435</span></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">ListAngleAperture</span><span class="p">))</span> <span class="o">*</span> <span class="n">RefractiveIndex</span>
</span></pre></div>


            <div class="docstring"><p>Returns the numerical aperture associated with the supplied ray-bundle 'Raylist'.
This is $n\sin\theta$, where $\theta$ is the maximum angle between any of the rays and the central ray,
and $n$ is the refractive index of the propagation medium.</p>

<h2 id="parameters">Parameters</h2>

<pre><code>RayList : list of Ray-object
    The ray-bundle of which to determine the NA.

RefractiveIndex : float, optional
    Refractive index of the propagation medium, defaults to =1.
</code></pre>

<h2 id="returns">Returns</h2>

<pre><code>NA : float
</code></pre>
</div>


                </section>
                <section id="ReturnAiryRadius">
                            <input id="ReturnAiryRadius-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">ReturnAiryRadius</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">Wavelength</span><span class="p">:</span> <span class="nb">float</span>, </span><span class="param"><span class="n">NumericalAperture</span><span class="p">:</span> <span class="nb">float</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="ReturnAiryRadius-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ReturnAiryRadius"></a>
            <div class="chroma pdoc-code"><pre><span></span><span id="ReturnAiryRadius-439"><a href="#ReturnAiryRadius-439"><span class="linenos">439</span></a><span class="k">def</span> <span class="nf">ReturnAiryRadius</span><span class="p">(</span><span class="n">Wavelength</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">NumericalAperture</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="ReturnAiryRadius-440"><a href="#ReturnAiryRadius-440"><span class="linenos">440</span></a><span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReturnAiryRadius-441"><a href="#ReturnAiryRadius-441"><span class="linenos">441</span></a><span class="sd">    Returns the radius of the Airy disk: $r = 1.22 \frac\{\lambda\}\{NA\}$,</span>
</span><span id="ReturnAiryRadius-442"><a href="#ReturnAiryRadius-442"><span class="linenos">442</span></a><span class="sd">    i.e. the diffraction-limited radius of the focal spot corresponding to a given</span>
</span><span id="ReturnAiryRadius-443"><a href="#ReturnAiryRadius-443"><span class="linenos">443</span></a><span class="sd">    numerical aperture $NA$ and a light wavelength $\lambda$.</span>
</span><span id="ReturnAiryRadius-444"><a href="#ReturnAiryRadius-444"><span class="linenos">444</span></a>
</span><span id="ReturnAiryRadius-445"><a href="#ReturnAiryRadius-445"><span class="linenos">445</span></a><span class="sd">    For very small $NA&lt;10^\{-3\}$, diffraction effects becomes negligible and the Airy Radius becomes meaningless,</span>
</span><span id="ReturnAiryRadius-446"><a href="#ReturnAiryRadius-446"><span class="linenos">446</span></a><span class="sd">    so in that case, a radius of 0 is returned.</span>
</span><span id="ReturnAiryRadius-447"><a href="#ReturnAiryRadius-447"><span class="linenos">447</span></a>
</span><span id="ReturnAiryRadius-448"><a href="#ReturnAiryRadius-448"><span class="linenos">448</span></a><span class="sd">    Parameters</span>
</span><span id="ReturnAiryRadius-449"><a href="#ReturnAiryRadius-449"><span class="linenos">449</span></a><span class="sd">    ----------</span>
</span><span id="ReturnAiryRadius-450"><a href="#ReturnAiryRadius-450"><span class="linenos">450</span></a><span class="sd">        Wavelength : float</span>
</span><span id="ReturnAiryRadius-451"><a href="#ReturnAiryRadius-451"><span class="linenos">451</span></a><span class="sd">            Light wavelength in mm.</span>
</span><span id="ReturnAiryRadius-452"><a href="#ReturnAiryRadius-452"><span class="linenos">452</span></a>
</span><span id="ReturnAiryRadius-453"><a href="#ReturnAiryRadius-453"><span class="linenos">453</span></a><span class="sd">        NumericalAperture : float</span>
</span><span id="ReturnAiryRadius-454"><a href="#ReturnAiryRadius-454"><span class="linenos">454</span></a>
</span><span id="ReturnAiryRadius-455"><a href="#ReturnAiryRadius-455"><span class="linenos">455</span></a><span class="sd">    Returns</span>
</span><span id="ReturnAiryRadius-456"><a href="#ReturnAiryRadius-456"><span class="linenos">456</span></a><span class="sd">    -------</span>
</span><span id="ReturnAiryRadius-457"><a href="#ReturnAiryRadius-457"><span class="linenos">457</span></a><span class="sd">        AiryRadius : float</span>
</span><span id="ReturnAiryRadius-458"><a href="#ReturnAiryRadius-458"><span class="linenos">458</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="ReturnAiryRadius-459"><a href="#ReturnAiryRadius-459"><span class="linenos">459</span></a>    <span class="k">if</span> <span class="n">NumericalAperture</span> <span class="o">&gt;</span> <span class="mf">1e-3</span> <span class="ow">and</span> <span class="n">Wavelength</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ReturnAiryRadius-460"><a href="#ReturnAiryRadius-460"><span class="linenos">460</span></a>        <span class="k">return</span> <span class="mf">1.22</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">Wavelength</span> <span class="o">/</span> <span class="n">NumericalAperture</span>
</span><span id="ReturnAiryRadius-461"><a href="#ReturnAiryRadius-461"><span class="linenos">461</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="ReturnAiryRadius-462"><a href="#ReturnAiryRadius-462"><span class="linenos">462</span></a>        <span class="k">return</span> <span class="mi">0</span>  <span class="c1"># for very small numerical apertures, diffraction effects becomes negligible and the Airy Radius becomes meaningless</span>
</span></pre></div>


            <div class="docstring"><p>Returns the radius of the Airy disk: $r = 1.22 \frac{\lambda}{NA}$,
i.e. the diffraction-limited radius of the focal spot corresponding to a given
numerical aperture $NA$ and a light wavelength $\lambda$.</p>

<p>For very small $NA&lt;10^{-3}$, diffraction effects becomes negligible and the Airy Radius becomes meaningless,
so in that case, a radius of 0 is returned.</p>

<h2 id="parameters">Parameters</h2>

<pre><code>Wavelength : float
    Light wavelength in mm.

NumericalAperture : float
</code></pre>

<h2 id="returns">Returns</h2>

<pre><code>AiryRadius : float
</code></pre>
</div>


                </section>
                <section id="save_compressed">
                            <input id="save_compressed-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">save_compressed</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">obj</span>, </span><span class="param"><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="save_compressed-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#save_compressed"></a>
            <div class="chroma pdoc-code"><pre><span></span><span id="save_compressed-481"><a href="#save_compressed-481"><span class="linenos">481</span></a><span class="k">def</span> <span class="nf">save_compressed</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="save_compressed-482"><a href="#save_compressed-482"><span class="linenos">482</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Save (=pickle) an object &#39;obj&#39; to a compressed file with name &#39;filename&#39;.&quot;&quot;&quot;</span>
</span><span id="save_compressed-483"><a href="#save_compressed-483"><span class="linenos">483</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="save_compressed-484"><a href="#save_compressed-484"><span class="linenos">484</span></a>        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;kept_data_&quot;</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">-%Hh%M&quot;</span><span class="p">)</span>
</span><span id="save_compressed-485"><a href="#save_compressed-485"><span class="linenos">485</span></a>
</span><span id="save_compressed-486"><a href="#save_compressed-486"><span class="linenos">486</span></a>    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="save_compressed-487"><a href="#save_compressed-487"><span class="linenos">487</span></a>    <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.xz&quot;</span><span class="p">):</span>
</span><span id="save_compressed-488"><a href="#save_compressed-488"><span class="linenos">488</span></a>        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="save_compressed-489"><a href="#save_compressed-489"><span class="linenos">489</span></a>    <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="save_compressed-490"><a href="#save_compressed-490"><span class="linenos">490</span></a>    <span class="c1"># with gzip.open(filename + &#39;.gz&#39;, &#39;wb&#39;) as f:</span>
</span><span id="save_compressed-491"><a href="#save_compressed-491"><span class="linenos">491</span></a>    <span class="k">with</span> <span class="n">lzma</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.xz&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="save_compressed-492"><a href="#save_compressed-492"><span class="linenos">492</span></a>        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</span><span id="save_compressed-493"><a href="#save_compressed-493"><span class="linenos">493</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saved results to &quot;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.xz.&quot;</span><span class="p">)</span>
</span><span id="save_compressed-494"><a href="#save_compressed-494"><span class="linenos">494</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&gt;To reload from disk do: kept_data = mp.load_compressed(&#39;&quot;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;&#39;)&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Save (=pickle) an object 'obj' to a compressed file with name 'filename'.</p>
</div>


                </section>
                <section id="load_compressed">
                            <input id="load_compressed-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">load_compressed</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="load_compressed-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#load_compressed"></a>
            <div class="chroma pdoc-code"><pre><span></span><span id="load_compressed-497"><a href="#load_compressed-497"><span class="linenos">497</span></a><span class="k">def</span> <span class="nf">load_compressed</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="load_compressed-498"><a href="#load_compressed-498"><span class="linenos">498</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Load (=unpickle) an object &#39;obj&#39; from a compressed file with name &#39;filename&#39;.&quot;&quot;&quot;</span>
</span><span id="load_compressed-499"><a href="#load_compressed-499"><span class="linenos">499</span></a>    <span class="c1"># with gzip.open(filename + &#39;.gz&#39;, &#39;rb&#39;) as f:</span>
</span><span id="load_compressed-500"><a href="#load_compressed-500"><span class="linenos">500</span></a>    <span class="k">with</span> <span class="n">lzma</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.xz&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="load_compressed-501"><a href="#load_compressed-501"><span class="linenos">501</span></a>        <span class="n">obj</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="load_compressed-502"><a href="#load_compressed-502"><span class="linenos">502</span></a>    <span class="k">return</span> <span class="n">obj</span>
</span></pre></div>


            <div class="docstring"><p>Load (=unpickle) an object 'obj' from a compressed file with name 'filename'.</p>
</div>


                </section>
</div>


<style>pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
<style>:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
<style>.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
<style>.pdoc *{scroll-margin:4rem;}</style>